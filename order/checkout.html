<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Online Order - My Cart</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <!-- moved icons to head so they are available when page renders -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    @media (max-width: 400px) {
      .container { max-width: 100vw; padding: 0; }
      .rounded-pill { font-size: 14px; }
    }
    .cart-food-card { border: 1px solid #aaa; border-radius: 10px; padding: 10px 14px; margin-bottom: 12px; }
    .cart-icons { font-size: 1.1em; cursor: pointer; margin-right: 7px; }
    .cart-icons .bi { vertical-align: middle; }
    .cart-bottom-bar button { border-radius: 18px !important; }
    .cart-nav-btn { font-size: 13px; }
    .cart-nav-bar { background: #fafafa; border-top: 1px solid #ddd; }
    .fixed-bottom-bar { position: fixed; left:0; right:0; bottom: 0; z-index:10; background: #fff; }
    .cart-bottom-bar { display: flex; }
    .cart-bottom-bar button { flex: 1; border: none; }
    .cart-table th, .cart-table td { font-size: 13px; padding: 4px 7px; }
    /* checkout form overlay */
    .checkout-overlay {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.45);
      z-index: 1200;
    }
    .checkout-card {
      width: 94%;
      max-width: 420px;
      background: #fff;
      border-radius: 10px;
      padding: 16px;
    }
  </style>
</head>
<body style="background: #f5f5f5;">
  <div class="container my-2" style="max-width:400px;">
    <h5 class="mb-2 mt-2"><b>My Cart</b></h5>
    <!-- Cart summary info table -->
    <table class="cart-table table table-bordered mb-3">
      <thead class="table-light">
        <tr>
          <th>Food Centre</th>
          <th>Stall</th>
          <th>Option</th>
          <th>Date &amp; Time</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td id="cartFoodCentre"></td>
          <td id="cartStall"></td>
          <td id="cartOption"></td>
          <td id="cartDateTime"></td>
        </tr>
      </tbody>
    </table>
    <!-- Food items in cart -->
    <div id="cartFoods">
      <!-- Render food item cards here -->
    </div>
    <b class="d-block mt-3 mb-4">Total: <span id="cartTotal">$0.00</span></b>
  </div>

  <!-- Bottom bar -->
  <div class="fixed-bottom-bar cart-bottom-bar p-2 gap-2" style="max-width:400px; margin: 0 auto;">
    <button class="btn btn-outline-primary" onclick="orderMore()">Order More</button>
    <button class="btn btn-success" onclick="showCheckoutForm()">Check Out</button>
  </div>

  <!-- Checkout overlay (appears when user clicks Check Out) -->
  <div id="checkoutOverlay" class="checkout-overlay" aria-hidden="true">
    <div class="checkout-card shadow-sm">
      <h6 class="mb-2">Enter details to complete order</h6>
      <div class="mb-2">
        <input id="custName" class="form-control form-control-sm" placeholder="Full name" />
      </div>
      <div class="mb-2">
        <input id="custEmail" class="form-control form-control-sm" placeholder="Email" type="email"/>
      </div>
      <div class="mb-2">
        <select id="paymentMethod" class="form-select form-select-sm">
          <option value="mock_card">Mock Card (test)</option>
          <option value="cash">Pay on Pickup (cash)</option>
        </select>
      </div>
      <div class="d-flex gap-2">
        <button class="btn btn-success btn-sm flex-grow-1" onclick="confirmPayment()">Pay (mock)</button>
        <button class="btn btn-outline-secondary btn-sm" onclick="hideCheckoutForm()">Cancel</button>
      </div>
      <div id="checkoutMsg" class="mt-2 small text-danger" style="display:none;"></div>
    </div>
  </div>

  <!-- Navigation bar removed to match menu/home/stall pages (no bottom nav on checkout) -->

  <script>
    /*****************************************************************
     * Utility: load saved cart and order info from localStorage
     * Robust: accepts multiple cart formats used by menu pages and
     * normalises to an array of {id,name,price,qty} for the checkout.
     *****************************************************************/
    function loadSavedCart() {
      try {
        const possibleKeys = ['cart', 'menuCart', 'orderCart'];
        let raw = null;
        for (const k of possibleKeys) {
          raw = localStorage.getItem(k);
          if (raw) break;
        }
        if (!raw) return [];
        const parsed = JSON.parse(raw);

        if (Array.isArray(parsed)) {
          // ensure numeric price/qty
          const arr = parsed.map(it => ({ id: it.id, name: it.name||it.title||it.id, price: Number(it.price)||0, qty: Number(it.qty)||0 })).filter(i=>i.qty>0);
          localStorage.setItem('cart', JSON.stringify(arr));
          return arr;
        }

        // object map { id: qty } -> reconstruct using catalog
        if (parsed && typeof parsed === 'object') {
          const catRaw = localStorage.getItem('productCatalog');
          const flat = catRaw ? JSON.parse(catRaw) : foodsPerCategory.flat();
          const map = Object.fromEntries(flat.map(f => [f.id, f]));
          const arr = Object.keys(parsed).map(id => {
            const qty = Number(parsed[id]) || 0;
            const p = map[id] || { id, name: id, price: 0 };
            return { id, name: p.name, price: Number(p.price)||0, qty };
          }).filter(i=>i.qty>0);
          localStorage.setItem('cart', JSON.stringify(arr));
          return arr;
        }
      } catch (e) { console.warn('loadSavedCart error', e); }
      return [];
    }

    function loadSavedOrderInfo() {
      // Try multiple keys used across pages; keep robust.
      const selectedOption = localStorage.getItem('selectedOption') || localStorage.getItem('option') || 'Dine In';
      // selectedTime may be stored as "HH:MM" or "ASAP" depending on stall page
      const selectedTime = localStorage.getItem('selectedTime') || localStorage.getItem('selectedDateTime') || '';

      // date should be based on current date (today)
      function formatToday() {
        const d = new Date();
        const day = String(d.getDate()).padStart(2, '0');
        const monthNames = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
        const month = monthNames[d.getMonth()];
        const year = d.getFullYear();
        return `${day} ${month} ${year}`;
      }

      let dateTimeStr = '';
      if (selectedOption && selectedOption.toLowerCase() === 'asap') {
        // per requirement: when ASAP selected do not show time (we will hide cell later)
        dateTimeStr = 'ASAP';
      } else {
        // preferred timing: show today's date and the selected time (if present)
        const timePart = selectedTime && selectedTime.toLowerCase() !== 'asap' ? selectedTime : '';
        dateTimeStr = timePart ? `${formatToday()} ${timePart}` : `${formatToday()}`;
      }

      const info = {
        foodCentre: localStorage.getItem('selectedFoodCentre') || localStorage.getItem('foodCentre') || 'Hawker A',
        stall: localStorage.getItem('selectedStall') || localStorage.getItem('stall') || 'Stall A',
        option: selectedOption,
        dateTime: dateTimeStr
      };
      return info;
    }
    
    // state
    let cartFoods = loadSavedCart();
    const cartInfo = loadSavedOrderInfo();
    
    // render summary row
    document.getElementById('cartFoodCentre').textContent = cartInfo.foodCentre;
    document.getElementById('cartStall').textContent = cartInfo.stall;
    document.getElementById('cartOption').textContent = cartInfo.option;
    // If user picked "ASAP" hide date/time cell (consistent with order page behaviour)
    const cartDateEl = document.getElementById('cartDateTime');
    if (cartInfo.dateTime && String(cartInfo.dateTime).toLowerCase() === 'asap') {
      cartDateEl.textContent = ''; // keep blank for ASAP per requirement
    } else {
      cartDateEl.textContent = cartInfo.dateTime;
    }

    /*****************************************************************
     * Cart rendering and manipulation
     *****************************************************************/
    function renderCartFoods() {
      let html = "";
      if (!cartFoods.length) {
        html = '<div class="text-center text-muted py-4">Your cart is empty.</div>';
      } else {
        cartFoods.forEach((food, i) => {
          html += `
            <div class="cart-food-card d-flex justify-content-between align-items-center">
              <div>
                <b>${food.name}</b><br>
                <div class="small text-muted">Unit: $${food.price.toFixed(2)}</div>
                <div class="mt-1">
                  <span class="cart-icons" title="Edit"><i class="bi bi-pencil"></i></span>
                  <span class="cart-icons text-danger" title="Remove" onclick="removeFood(${i})"><i class="bi bi-trash"></i></span>
                </div>
              </div>
              <div class="text-end">
                <div>Price: <b>$${(food.price*food.qty).toFixed(2)}</b></div>
                <select aria-label="Qty" style="width:70px; margin-top:6px;" onchange="changeQty(${i}, this.value)">
                  ${[1,2,3,4,5].map(n => `<option value="${n}" ${food.qty==n?'selected':''}>${n}</option>`).join('')}
                </select>
              </div>
            </div>
          `;
        });
      }
      document.getElementById('cartFoods').innerHTML = html;
      updateTotal();
      persistCart();
    }

    function removeFood(idx) {
      if (idx >=0 && idx < cartFoods.length) {
        cartFoods.splice(idx, 1);
        renderCartFoods();
      }
    }

    function changeQty(idx, qty) {
      qty = parseInt(qty,10) || 1;
      if (idx >=0 && idx < cartFoods.length) {
        cartFoods[idx].qty = qty;
        renderCartFoods();
      }
    }

    function updateTotal() {
      let total = 0;
      cartFoods.forEach(f => total += (f.price || 0) * (f.qty || 0));
      document.getElementById('cartTotal').textContent = '$' + total.toFixed(2);
    }

    function persistCart() {
      try {
        localStorage.setItem('cart', JSON.stringify(cartFoods));
      } catch(e) { console.warn('failed saving cart', e); }
    }

    function persistCartToStorage(cartObj) {
      // normalize to array [{id,name,price,qty}, ...]
      const arr = [];
      // if cartObj is already an array just save it
      if (Array.isArray(cartObj)) {
        localStorage.setItem('cart', JSON.stringify(cartObj));
        return;
      }
      // cartObj as map {id:qty}
      for (const id of Object.keys(cartObj || {})) {
        const qty = Number(cartObj[id]) || 0;
        if (!qty) continue;
        // lookup product metadata from your foodsPerCategory map
        const flat = foodsPerCategory.flat();
        const p = flat.find(x => x.id === id) || { id, name: id, price: 0 };
        arr.push({ id: p.id, name: p.name, price: Number(p.price)||0, qty });
      }
      localStorage.setItem('cart', JSON.stringify(arr));
    }

    /*****************************************************************
     * Navigation helpers
     *****************************************************************/
    function orderMore() {
      // Return to menu page to add more items.
      // checkout.html lives in the "order" folder; the menu is order/menu.html
      window.location.href = "menu.html";
    }
    
    /*****************************************************************
     * Checkout flow (mock payment)
     *****************************************************************/
    function showCheckoutForm() {
      if (!cartFoods.length) {
        alert('Your cart is empty.');
        return;
      }
      document.getElementById('checkoutOverlay').style.display = 'flex';
      document.getElementById('checkoutOverlay').setAttribute('aria-hidden', 'false');
    }
    function hideCheckoutForm() {
      document.getElementById('checkoutOverlay').style.display = 'none';
      document.getElementById('checkoutOverlay').setAttribute('aria-hidden', 'true');
      document.getElementById('checkoutMsg').style.display = 'none';
    }

    function confirmPayment() {
      const name = document.getElementById('custName').value.trim();
      const email = document.getElementById('custEmail').value.trim();
      const msgEl = document.getElementById('checkoutMsg');
      if (!name) { msgEl.textContent = 'Please enter your name.'; msgEl.style.display='block'; return; }
      if (!email || !email.includes('@')) { msgEl.textContent = 'Please enter a valid email.'; msgEl.style.display='block'; return; }
      msgEl.style.display='none';

      // simulate payment processing
      const paymentMethod = document.getElementById('paymentMethod').value;
      // build order object
      const order = {
        id: 'ord_' + Date.now(),
        customer: { name, email },
        info: cartInfo,
        items: cartFoods,
        total: cartFoods.reduce((s,i) => s + (i.price||0)*(i.qty||0), 0),
        paymentMethod,
        paymentStatus: paymentMethod === 'cash' ? 'pending' : 'paid',
        createdAt: new Date().toISOString()
      };

      // persist order list in localStorage (demo backend)
      try {
        const raw = localStorage.getItem('orders');
        const list = raw ? JSON.parse(raw) : [];
        list.push(order);
        localStorage.setItem('orders', JSON.stringify(list));
      } catch(e) { console.warn('failed saving order', e); }

      // clear cart
      cartFoods = [];
      persistCart();
      renderCartFoods();
      hideCheckoutForm();

      // show success and redirect to a simple success view (or display inline)
      alert('Order placed: ' + order.id + '\nStatus: ' + order.paymentStatus);
      // redirect to a simple success page if you have one:
      // window.location.href = "order-success.html?id=" + order.id;
    }

    /*****************************************************************
     * Initial render
     *****************************************************************/
    // initial render + debug
    console.debug('Loaded cartFoods:', cartFoods);
    renderCartFoods();
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
