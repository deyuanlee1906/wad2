<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>ChopeLah - Crowd View Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet" />
  <link rel="stylesheet" href="/styles/main.css" />
  <link rel="stylesheet" href="/styles/components.css" />
  <style>
        :root {
            --color-white: rgba(255, 255, 255, 1);
            --color-cream-50: #fafafa;
            --color-cream-100: #ffffff;
            --color-gray-200: #f5f5f5;
            --color-gray-300: rgba(167, 169, 169, 1);
            --color-slate-500: rgba(98, 108, 113, 1);
            --color-brown-600: rgba(94, 82, 64, 1);
            --color-charcoal-700: rgba(31, 33, 33, 1);
            --color-charcoal-800: rgba(38, 40, 40, 1);
            --color-slate-900: #262626;
            
            /* Theme colors matching the rest of the site */
            --color-primary: #C9784F;
            --color-primary-hover: #b36a43;
            --color-secondary: #D98566;
            --color-accent: #F2C6B6;
            --color-background-light: #F2D9BB;
            --color-surface-light: #F2F2F2;
            
            --color-red-400: rgba(255, 84, 89, 1);
            --color-orange-400: #D98566;
            --color-orange-500: #C9784F;
            --color-green-500: rgba(34, 197, 94, 1);
            
            --color-primary-rgb: 201, 120, 79;
            --color-brown-600-rgb: 242, 198, 182;
            --color-slate-900-rgb: 38, 38, 38;
            
            --color-background: #fafafa;
            --color-surface: #ffffff;
            --color-text: #1a1a1a;
            --color-text-secondary: #666;
            --color-border: rgba(224, 224, 224, 1);
            --color-card-border: #e0e0e0;
            
            --font-family-base: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            --font-size-xs: 11px;
            --font-size-sm: 12px;
            --font-size-base: 14px;
            --font-size-lg: 16px;
            --font-size-xl: 18px;
            --font-size-2xl: 20px;
            --font-size-3xl: 24px;
            --font-weight-medium: 500;
            --font-weight-semibold: 550;
            --font-weight-bold: 600;
            
            --space-8: 8px;
            --space-12: 12px;
            --space-16: 16px;
            --space-20: 20px;
            --space-24: 24px;
            --space-32: 32px;
            
            --radius-base: 8px;
            --radius-md: 10px;
            --radius-lg: 12px;
            
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.02);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.04), 0 2px 4px -1px rgba(0, 0, 0, 0.02);
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --color-gray-400-rgb: 119, 124, 124;
                --color-gray-300-rgb: 167, 169, 169;
                
                --color-background: var(--color-charcoal-700);
                --color-surface: var(--color-charcoal-800);
                --color-text: var(--color-gray-200);
                --color-text-secondary: rgba(var(--color-gray-300-rgb), 0.7);
                --color-primary: #D98566;
                --color-primary-hover: #C9784F;
                --color-border: rgba(var(--color-gray-400-rgb), 0.3);
                --color-card-border: rgba(var(--color-gray-400-rgb), 0.2);
            }
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background-color: #fafafa;
            color: #1a1a1a;
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            padding-top: 70px;
            padding-bottom: 80px;
            overflow-x: hidden;
            width: 100%;
            max-width: 100vw;
        }

        @media (max-width: 768px) {
            body {
                padding-top: env(safe-area-inset-top);
                padding-bottom: calc(80px + env(safe-area-inset-bottom));
            }
        }

        /* Desktop View */
        .desktop-view {
            display: block;
            padding: var(--space-32);
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Mobile View */
        .mobile-view {
            display: none;
            padding: var(--space-16);
            padding-top: max(var(--space-16), env(safe-area-inset-top));
            width: 100%;
            max-width: 100vw;
            box-sizing: border-box;
            overflow-x: hidden;
        }

        /* Header */
        .header {
            margin-bottom: var(--space-32);
        }

        .header h1 {
            font-size: var(--font-size-3xl);
            font-weight: var(--font-weight-bold);
            color: #1a1a1a;
            margin-bottom: var(--space-8);
        }

        .header-subtitle {
            font-size: var(--font-size-base);
            color: var(--color-text-secondary);
        }

        .hawker-selector {
            display: flex;
            gap: var(--space-16);
            margin-top: var(--space-20);
            flex-wrap: wrap;
        }

        .select-wrapper {
            flex: 1;
            min-width: 200px;
            position: relative;
        }

        .select-wrapper label {
            display: block;
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-medium);
            color: #1a1a1a;
            margin-bottom: var(--space-8);
        }

        /* Custom searchable dropdown for hawker centre */
        .hawker-centre-select {
            position: relative;
            width: 100%;
        }

        .hawker-centre-input-wrapper {
            position: relative;
        }

        .hawker-centre-input {
            width: 100%;
            padding: 10px 36px 10px 12px;
            border: 1px solid #1a1a1a;
            border-radius: 6px;
            background: white;
            color: #1a1a1a;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            box-sizing: border-box;
        }

        .hawker-centre-input::placeholder {
            color: rgba(26, 26, 26, 0.5);
            font-weight: 500;
        }

        .hawker-centre-input:hover {
            border-color: #4285f4;
            box-shadow: 0 0 0 2px rgba(66, 133, 244, 0.1);
        }

        .hawker-centre-input:focus {
            outline: none;
            border-color: #4285f4;
            box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.2);
        }

        .hawker-centre-dropdown-icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
            width: 12px;
            height: 12px;
            transition: transform 0.2s;
        }

        .hawker-centre-select.open .hawker-centre-dropdown-icon {
            transform: translateY(-50%) rotate(180deg);
        }

        .hawker-centre-dropdown {
            position: absolute;
            top: calc(100% + 4px);
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #1a1a1a;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            margin-top: 4px;
        }

        .hawker-centre-select.open .hawker-centre-dropdown {
            display: block;
        }

        .dropdown-label-above {
            display: block;
            position: absolute;
            bottom: 100%;
            left: 0;
            right: 0;
            padding: 8px 12px 4px 0;
            margin-bottom: 4px;
            font-size: var(--font-size-sm);
            font-weight: bold;
            color: #1a1a1a;
            background: transparent;
            border: none;
            box-shadow: none;
            z-index: 1001;
            white-space: nowrap;
        }

        .dropdown-search-bar {
            padding: 12px;
            border-bottom: 1px solid rgba(26, 26, 26, 0.1);
            position: sticky;
            top: 0;
            background: white;
            z-index: 10;
        }

        .dropdown-search-bar input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid rgba(26, 26, 26, 0.2);
            border-radius: 4px;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        .dropdown-search-bar input:focus {
            outline: none;
            border-color: #4285f4;
            box-shadow: 0 0 0 2px rgba(66, 133, 244, 0.1);
        }

        .hawker-centre-option {
            padding: 12px;
            cursor: pointer;
            transition: background-color 0.15s;
            border-bottom: 1px solid rgba(26, 26, 26, 0.1);
            font-weight: 500;
        }

        .hawker-centre-option:last-child {
            border-bottom: none;
        }

        .hawker-centre-option:hover {
            background-color: rgba(66, 133, 244, 0.1);
        }

        .hawker-centre-option.selected {
            background-color: rgba(66, 133, 244, 0.15);
            font-weight: 600;
        }

        .hawker-centre-option.hidden {
            display: none;
        }

        /* Custom searchable dropdown for stall (same styling as hawker centre) */
        .stall-select {
            position: relative;
            width: 100%;
        }

        .stall-input-wrapper {
            position: relative;
        }

        .stall-input {
            width: 100%;
            padding: 10px 36px 10px 12px;
            border: 1px solid #1a1a1a;
            border-radius: 6px;
            background: white;
            color: #1a1a1a;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            box-sizing: border-box;
        }

        .stall-input::placeholder {
            color: rgba(26, 26, 26, 0.5);
            font-weight: 500;
        }

        .stall-input:hover {
            border-color: #4285f4;
            box-shadow: 0 0 0 2px rgba(66, 133, 244, 0.1);
        }

        .stall-input:focus {
            outline: none;
            border-color: #4285f4;
            box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.2);
        }

        .stall-input:disabled {
            background-color: #f5f5f5;
            color: #999;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .stall-input:disabled:hover {
            border-color: #1a1a1a;
            box-shadow: none;
        }

        .stall-dropdown-icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
            width: 12px;
            height: 12px;
            transition: transform 0.2s;
        }

        .stall-select.open .stall-dropdown-icon {
            transform: translateY(-50%) rotate(180deg);
        }

        .stall-dropdown {
            position: absolute;
            top: calc(100% + 4px);
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #1a1a1a;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            max-height: 300px;
            overflow-y: auto;
            z-index: 1001;
            display: none;
            margin-top: 4px;
        }

        .stall-select.open .stall-dropdown {
            display: block;
        }

        .stall-option {
            padding: 12px;
            cursor: pointer;
            transition: background-color 0.15s;
            border-bottom: 1px solid rgba(26, 26, 26, 0.1);
            font-weight: 500;
        }

        .stall-option:last-child {
            border-bottom: none;
        }

        .stall-option:hover {
            background-color: rgba(66, 133, 244, 0.1);
        }

        .stall-option.selected {
            background-color: rgba(66, 133, 244, 0.15);
            font-weight: 600;
        }

        .stall-option.hidden {
            display: none;
        }

        select {
  width: 100%;
            padding: 10px 36px 10px 12px;
            border: 1px solid #1a1a1a;
            border-radius: 6px;
            background-color: white;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%231a1a1a' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 12px;
            color: #1a1a1a;
            font-size: 16px;
            font-weight: 600;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            appearance: none;
            box-sizing: border-box;
            cursor: pointer;
            transition: all 0.2s;
        }

        select:hover {
            border-color: #4285f4;
            box-shadow: 0 0 0 2px rgba(66, 133, 244, 0.1);
        }

        select:focus {
            outline: none;
            border-color: #4285f4;
            box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.2);
        }

        select:disabled {
            background-color: #e9ecef;
            opacity: 0.6;
            cursor: not-allowed;
        }

        select option {
            color: #1a1a1a;
            background: white;
            font-size: 16px;
            font-weight: 600;
            padding: 10px 12px;
        }

        select option:disabled {
            color: rgba(26, 26, 26, 0.5);
            font-weight: 500;
        }

        select option:hover,
        select option:focus {
            background-color: rgba(66, 133, 244, 0.1);
        }

        /* Maintain focus style when dropdown is open */
        select:focus:not(:disabled) {
            border-color: #4285f4;
            box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.2);
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-16);
            margin-bottom: var(--space-32);
        }

        .stat-card {
            background: #ffffff;
            border: 1px solid #e0e0e0;
            border-radius: var(--radius-lg);
            padding: var(--space-20);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .stat-label {
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: var(--space-8);
        }

        .stat-value {
            font-size: var(--font-size-3xl);
            font-weight: var(--font-weight-bold);
            color: #1a1a1a;
            margin-bottom: var(--space-8);
        }

        .stat-change {
            font-size: var(--font-size-sm);
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .stat-change.positive {
            color: var(--color-green-500);
        }

        .stat-change.negative {
            color: var(--color-red-400);
        }

        /* Main Grid */
        .main-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: var(--space-24);
            margin-bottom: var(--space-24);
        }

        /* Chart Card */
        .chart-card {
            background: #ffffff;
            border: 1px solid #e0e0e0;
            border-radius: var(--radius-lg);
            padding: var(--space-24);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-20);
        }

        .chart-title {
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-semibold);
            color: #1a1a1a;
        }

        .time-filter {
            display: flex;
            gap: var(--space-8);
        }

        .time-btn {
            padding: 6px 12px;
            border: 1px solid var(--color-border);
            background: transparent;
            border-radius: var(--radius-base);
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .time-btn.active {
            background: var(--color-primary);
            color: white;
            border-color: var(--color-primary);
        }

        .time-btn:hover:not(.active) {
            border-color: var(--color-primary);
            color: var(--color-primary);
        }

        /* Bar Chart */
        .bar-chart {
            display: flex;
            flex-direction: column;
            gap: var(--space-16);
            min-height: 300px;
        }

        .bar-item {
            display: flex;
            align-items: center;
            gap: var(--space-12);
            animation: slideIn 0.4s ease-out forwards;
            opacity: 0;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* Staggered animation delays */
        .bar-item:nth-child(1) { animation-delay: 0.05s; }
        .bar-item:nth-child(2) { animation-delay: 0.1s; }
        .bar-item:nth-child(3) { animation-delay: 0.15s; }
        .bar-item:nth-child(4) { animation-delay: 0.2s; }
        .bar-item:nth-child(5) { animation-delay: 0.25s; }
        .bar-item:nth-child(6) { animation-delay: 0.3s; }
        .bar-item:nth-child(7) { animation-delay: 0.35s; }

        .bar-label {
            width: 120px;
            min-width: 120px;
            font-size: var(--font-size-sm);
            color: #1a1a1a;
            font-weight: var(--font-weight-medium);
            flex-shrink: 0;
        }

        .bar-track {
            flex: 1;
            height: 32px;
            background: rgba(var(--color-primary-rgb), 0.1);
            border-radius: var(--radius-base);
            position: relative;
            overflow: hidden;
        }

        .bar-fill {
            height: 100%;
            border-radius: var(--radius-base);
            display: flex;
            align-items: center;
            padding: 0 var(--space-12);
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-semibold);
            color: white;
            transition: width 0.5s ease, background-color 0.3s ease;
        }

        .bar-fill.low {
            background: var(--color-green-500);
        }

        .bar-fill.medium {
            background: var(--color-secondary);
        }

        .bar-fill.high {
            background: var(--color-primary);
        }

        /* Stall-specific crowd level: black text for Queue label */
        .second-row .bar-fill {
            color: #1a1a1a;
        }

        .bar-value {
            width: 50px;
            min-width: 50px;
            text-align: right;
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-semibold);
            color: #1a1a1a;
            flex-shrink: 0;
        }

        /* Leaderboard */
        .leaderboard {
            display: flex;
            flex-direction: column;
            gap: var(--space-12);
        }

        .leaderboard-item {
            display: flex;
            align-items: center;
            gap: var(--space-12);
            padding: var(--space-16);
            background: #ffffff;
            border: 1px solid #e0e0e0;
            border-radius: var(--radius-md);
            transition: all 0.2s;
            animation: fadeInUp 0.4s ease-out forwards;
            opacity: 0;
        }
        
        .leaderboard-item:hover {
            transform: translateX(4px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            border-color: #C9784F;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Staggered animation delays */
        .leaderboard-item:nth-child(1) { animation-delay: 0.05s; }
        .leaderboard-item:nth-child(2) { animation-delay: 0.1s; }
        .leaderboard-item:nth-child(3) { animation-delay: 0.15s; }

        .rank-badge {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: var(--font-weight-bold);
            font-size: var(--font-size-base);
            flex-shrink: 0;
        }

        .rank-badge.gold {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: white;
        }

        .rank-badge.silver {
            background: linear-gradient(135deg, #C0C0C0, #808080);
            color: white;
        }

        .rank-badge.bronze {
            background: linear-gradient(135deg, #CD7F32, #8B4513);
            color: white;
        }

        .stall-info {
            flex: 1;
        }

        .stall-name {
            font-weight: var(--font-weight-semibold);
            color: #1a1a1a;
            margin-bottom: 2px;
        }

        .stall-cuisine {
            font-size: var(--font-size-xs);
            color: var(--color-text-secondary);
        }

        .popularity-score {
            text-align: right;
        }

        .score-value {
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-bold);
            color: var(--color-primary);
        }

        .score-label {
            font-size: var(--font-size-xs);
            color: var(--color-text-secondary);
        }

        /* Second Row */
        .second-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-24);
        }

        /* Activity Feed */
        .activity-feed {
            display: flex;
            flex-direction: column;
            gap: var(--space-12);
            max-height: 300px;
            overflow-y: auto;
        }

        .activity-item {
            display: flex;
            gap: var(--space-12);
            padding: var(--space-12);
            border-left: 3px solid var(--color-primary);
            background: #ffffff;
            border-radius: 0 var(--radius-base) var(--radius-base) 0;
            animation: fadeInUp 0.4s ease-out forwards;
            opacity: 0;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .activity-item:hover {
            transform: translateX(4px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border-left-color: var(--color-primary-hover);
        }

        .activity-item.reservation-item {
            border-left-color: var(--color-primary);
        }

        /* Staggered animation delays for activity items */
        .activity-item:nth-child(1) { animation-delay: 0.05s; }
        .activity-item:nth-child(2) { animation-delay: 0.1s; }
        .activity-item:nth-child(3) { animation-delay: 0.15s; }
        .activity-item:nth-child(4) { animation-delay: 0.2s; }
        .activity-item:nth-child(5) { animation-delay: 0.25s; }

        .activity-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--color-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: var(--font-size-sm);
            flex-shrink: 0;
        }

        .activity-content {
            flex: 1;
        }

        .activity-text {
            font-size: var(--font-size-sm);
            color: #1a1a1a;
            margin-bottom: 4px;
        }

        .activity-time {
            font-size: var(--font-size-xs);
            color: var(--color-text-secondary);
        }

        /* Peak Hours */
        .peak-hours-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: var(--space-12);
        }

        .hour-card {
            padding: var(--space-16);
            border: 1px solid #e0e0e0;
            border-radius: var(--radius-md);
            text-align: center;
            background: #ffffff;
            animation: fadeInUp 0.4s ease-out forwards;
            opacity: 0;
        }

        /* Staggered animation delays for hour cards */
        .hour-card:nth-child(1) { animation-delay: 0.05s; }
        .hour-card:nth-child(2) { animation-delay: 0.1s; }
        .hour-card:nth-child(3) { animation-delay: 0.15s; }
        .hour-card:nth-child(4) { animation-delay: 0.2s; }

        .hour-time {
            font-size: var(--font-size-base);
            font-weight: var(--font-weight-semibold);
            color: #1a1a1a;
            margin-bottom: var(--space-8);
        }

        .hour-bar {
            height: 60px;
            background: rgba(var(--color-primary-rgb), 0.1);
            border-radius: var(--radius-base);
            position: relative;
            overflow: hidden;
            margin-bottom: var(--space-8);
        }

        .hour-bar-fill {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--color-primary);
            transition: height 0.5s ease, background-color 0.3s ease;
        }

        .hour-percentage {
            font-size: var(--font-size-xs);
            color: var(--color-text-secondary);
        }

        /* Responsive - Mobile */
        @media (max-width: 430px) {
            .desktop-view {
                display: none;
            }

            .mobile-view {
                display: block;
            }

            .mobile-view .header {
                margin-bottom: var(--space-24);
                padding: 0 var(--space-16);
                padding-top: var(--space-8);
            }

            .mobile-view .header > div:first-child {
                display: flex;
                justify-content: space-between;
                align-items: center;
                gap: var(--space-8);
                flex-wrap: nowrap;
                width: 100%;
                position: relative;
                margin-bottom: var(--space-12);
            }

            .mobile-view .header h1 {
                font-size: var(--font-size-2xl);
                margin: 0;
                flex: 1 1 0%;
                min-width: 0;
                max-width: calc(100% - 85px);
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                -webkit-font-smoothing: antialiased;
                -moz-osx-font-smoothing: grayscale;
                text-rendering: optimizeLegibility;
                line-height: 1.3;
                word-break: normal;
                transform: translateZ(0);
                -webkit-transform: translateZ(0);
                backface-visibility: hidden;
                -webkit-backface-visibility: hidden;
                padding-right: var(--space-8);
                box-sizing: border-box;
            }

            .mobile-view .live-indicator {
                flex-shrink: 0;
                white-space: nowrap;
                padding: 4px 8px;
                font-size: var(--font-size-xs);
                min-width: 60px;
                box-sizing: border-box;
            }
            
            /* Specific adjustments for iPhone 14 Pro Max and similar sizes */
            @media (max-width: 430px) {
                .mobile-view .header h1 {
                    font-size: var(--font-size-xl);
                    max-width: calc(100% - 70px);
                    padding-right: var(--space-4);
                }
                
                .mobile-view .live-indicator {
                    padding: 3px 6px;
                    font-size: 10px;
                    min-width: 55px;
                }
            }

            .hawker-selector {
                flex-direction: column;
                gap: var(--space-16);
            }

            .select-wrapper {
                min-width: 100%;
                margin-bottom: var(--space-8);
            }

            .select-wrapper:last-child {
                margin-bottom: 0;
            }

            .mobile-view .dropdown-label-above {
                position: static;
                display: block;
                padding: 0;
            }

            .mobile-view .bar-label {
                width: 80px;
                min-width: 80px;
            }

            .mobile-view .bar-value {
                width: 40px;
                min-width: 40px;
            }

            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }

            .main-grid {
                grid-template-columns: 1fr;
            }

            .second-row {
                grid-template-columns: 1fr;
            }

            .time-filter {
                width: 100%;
                justify-content: space-between;
            }

            .time-btn {
                flex: 1;
            }

            .peak-hours-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Loading state */
        .loading {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid rgba(var(--color-primary-rgb), 0.2);
            border-top-color: var(--color-primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Live indicator */
        .live-indicator {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            background: rgba(var(--color-primary-rgb), 0.1);
            border-radius: 999px;
            font-size: var(--font-size-xs);
            font-weight: var(--font-weight-medium);
            color: var(--color-primary);
        }

        .live-dot {
            width: 8px;
            height: 8px;
            background: var(--color-primary);
            border-radius: 50%;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
}
  </style>
</head>
<body>
    <!-- DESKTOP VIEW -->
    <div class="desktop-view">
        <div class="header">
            <div style="display: flex; justify-content: space-between; align-items: start;">
                <div>
                    <h1>Crowd View Dashboard</h1>
                    <p class="header-subtitle">Real-time crowd analytics for hawker centres in Singapore</p>
                </div>
                <div class="live-indicator">
                    <span class="live-dot"></span>
                    LIVE
                </div>
  </div>

            <div class="hawker-selector">
                <div class="select-wrapper">
                    <label for="hawker-select">Select Hawker Centre</label>
                    <div class="hawker-centre-select" id="hawkerCentreSelectWrapper">
                        <div class="hawker-centre-input-wrapper">
                            <input 
                                type="text" 
                                id="hawker-select" 
                                class="hawker-centre-input" 
                                placeholder="Please select a food centre"
                                autocomplete="off"
                                aria-label="Select Food Centre"
                                readonly
                                value=""
                            />
                            <svg class="hawker-centre-dropdown-icon" xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 12 12">
                                <path fill="#1a1a1a" d="M6 9L1 4h10z"/>
                            </svg>
                        </div>
                        <div class="dropdown-label-above">Select Food Centre</div>
                        <div class="hawker-centre-dropdown" id="hawkerCentreDropdown" role="listbox">
                            <div class="dropdown-search-bar">
                                <input 
                                    type="text" 
                                    id="hawkerDropdownSearchInput" 
                                    placeholder="Search food centre..."
                                    autocomplete="off"
                                />
                            </div>
                            <div class="hawker-centre-option" data-value="maxwell" data-label="Maxwell Food Centre">Maxwell Food Centre</div>
                            <div class="hawker-centre-option" data-value="newton" data-label="Newton Food Centre">Newton Food Centre</div>
                            <div class="hawker-centre-option" data-value="changi" data-label="Changi Village Food Centre">Changi Village Food Centre</div>
                        </div>
                    </div>
                </div>
                <div class="select-wrapper">
                    <div class="stall-select" id="stallSelectWrapper">
                        <div class="stall-input-wrapper">
                            <input 
                                type="text" 
                                id="stall-select" 
                                class="stall-input" 
                                placeholder="Please select a food stall"
                                autocomplete="off"
                                aria-label="Select Stall"
                                readonly
                            />
                            <svg class="stall-dropdown-icon" xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 12 12">
                                <path fill="#1a1a1a" d="M6 9L1 4h10z"/>
                            </svg>
          </div>
                        <div class="dropdown-label-above">Select Stall (Optional)</div>
                        <div class="stall-dropdown" id="stallDropdown" role="listbox">
                            <div class="dropdown-search-bar">
                                <input 
                                    type="text" 
                                    id="stallDropdownSearchInput" 
                                    placeholder="Search food stall..."
                                    autocomplete="off"
                                />
                            </div>
                            <div class="stall-option" data-value="" data-label="">All Stalls</div>
                        </div>
                    </div>
          </div>
        </div>
      </div>
      
        <!-- Stats Cards -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Current Occupancy</div>
                <div class="stat-value">78%</div>
                <div class="stat-change positive">‚Üë 12% from 1hr ago</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Active Reservations</div>
                <div class="stat-value">34</div>
                <div class="stat-change positive">‚Üë 8 new bookings</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Avg Wait Time</div>
                <div class="stat-value">15m</div>
                <div class="stat-change negative">‚Üë 3 mins</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Peak Time Today</div>
                <div class="stat-value">12:30</div>
                <div class="stat-change">Expected at 92%</div>
      </div>
        </div>

        <!-- Main Grid -->
        <div class="main-grid">
            <div class="chart-card">
                <div class="chart-header">
                    <h2 class="chart-title">Food Centre Crowd Level</h2>
                    <div class="time-filter">
                        <button class="time-btn">1H</button>
                        <button class="time-btn active">Today</button>
                        <button class="time-btn">Week</button>
                    </div>
                </div>
                <div class="bar-chart" id="hawker-chart">
                    <div class="bar-item">
                        <div class="bar-label">8:00 AM</div>
                        <div class="bar-track">
                            <div class="bar-fill low" style="width: 35%;">35%</div>
                        </div>
                        <div class="bar-value">Low</div>
                    </div>
                    <div class="bar-item">
                        <div class="bar-label">10:00 AM</div>
                        <div class="bar-track">
                            <div class="bar-fill medium" style="width: 58%;">58%</div>
                        </div>
                        <div class="bar-value">Medium</div>
                    </div>
                    <div class="bar-item">
                        <div class="bar-label">12:00 PM</div>
                        <div class="bar-track">
                            <div class="bar-fill high" style="width: 92%;">92%</div>
                        </div>
                        <div class="bar-value">High</div>
                    </div>
                    <div class="bar-item">
                        <div class="bar-label">2:00 PM</div>
                        <div class="bar-track">
                            <div class="bar-fill medium" style="width: 65%;">65%</div>
                        </div>
                        <div class="bar-value">Medium</div>
                    </div>
                    <div class="bar-item">
                        <div class="bar-label">4:00 PM</div>
                        <div class="bar-track">
                            <div class="bar-fill low" style="width: 42%;">42%</div>
                        </div>
                        <div class="bar-value">Low</div>
                    </div>
                    <div class="bar-item">
                        <div class="bar-label">6:00 PM</div>
                        <div class="bar-track">
                            <div class="bar-fill high" style="width: 88%;">88%</div>
                        </div>
                        <div class="bar-value">High</div>
                    </div>
                </div>
            </div>

            <div class="chart-card">
                <div class="chart-header">
                    <h2 class="chart-title">üèÜ Top 3 Popular Stalls</h2>
                </div>
                <div class="leaderboard">
                    <div class="leaderboard-item">
                        <div class="rank-badge gold">1</div>
                        <div class="stall-info">
                            <div class="stall-name">Tian Tian Chicken Rice</div>
                            <div class="stall-cuisine">Hainanese ‚Ä¢ Chicken Rice</div>
                        </div>
                        <div class="popularity-score">
                            <div class="score-value">9.4</div>
                            <div class="score-label">Rating</div>
                        </div>
                    </div>
                    <div class="leaderboard-item">
                        <div class="rank-badge silver">2</div>
                        <div class="stall-info">
                            <div class="stall-name">Sungei Road Laksa</div>
                            <div class="stall-cuisine">Peranakan ‚Ä¢ Laksa</div>
                        </div>
                        <div class="popularity-score">
                            <div class="score-value">9.1</div>
                            <div class="score-label">Rating</div>
                        </div>
                    </div>
                    <div class="leaderboard-item">
                        <div class="rank-badge bronze">3</div>
                        <div class="stall-info">
                            <div class="stall-name">Wei Wei Noodles</div>
                            <div class="stall-cuisine">Chinese ‚Ä¢ Noodles</div>
                        </div>
                        <div class="popularity-score">
                            <div class="score-value">8.8</div>
                            <div class="score-label">Rating</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Second Row -->
        <div class="second-row">
            <div class="chart-card">
                <div class="chart-header">
                    <h2 class="chart-title">Stall-Specific Crowd Level</h2>
                </div>
                <div class="bar-chart">
                    <div class="bar-item">
                        <div class="bar-label">Chicken Rice</div>
                        <div class="bar-track">
                            <div class="bar-fill high" style="width: 85%;">Queue: 12</div>
                        </div>
                        <div class="bar-value">15m</div>
                    </div>
                    <div class="bar-item">
                        <div class="bar-label">Laksa</div>
                        <div class="bar-track">
                            <div class="bar-fill medium" style="width: 70%;">Queue: 8</div>
                        </div>
                        <div class="bar-value">10m</div>
                    </div>
                    <div class="bar-item">
                        <div class="bar-label">Satay</div>
                        <div class="bar-track">
                            <div class="bar-fill medium" style="width: 55%;">Queue: 6</div>
                        </div>
                        <div class="bar-value">8m</div>
                    </div>
                    <div class="bar-item">
                        <div class="bar-label">Roast Meat</div>
                        <div class="bar-track">
                            <div class="bar-fill low" style="width: 40%;">Queue: 3</div>
                        </div>
                        <div class="bar-value">5m</div>
                    </div>
                    <div class="bar-item">
                        <div class="bar-label">Noodles</div>
                        <div class="bar-track">
                            <div class="bar-fill low" style="width: 32%;">Queue: 2</div>
                        </div>
                        <div class="bar-value">3m</div>
                    </div>
                </div>
            </div>

            <div class="chart-card">
                <div class="chart-header">
                    <h2 class="chart-title" id="peak-hours-title">üìä Peak Hours Analysis</h2>
                </div>
                <div class="peak-hours-grid" id="desktop-peak-hours">
                    <!-- Peak hours will be dynamically populated -->
                </div>
            </div>
        </div>
        
        <!-- Activity Feed -->
        <div class="chart-card" style="margin-top: var(--space-24);">
            <div class="chart-header">
                <h2 class="chart-title">üîî Recent Activity</h2>
            </div>
            <div class="activity-feed">
                <div class="activity-item">
                    <div class="activity-icon">üìÖ</div>
                    <div class="activity-content">
                        <div class="activity-text"><strong>New reservation</strong> at Tian Tian Chicken Rice for 4 people</div>
                        <div class="activity-time">2 minutes ago</div>
                    </div>
                </div>
                <div class="activity-item">
                    <div class="activity-icon">‚ö†Ô∏è</div>
                    <div class="activity-content">
                        <div class="activity-text"><strong>High crowd alert</strong> - Maxwell Food Centre reached 92% capacity</div>
                        <div class="activity-time">8 minutes ago</div>
                    </div>
                </div>
                <div class="activity-item">
                    <div class="activity-icon">‚úÖ</div>
                    <div class="activity-content">
                        <div class="activity-text"><strong>Reservation completed</strong> - Table released at Satay Street</div>
                        <div class="activity-time">15 minutes ago</div>
                    </div>
                </div>
                <div class="activity-item">
                    <div class="activity-icon">üìä</div>
                    <div class="activity-content">
                        <div class="activity-text"><strong>Crowd decreased</strong> - Now at 78% capacity (was 92%)</div>
                        <div class="activity-time">22 minutes ago</div>
        </div>
      </div>
    </div>
  </div>
</div>

    <!-- MOBILE VIEW (iPhone SE) -->
    <div class="mobile-view">
        <div class="header">
            <div>
                <h1>üçú Crowd View</h1>
                <div class="live-indicator">
                    <span class="live-dot"></span>
                    LIVE
                </div>
            </div>
            
            <div class="hawker-selector">
                <div class="select-wrapper">
                    <div class="dropdown-label-above">Food Centre</div>
                    <div class="hawker-centre-select" id="hawkerCentreSelectWrapperMobile">
                        <div class="hawker-centre-input-wrapper">
                            <input 
                                type="text" 
                                id="hawker-select-mobile" 
                                class="hawker-centre-input" 
                                placeholder="Please select a food centre"
                                autocomplete="off"
                                aria-label="Select Food Centre"
                                readonly
                                value=""
                            />
                            <svg class="hawker-centre-dropdown-icon" xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 12 12">
                                <path fill="#1a1a1a" d="M6 9L1 4h10z"/>
                            </svg>
                        </div>
                        <div class="hawker-centre-dropdown" id="hawkerCentreDropdownMobile" role="listbox">
                            <div class="dropdown-search-bar">
                                <input 
                                    type="text" 
                                    id="hawkerDropdownSearchInputMobile" 
                                    placeholder="Search food centre..."
                                    autocomplete="off"
                                />
                            </div>
                            <div class="hawker-centre-option" data-value="maxwell" data-label="Maxwell Food Centre">Maxwell Food Centre</div>
                            <div class="hawker-centre-option" data-value="newton" data-label="Newton Food Centre">Newton Food Centre</div>
                            <div class="hawker-centre-option" data-value="changi" data-label="Changi Village Food Centre">Changi Village Food Centre</div>
                        </div>
                    </div>
                </div>
                <div class="select-wrapper">
                    <div class="dropdown-label-above">Stall (Optional)</div>
                    <div class="stall-select" id="stallSelectWrapperMobile">
                        <div class="stall-input-wrapper">
                            <input 
                                type="text" 
                                id="stall-select-mobile" 
                                class="stall-input" 
                                placeholder="Please select a food stall"
                                autocomplete="off"
                                aria-label="Select Stall"
                                readonly
                            />
                            <svg class="stall-dropdown-icon" xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 12 12">
                                <path fill="#1a1a1a" d="M6 9L1 4h10z"/>
                            </svg>
                </div>
                        <div class="stall-dropdown" id="stallDropdownMobile" role="listbox">
                            <div class="dropdown-search-bar">
                                <input 
                                    type="text" 
                                    id="stallDropdownSearchInputMobile" 
                                    placeholder="Search food stall..."
                                    autocomplete="off"
                                />
                            </div>
                            <div class="stall-option" data-value="" data-label="">All Stalls</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Occupancy</div>
                <div class="stat-value">78%</div>
                <div class="stat-change positive">‚Üë 12%</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Wait Time</div>
                <div class="stat-value">15m</div>
                <div class="stat-change negative">‚Üë 3m</div>
            </div>
        </div>

        <!-- Hawker Centre Chart -->
        <div class="chart-card">
            <div class="chart-header">
                <h2 class="chart-title">Food Centre Crowd</h2>
                <div class="time-filter">
                    <button class="time-btn">1H</button>
                    <button class="time-btn active">Today</button>
                    <button class="time-btn">Week</button>
                </div>
            </div>
            <div class="bar-chart">
                <div class="bar-item">
                    <div class="bar-label">8AM</div>
                    <div class="bar-track">
                        <div class="bar-fill low" style="width: 35%;">35%</div>
                    </div>
                </div>
                <div class="bar-item">
                    <div class="bar-label">10AM</div>
                    <div class="bar-track">
                        <div class="bar-fill medium" style="width: 58%;">58%</div>
                    </div>
                </div>
                <div class="bar-item">
                    <div class="bar-label">12PM</div>
                    <div class="bar-track">
                        <div class="bar-fill high" style="width: 92%;">92%</div>
                    </div>
                </div>
                <div class="bar-item">
                    <div class="bar-label">2PM</div>
                    <div class="bar-track">
                        <div class="bar-fill medium" style="width: 65%;">65%</div>
                    </div>
                </div>
                <div class="bar-item">
                    <div class="bar-label">6PM</div>
                    <div class="bar-track">
                        <div class="bar-fill high" style="width: 88%;">88%</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Top Stalls -->
        <div class="chart-card">
            <div class="chart-header">
                <h2 class="chart-title">üèÜ Top Stalls</h2>
            </div>
            <div class="leaderboard">
                <div class="leaderboard-item">
                    <div class="rank-badge gold">1</div>
                    <div class="stall-info">
                        <div class="stall-name">Tian Tian Chicken Rice</div>
                        <div class="stall-cuisine">Chicken Rice</div>
                    </div>
                    <div class="popularity-score">
                        <div class="score-value">9.4</div>
                    </div>
                </div>
                <div class="leaderboard-item">
                    <div class="rank-badge silver">2</div>
                    <div class="stall-info">
                        <div class="stall-name">Sungei Road Laksa</div>
                        <div class="stall-cuisine">Laksa</div>
                    </div>
                    <div class="popularity-score">
                        <div class="score-value">9.1</div>
                    </div>
                </div>
                <div class="leaderboard-item">
                    <div class="rank-badge bronze">3</div>
                    <div class="stall-info">
                        <div class="stall-name">Wei Wei Noodles</div>
                        <div class="stall-cuisine">Noodles</div>
                    </div>
                    <div class="popularity-score">
                        <div class="score-value">8.8</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stall Crowds -->
        <div class="chart-card">
            <div class="chart-header">
                <h2 class="chart-title">Stall Queues</h2>
            </div>
            <div class="bar-chart">
                <div class="bar-item">
                    <div class="bar-label" style="min-width: 60px;">Chicken</div>
                    <div class="bar-track">
                        <div class="bar-fill high" style="width: 85%;">12</div>
                    </div>
                    <div class="bar-value">15m</div>
                </div>
                <div class="bar-item">
                    <div class="bar-label" style="min-width: 60px;">Laksa</div>
                    <div class="bar-track">
                        <div class="bar-fill medium" style="width: 70%;">8</div>
                    </div>
                    <div class="bar-value">10m</div>
                </div>
                <div class="bar-item">
                    <div class="bar-label" style="min-width: 60px;">Satay</div>
                    <div class="bar-track">
                        <div class="bar-fill medium" style="width: 55%;">6</div>
                    </div>
                    <div class="bar-value">8m</div>
                </div>
                <div class="bar-item">
                    <div class="bar-label" style="min-width: 60px;">Roast</div>
                    <div class="bar-track">
                        <div class="bar-fill low" style="width: 40%;">3</div>
                    </div>
                    <div class="bar-value">5m</div>
                </div>
            </div>
        </div>

        <!-- Peak Hours -->
        <div class="chart-card">
            <div class="chart-header">
                <h2 class="chart-title" id="mobile-peak-hours-title">üìä Peak Hours</h2>
            </div>
            <div class="peak-hours-grid" id="mobile-peak-hours">
                <!-- Peak hours will be dynamically populated -->
            </div>
        </div>

        <!-- Activity -->
        <div class="chart-card">
            <div class="chart-header">
                <h2 class="chart-title">üîî Activity</h2>
            </div>
            <div class="activity-feed">
                <div class="activity-item">
                    <div class="activity-icon">üìÖ</div>
                    <div class="activity-content">
                        <div class="activity-text">New reservation at Chicken Rice</div>
                        <div class="activity-time">2 mins ago</div>
                    </div>
                </div>
                <div class="activity-item">
                    <div class="activity-icon">‚ö†Ô∏è</div>
                    <div class="activity-content">
                        <div class="activity-text">High crowd alert - 92% capacity</div>
                        <div class="activity-time">8 mins ago</div>
                    </div>
                </div>
                <div class="activity-item">
                    <div class="activity-icon">‚úÖ</div>
                    <div class="activity-content">
                        <div class="activity-text">Table released at Satay Street</div>
                        <div class="activity-time">15 mins ago</div>
                    </div>
                </div>
  </div>
  </div>
  </div>
  <script type="module" src="/scripts/firebaseauth.js"></script>
  <script src="/pages/chope/seatDatabase.js"></script>
  <script>
        // Track current time filter
        let currentTimeFilter = 'Today';

        // Track activity log for live updates with timestamps
        let activityLog = [];
        
        // Helper function to get relative time string
        function getRelativeTime(minutesAgo) {
            if (minutesAgo === 0) return "Just now";
            if (minutesAgo === 1) return "1 minute ago";
            if (minutesAgo < 60) return `${minutesAgo} minutes ago`;
            const hoursAgo = Math.floor(minutesAgo / 60);
            if (hoursAgo === 1) return "1 hour ago";
            return `${hoursAgo} hours ago`;
        }
        
        // Helper function to update activity timestamps
        function updateActivityTimestamps() {
            const now = Date.now();
            activityLog.forEach(activity => {
                if (activity.timestamp) {
                    const minutesAgo = Math.floor((now - activity.timestamp) / (1000 * 60));
                    activity.time = getRelativeTime(minutesAgo);
                }
            });
        }

        // Comprehensive stall data with realistic personalized metrics
        const stallData = {
            maxwell: {
                name: "Maxwell Food Centre",
                address: "1 Kadayanallur St, Singapore 069184",
                currentOccupancy: 78,
                avgWaitTime: 15,
                activeReservations: 34,
                peakTimeToday: "12:30 PM",
                peakExpectedOccupancy: 92,
                occupancyChange: "+12%",
                occupancyChangeText: "from 1hr ago",
                reservationChange: "+8",
                reservationChangeText: "new bookings",
                waitTimeChange: "+3",
                waitTimeChangeText: "mins",
                crowdLevels1H: [65, 72, 78],
                crowdLevels: [35, 58, 92, 65, 42, 88, 72, 45],
                crowdLevelsWeek: [68, 72, 75, 70, 73, 78, 71],
                peakHours: { breakfast: 45, lunch: 92, teaTime: 38, dinner: 88 },
                stalls: [
                    { slug: "peanuts-soup", name: "Peanuts Soup", queue: 3, waitTime: 4, occupancy: 40, rating: 4.3, cuisine: "Chinese", peakHours: { breakfast: 65, lunch: 45, teaTime: 35, dinner: 30 } },
                    { slug: "hajmeer-kwaja", name: "Hajmeer Kwaja", queue: 0, waitTime: 0, occupancy: 0, rating: 4.8, cuisine: "Malay", closed: true, peakHours: { breakfast: 85, lunch: 70, teaTime: 20, dinner: 15 } },
                    { slug: "luckmeow", name: "LuckMeow", queue: 8, waitTime: 15, occupancy: 65, rating: 4.1, cuisine: "Indian", peakHours: { breakfast: 40, lunch: 75, teaTime: 60, dinner: 55 } },
                    { slug: "ramen-taisho", name: "Ramen Taisho", queue: 5, waitTime: 8, occupancy: 55, rating: 4.2, cuisine: "Japanese", peakHours: { breakfast: 20, lunch: 70, teaTime: 50, dinner: 85 } },
                    { slug: "china-street-fritters", name: "China Street Fritters", queue: 2, waitTime: 2, occupancy: 35, rating: 4.5, cuisine: "Chinese", peakHours: { breakfast: 55, lunch: 40, teaTime: 30, dinner: 25 } },
                    { slug: "bold-x-braised", name: "Bold X Braised", queue: 0, waitTime: 0, occupancy: 0, rating: 4.0, cuisine: "Taiwanese", closed: true, peakHours: { breakfast: 25, lunch: 80, teaTime: 65, dinner: 75 } },
                    { slug: "korean-cuisine", name: "Korean Cuisine", queue: 6, waitTime: 10, occupancy: 60, rating: 4.0, cuisine: "Korean", peakHours: { breakfast: 30, lunch: 75, teaTime: 55, dinner: 80 } },
                    { slug: "neapolitan-style-pizza", name: "Neapolitan Style Pizza", queue: 4, waitTime: 10, occupancy: 50, rating: 4.0, cuisine: "Western", peakHours: { breakfast: 15, lunch: 60, teaTime: 45, dinner: 90 } },
                    { slug: "tian-tian-chicken-rice", name: "Tian Tian Chicken Rice", queue: 18, waitTime: 12, occupancy: 95, rating: 4.7, cuisine: "Chinese", peakHours: { breakfast: 70, lunch: 95, teaTime: 85, dinner: 75 } }
                ]
            },
            newton: {
                name: "Newton Food Centre",
                address: "500 Clemenceau Ave N, Singapore 229495",
                currentOccupancy: 72,
                avgWaitTime: 18,
                activeReservations: 28,
                peakTimeToday: "7:00 PM",
                peakExpectedOccupancy: 89,
                occupancyChange: "+10%",
                occupancyChangeText: "from 1hr ago",
                reservationChange: "+5",
                reservationChangeText: "new bookings",
                waitTimeChange: "+4",
                waitTimeChangeText: "mins",
                crowdLevels1H: [58, 68, 72],
                crowdLevels: [30, 45, 68, 85, 55, 89, 82, 40],
                crowdLevelsWeek: [65, 70, 72, 68, 71, 75, 69],
                peakHours: { breakfast: 30, lunch: 68, teaTime: 55, dinner: 89 },
                stalls: [
                    { slug: "hotplate-bbq-seafood", name: "Hotplate BBQ Seafood", queue: 12, waitTime: 20, occupancy: 85, rating: 4.6, cuisine: "Seafood", peakHours: { breakfast: 20, lunch: 60, teaTime: 40, dinner: 95 } },
                    { slug: "22-best-satay", name: "22 Best Satay", queue: 15, waitTime: 18, occupancy: 90, rating: 4.4, cuisine: "Malay", peakHours: { breakfast: 25, lunch: 55, teaTime: 45, dinner: 92 } },
                    { slug: "heng-heng-chicken-rice", name: "Heng Heng Chicken Rice", queue: 7, waitTime: 10, occupancy: 60, rating: 4.2, cuisine: "Western", peakHours: { breakfast: 50, lunch: 75, teaTime: 55, dinner: 70 } },
                    { slug: "teochew-rice-and-porridge", name: "Teochew Rice And Porridge", queue: 4, waitTime: 5, occupancy: 45, rating: 4.3, cuisine: "Chinese", peakHours: { breakfast: 70, lunch: 50, teaTime: 35, dinner: 40 } },
                    { slug: "lina-fishball-noodles", name: "Lina Fishball Noodles", queue: 0, waitTime: 0, occupancy: 0, rating: 4.0, cuisine: "Chinese", closed: true, peakHours: { breakfast: 60, lunch: 70, teaTime: 40, dinner: 45 } },
                    { slug: "aminahs-prata", name: "Aminah's Prata", queue: 0, waitTime: 0, occupancy: 0, rating: 4.0, cuisine: "Indian", closed: true, peakHours: { breakfast: 85, lunch: 65, teaTime: 50, dinner: 55 } }
                ]
            },
            changi: {
                name: "Changi Village Food Centre",
                address: "2 Changi Village Rd, Singapore 500002",
                currentOccupancy: 65,
                avgWaitTime: 12,
                activeReservations: 22,
                peakTimeToday: "12:00 PM",
                peakExpectedOccupancy: 85,
                occupancyChange: "+7%",
                occupancyChangeText: "from 1hr ago",
                reservationChange: "+4",
                reservationChangeText: "new bookings",
                waitTimeChange: "+2",
                waitTimeChangeText: "mins",
                crowdLevels1H: [55, 60, 65],
                crowdLevels: [25, 42, 85, 70, 48, 75, 60, 35],
                crowdLevelsWeek: [58, 63, 65, 62, 64, 67, 61],
                peakHours: { breakfast: 42, lunch: 85, teaTime: 48, dinner: 75 },
                stalls: [
                    { slug: "d-authentic-nasi-lemak", name: "D Authentic Nasi Lemak", queue: 10, waitTime: 8, occupancy: 80, rating: 4.7, cuisine: "Malay", peakHours: { breakfast: 85, lunch: 92, teaTime: 70, dinner: 65 } },
                    { slug: "alliance-seafood", name: "Alliance Seafood", queue: 8, waitTime: 25, occupancy: 70, rating: 4.5, cuisine: "Seafood", peakHours: { breakfast: 15, lunch: 50, teaTime: 35, dinner: 88 } },
                    { slug: "burgs", name: "Burgs", queue: 5, waitTime: 12, occupancy: 55, rating: 4.4, cuisine: "Western", peakHours: { breakfast: 30, lunch: 70, teaTime: 55, dinner: 82 } },
                    { slug: "koka-wanton-noodles", name: "Koka Wanton Noodles", queue: 3, waitTime: 5, occupancy: 40, rating: 4.1, cuisine: "Chinese", peakHours: { breakfast: 65, lunch: 55, teaTime: 35, dinner: 45 } },
                    { slug: "jiak-mee", name: "Jiak Mee", queue: 3, waitTime: 5, occupancy: 40, rating: 4.1, cuisine: "Chinese", peakHours: { breakfast: 60, lunch: 50, teaTime: 30, dinner: 40 } },
                    { slug: "fortune-popiah", name: "Fortune Popiah", queue: 1, waitTime: 2, occupancy: 25, rating: 4.0, cuisine: "Chinese", peakHours: { breakfast: 45, lunch: 40, teaTime: 25, dinner: 30 } },
                    { slug: "alifs-nasi-lemak", name: "Alif's Nasi Lemak", queue: 6, waitTime: 3, occupancy: 50, rating: 4.0, cuisine: "Malay", peakHours: { breakfast: 80, lunch: 75, teaTime: 55, dinner: 60 } },
                    { slug: "mala-hotpot", name: "Mala Hotpot", queue: 0, waitTime: 0, occupancy: 0, rating: 4.0, cuisine: "Chinese", closed: true, peakHours: { breakfast: 20, lunch: 60, teaTime: 50, dinner: 85 } }
                ]
            }
        };

        // Wait for Firebase to be available
        async function waitForDb(timeout = 10000) {
            const startTime = Date.now();
            while (typeof window.db === 'undefined') {
                if (Date.now() - startTime > timeout) {
                    console.warn('Timeout waiting for window.db');
                    return false;
                }
                await new Promise(r => setTimeout(r, 50));
            }
            return true;
        }

        // Parse wait time string to numeric minutes (e.g., "15-20 minutes" -> 18, "30 minutes" -> 30)
        function parseWaitTimeToMinutes(waitTimeStr) {
            if (!waitTimeStr || waitTimeStr === 'N/A' || waitTimeStr === '') {
                return null;
            }
            
            // Try to match "15-20 minutes" or "15-20 mins" format
            const rangeMatch = waitTimeStr.match(/(\d+)\s*-\s*(\d+)\s*(?:minutes?|mins?)/i);
            if (rangeMatch) {
                const min = parseInt(rangeMatch[1]);
                const max = parseInt(rangeMatch[2]);
                return Math.round((min + max) / 2); // Return average
            }
            
            // Try to match single number format "30 minutes" or "30 mins"
            const singleMatch = waitTimeStr.match(/(\d+)\s*(?:minutes?|mins?)/i);
            if (singleMatch) {
                return parseInt(singleMatch[1]);
            }
            
            // Try to match just a number
            const numberMatch = waitTimeStr.match(/(\d+)/);
            if (numberMatch) {
                return parseInt(numberMatch[1]);
            }
            
            return null;
        }

        // Calculate queue length based on wait time
        // Formula: queue ‚âà waitTime / 2 (assuming ~2 minutes per person in queue)
        function calculateQueueFromWaitTime(waitTime) {
            if (!waitTime || waitTime === 0) {
                return 0;
            }
            // Round to nearest integer, minimum 0
            return Math.max(0, Math.round(waitTime / 2));
        }

        // Fetch wait times from Firebase and update stallData
        async function updateStallWaitTimes() {
            try {
                const dbAvailable = await waitForDb(5000);
                if (!dbAvailable || !window.db || !window.collection || !window.getDocs) {
                    console.warn('Firebase not available, using default wait times');
                    return;
                }

                const stallsRef = window.collection(window.db, 'stalls');
                const snap = await window.getDocs(stallsRef);
                
                console.log(`Loaded ${snap.docs.length} stalls from Firebase for wait time updates`);
                
                // Create a map of slug -> waitTime from Firebase
                const waitTimeMap = {};
                snap.docs.forEach(doc => {
                    const data = doc.data();
                    const slug = data.slug || '';
                    const waitTimeStr = data.waitTime || '';
                    const waitTimeMinutes = parseWaitTimeToMinutes(waitTimeStr);
                    if (waitTimeMinutes !== null) {
                        waitTimeMap[slug] = waitTimeMinutes;
                    }
                });

                // Update wait times in stallData and calculate queues
                Object.keys(stallData).forEach(hawkerKey => {
                    const stalls = stallData[hawkerKey].stalls;
                    stalls.forEach(stall => {
                        if (waitTimeMap[stall.slug] !== undefined) {
                            stall.waitTime = waitTimeMap[stall.slug];
                            // Calculate queue based on wait time
                            stall.queue = calculateQueueFromWaitTime(stall.waitTime);
                            // Update occupancy based on queue (as a percentage, capped at 100)
                            stall.occupancy = Math.min(100, stall.queue * 5);
                        }
                    });
                });

                // Refresh the dashboard if it's already displayed
                const hawkerSelectWrapper = document.getElementById('hawkerCentreSelectWrapper');
                if (hawkerSelectWrapper) {
                    const selectedOption = Array.from(hawkerSelectWrapper.querySelectorAll('.hawker-centre-option')).find(
                        opt => opt.classList.contains('selected')
                    );
                    if (selectedOption) {
                        const hawkerKey = selectedOption.dataset.value;
                        if (hawkerKey) {
                            updateDashboard(hawkerKey);
                        }
                    }
                }

                // Also update mobile dashboard if it's displayed
                const hawkerSelectWrapperMobile = document.getElementById('hawkerCentreSelectWrapperMobile');
                if (hawkerSelectWrapperMobile) {
                    const selectedOptionMobile = Array.from(hawkerSelectWrapperMobile.querySelectorAll('.hawker-centre-option')).find(
                        opt => opt.classList.contains('selected')
                    );
                    if (selectedOptionMobile) {
                        const hawkerKeyMobile = selectedOptionMobile.dataset.value;
                        if (hawkerKeyMobile) {
                            updateMobileDashboard(hawkerKeyMobile);
                        }
                    }
                }

                console.log('Stall wait times updated from Firebase');
            } catch (error) {
                console.warn('Error updating stall wait times from Firebase:', error);
            }
        }

        // Load raw reservations from localStorage
        function loadRawReservations() {
            try {
                return JSON.parse(localStorage.getItem('reservations') || '[]');
            } catch (e) {
                console.warn('Could not load reservations', e);
                return [];
            }
        }

        // Load reservations from localStorage (formatted for activity feed)
        function loadReservations() {
            try {
                const reservations = loadRawReservations();
                return reservations.map(reservation => {
                    const minutesAgo = Math.floor((Date.now() - reservation.timestamp) / (1000 * 60));
                    return {
                        icon: "üìÖ",
                        text: `Reservation for ${reservation.pax} ${reservation.pax === 1 ? 'person' : 'people'} at ${reservation.hawkerCentre} at ${reservation.time}`,
                        time: getRelativeTime(minutesAgo),
                        timestamp: reservation.timestamp,
                        type: 'reservation',
                        link: '/pages/chope/chope.html',
                        hawkerCentre: reservation.hawkerCentre
                    };
                });
            } catch (e) {
                console.warn('Could not load reservations', e);
                return [];
            }
        }

        // Check if a reservation is still active (not expired)
        function isReservationActive(reservation) {
            if (!reservation.time || !reservation.timestamp) {
                return false;
            }
            
            const now = new Date();
            const reservationCreatedDate = new Date(reservation.timestamp);
            
            // Parse time string (e.g., "12:00 PM", "1:30 PM", "11:45 AM")
            const timeMatch = reservation.time.match(/(\d{1,2}):(\d{2})\s*(AM|PM)/i);
            if (!timeMatch) {
                // If we can't parse, assume expired after duration from timestamp
                const duration = reservation.duration ? parseInt(reservation.duration) : 60;
                const expirationTime = new Date(reservationCreatedDate.getTime() + duration * 60 * 1000);
                return now.getTime() < expirationTime.getTime();
            }
            
            const hours = parseInt(timeMatch[1]);
            const minutes = parseInt(timeMatch[2]);
            const ampm = timeMatch[3].toUpperCase();
            
            // Convert to 24-hour format
            let reservationHours = hours;
            if (ampm === 'PM' && hours !== 12) {
                reservationHours += 12;
            } else if (ampm === 'AM' && hours === 12) {
                reservationHours = 0;
            }
            
            // Create reservation start time using the date from timestamp and time from reservation.time
            const reservationStartTime = new Date(reservationCreatedDate);
            reservationStartTime.setHours(reservationHours, minutes, 0, 0);
            
            // If the reservation time is in the past relative to creation time, assume it's for today
            // (e.g., if created at 2 PM but reservation time is 12:00 PM, it might be for tomorrow)
            // For simplicity, if reservation time is before creation time on same day, add 1 day
            if (reservationStartTime.getTime() < reservationCreatedDate.getTime()) {
                // Check if reservation time is significantly earlier (more than 2 hours before creation)
                const timeDiff = reservationCreatedDate.getTime() - reservationStartTime.getTime();
                if (timeDiff > 2 * 60 * 60 * 1000) {
                    // Assume it's for the next day
                    reservationStartTime.setDate(reservationStartTime.getDate() + 1);
                }
            }
            
            // Default duration is 60 minutes (1 hour)
            const duration = reservation.duration ? parseInt(reservation.duration) : 60;
            const reservationEndTime = new Date(reservationStartTime.getTime() + duration * 60 * 1000);
            
            // Check if current time is before reservation end time
            return now.getTime() < reservationEndTime.getTime();
        }

        // Map hawker centre name to seatDatabase key
        function getSeatDatabaseKey(hawkerCentreName) {
            const nameLower = hawkerCentreName.toLowerCase();
            if (nameLower.includes('maxwell')) {
                return 'maxwell';
            } else if (nameLower.includes('newton')) {
                return 'newton';
            } else if (nameLower.includes('changi')) {
                return 'changiVillage';
            }
            return null;
        }

        // Count active reservations from seatDatabase (matching chope page logic)
        async function countActiveReservationsFromSeatDatabase(hawkerCentreName) {
            try {
                // Get the seatDatabase key for this hawker centre
                const foodCenterKey = getSeatDatabaseKey(hawkerCentreName);
                if (!foodCenterKey) {
                    return 0;
                }

                // Wait for seatDatabase to be initialized
                if (window.seatDatabase && window.seatDatabase.initPromise) {
                    await window.seatDatabase.initPromise;
                }

                // Use the same method as chope pages to get seat counts
                if (window.seatDatabase && typeof window.seatDatabase.getSeatCounts === 'function') {
                    // Refresh data from Firebase to ensure we have latest data
                    if (window.seatDatabase.refresh) {
                        await window.seatDatabase.refresh();
                    }
                    
                    // Clean up expired bookings before counting
                    if (window.seatDatabase.cleanupExpiredBookings) {
                        await window.seatDatabase.cleanupExpiredBookings();
                    }
                    
                    // Get seat counts using the same method as chope page
                    const seatCounts = await window.seatDatabase.getSeatCounts(foodCenterKey);
                    return seatCounts.booked || 0;
                }

                // Fallback: Load seatDatabase from localStorage (for compatibility)
                const seatDatabaseData = localStorage.getItem('seatDatabase');
                if (!seatDatabaseData) {
                    return 0;
                }

                const bookings = JSON.parse(seatDatabaseData);
                const foodCenterBookings = bookings[foodCenterKey];
                
                if (!foodCenterBookings) {
                    return 0;
                }

                // Count all seats with status 'booked'
                let activeCount = 0;
                const now = new Date();
                
                for (const table in foodCenterBookings) {
                    for (const seat in foodCenterBookings[table]) {
                        const booking = foodCenterBookings[table][seat];
                        if (booking.status === 'booked') {
                            // Double-check expiration in case cleanup hasn't run yet
                            if (booking.expiresAt) {
                                const expiresAt = new Date(booking.expiresAt);
                                if (now <= expiresAt) {
                                    activeCount++;
                                }
                            } else {
                                // If no expiration, count it as active
                                activeCount++;
                            }
                        }
                    }
                }
                
                return activeCount;
            } catch (e) {
                console.warn('Error counting active reservations from seatDatabase:', e);
                return 0;
            }
        }

        // Count active reservations for a specific hawker centre
        // Uses seatDatabase to match the chope page logic
        async function countActiveReservations(hawkerCentreName) {
            // Use seatDatabase for accurate count that matches chope pages
            return await countActiveReservationsFromSeatDatabase(hawkerCentreName);
        }

        // Get total seats for a hawker centre
        function getTotalSeatsForHawkerCentre(hawkerCentreName) {
            const foodCenterKey = getSeatDatabaseKey(hawkerCentreName);
            if (!foodCenterKey) {
                return 0;
            }

            // Total seats configuration matching chope pages
            const totalSeatsMap = {
                'maxwell': 72,      // 6 tables √ó 12 seats each
                'newton': 50,       // 5 tables √ó 10 seats each
                'changiVillage': 60 // 6 tables √ó 10 seats each
            };

            return totalSeatsMap[foodCenterKey] || 0;
        }

        // Calculate occupancy 1 hour ago from seatDatabase
        async function calculateOccupancyOneHourAgo(hawkerCentreName) {
            try {
                const foodCenterKey = getSeatDatabaseKey(hawkerCentreName);
                if (!foodCenterKey) {
                    return 0;
                }

                // Try to use seatDatabase if available
                let bookings = {};
                if (window.seatDatabase && window.seatDatabase.initPromise) {
                    await window.seatDatabase.initPromise;
                    if (window.seatDatabase.refresh) {
                        await window.seatDatabase.refresh();
                    }
                    bookings = window.seatDatabase.bookings || {};
                } else {
                    // Fallback to localStorage
                    const seatDatabaseData = localStorage.getItem('seatDatabase');
                    if (seatDatabaseData) {
                        bookings = JSON.parse(seatDatabaseData);
                    }
                }

                const foodCenterBookings = bookings[foodCenterKey];
                
                if (!foodCenterBookings) {
                    return 0;
                }

                const now = new Date();
                const oneHourAgo = new Date(now.getTime() - (60 * 60 * 1000)); // 1 hour ago
                
                let bookedSeatsOneHourAgo = 0;
                
                for (const table in foodCenterBookings) {
                    for (const seat in foodCenterBookings[table]) {
                        const booking = foodCenterBookings[table][seat];
                        if (booking.status === 'booked' && booking.bookedAt && booking.expiresAt) {
                            const bookedAt = new Date(booking.bookedAt);
                            const expiresAt = new Date(booking.expiresAt);
                            
                            // Check if this booking was active 1 hour ago
                            // It was active if: bookedAt <= oneHourAgo AND expiresAt > oneHourAgo
                            if (bookedAt <= oneHourAgo && expiresAt > oneHourAgo) {
                                bookedSeatsOneHourAgo++;
                            }
                        }
                    }
                }

                const totalSeats = getTotalSeatsForHawkerCentre(hawkerCentreName);
                if (totalSeats === 0) {
                    return 0;
                }

                const occupancy = Math.round((bookedSeatsOneHourAgo / totalSeats) * 100);
                return occupancy;
            } catch (e) {
                console.warn('Error calculating occupancy 1 hour ago:', e);
                return 0;
            }
        }

        // Calculate current occupancy percentage from seatDatabase
        async function calculateCurrentOccupancy(hawkerCentreName) {
            try {
                const totalSeats = getTotalSeatsForHawkerCentre(hawkerCentreName);
                if (totalSeats === 0) {
                    return 0;
                }

                const bookedSeats = await countActiveReservationsFromSeatDatabase(hawkerCentreName);
                const occupancy = Math.round((bookedSeats / totalSeats) * 100);
                
                return occupancy;
            } catch (e) {
                console.warn('Error calculating current occupancy:', e);
                return 0;
            }
        }

        // Calculate occupancy change from 1 hour ago
        async function calculateOccupancyChange(hawkerCentreName) {
            try {
                const currentOccupancy = await calculateCurrentOccupancy(hawkerCentreName);
                const occupancyOneHourAgo = await calculateOccupancyOneHourAgo(hawkerCentreName);
                const change = currentOccupancy - occupancyOneHourAgo;
                
                return {
                    change: change,
                    changeText: change >= 0 ? '+' + change + '%' : change + '%',
                    isPositive: change >= 0
                };
            } catch (e) {
                console.warn('Error calculating occupancy change:', e);
                return {
                    change: 0,
                    changeText: '+0%',
                    isPositive: true
                };
            }
        }

        // Count new reservations made in the last 1 hour for a specific hawker centre
        function countNewReservationsLastHour(hawkerCentreName) {
            const allReservations = loadRawReservations();
            const now = Date.now();
            const oneHourAgo = now - (60 * 60 * 1000); // 1 hour in milliseconds
            
            return allReservations.filter(reservation => {
                // Match hawker centre (case-insensitive)
                if (!reservation.hawkerCentre || 
                    reservation.hawkerCentre.toLowerCase() !== hawkerCentreName.toLowerCase()) {
                    return false;
                }
                
                // Check if reservation was created in the last 1 hour
                if (!reservation.timestamp) {
                    return false;
                }
                
                return reservation.timestamp >= oneHourAgo && reservation.timestamp <= now;
            }).length;
        }

        // Activity feed data with realistic timestamps
        function getActivityFeed(hawkerKey, stallSlug = null) {
            // If no hawker centre is selected, return empty array
            if (!hawkerKey || !hawkerKey.trim()) {
                return [];
            }
            
            // Get the hawker centre name from stallData
            const hawker = stallData[hawkerKey];
            if (!hawker) {
                return [];
            }
            
            // Load reservations from localStorage - only show reservations
            const allReservations = loadReservations();
            
            // Filter reservations by the selected hawker centre and only show active ones
            const filteredReservations = allReservations.filter(reservation => {
                // Match by hawker centre name (case-insensitive)
                if (!reservation.hawkerCentre || 
                    reservation.hawkerCentre.toLowerCase() !== hawker.name.toLowerCase()) {
                    return false;
                }
                
                // Only show active reservations (not expired)
                return isReservationActive(reservation);
            });
            
            // Sort by timestamp (most recent first)
            filteredReservations.sort((a, b) => b.timestamp - a.timestamp);
            
            return filteredReservations.slice(0, 10); // Return top 10 active reservations for this hawker centre
        }
        
        // Helper function to add new activity to the log (deprecated - only reservations are shown now)
        function addActivity(icon, text) {
            // No longer adding non-reservation activities to the feed
            // Only reservations are displayed in the recent activity section
        }

        // Function to enable/disable stall dropdowns based on hawker centre selection
        function toggleStallDropdowns(enabled) {
            // Desktop stall dropdown
            const stallInput = document.getElementById('stall-select');
            const stallWrapper = document.getElementById('stallSelectWrapper');
            if (stallInput && stallWrapper) {
                stallInput.disabled = !enabled;
                if (!enabled) {
                    stallWrapper.classList.remove('open');
                    stallInput.value = '';
                    stallInput.placeholder = 'Please select a food stall';
                }
            }
            
            // Mobile stall dropdown
            const stallInputMobile = document.getElementById('stall-select-mobile');
            const stallWrapperMobile = document.getElementById('stallSelectWrapperMobile');
            if (stallInputMobile && stallWrapperMobile) {
                stallInputMobile.disabled = !enabled;
                if (!enabled) {
                    stallWrapperMobile.classList.remove('open');
                    stallInputMobile.value = '';
                    stallInputMobile.placeholder = 'Please select a food stall';
                }
            }
        }

        // Function to update stall dropdown based on selected hawker centre
        function updateStallOptions(hawkerValue, stallElement) {
            // Check if it's a custom dropdown (stall-dropdown) or native select
            const isCustomDropdown = stallElement && stallElement.classList && stallElement.classList.contains('stall-dropdown');
            
            if (isCustomDropdown) {
                // Clear existing options (but keep search bar structure)
                const existingOptions = stallElement.querySelectorAll('.stall-option');
                existingOptions.forEach(opt => opt.remove());
                
                // Add "All Stalls" option first
                const allOption = document.createElement('div');
                allOption.className = 'stall-option';
                allOption.setAttribute('data-value', '');
                allOption.setAttribute('data-label', '');
                allOption.textContent = 'All Stalls';
                stallElement.appendChild(allOption);
                
                // Add stall options
                if (hawkerValue && stallData[hawkerValue]) {
                    const stalls = stallData[hawkerValue].stalls;
                    stalls.forEach(stall => {
                        const option = document.createElement('div');
                        option.className = 'stall-option';
                        option.setAttribute('data-value', stall.slug);
                        option.setAttribute('data-label', stall.name);
                        option.textContent = stall.name;
                        stallElement.appendChild(option);
                    });
                }
                
                // Select "All Stalls" by default
                const allStallsOption = stallElement.querySelector('.stall-option[data-value=""]');
                if (allStallsOption) {
                    allStallsOption.classList.add('selected');
                }
            } else {
                // Legacy native select (fallback)
                stallElement.innerHTML = '<option value="" disabled selected>Please select a food stall</option>';
            
            if (hawkerValue && stallData[hawkerValue]) {
                const stalls = stallData[hawkerValue].stalls;
                stalls.forEach(stall => {
                    const option = document.createElement('option');
                    option.value = stall.slug;
                    option.textContent = stall.name;
                        stallElement.appendChild(option);
                });
                }
            }
        }

        // Initialize stall options on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize queues from wait times for all stalls (overwrite existing queue values)
            Object.keys(stallData).forEach(hawkerKey => {
                const stalls = stallData[hawkerKey].stalls;
                stalls.forEach(stall => {
                    // Always calculate queue from wait time
                    if (stall.waitTime !== undefined) {
                        stall.queue = calculateQueueFromWaitTime(stall.waitTime);
                        // Update occupancy based on queue (as a percentage, capped at 100)
                        stall.occupancy = Math.min(100, stall.queue * 5);
                    }
                });
            });
            
            // Load wait times from Firebase (this will update queues again)
            updateStallWaitTimes();
            
            const stallDropdown = document.getElementById('stallDropdown');
            const stallDropdownMobile = document.getElementById('stallDropdownMobile');

            // Initialize desktop dropdowns - custom dropdown will handle initialization
            if (stallDropdown) {
                // Wait a bit for custom dropdown to initialize
                setTimeout(() => {
                    const wrapper = document.getElementById('hawkerCentreSelectWrapper');
                    const options = wrapper ? wrapper.querySelectorAll('.hawker-centre-option') : [];
                    const selectedOption = Array.from(options).find(opt => opt.classList.contains('selected'));
                    const hawkerKey = selectedOption ? selectedOption.dataset.value : 'maxwell';
                    updateStallOptions(hawkerKey, stallDropdown);
                }, 100);
            }

            // Initialize mobile dropdowns - custom dropdown will handle initialization
            if (stallDropdownMobile) {
                // Wait a bit for custom dropdown to initialize
                setTimeout(() => {
                    const wrapperMobile = document.getElementById('hawkerCentreSelectWrapperMobile');
                    const optionsMobile = wrapperMobile ? wrapperMobile.querySelectorAll('.hawker-centre-option') : [];
                    const selectedOptionMobile = Array.from(optionsMobile).find(opt => opt.classList.contains('selected'));
                    const hawkerKeyMobile = selectedOptionMobile ? selectedOptionMobile.dataset.value : 'maxwell';
                    updateStallOptions(hawkerKeyMobile, stallDropdownMobile);
                }, 100);
            }
        });

        // Function to clear dashboard (show nothing)
        function clearDashboard() {
            // Clear stats cards
            const statValues = document.querySelectorAll('.stat-value');
            statValues.forEach(stat => stat.textContent = '--');
            
            // Hide stat-change divs
            const statChanges = document.querySelectorAll('.stat-change');
            statChanges.forEach(change => {
                change.style.display = 'none';
            });
            
            // Clear crowd chart
            const chartContainer = document.getElementById('hawker-chart');
            if (chartContainer) {
                chartContainer.innerHTML = '';
            }
            
            // Clear leaderboard
            const leaderboard = document.querySelector('.leaderboard');
            if (leaderboard) {
                leaderboard.innerHTML = '';
            }
            
            // Clear stall crowd levels
            clearStallCrowdLevels();
            
            // Clear peak hours
            const peakGrid = document.getElementById('desktop-peak-hours') || document.querySelector('.desktop-view .peak-hours-grid');
            if (peakGrid) {
                peakGrid.innerHTML = '';
            }
            
            // Clear activity feed
            const feed = document.querySelector('.activity-feed');
            if (feed) {
                feed.innerHTML = '';
            }
        }

        // Generate 1H crowd levels based on current time and Today data
        function generate1HCrowdLevels(hawker) {
            const now = new Date();
            const currentHour = now.getHours();
            const currentMinute = now.getMinutes();
            
            // Today time slots: ['8:00 AM', '10:00 AM', '12:00 PM', '2:00 PM', '4:00 PM', '6:00 PM', '8:00 PM', '10:00 PM']
            // Convert to 24-hour format: [8, 10, 12, 14, 16, 18, 20, 22]
            const todayTimeSlots = [8, 10, 12, 14, 16, 18, 20, 22];
            const todayData = hawker.crowdLevels || [35, 58, 92, 65, 42, 88, 72, 45];
            
            // Find the current time slot index
            let currentSlotIndex = -1;
            for (let i = 0; i < todayTimeSlots.length; i++) {
                if (currentHour < todayTimeSlots[i]) {
                    currentSlotIndex = i - 1;
                    break;
                }
            }
            // If current time is after the last slot, use the last slot
            if (currentSlotIndex === -1) {
                currentSlotIndex = todayTimeSlots.length - 1;
            }
            // If current time is before the first slot, use the first slot
            if (currentSlotIndex < 0) {
                currentSlotIndex = 0;
            }
            
            // Get the value for "Now" - interpolate between current and next slot if needed
            let nowValue;
            if (currentSlotIndex === todayTimeSlots.length - 1) {
                // After last slot, use last value
                nowValue = todayData[currentSlotIndex];
            } else {
                const currentSlotHour = todayTimeSlots[currentSlotIndex];
                const nextSlotHour = todayTimeSlots[currentSlotIndex + 1];
                const currentSlotValue = todayData[currentSlotIndex];
                const nextSlotValue = todayData[currentSlotIndex + 1];
                
                // Calculate minutes into the current slot
                const minutesIntoSlot = (currentHour - currentSlotHour) * 60 + currentMinute;
                const slotDuration = (nextSlotHour - currentSlotHour) * 60;
                
                // Interpolate between current and next slot values
                const interpolationFactor = Math.min(1, minutesIntoSlot / slotDuration);
                nowValue = Math.round(currentSlotValue + (nextSlotValue - currentSlotValue) * interpolationFactor);
            }
            
            // Calculate 20 minutes ago and 40 minutes ago
            const minutes20Ago = new Date(now.getTime() - 20 * 60 * 1000);
            const minutes40Ago = new Date(now.getTime() - 40 * 60 * 1000);
            
            // Helper function to get value at a specific time
            function getValueAtTime(targetTime) {
                const targetHour = targetTime.getHours();
                const targetMinute = targetTime.getMinutes();
                
                let slotIndex = -1;
                for (let i = 0; i < todayTimeSlots.length; i++) {
                    if (targetHour < todayTimeSlots[i]) {
                        slotIndex = i - 1;
                        break;
                    }
                }
                if (slotIndex === -1) {
                    slotIndex = todayTimeSlots.length - 1;
                }
                if (slotIndex < 0) {
                    slotIndex = 0;
                }
                
                if (slotIndex === todayTimeSlots.length - 1) {
                    return todayData[slotIndex];
                }
                
                const currentSlotHour = todayTimeSlots[slotIndex];
                const nextSlotHour = todayTimeSlots[slotIndex + 1];
                const currentSlotValue = todayData[slotIndex];
                const nextSlotValue = todayData[slotIndex + 1];
                
                const minutesIntoSlot = (targetHour - currentSlotHour) * 60 + targetMinute;
                const slotDuration = (nextSlotHour - currentSlotHour) * 60;
                
                const interpolationFactor = Math.min(1, Math.max(0, minutesIntoSlot / slotDuration));
                return Math.round(currentSlotValue + (nextSlotValue - currentSlotValue) * interpolationFactor);
            }
            
            const value20mAgo = getValueAtTime(minutes20Ago);
            const value40mAgo = getValueAtTime(minutes40Ago);
            
            return [value40mAgo, value20mAgo, nowValue];
        }

        // Function to update dashboard with hawker centre data
        async function updateDashboard(hawkerKey, stallSlug = null) {
            // If no hawker key is provided or invalid, clear dashboard
            if (!hawkerKey || !hawkerKey.trim()) {
                clearDashboard();
                return;
            }
            
            const hawker = stallData[hawkerKey];
            if (!hawker) {
                clearDashboard();
                return;
            }

            // Count active reservations for this hawker centre
            const activeReservationsCount = await countActiveReservations(hawker.name);
            
            // Count new reservations in the last 1 hour
            const newReservationsCount = countNewReservationsLastHour(hawker.name);
            
            // Calculate current occupancy from seatDatabase (matching chope page)
            const currentOccupancy = await calculateCurrentOccupancy(hawker.name);
            
            // Calculate occupancy change from 1 hour ago
            const occupancyChange = await calculateOccupancyChange(hawker.name);

            // Update stats cards
            const statValues = document.querySelectorAll('.stat-value');
            const statChanges = document.querySelectorAll('.stat-change');
            if (statValues.length >= 4 && statChanges.length >= 4) {
                statValues[0].textContent = currentOccupancy + '%';
                statValues[1].textContent = activeReservationsCount;
                statValues[2].textContent = hawker.avgWaitTime + 'm';
                statValues[3].textContent = hawker.peakTimeToday;
                
                // Update stat-change divs with hawker-specific values
                // Use calculated occupancy change from 1 hour ago
                statChanges[0].textContent = occupancyChange.changeText + ' ' + hawker.occupancyChangeText;
                statChanges[0].className = 'stat-change ' + (occupancyChange.isPositive ? 'positive' : 'negative');
                statChanges[0].style.display = 'flex';
                
                // Update reservation change with actual count from last 1 hour
                statChanges[1].textContent = '+' + newReservationsCount + ' ' + hawker.reservationChangeText;
                statChanges[1].className = 'stat-change positive';
                statChanges[1].style.display = 'flex';
                
                statChanges[2].textContent = hawker.waitTimeChange + ' ' + hawker.waitTimeChangeText;
                statChanges[2].className = 'stat-change negative';
                statChanges[2].style.display = 'flex';
                
                statChanges[3].textContent = 'Expected at ' + hawker.peakExpectedOccupancy + '%';
                statChanges[3].className = 'stat-change';
                statChanges[3].style.display = 'flex';
            }

            // Update crowd level chart based on current time filter
            let crowdData;
            if (currentTimeFilter === '1H') {
                // Generate 1H data based on current time and Today data
                crowdData = generate1HCrowdLevels(hawker);
            } else if (currentTimeFilter === 'Week') {
                crowdData = hawker.crowdLevelsWeek;
            } else {
                crowdData = hawker.crowdLevels;
            }
            updateCrowdChart(crowdData, currentTimeFilter);

            // Update top stalls leaderboard
            updateLeaderboard(hawker.stalls);

            // Update peak hours (stall-specific if stall is selected)
            const stallSelectWrapper = document.getElementById('stallSelectWrapper');
            let selectedStallSlug = stallSlug;
            if (!selectedStallSlug && stallSelectWrapper) {
                const stallDropdown = document.getElementById('stallDropdown');
                const selectedStallOption = stallDropdown ? Array.from(stallDropdown.querySelectorAll('.stall-option')).find(opt => opt.classList.contains('selected')) : null;
                selectedStallSlug = selectedStallOption ? selectedStallOption.dataset.value : null;
            }
            
            // Update stall-specific crowd levels
            // If "All Stalls" is selected (empty value), show all stalls
            // If a specific stall is selected, show only that stall
            if (selectedStallSlug && selectedStallSlug !== '') {
                // Specific stall selected - show only that stall
                const selectedStall = hawker.stalls.find(s => s.slug === selectedStallSlug);
                if (selectedStall) {
                    updateStallCrowdLevels([selectedStall]);
                    if (selectedStall.peakHours) {
                    updatePeakHours(selectedStall.peakHours, selectedStall.name);
                } else {
                    updatePeakHours(hawker.peakHours, hawker.name);
                }
            } else {
                    // Clear stall-specific crowd levels if stall not found
                    clearStallCrowdLevels();
                    updatePeakHours(hawker.peakHours, hawker.name);
                }
            } else {
                // "All Stalls" is selected - show all stalls
                updateStallCrowdLevels(hawker.stalls);
                updatePeakHours(hawker.peakHours, hawker.name);
            }

            // Update activity feed
            updateActivityFeed(hawkerKey, stallSlug);
        }

        function updateCrowdChart(levels, timeFilter = 'Today') {
            const chartContainer = document.getElementById('hawker-chart');
            if (!chartContainer) return;

            let timeSlots;
            let maxItems;
            
            if (timeFilter === '1H') {
                // Generate actual time labels for 1H view
                const now = new Date();
                const minutes40Ago = new Date(now.getTime() - 40 * 60 * 1000);
                const minutes20Ago = new Date(now.getTime() - 20 * 60 * 1000);
                
                function formatTime(date) {
                    const hours = date.getHours();
                    const minutes = date.getMinutes();
                    const ampm = hours >= 12 ? 'PM' : 'AM';
                    const displayHours = hours % 12 || 12;
                    return `${displayHours}:${minutes.toString().padStart(2, '0')} ${ampm}`;
                }
                
                timeSlots = [formatTime(minutes40Ago), formatTime(minutes20Ago), formatTime(now)];
                maxItems = 3;
            } else if (timeFilter === 'Week') {
                timeSlots = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
                maxItems = 7;
            } else {
                // Today
                timeSlots = ['8:00 AM', '10:00 AM', '12:00 PM', '2:00 PM', '4:00 PM', '6:00 PM', '8:00 PM', '10:00 PM'];
                maxItems = 6;
            }
            
            chartContainer.innerHTML = '';
            
            levels.slice(0, maxItems).forEach((level, idx) => {
                const levelClass = level >= 80 ? 'high' : level >= 50 ? 'medium' : 'low';
                const barItem = document.createElement('div');
                barItem.className = 'bar-item';
                barItem.innerHTML = `
                    <div class="bar-label">${timeSlots[idx]}</div>
                    <div class="bar-track">
                        <div class="bar-fill ${levelClass}" style="width: 0;">0%</div>
                    </div>
                    <div class="bar-value">${level >= 80 ? 'High' : level >= 50 ? 'Medium' : 'Low'}</div>
                `;
                chartContainer.appendChild(barItem);
                
                // Animate to the actual width using requestAnimationFrame
                requestAnimationFrame(() => {
                    const barFill = barItem.querySelector('.bar-fill');
                    if (barFill) {
                        barFill.style.width = `${level}%`;
                        barFill.textContent = `${level}%`;
                    }
                });
            });
        }

        function updateLeaderboard(stalls) {
            const leaderboard = document.querySelector('.leaderboard');
            if (!leaderboard) return;

            const topStalls = stalls
                .filter(s => !s.closed)
                .sort((a, b) => b.rating - a.rating)
                .slice(0, 3);

            leaderboard.innerHTML = '';
            topStalls.forEach((stall, idx) => {
                const badges = ['gold', 'silver', 'bronze'];
                const item = document.createElement('div');
                item.className = 'leaderboard-item';
                item.innerHTML = `
                    <div class="rank-badge ${badges[idx]}">${idx + 1}</div>
                    <div class="stall-info">
                        <div class="stall-name">${stall.name}</div>
                        <div class="stall-cuisine">${stall.cuisine}</div>
                    </div>
                    <div class="popularity-score">
                        <div class="score-value">${stall.rating}</div>
                        <div class="score-label">Rating</div>
                    </div>
                `;
                leaderboard.appendChild(item);
            });
        }

        function clearStallCrowdLevels() {
            const stallCrowdContainer = document.querySelector('.second-row .bar-chart');
            if (stallCrowdContainer) {
                stallCrowdContainer.innerHTML = '';
            }
        }

        function updateStallCrowdLevels(stalls) {
            const stallCrowdContainer = document.querySelector('.second-row .bar-chart');
            if (!stallCrowdContainer) return;

            // If no stalls provided, clear the container
            if (!stalls || stalls.length === 0) {
                stallCrowdContainer.innerHTML = '';
                return;
            }

            const openStalls = stalls.filter(s => !s.closed).sort((a, b) => b.queue - a.queue);
            stallCrowdContainer.innerHTML = '';
            
            openStalls.slice(0, 5).forEach(stall => {
                const occupancy = stall.occupancy || 0;
                const levelClass = occupancy >= 80 ? 'high' : occupancy >= 50 ? 'medium' : 'low';
                const barItem = document.createElement('div');
                barItem.className = 'bar-item';
                barItem.innerHTML = `
                    <div class="bar-label">${stall.name.length > 15 ? stall.name.substring(0, 15) + '...' : stall.name}</div>
                    <div class="bar-track">
                        <div class="bar-fill ${levelClass}" style="width: 0;">Queue: 0</div>
                    </div>
                    <div class="bar-value">${stall.waitTime}m</div>
                `;
                stallCrowdContainer.appendChild(barItem);
                
                // Animate to the actual width using requestAnimationFrame
                requestAnimationFrame(() => {
                    const barFill = barItem.querySelector('.bar-fill');
                    if (barFill) {
                        barFill.style.width = `${occupancy}%`;
                        barFill.textContent = `Queue: ${stall.queue}`;
                    }
                });
            });
        }

        function updatePeakHours(peakHours, locationName = null) {
            const peakGrid = document.getElementById('desktop-peak-hours') || document.querySelector('.desktop-view .peak-hours-grid');
            const peakTitle = document.getElementById('peak-hours-title');
            if (!peakGrid) return;

            // Update title to show stall-specific or hawker centre-specific
            if (peakTitle && locationName) {
                // Check if it's a hawker centre name
                const isHawkerCentre = locationName === stallData.maxwell?.name || 
                                       locationName === stallData.newton?.name || 
                                       locationName === stallData.changi?.name;
                
                if (isHawkerCentre) {
                    peakTitle.textContent = `üìä Peak Hours Analysis`;
                } else {
                    // It's a stall name
                    peakTitle.textContent = `üìä ${locationName} Peak Hours`;
                }
            }

            const periods = [
                { label: 'Breakfast', value: peakHours.breakfast },
                { label: 'Lunch', value: peakHours.lunch },
                { label: 'Tea Time', value: peakHours.teaTime },
                { label: 'Dinner', value: peakHours.dinner }
            ];

            peakGrid.innerHTML = '';
            periods.forEach(period => {
                const card = document.createElement('div');
                card.className = 'hour-card';
                card.innerHTML = `
                    <div class="hour-time">${period.label}</div>
                    <div class="hour-bar">
                        <div class="hour-bar-fill" style="height: 0;"></div>
                    </div>
                    <div class="hour-percentage">0%</div>
                `;
                peakGrid.appendChild(card);
                
                // Animate to the actual height using requestAnimationFrame
                requestAnimationFrame(() => {
                    const barFill = card.querySelector('.hour-bar-fill');
                    const percentage = card.querySelector('.hour-percentage');
                    if (barFill) {
                        barFill.style.height = `${period.value}%`;
                    }
                    if (percentage) {
                        percentage.textContent = `${period.value}%`;
                    }
                });
            });
        }

        function updateActivityFeed(hawkerKey, stallSlug) {
            const feed = document.querySelector('.activity-feed');
            if (!feed) return;

            const activities = getActivityFeed(hawkerKey, stallSlug);
            feed.innerHTML = '';
            
            activities.forEach(activity => {
                const item = document.createElement('div');
                item.className = 'activity-item' + (activity.type === 'reservation' ? ' reservation-item' : '');
                
                // Make reservation items clickable
                if (activity.type === 'reservation' && activity.link) {
                    item.style.cursor = 'pointer';
                    item.addEventListener('click', function() {
                        window.location.href = activity.link;
                    });
                }
                
                item.innerHTML = `
                    <div class="activity-icon">${activity.icon}</div>
                    <div class="activity-content">
                        <div class="activity-text">${activity.type === 'reservation' ? '<strong>New reservation:</strong> ' : ''}<strong>${activity.text}</strong></div>
                        <div class="activity-time">${activity.time}</div>
                    </div>
                `;
                feed.appendChild(item);
            });
        }

        // Simulate live data updates
        function updateCrowdData() {
            const wrapper = document.getElementById('hawkerCentreSelectWrapper');
            const options = wrapper ? wrapper.querySelectorAll('.hawker-centre-option') : [];
            const selectedOption = Array.from(options).find(opt => opt.classList.contains('selected'));
            const hawkerKey = selectedOption ? selectedOption.dataset.value : 'maxwell';
            
            if (hawkerKey) {
                const hawker = stallData[hawkerKey];
                if (hawker) {
                    const oldOccupancy = hawker.currentOccupancy;
                    
                    // Simulate small fluctuations
                    const fluctuation = Math.floor(Math.random() * 6) - 3;
                    hawker.currentOccupancy = Math.max(30, Math.min(95, hawker.currentOccupancy + fluctuation));
                    
                    // Update active reservations randomly
                    const reservationChange = Math.floor(Math.random() * 5) - 2;
                    hawker.activeReservations = Math.max(0, hawker.activeReservations + reservationChange);
                    
                    // Update average wait time based on occupancy
                    const waitTimeChange = Math.floor(Math.random() * 4) - 2;
                    hawker.avgWaitTime = Math.max(3, Math.min(30, hawker.avgWaitTime + waitTimeChange));
                    
                    // Update stall wait times and recalculate queues
                    hawker.stalls.filter(s => !s.closed).forEach(stall => {
                        if (Math.random() > 0.6) {
                            const waitTimeChange = Math.floor(Math.random() * 4) - 2;
                            stall.waitTime = Math.max(0, Math.min(30, stall.waitTime + waitTimeChange));
                            // Recalculate queue from updated wait time
                            stall.queue = calculateQueueFromWaitTime(stall.waitTime);
                            // Update occupancy based on queue (as a percentage, capped at 100)
                            stall.occupancy = Math.min(100, stall.queue * 5);
                        }
                    });
                    
                    // Activity feed now only shows reservations, so no need to add other activities
                    updateDashboard(hawkerKey);
                }
            }
        }

        // Auto-refresh disabled
        // setInterval(updateCrowdData, 60000);
        
        // Auto-refresh disabled - activity feed will only update when manually triggered
        // setInterval(() => {
        //     const hawkerSelect = document.getElementById('hawker-select');
        //     if (hawkerSelect) {
        //         updateDashboard(hawkerSelect.value);
        //     }
        //     const hawkerSelectMobile = document.getElementById('hawker-select-mobile');
        //     if (hawkerSelectMobile) {
        //         updateMobileDashboard(hawkerSelectMobile.value);
        //     }
        // }, 30000);

        // Custom searchable dropdown for hawker centre (Desktop)
        function initHawkerDropdown() {
            const input = document.getElementById('hawker-select');
            const wrapper = document.getElementById('hawkerCentreSelectWrapper');
            const dropdown = document.getElementById('hawkerCentreDropdown');
            const dropdownSearch = document.getElementById('hawkerDropdownSearchInput');
            
            if (!input || !wrapper || !dropdown || !dropdownSearch) return;
            
            function getOptions() {
                return dropdown ? dropdown.querySelectorAll('.hawker-centre-option') : [];
            }
            
            function updateSelectedOption(value) {
                const options = getOptions();
                options.forEach(opt => {
                    opt.classList.remove('selected');
                    if (opt.dataset.value === value) {
                        opt.classList.add('selected');
                    }
                });
            }
            
            function filterOptions() {
                const searchTerm = dropdownSearch.value.toLowerCase().trim();
                const options = getOptions();
                options.forEach(option => {
                    const label = option.dataset.label ? option.dataset.label.toLowerCase() : option.textContent.toLowerCase();
                    if (label.includes(searchTerm) || searchTerm === '') {
                        option.classList.remove('hidden');
                        } else {
                        option.classList.add('hidden');
                    }
                });
            }
            
            // Use event delegation instead of attaching listeners to each option
            dropdown.addEventListener('click', (e) => {
                const option = e.target.closest('.hawker-centre-option');
                if (!option) return;
                
                const value = option.dataset.value;
                const label = option.dataset.label || option.textContent;
                
                if (value && value.trim()) {
                    input.value = label;
                    wrapper.classList.remove('open');
                    dropdownSearch.value = '';
                    updateSelectedOption(value);
                    
                    // Enable stall dropdowns when hawker centre is selected
                    toggleStallDropdowns(true);
                    
                    const stallDropdown = document.getElementById('stallDropdown');
                    if (stallDropdown) {
                        updateStallOptions(value, stallDropdown);
                        // Reset stall selection to "All Stalls"
                        const stallInput = document.getElementById('stall-select');
                        if (stallInput) {
                            stallInput.value = '';
                            stallInput.placeholder = 'Please select a food stall';
                        }
                        const stallWrapper = document.getElementById('stallSelectWrapper');
                        if (stallWrapper) {
                            const allStallsOption = stallDropdown.querySelector('.stall-option[data-value=""]');
                            if (allStallsOption) {
                                Array.from(stallDropdown.querySelectorAll('.stall-option')).forEach(opt => opt.classList.remove('selected'));
                                allStallsOption.classList.add('selected');
                            }
                        }
                        updateDashboard(value);
                        } else {
                        updateDashboard(value);
                    }
                } else {
                    // If no value selected, clear everything
                    input.value = '';
                    wrapper.classList.remove('open');
                    dropdownSearch.value = '';
                    // Disable stall dropdowns when no hawker centre is selected
                    toggleStallDropdowns(false);
                    clearDashboard();
                }
            });
            
            // Keep input empty to show placeholder initially
            input.value = '';
            // Clear dashboard on initial load since nothing is selected
            clearDashboard();
            // Disable stall dropdowns initially since no hawker centre is selected
            toggleStallDropdowns(false);
            
            input.addEventListener('focus', () => {
                wrapper.classList.add('open');
                dropdownSearch.focus();
                filterOptions();
            });
            
            input.addEventListener('click', () => {
                wrapper.classList.add('open');
                dropdownSearch.focus();
                filterOptions();
            });
            
            dropdownSearch.addEventListener('input', () => {
                filterOptions();
            });
            
            document.addEventListener('click', (e) => {
                if (!wrapper.contains(e.target)) {
                    wrapper.classList.remove('open');
                    dropdownSearch.value = '';
                }
            });
            
            dropdownSearch.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    wrapper.classList.remove('open');
                    input.blur();
                }
            });
        }
        
        // Initialize desktop dropdown on DOM ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initHawkerDropdown);
        } else {
            initHawkerDropdown();
        }

        // Initialize stall dropdown (Desktop)
        function initStallDropdown() {
            const input = document.getElementById('stall-select');
            const wrapper = document.getElementById('stallSelectWrapper');
            const dropdown = document.getElementById('stallDropdown');
            const dropdownSearch = document.getElementById('stallDropdownSearchInput');
            
            if (!input || !wrapper || !dropdown || !dropdownSearch) return;
            
            function getOptions() {
                return dropdown ? dropdown.querySelectorAll('.stall-option') : [];
            }
            
            function updateSelectedOption(value) {
                const options = getOptions();
                options.forEach(opt => {
                    opt.classList.remove('selected');
                    if (opt.dataset.value === value) {
                        opt.classList.add('selected');
                    }
                });
            }
            
            function filterOptions() {
                const searchTerm = dropdownSearch.value.toLowerCase().trim();
                const options = getOptions();
                options.forEach(option => {
                    const label = option.dataset.label ? option.dataset.label.toLowerCase() : option.textContent.toLowerCase();
                    if (label.includes(searchTerm) || searchTerm === '') {
                        option.classList.remove('hidden');
                    } else {
                        option.classList.add('hidden');
                    }
                });
            }
            
            // Use event delegation instead of attaching listeners to each option
            dropdown.addEventListener('click', (e) => {
                const option = e.target.closest('.stall-option');
                if (!option) return;
                
                const value = option.dataset.value;
                const label = option.dataset.label || option.textContent;
                if (value === '') {
                    input.value = '';
                    input.placeholder = 'Please select a food stall';
                } else {
                    input.value = label;
                }
                wrapper.classList.remove('open');
                dropdownSearch.value = '';
                updateSelectedOption(value);
                
                // Update dashboard with selected stall
                const hawkerWrapper = document.getElementById('hawkerCentreSelectWrapper');
                const hawkerOptions = hawkerWrapper ? hawkerWrapper.querySelectorAll('.hawker-centre-option') : [];
                const selectedHawkerOption = Array.from(hawkerOptions).find(opt => opt.classList.contains('selected'));
                const hawkerKey = selectedHawkerOption ? selectedHawkerOption.dataset.value : null;
                if (hawkerKey && hawkerKey.trim()) {
                    updateDashboard(hawkerKey, value || null);
                } else {
                    clearDashboard();
                }
            });
            
            // Set initial value to "All Stalls"
            input.value = '';
            input.placeholder = 'Please select a food stall';
            
            input.addEventListener('focus', () => {
                // Don't open if disabled
                if (input.disabled) return;
                wrapper.classList.add('open');
                dropdownSearch.focus();
                filterOptions();
            });
            
            input.addEventListener('click', () => {
                // Don't open if disabled
                if (input.disabled) return;
                wrapper.classList.add('open');
                dropdownSearch.focus();
                filterOptions();
            });
            
            dropdownSearch.addEventListener('input', () => {
                filterOptions();
            });
            
            document.addEventListener('click', (e) => {
                if (!wrapper.contains(e.target)) {
                    wrapper.classList.remove('open');
                    dropdownSearch.value = '';
                }
            });
            
            dropdownSearch.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    wrapper.classList.remove('open');
                    input.blur();
                }
            });
        }
        
        // Initialize desktop stall dropdown on DOM ready (after hawker dropdown initializes)
        function initStallDropdownDelayed() {
            setTimeout(() => {
                initStallDropdown();
            }, 200);
        }
        
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initStallDropdownDelayed);
        } else {
            initStallDropdownDelayed();
        }

        // Function to clear mobile dashboard (show nothing)
        function clearMobileDashboard() {
            // Clear mobile stats
            const mobileStats = document.querySelectorAll('.mobile-view .stat-value');
            mobileStats.forEach(stat => stat.textContent = '--');
            
            // Hide mobile stat-change divs
            const mobileStatChanges = document.querySelectorAll('.mobile-view .stat-change');
            mobileStatChanges.forEach(change => {
                change.style.display = 'none';
            });
            
            // Clear mobile crowd chart
            const mobileChart = document.querySelector('.mobile-view .bar-chart');
            if (mobileChart && mobileChart.id !== 'hawker-chart') {
                mobileChart.innerHTML = '';
            }
            
            // Clear mobile leaderboard
            const mobileLeaderboard = document.querySelector('.mobile-view .leaderboard');
            if (mobileLeaderboard) {
                mobileLeaderboard.innerHTML = '';
            }
            
            // Clear mobile stall queues
            const mobileStallQueues = document.querySelectorAll('.mobile-view .bar-chart');
            if (mobileStallQueues.length > 1) {
                const stallQueues = mobileStallQueues[mobileStallQueues.length - 1];
                if (stallQueues) {
                    stallQueues.innerHTML = '';
                }
            }
            
            // Clear mobile peak hours
            const mobilePeakHours = document.getElementById('mobile-peak-hours') || document.querySelector('.mobile-view .peak-hours-grid');
            if (mobilePeakHours) {
                mobilePeakHours.innerHTML = '';
            }
            
            // Clear mobile activity feed
            const mobileActivity = document.querySelector('.mobile-view .activity-feed');
            if (mobileActivity) {
                mobileActivity.innerHTML = '';
            }
        }

        // Function to update mobile dashboard
        async function updateMobileDashboard(hawkerKey, stallSlug = null) {
            // If no hawker key is provided or invalid, clear dashboard
            if (!hawkerKey || !hawkerKey.trim()) {
                clearMobileDashboard();
                return;
            }
            
            const hawker = stallData[hawkerKey];
            if (!hawker) {
                clearMobileDashboard();
                return;
            }

            // Count active reservations for this hawker centre
            const activeReservationsCount = await countActiveReservations(hawker.name);
            
            // Calculate current occupancy from seatDatabase (matching chope page)
            const currentOccupancy = await calculateCurrentOccupancy(hawker.name);
            
            // Calculate occupancy change from 1 hour ago
            const occupancyChange = await calculateOccupancyChange(hawker.name);
            
            // Update mobile stats
            const mobileStats = document.querySelectorAll('.mobile-view .stat-value');
            const mobileStatChanges = document.querySelectorAll('.mobile-view .stat-change');
            if (mobileStats.length >= 2 && mobileStatChanges.length >= 2) {
                mobileStats[0].textContent = currentOccupancy + '%';
                mobileStats[1].textContent = hawker.avgWaitTime + 'm';
                
                // Update mobile stat-change divs with hawker-specific values
                // Use calculated occupancy change from 1 hour ago
                mobileStatChanges[0].textContent = occupancyChange.changeText;
                mobileStatChanges[0].className = 'stat-change ' + (occupancyChange.isPositive ? 'positive' : 'negative');
                mobileStatChanges[0].style.display = 'flex';
                
                mobileStatChanges[1].textContent = hawker.waitTimeChange + 'm';
                mobileStatChanges[1].className = 'stat-change negative';
                mobileStatChanges[1].style.display = 'flex';
            }

            // Update mobile crowd chart based on current time filter
            const mobileChart = document.querySelector('.mobile-view .bar-chart');
            if (mobileChart && mobileChart.id !== 'hawker-chart') {
                let timeSlots;
                let crowdData;
                let maxItems;
                
                if (currentTimeFilter === '1H') {
                    // Generate actual time labels for 1H view
                    const now = new Date();
                    const minutes40Ago = new Date(now.getTime() - 40 * 60 * 1000);
                    const minutes20Ago = new Date(now.getTime() - 20 * 60 * 1000);
                    
                    function formatTime(date) {
                        const hours = date.getHours();
                        const minutes = date.getMinutes();
                        const ampm = hours >= 12 ? 'PM' : 'AM';
                        const displayHours = hours % 12 || 12;
                        return `${displayHours}:${minutes.toString().padStart(2, '0')} ${ampm}`;
                    }
                    
                    timeSlots = [formatTime(minutes40Ago), formatTime(minutes20Ago), formatTime(now)];
                    // Generate 1H data based on current time and Today data
                    crowdData = generate1HCrowdLevels(hawker);
                    maxItems = 3;
                } else if (currentTimeFilter === 'Week') {
                    timeSlots = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
                    crowdData = hawker.crowdLevelsWeek;
                    maxItems = 7;
                } else {
                    timeSlots = ['8AM', '10AM', '12PM', '2PM', '6PM'];
                    crowdData = hawker.crowdLevels;
                    maxItems = 5;
                }
                
                mobileChart.innerHTML = '';
                
                crowdData.slice(0, maxItems).forEach((level, idx) => {
                    const levelClass = level >= 80 ? 'high' : level >= 50 ? 'medium' : 'low';
                    const barItem = document.createElement('div');
                    barItem.className = 'bar-item';
                    barItem.innerHTML = `
                        <div class="bar-label">${timeSlots[idx]}</div>
                        <div class="bar-track">
                            <div class="bar-fill ${levelClass}" style="width: 0;">0%</div>
                        </div>
                    `;
                    mobileChart.appendChild(barItem);
                    
                    // Animate to the actual width using requestAnimationFrame
                    requestAnimationFrame(() => {
                        const barFill = barItem.querySelector('.bar-fill');
                        if (barFill) {
                            barFill.style.width = `${level}%`;
                            barFill.textContent = `${level}%`;
                        }
                    });
                });
            }

            // Update mobile leaderboard
            const mobileLeaderboard = document.querySelector('.mobile-view .leaderboard');
            if (mobileLeaderboard) {
                const topStalls = hawker.stalls
                    .filter(s => !s.closed)
                    .sort((a, b) => b.rating - a.rating)
                    .slice(0, 3);

                mobileLeaderboard.innerHTML = '';
                topStalls.forEach((stall, idx) => {
                    const badges = ['gold', 'silver', 'bronze'];
                    const item = document.createElement('div');
                    item.className = 'leaderboard-item';
                    item.innerHTML = `
                        <div class="rank-badge ${badges[idx]}">${idx + 1}</div>
                        <div class="stall-info">
                            <div class="stall-name">${stall.name}</div>
                            <div class="stall-cuisine">${stall.cuisine}</div>
                        </div>
                        <div class="popularity-score">
                            <div class="score-value">${stall.rating}</div>
                        </div>
                    `;
                    mobileLeaderboard.appendChild(item);
                });
            }

            // Update mobile peak hours (stall-specific if stall is selected)
            const mobilePeakHours = document.getElementById('mobile-peak-hours') || document.querySelector('.mobile-view .peak-hours-grid');
            const mobilePeakTitle = document.getElementById('mobile-peak-hours-title') || document.querySelector('.mobile-view .chart-title');
            let selectedMobileStallSlug = stallSlug;
            if (!selectedMobileStallSlug) {
                const stallDropdownMobile = document.getElementById('stallDropdownMobile');
                const selectedMobileStallOption = stallDropdownMobile ? Array.from(stallDropdownMobile.querySelectorAll('.stall-option')).find(opt => opt.classList.contains('selected')) : null;
                selectedMobileStallSlug = selectedMobileStallOption ? selectedMobileStallOption.dataset.value : null;
            }

            // Update mobile stall queues
            // If "All Stalls" is selected (empty value), show all stalls
            // If a specific stall is selected, show only that stall
            const mobileStallQueues = document.querySelectorAll('.mobile-view .bar-chart');
            if (mobileStallQueues.length > 1) {
                const stallQueues = mobileStallQueues[mobileStallQueues.length - 1];
                stallQueues.innerHTML = '';
                
                if (selectedMobileStallSlug && selectedMobileStallSlug !== '') {
                    // Specific stall selected - show only that stall
                    const selectedStall = hawker.stalls.find(s => s.slug === selectedMobileStallSlug);
                    if (selectedStall) {
                        const occupancy = selectedStall.occupancy || 0;
                        const levelClass = occupancy >= 80 ? 'high' : occupancy >= 50 ? 'medium' : 'low';
                        const barItem = document.createElement('div');
                        barItem.className = 'bar-item';
                        barItem.innerHTML = `
                            <div class="bar-label">${selectedStall.name.length > 10 ? selectedStall.name.substring(0, 10) + '...' : selectedStall.name}</div>
                            <div class="bar-track">
                                <div class="bar-fill ${levelClass}" style="width: 0;">0</div>
                            </div>
                            <div class="bar-value">${selectedStall.waitTime}m</div>
                        `;
                        stallQueues.appendChild(barItem);
                        
                        // Animate to the actual width using requestAnimationFrame
                        requestAnimationFrame(() => {
                            const barFill = barItem.querySelector('.bar-fill');
                            if (barFill) {
                                barFill.style.width = `${occupancy}%`;
                                barFill.textContent = `${selectedStall.queue}`;
                            }
                        });
                    }
                } else {
                    // "All Stalls" is selected - show all stalls
                    const openStalls = hawker.stalls.filter(s => !s.closed).sort((a, b) => b.queue - a.queue);
                openStalls.slice(0, 4).forEach(stall => {
                    const occupancy = stall.occupancy || 0;
                    const levelClass = occupancy >= 80 ? 'high' : occupancy >= 50 ? 'medium' : 'low';
                    const barItem = document.createElement('div');
                    barItem.className = 'bar-item';
                    barItem.innerHTML = `
                        <div class="bar-label">${stall.name.length > 10 ? stall.name.substring(0, 10) + '...' : stall.name}</div>
                        <div class="bar-track">
                            <div class="bar-fill ${levelClass}" style="width: 0;">0</div>
                        </div>
                        <div class="bar-value">${stall.waitTime}m</div>
                    `;
                    stallQueues.appendChild(barItem);
                    
                    // Animate to the actual width using requestAnimationFrame
                    requestAnimationFrame(() => {
                        const barFill = barItem.querySelector('.bar-fill');
                        if (barFill) {
                            barFill.style.width = `${occupancy}%`;
                            barFill.textContent = `${stall.queue}`;
                        }
                    });
                });
                }
            }
            
            if (mobilePeakHours) {
                let peakHoursData = hawker.peakHours;
                let locationName = hawker.name;
                
                if (selectedMobileStallSlug && selectedMobileStallSlug !== '') {
                    const selectedStall = hawker.stalls.find(s => s.slug === selectedMobileStallSlug);
                    if (selectedStall && selectedStall.peakHours) {
                        peakHoursData = selectedStall.peakHours;
                        locationName = selectedStall.name;
                    }
                }
                
                // Update mobile title
                if (mobilePeakTitle) {
                    if (locationName !== hawker.name) {
                        mobilePeakTitle.textContent = `üìä ${locationName} Peak Hours`;
                    } else {
                        mobilePeakTitle.textContent = `üìä Peak Hours`;
                    }
                }
                
                const periods = [
                    { label: 'Breakfast', value: peakHoursData.breakfast },
                    { label: 'Lunch', value: peakHoursData.lunch },
                    { label: 'Tea', value: peakHoursData.teaTime },
                    { label: 'Dinner', value: peakHoursData.dinner }
                ];

                mobilePeakHours.innerHTML = '';
                periods.forEach(period => {
                    const card = document.createElement('div');
                    card.className = 'hour-card';
                    card.innerHTML = `
                        <div class="hour-time">${period.label}</div>
                        <div class="hour-bar">
                            <div class="hour-bar-fill" style="height: 0;"></div>
                        </div>
                        <div class="hour-percentage">0%</div>
                    `;
                    mobilePeakHours.appendChild(card);
                    
                    // Animate to the actual height using requestAnimationFrame
                    requestAnimationFrame(() => {
                        const barFill = card.querySelector('.hour-bar-fill');
                        const percentage = card.querySelector('.hour-percentage');
                        if (barFill) {
                            barFill.style.height = `${period.value}%`;
                        }
                        if (percentage) {
                            percentage.textContent = `${period.value}%`;
                        }
                    });
                });
            }

            // Update mobile activity feed
            const mobileActivity = document.querySelector('.mobile-view .activity-feed');
            if (mobileActivity) {
                const activities = getActivityFeed(hawkerKey);
                mobileActivity.innerHTML = '';
                
                activities.slice(0, 3).forEach(activity => {
                    const item = document.createElement('div');
                    item.className = 'activity-item' + (activity.type === 'reservation' ? ' reservation-item' : '');
                    
                    // Make reservation items clickable
                    if (activity.type === 'reservation' && activity.link) {
                        item.style.cursor = 'pointer';
                        item.addEventListener('click', function() {
                            window.location.href = activity.link;
                        });
                    }
                    
                    item.innerHTML = `
                        <div class="activity-icon">${activity.icon}</div>
                        <div class="activity-content">
                            <div class="activity-text">${activity.type === 'reservation' ? '<strong>New reservation:</strong> ' : ''}${activity.text}</div>
                            <div class="activity-time">${activity.time}</div>
                        </div>
                    `;
                    mobileActivity.appendChild(item);
                });
            }
        }

        // Custom searchable dropdown for hawker centre (Mobile)
        function initHawkerDropdownMobile() {
            const input = document.getElementById('hawker-select-mobile');
            const wrapper = document.getElementById('hawkerCentreSelectWrapperMobile');
            const dropdown = document.getElementById('hawkerCentreDropdownMobile');
            const dropdownSearch = document.getElementById('hawkerDropdownSearchInputMobile');
            
            if (!input || !wrapper || !dropdown || !dropdownSearch) return;
            
            function getOptions() {
                return dropdown ? dropdown.querySelectorAll('.hawker-centre-option') : [];
            }
            
            function updateSelectedOption(value) {
                const options = getOptions();
                options.forEach(opt => {
                    opt.classList.remove('selected');
                    if (opt.dataset.value === value) {
                        opt.classList.add('selected');
                    }
                });
            }
            
            function filterOptions() {
                const searchTerm = dropdownSearch.value.toLowerCase().trim();
                const options = getOptions();
                options.forEach(option => {
                    const label = option.dataset.label ? option.dataset.label.toLowerCase() : option.textContent.toLowerCase();
                    if (label.includes(searchTerm) || searchTerm === '') {
                        option.classList.remove('hidden');
                    } else {
                        option.classList.add('hidden');
                    }
                });
            }
            
            // Use event delegation instead of attaching listeners to each option
            dropdown.addEventListener('click', (e) => {
                const option = e.target.closest('.hawker-centre-option');
                if (!option) return;
                
                const value = option.dataset.value;
                const label = option.dataset.label || option.textContent;
                
                if (value && value.trim()) {
                    input.value = label;
                    wrapper.classList.remove('open');
                    dropdownSearch.value = '';
                    updateSelectedOption(value);
                    
                    // Enable stall dropdowns when hawker centre is selected
                    toggleStallDropdowns(true);
                    
                    const stallDropdownMobile = document.getElementById('stallDropdownMobile');
                    if (stallDropdownMobile) {
                        updateStallOptions(value, stallDropdownMobile);
                        // Reset stall selection to "All Stalls"
                        const stallInputMobile = document.getElementById('stall-select-mobile');
                        if (stallInputMobile) {
                            stallInputMobile.value = '';
                            stallInputMobile.placeholder = 'Please select a food stall';
                        }
                        const stallWrapperMobile = document.getElementById('stallSelectWrapperMobile');
                        if (stallWrapperMobile) {
                            const allStallsOptionMobile = stallDropdownMobile.querySelector('.stall-option[data-value=""]');
                            if (allStallsOptionMobile) {
                                Array.from(stallDropdownMobile.querySelectorAll('.stall-option')).forEach(opt => opt.classList.remove('selected'));
                                allStallsOptionMobile.classList.add('selected');
                            }
                        }
                        updateMobileDashboard(value);
                    } else {
                        updateMobileDashboard(value);
                    }
                } else {
                    // If no value selected, clear everything
                    input.value = '';
                    wrapper.classList.remove('open');
                    dropdownSearch.value = '';
                    // Disable stall dropdowns when no hawker centre is selected
                    toggleStallDropdowns(false);
                    clearMobileDashboard();
                }
            });
            
            // Keep input empty to show placeholder initially
            input.value = '';
            // Clear mobile dashboard on initial load since nothing is selected
            clearMobileDashboard();
            // Disable stall dropdowns initially since no hawker centre is selected
            toggleStallDropdowns(false);
            
            input.addEventListener('focus', () => {
                wrapper.classList.add('open');
                dropdownSearch.focus();
                filterOptions();
            });
            
            input.addEventListener('click', () => {
                wrapper.classList.add('open');
                dropdownSearch.focus();
                filterOptions();
            });
            
            dropdownSearch.addEventListener('input', () => {
                filterOptions();
            });
            
            document.addEventListener('click', (e) => {
                if (!wrapper.contains(e.target)) {
                    wrapper.classList.remove('open');
                    dropdownSearch.value = '';
                }
            });
            
            dropdownSearch.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    wrapper.classList.remove('open');
                    input.blur();
                }
            });
        }
        
        // Initialize mobile dropdown on DOM ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initHawkerDropdownMobile);
        } else {
            initHawkerDropdownMobile();
        }

        // Initialize stall dropdown (Mobile)
        function initStallDropdownMobile() {
            const input = document.getElementById('stall-select-mobile');
            const wrapper = document.getElementById('stallSelectWrapperMobile');
            const dropdown = document.getElementById('stallDropdownMobile');
            const dropdownSearch = document.getElementById('stallDropdownSearchInputMobile');
            
            if (!input || !wrapper || !dropdown || !dropdownSearch) return;
            
            function getOptions() {
                return dropdown ? dropdown.querySelectorAll('.stall-option') : [];
            }
            
            function updateSelectedOption(value) {
                const options = getOptions();
                options.forEach(opt => {
                    opt.classList.remove('selected');
                    if (opt.dataset.value === value) {
                        opt.classList.add('selected');
                    }
                });
            }
            
            function filterOptions() {
                const searchTerm = dropdownSearch.value.toLowerCase().trim();
                const options = getOptions();
                options.forEach(option => {
                    const label = option.dataset.label ? option.dataset.label.toLowerCase() : option.textContent.toLowerCase();
                    if (label.includes(searchTerm) || searchTerm === '') {
                        option.classList.remove('hidden');
                    } else {
                        option.classList.add('hidden');
                    }
                });
            }
            
            // Use event delegation instead of attaching listeners to each option
            dropdown.addEventListener('click', (e) => {
                const option = e.target.closest('.stall-option');
                if (!option) return;
                
                const value = option.dataset.value;
                const label = option.dataset.label || option.textContent;
                if (value === '') {
                    input.value = '';
                    input.placeholder = 'Please select a food stall';
                } else {
                    input.value = label;
                }
                wrapper.classList.remove('open');
                dropdownSearch.value = '';
                updateSelectedOption(value);
                
                    // Update mobile dashboard with selected stall
                    const hawkerWrapperMobile = document.getElementById('hawkerCentreSelectWrapperMobile');
                    const hawkerOptionsMobile = hawkerWrapperMobile ? hawkerWrapperMobile.querySelectorAll('.hawker-centre-option') : [];
                    const selectedHawkerOptionMobile = Array.from(hawkerOptionsMobile).find(opt => opt.classList.contains('selected'));
                    const hawkerKeyMobile = selectedHawkerOptionMobile ? selectedHawkerOptionMobile.dataset.value : null;
                    if (hawkerKeyMobile && hawkerKeyMobile.trim()) {
                        updateMobileDashboard(hawkerKeyMobile, value || null);
                    } else {
                        clearMobileDashboard();
                    }
            });
            
            // Set initial value to "All Stalls"
            input.value = '';
            input.placeholder = 'Please select a food stall';
            
            input.addEventListener('focus', () => {
                // Don't open if disabled
                if (input.disabled) return;
                wrapper.classList.add('open');
                dropdownSearch.focus();
                filterOptions();
            });
            
            input.addEventListener('click', () => {
                // Don't open if disabled
                if (input.disabled) return;
                wrapper.classList.add('open');
                dropdownSearch.focus();
                filterOptions();
            });
            
            dropdownSearch.addEventListener('input', () => {
                filterOptions();
            });
            
            document.addEventListener('click', (e) => {
                if (!wrapper.contains(e.target)) {
                    wrapper.classList.remove('open');
                    dropdownSearch.value = '';
                }
            });
            
            dropdownSearch.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    wrapper.classList.remove('open');
                    input.blur();
                }
            });
        }
        
        // Initialize mobile stall dropdown on DOM ready (after hawker dropdown initializes)
        function initStallDropdownMobileDelayed() {
            setTimeout(() => {
                initStallDropdownMobile();
            }, 200);
        }
        
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initStallDropdownMobileDelayed);
        } else {
            initStallDropdownMobileDelayed();
        }

        // Time filter buttons
        document.querySelectorAll('.time-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                // Remove active class from siblings in the same container
                this.parentElement.querySelectorAll('.time-btn').forEach(b => b.classList.remove('active'));
                // Add active class to clicked button
                this.classList.add('active');
                
                // Update the global time filter variable
                currentTimeFilter = this.textContent.trim();
                
                // Update the dashboard with new time filter (both desktop and mobile)
                // Only update if a hawker centre is actually selected
                const wrapper = document.getElementById('hawkerCentreSelectWrapper');
                const options = wrapper ? wrapper.querySelectorAll('.hawker-centre-option') : [];
                const selectedOption = Array.from(options).find(opt => opt.classList.contains('selected'));
                const hawkerKey = selectedOption ? selectedOption.dataset.value : null;
                if (hawkerKey) {
                    updateDashboard(hawkerKey);
                } else {
                    // No hawker centre selected, clear the dashboard
                    clearDashboard();
                }
                
                const wrapperMobile = document.getElementById('hawkerCentreSelectWrapperMobile');
                const optionsMobile = wrapperMobile ? wrapperMobile.querySelectorAll('.hawker-centre-option') : [];
                const selectedOptionMobile = Array.from(optionsMobile).find(opt => opt.classList.contains('selected'));
                const hawkerKeyMobile = selectedOptionMobile ? selectedOptionMobile.dataset.value : null;
                if (hawkerKeyMobile) {
                    updateMobileDashboard(hawkerKeyMobile);
                } else {
                    // No hawker centre selected, clear the mobile dashboard
                    clearMobileDashboard();
                }
            });
        });
    </script>

    <!-- Navigation Bar -->
<div class="nav-bar">
  <a href="/" class="nav-logo"><img src="/img/logo.jpg" alt="ChopeLah" /></a>
  <div class="nav-items">
    <button onclick="location.href='/pages/order/online-order-home.html'">
      <i class="bi bi-cart3"></i>
      <span>Order</span>
    </button>
    <button onclick="location.href='/pages/community/community.html'">
      <i class="bi bi-people"></i>
      <span>Community</span>
    </button>
    <button onclick="location.href='/pages/chope/chope.html'">
      <i class="bi bi-bookmark"></i>
      <span>Chope</span>
    </button>
    <button class="active">
      <i class="bi bi-eye"></i>
      <span>Crowd View</span>
    </button>
  </div>
  <div class="nav-right">
                <button class="notification-btn" onclick="toggleOrderNotification()">
                <i class="bi bi-bell"></i>
                <span class="notification-badge" style="display: none;">1</span>
            </button>
    <button onclick="location.href='/pages/profile/profile.html'">
      <i class="bi bi-person"></i>
      <span>Profile</span>
    </button>
  </div>
</div>
<script src="/scripts/notification.js"></script>
</body>
</html>
