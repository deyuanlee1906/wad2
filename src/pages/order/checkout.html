<!-- /pages/order/checkout.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Checkout</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet" />
  <script src="https://js.stripe.com/v3/"></script>
  <script type="module" src="/scripts/firebaseauth.js"></script>

  <style>
    body{background:#f8f9fa;margin:0;padding-top:70px;padding-bottom:110px}
    @media (max-width:768px){ body{padding-top:0;padding-bottom:110px} }
    .container{max-width:900px;padding:18px;margin:0 auto}
    .cart-item{background:#fff;padding:12px;border-radius:10px;border:1px solid rgba(0,0,0,0.05);display:flex;gap:12px;align-items:center}
    .cart-item img{width:70px;height:60px;object-fit:cover;border-radius:8px}
    .nav-bar{position:fixed;bottom:0;left:0;right:0;background:#fff;border-top:1px solid #ddd;display:flex;justify-content:space-around;padding:10px;height:70px;z-index:999}
  </style>
</head>
<body>
  <div class="container">
    <h3>Checkout</h3>
    <div id="cartList" class="mb-3"></div>

    <div class="mb-3">
      <label class="form-label">Name</label>
      <input id="customerName" class="form-control" placeholder="Your name (optional)">
    </div>

    <div class="mb-3">
      <label class="form-label">Phone</label>
      <input id="customerPhone" class="form-control" placeholder="Phone (optional)">
    </div>

    <div class="d-flex justify-content-between align-items-center mb-3">
      <div><strong>Total:</strong> <span id="grandTotal">$0.00</span></div>
      <div><button id="payBtn" class="btn btn-primary" disabled>Pay with Card (Stripe)</button></div>
    </div>
  </div>

  <script>
    // load cart from localStorage
    let cart = JSON.parse(localStorage.getItem('cart') || '[]');
    function renderCart(){
      const list = document.getElementById('cartList');
      if(!cart.length){ list.innerHTML = '<div class="text-muted">Cart is empty.</div>'; document.getElementById('payBtn').disabled = true; updateTotal(); return;}
      list.innerHTML = cart.map(it=>`
        <div class="cart-item mb-2">
          <img src="${it.image||'/img/placeholder.svg'}" alt="${it.name}">
          <div style="flex:1">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div><strong>${it.name}</strong><div class="text-muted small">qty: ${it.qty}</div></div>
              <div class="fw-semibold">$${(it.price*it.qty).toFixed(2)}</div>
            </div>
          </div>
        </div>
      `).join('');
      updateTotal();
      document.getElementById('payBtn').disabled = false;
    }
    function updateTotal(){
      const total = cart.reduce((s,i)=>s+i.price*i.qty,0);
      document.getElementById('grandTotal').textContent = '$'+total.toFixed(2);
    }

    renderCart();

    // When user clicks pay -> call server to create Stripe Checkout Session
    document.getElementById('payBtn').addEventListener('click', async ()=>{
      const customerName = document.getElementById('customerName').value || '';
      const customerPhone = document.getElementById('customerPhone').value || '';
      const payload = { cart, customerName, customerPhone };
      // call your backend endpoint
      const res = await fetch('/create-checkout-session', {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify(payload)
      });
      if(!res.ok){ const txt = await res.text(); alert('Payment init failed: ' + txt); return; }
      const data = await res.json();
      // data should contain { sessionId }
      const stripe = Stripe(data.publishableKey || 'pk_test_...'); // optionally server can return publishableKey
      stripe.redirectToCheckout({ sessionId: data.sessionId }).then(function(result){
        if(result.error) alert(result.error.message);
      });
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Bottom Nav -->
  <div class="nav-bar">
    <button onclick="location.href='/pages/order/online-order-home.html'"><i class="bi bi-cart3"></i><span>Order</span></button>
    <button onclick="location.href='/pages/community/community.html'"><i class="bi bi-people"></i><span>Community</span></button>
    <button onclick="location.href='/pages/chope/chope.html'"><i class="bi bi-bookmark"></i><span>Chope</span></button>
    <button onclick="location.href='/pages/crowd/crowd-view.html'"><i class="bi bi-eye"></i><span>Crowd</span></button>
    <button onclick="location.href='/pages/profile/profile.html'"><i class="bi bi-person"></i><span>Profile</span></button>
  </div>
</body>
</html>
