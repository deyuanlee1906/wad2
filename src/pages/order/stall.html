<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Stall — Menu</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet" />
  <script type="module" src="/scripts/firebaseauth.js"></script>

  <style>
    /* Applied cleaner styling from wait-for-db with coral accent color and improved spacing */
    :root{--bg:#f5f5f5;--card:#fff;--accent:#d98566;--text:#1a1a1a;--text-muted:#666}
    * {margin:0;padding:0;box-sizing:border-box}
    html,body{height:100%;width:100%;font-family:Inter,system-ui;overflow-x:hidden}
    body{background:var(--bg);color:var(--text);display:flex;flex-direction:column;overflow-x:hidden}
    
    /* Increased bottom margin to account for fixed footer height */
    .main-content{display:flex;flex-direction:column;flex:1;min-height:100vh;margin-bottom:100px}
    .header-section{padding:20px 24px;border-bottom:1px solid rgba(0,0,0,0.06);background:var(--card);flex-shrink:0}
    .header{display:flex;align-items:center;gap:12px;margin-bottom:12px}
    .header h2{margin:0;font-size:1.5rem;font-weight:600}
    .controls{display:flex;gap:12px;align-items:center;flex-wrap:wrap;width:100%}
    .time-select{min-width:180px;max-width:220px;flex:0 1 auto;position:relative}
    .time-select .form-select{
      width:100%;
      padding:10px 36px 10px 12px;
      border:1px solid var(--text);
      border-radius:6px;
      background:white;
      color:var(--text);
      font-size:16px;
      font-weight:600;
      appearance:none;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%231a1a1a' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
      background-repeat:no-repeat;
      background-position:right 12px center;
      background-size:12px;
      box-sizing:border-box;
      cursor:pointer;
      transition:all 0.2s;
    }
    .time-select .form-select:hover{
      border-color:#4285f4;
      box-shadow:0 0 0 2px rgba(66, 133, 244, 0.1);
    }
    .time-select .form-select:focus{
      outline:none;
      border-color:#4285f4;
      box-shadow:0 0 0 3px rgba(66, 133, 244, 0.2);
    }
    .time-select .form-select:disabled{
      background-color:#e9ecef;
      opacity:0.6;
      cursor:not-allowed;
    }
    .controls .flex-grow-1{flex:1;min-width:0;text-align:right}
    .controls .flex-grow-1 small{overflow:hidden;text-overflow:ellipsis;white-space:nowrap;display:block}
    
    /* Full-height layout grid with improved spacing */
    .layout-wrapper{display:flex;flex:1;gap:0;min-height:0}
    .layout{display:grid;grid-template-columns:240px 1fr;gap:0;width:100%;height:100%;min-height:0}
    @media (max-width:767px){ .layout { grid-template-columns: 1fr; } }
    
    .left-rail{position:sticky;top:0;height:100%;overflow-y:auto;padding:12px 8px;background:var(--card);border-right:1px solid rgba(0,0,0,0.06);flex-shrink:0}
    @media (max-width:768px){ .left-rail{display:none} }
    
    /* Increased padding-bottom to ensure last item is visible above fixed footer */
    .menu-col{flex:1;overflow-y:auto;min-height:0;padding:20px 24px;padding-bottom:120px}
    .menu-list{max-width:100%}
    .menu-section{margin-bottom:28px}
    .menu-section h4{margin-bottom:14px;font-size:1.3rem;font-weight:600;color:var(--text)}
    
    /* Enhanced menu item styling with better spacing and shadows */
    .menu-item{display:flex;gap:14px;background:var(--card);padding:14px;border-radius:12px;align-items:stretch;border:1px solid rgba(0,0,0,0.04);transition:all 0.2s ease;cursor:pointer}
    .menu-item:hover{box-shadow:0 4px 12px rgba(0,0,0,0.08);border-color:rgba(0,0,0,0.08)}
    .menu-item img{width:100px;height:80px;object-fit:cover;border-radius:10px;flex-shrink:0}
    .menu-item-content{flex:1;display:flex;flex-direction:column;justify-content:space-between}
    .menu-item-header{display:flex;flex-direction:column;gap:4px}
    .menu-item-title{font-weight:600;font-size:1.3rem;margin:0}
    .menu-item-price{font-weight:700;color:var(--accent);font-size:1.1rem;margin-top:2px}
    .menu-item-description{font-size:0.875rem;color:var(--text-muted);margin:4px 0 0 0}
    .menu-item-status{font-size:0.8rem;color:var(--text-muted);margin-top:4px}
    
    /* Modern quantity controls with refined styling */
    .qty-controls{display:flex;align-items:center;gap:0;background:#f0f0f0;border-radius:8px;padding:2px;width:fit-content}
    .qty-controls button{width:40px;height:40px;border:none;background:transparent;color:var(--accent);font-weight:600;font-size:1.2rem;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.15s ease;border-radius:6px;margin:2px}
    .qty-controls button:hover{background:rgba(217,133,102,0.1);color:var(--accent)}
    .qty-controls button:active{transform:scale(0.95)}
    .qty-display{min-width:44px;text-align:center;font-weight:600;color:var(--text);font-size:1rem}
    .btn-add{display:inline-flex;align-items:center;justify-content:center;background:var(--accent);color:#fff;border:none;padding:8px 16px;border-radius:8px;font-weight:600;cursor:pointer;transition:all 0.2s ease;font-size:0.95rem}
    .btn-add:hover{background:#c66d52;transform:translateY(-1px);box-shadow:0 2px 8px rgba(217,133,102,0.3)}
    .btn-add:active{transform:translateY(0)}
    
    /* Full-screen cart footer with improved styling */
    .cart-fixed{position:fixed;bottom:0;left:0;right:0;background:var(--card);padding:14px 0;border-top:1px solid rgba(0,0,0,0.08);z-index:1000;box-shadow:0 -2px 8px rgba(0,0,0,0.04);height:80px;display:flex;align-items:center}
    .cart-content{display:flex;justify-content:space-between;align-items:center;max-width:100%;padding:0 24px;width:100%}
    .cart-total{display:flex;align-items:center;gap:12px;font-size:1.3rem}
    .cart-total strong{font-size:1.3rem;font-weight:600;color:var(--text)}
    #cartTotal{font-weight:700;color:var(--accent);font-size:1.3rem}
    .checkout-section{display:flex;gap:12px;align-items:center}
    #checkoutBtn{background:var(--accent);color:#fff;border:none;padding:8px 16px;border-radius:8px;font-weight:600;cursor:pointer;transition:all 0.2s ease;font-size:0.95rem;display:inline-flex;align-items:center;justify-content:center}
    #checkoutBtn:hover:not(:disabled){background:#c66d52;transform:translateY(-1px);box-shadow:0 2px 8px rgba(217,133,102,0.3)}
    #checkoutBtn:active:not(:disabled){transform:translateY(0)}
    #checkoutBtn:disabled{opacity:0.5;cursor:not-allowed}
    
    /* Improved category pills with better contrast */
    .category-pill{padding:10px 14px;border-radius:999px;background:#fff;margin-bottom:8px;display:block;border:1px solid rgba(0,0,0,0.08);cursor:pointer;font-size:0.95rem;font-weight:500;transition:all 0.2s ease;color:var(--text)}
    .category-pill:hover{border-color:var(--accent);background:#fafafa}
    .category-pill.active{background:var(--accent);color:#fff;border-color:var(--accent);box-shadow:0 2px 8px rgba(217,133,102,0.2)}
    
    /* Notification popup - matching confirmation popup styling */
    .notification-popup{position:fixed;top:50%;left:50%;transform:translate(-50%, -50%) scale(0.8);background:var(--card);padding:32px;border-radius:12px;box-shadow:0 8px 32px rgba(0,0,0,0.2);border:1px solid rgba(0,0,0,0.08);z-index:10001;min-width:400px;max-width:90%;opacity:0;transition:all 0.3s ease;pointer-events:none;text-align:center}
    .notification-popup.show{opacity:1;transform:translate(-50%, -50%) scale(1);pointer-events:auto}
    .notification-popup .notification-icon{width:48px;height:48px;margin:0 auto 16px;font-size:3rem;display:flex;align-items:center;justify-content:center;line-height:1}
    .notification-popup .notification-message{font-size:1rem;color:var(--text-muted);margin-bottom:24px;line-height:1.5}
    .notification-popup .notification-button{display:flex;gap:12px;justify-content:center}
    .notification-popup .notification-btn{padding:10px 24px;border-radius:8px;font-weight:600;cursor:pointer;transition:all 0.2s ease;font-size:1rem;border:none;min-width:100px;background:var(--accent);color:#fff}
    .notification-popup .notification-btn:hover{background:#c66d52;transform:translateY(-1px);box-shadow:0 2px 8px rgba(217,133,102,0.3)}
    
    /* Backdrop overlay */
    .notification-backdrop{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.4);z-index:9999;opacity:0;transition:opacity 0.3s ease;pointer-events:none}
    .notification-backdrop.show{opacity:1;pointer-events:auto}
    
    /* Confirmation popup */
    .confirmation-popup{position:fixed;top:50%;left:50%;transform:translate(-50%, -50%) scale(0.8);background:var(--card);padding:32px;border-radius:12px;box-shadow:0 8px 32px rgba(0,0,0,0.2);border:1px solid rgba(0,0,0,0.08);z-index:10001;min-width:400px;max-width:90%;opacity:0;transition:all 0.3s ease;pointer-events:none;text-align:center}
    .confirmation-popup.show{opacity:1;transform:translate(-50%, -50%) scale(1);pointer-events:auto}
    .confirmation-popup .confirmation-icon{width:48px;height:48px;margin:0 auto 16px;font-size:3rem;display:flex;align-items:center;justify-content:center;line-height:1}
    .confirmation-popup .confirmation-title{font-size:1.3rem;font-weight:600;color:var(--text);margin-bottom:12px}
    .confirmation-popup .confirmation-message{font-size:1rem;color:var(--text-muted);margin-bottom:24px;line-height:1.5}
    .confirmation-popup .confirmation-buttons{display:flex;gap:12px;justify-content:center}
    .confirmation-popup .confirmation-btn{padding:10px 24px;border-radius:8px;font-weight:600;cursor:pointer;transition:all 0.2s ease;font-size:1rem;border:none;min-width:100px}
    .confirmation-popup .confirmation-btn-yes{background:var(--accent);color:#fff}
    .confirmation-popup .confirmation-btn-yes:hover{background:#c66d52;transform:translateY(-1px);box-shadow:0 2px 8px rgba(217,133,102,0.3)}
    .confirmation-popup .confirmation-btn-no{background:var(--bg);color:var(--text);border:1px solid rgba(0,0,0,0.1)}
    .confirmation-popup .confirmation-btn-no:hover{background:#f1f3f5;border-color:var(--accent)}
    
    /* Enhanced button group styling to match new accent color */
    .btn-group .btn{
      font-weight:600;
      border-radius:10px;
      padding:10px 20px;
      transition:all 0.2s ease;
    }
    .btn-group .btn-outline-primary{
      border-color:var(--accent);
      color:var(--accent);
      background:transparent;
    }
    .btn-group .btn-outline-primary:hover:not(.active){
      background:transparent;
      border-color:var(--accent);
      color:var(--accent);
      box-shadow:none;
    }
    .btn-group .btn.active{
      background:var(--accent);
      border-color:var(--accent);
      color:white;
      box-shadow:0 2px 8px rgba(217,133,102,0.3);
    }
    
    /* Enhanced form select styling - only apply to non-time-select selects */
    /* Time select has its own styling above */
    
    @media (max-width:768px){ 
      /* Increased mobile bottom margin and padding for taller footer */
      .main-content{margin-bottom:130px}
      .menu-col{padding:16px 12px;padding-bottom:140px}
      .header-section{padding:16px 12px}
      .cart-fixed{height:100px;padding:12px 0}
      .cart-content{padding:0 12px}
      .header h2{font-size:1.3rem}
      .controls{flex-direction:column;align-items:stretch;gap:8px;width:100%}
      .time-select{width:100%;min-width:100%;max-width:100%}
      .btn-group{width:100%}
      .btn-group .btn{flex:1}
      .controls .flex-grow-1{text-align:left;width:100%}
      /* Show horizontal category bar on mobile */
      .category-bar-horizontal{display:block}
    }
    
    /* Horizontal category bar for mobile */
    .category-bar-horizontal{
      display:none;
      background:var(--card);
      border-bottom:1px solid rgba(0,0,0,0.08);
      padding:12px 8px;
      overflow-x:auto;
      overflow-y:hidden;
      white-space:nowrap;
      position:sticky;
      top:0;
      z-index:99;
      -webkit-overflow-scrolling:touch;
    }
    .category-bar-horizontal::-webkit-scrollbar{
      display:none;
    }
    .category-bar-horizontal{
      -ms-overflow-style:none;
      scrollbar-width:none;
    }
    .category-pill-horizontal{
      display:inline-block;
      padding:8px 14px;
      border-radius:999px;
      background:#fff;
      margin-right:8px;
      border:1px solid rgba(0,0,0,0.08);
      cursor:pointer;
      font-size:0.85rem;
      font-weight:500;
      transition:all 0.2s ease;
      color:var(--text);
      white-space:nowrap;
      flex-shrink:0;
    }
    .category-pill-horizontal:hover{
      border-color:var(--accent);
      background:#fafafa;
    }
    .category-pill-horizontal.active{
      background:var(--accent);
      color:#fff;
      border-color:var(--accent);
      box-shadow:0 2px 8px rgba(217,133,102,0.2);
    }
    
    /* iPhone SE and small devices */
    @media (max-width:390px){
      body{overflow:hidden;height:100vh}
      .main-content{display:flex;flex-direction:column;height:100vh;margin-bottom:0;padding-top:0}
      .header-section{position:fixed;top:0;left:0;right:0;z-index:1000;background:var(--card);padding:12px 8px;border-bottom:1px solid rgba(0,0,0,0.08);box-shadow:0 2px 4px rgba(0,0,0,0.04)}
      /* Fixed category bar below header, above cart */
      .category-bar-horizontal{
        position:fixed;
        top:140px;
        left:0;
        right:0;
        z-index:999;
        background:var(--card);
        border-bottom:1px solid rgba(0,0,0,0.08);
        border-top:1px solid rgba(0,0,0,0.08);
        padding:10px 8px;
        display:block;
        box-shadow:0 2px 4px rgba(0,0,0,0.04);
      }
      /* Adjust layout wrapper to account for header (140px) + category bar (~55px) = 195px top, 90px cart bottom */
      .layout-wrapper{
        flex:1;
        min-height:0;
        overflow:hidden;
        display:flex;
        flex-direction:column;
        padding-top:0;
        margin-top:195px;
        height:calc(100vh - 285px)
      }
      .menu-col{padding:12px 8px;padding-bottom:20px;padding-top:12px}
      .header h2{font-size:1.15rem;margin-bottom:8px}
      .controls{flex-direction:column;align-items:stretch;gap:6px;width:100%}
      .time-select{width:100%;min-width:100%;max-width:100%}
      .time-select .form-select{
        font-size:14px;
        padding:8px 32px 8px 10px;
        width:100%;
        background-position:right 10px center;
        border-radius:6px;
      }
      .time-select .form-select option{
        color:var(--text);
        background:white;
      }
      .time-select .form-select option:disabled{
        color:rgba(34, 34, 34, 0.5);
        font-weight:500;
      }
      .btn-group{width:100%}
      .btn-group .btn{font-size:0.85rem;padding:8px 12px;flex:1}
      .controls .flex-grow-1{text-align:left;width:100%}
      .controls .flex-grow-1 small{font-size:0.75rem}
      .layout{display:flex;flex-direction:column;height:100%;min-height:0}
      /* Adjust menu col padding-top to account for fixed category bar */
      .menu-col{
        flex:1;
        overflow-y:auto;
        overflow-x:hidden;
        min-height:0;
        -webkit-overflow-scrolling:touch;
        padding-bottom:100px;
        padding-top:50px;
        height:100%
      }
      .menu-item{padding:12px;gap:10px}
      .menu-item img{width:80px;height:70px}
      .menu-item-title{font-size:1.1rem}
      .menu-item-price{font-size:1rem}
      .menu-item-description{font-size:0.8rem}
      .qty-controls button{width:36px;height:36px;font-size:1rem}
      .qty-display{min-width:36px;font-size:0.9rem}
      .btn-add{font-size:0.85rem;padding:6px 12px}
      .cart-fixed{height:90px;padding:10px 0;bottom:0;position:fixed}
      .cart-content{padding:0 8px;flex-wrap:wrap;gap:8px}
      .cart-total{font-size:1.1rem}
      .cart-total strong{font-size:1.1rem}
      #cartTotal{font-size:1.1rem}
      #checkoutBtn{font-size:0.85rem;padding:8px 16px;width:100%;min-height:44px}
      .menu-item-title{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
      .menu-item-description{overflow:hidden;text-overflow:ellipsis;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;white-space:normal}
      .time-select .form-select{min-height:44px}
      .btn-group .btn{min-height:44px}
      .qty-controls button{min-width:44px;min-height:44px}
      .btn-add{min-height:44px}
      .confirmation-popup{min-width:320px;padding:20px}
      .notification-popup{min-width:320px;padding:20px}
    }
  </style>
</head>
<body>
  <div class="main-content">
    <div class="header-section">
      <div class="header">
        <button class="btn btn-link" onclick="goBack()"><i class="bi bi-arrow-left"></i> Back</button>
        <h2 id="stallName"></h2>
      </div>

      <div class="controls">
        <div class="btn-group" role="group">
          <button id="dineBtn" class="btn btn-outline-primary active" onclick="setOption('Dine In')">Dine In</button>
          <button id="pickupBtn" class="btn btn-outline-primary" onclick="setOption('Takeaway')">Takeaway</button>
        </div>

        <div class="time-select">
          <select id="timeSelect" class="form-select" aria-label="Select pickup time"></select>
        </div>

        <div class="flex-grow-1 text-end">
          <small id="stallMeta" class="text-muted"></small>
        </div>
      </div>
    </div>

    <div class="category-bar-horizontal" id="categoryBarHorizontal" aria-label="Menu categories"></div>
    <div class="layout-wrapper">
      <div class="layout">
        <aside class="left-rail" id="categoryRail" aria-label="Menu categories"></aside>
        <main class="menu-col">
          <div id="menuContainer" class="menu-list"></div>
        </main>
      </div>
    </div>
  </div>

  <script>
    async function waitForDb(){
      if (typeof window.db !== 'undefined') {
        return;
      }
      const start = Date.now();
      while(typeof window.db==='undefined'){ 
        if(Date.now()-start>7000) break; 
        await new Promise(r=>setTimeout(r,50));
      }
    }

    let selectedOption = 'Dine In';
    let selectedTime = '';
    let currentStall = null;
    let menuItems = [];
    let cart = JSON.parse(localStorage.getItem('cart') || '[]');
    let isNavigating = false;
    let navigationDestination = null;

    function setOption(opt){
      selectedOption = opt;
      document.getElementById('dineBtn').classList.toggle('active', opt==='Dine In');
      document.getElementById('pickupBtn').classList.toggle('active', opt==='Takeaway');
      saveSession();
    }

    function formatTime(d){
      // Format as "9:00AM" (no space, 12-hour format)
      let hours = d.getHours();
      const minutes = d.getMinutes();
      const ampm = hours >= 12 ? 'PM' : 'AM';
      hours = hours % 12;
      hours = hours ? hours : 12; // the hour '0' should be '12'
      const minutesStr = minutes < 10 ? '0' + minutes : minutes;
      return `${hours}:${minutesStr}${ampm}`;
    }

    // Store the change handler function to avoid duplicate listeners
    let timeSelectChangeHandler = null;
    let timeSelectInitialized = false;

    function buildTimeOptions(shouldRestoreTime = false){
      const sel = document.getElementById('timeSelect');
      if (!sel) {
        console.log('timeSelect element not found');
        return;
      }
      
      // Restore saved time if explicitly requested (e.g., returning from checkout)
      let savedTime = '';
      if (shouldRestoreTime) {
        savedTime = selectedTime;
        if (!savedTime) {
          try {
            const session = JSON.parse(sessionStorage.getItem('orderSession') || '{}');
            savedTime = session.selectedTime || localStorage.getItem('selectedTime') || '';
          } catch (e) {
            savedTime = localStorage.getItem('selectedTime') || '';
          }
        }
      }
      
      // Remove old event listener if it exists
      if (timeSelectChangeHandler && timeSelectInitialized) {
        sel.removeEventListener('change', timeSelectChangeHandler);
      }
      
      // Clear existing options
      sel.innerHTML = '';
      
      // Add placeholder option
      const placeholderOption = document.createElement('option');
      placeholderOption.value = '';
      placeholderOption.textContent = 'Please select a time';
      placeholderOption.disabled = true;
      placeholderOption.selected = !savedTime;
      sel.appendChild(placeholderOption);
      
      // Add ASAP option
      const asapOption = document.createElement('option');
      asapOption.value = 'asap';
      asapOption.textContent = 'ASAP';
      if (savedTime === 'asap') {
        asapOption.selected = true;
        placeholderOption.selected = false;
      }
      sel.appendChild(asapOption);
      
      // Ensure placeholder is selected if no saved time
      if (!savedTime) {
        placeholderOption.selected = true;
      }
      
      // Add time intervals starting from current time
      const now = new Date();
      const currentMinutes = now.getMinutes();
      const remainder = (15 - (currentMinutes % 15)) % 15;
      const startTime = new Date(now);
      startTime.setMinutes(currentMinutes + remainder);
      
      // Generate options for the next 24 intervals (6 hours)
      for(let i=0;i<24;i++){
        const opt = new Date(startTime.getTime() + i*15*60000);
        const label = formatTime(opt);
        const timeOption = document.createElement('option');
        timeOption.value = opt.toISOString();
        timeOption.textContent = label;
        // Check if this option matches the saved time
        if (savedTime && savedTime === opt.toISOString()) {
          timeOption.selected = true;
          placeholderOption.selected = false;
        }
        sel.appendChild(timeOption);
      }
      
      // Create and add event listener for time selection (only once)
      if (!timeSelectInitialized) {
        timeSelectChangeHandler = function(){
          const currentSelect = document.getElementById('timeSelect');
          if (currentSelect) {
            selectedTime = currentSelect.value;
            saveSession();
          }
        };
        sel.addEventListener('change', timeSelectChangeHandler);
        timeSelectInitialized = true;
      }
      
      // Restore saved time if it exists
      if (savedTime) {
        selectedTime = savedTime;
        sel.value = savedTime;
        // If value didn't match exactly, try to find a close match
        if (sel.value !== savedTime && savedTime !== 'asap') {
          try {
            const savedDate = new Date(savedTime);
            if (!isNaN(savedDate.getTime())) {
              for (let option of sel.options) {
                if (option.value && option.value !== '') {
                  const optionDate = new Date(option.value);
                  if (!isNaN(optionDate.getTime())) {
                    const timeDiff = Math.abs(savedDate.getTime() - optionDate.getTime());
                    if (timeDiff < 15 * 60 * 1000) {
                      option.selected = true;
                      selectedTime = option.value;
                      sel.value = option.value;
                      saveSession();
                      break;
                    }
                  }
                }
              }
            }
          } catch (e) {
            // Ignore parse errors
          }
        }
      }
    }

    async function loadStallAndMenu(){
      await waitForDb();
      const slug = (new URL(location.href)).searchParams.get('slug') || sessionStorage.getItem('stallSlug') || '';
      if(!slug){ document.getElementById('menuContainer').innerHTML = '<div class="text-muted">No stall selected.</div>'; return; }

      const stallsRef = window.collection(window.db,'stalls');
      const q = window.query(stallsRef, window.where('slug','==',slug));
      const stallSnap = await window.getDocs(q);
      
      if(stallSnap.empty){ document.getElementById('menuContainer').innerHTML = '<div class="text-muted">Stall not found.</div>'; return; }
      const stallDoc = stallSnap.docs[0];
      currentStall = { id: stallDoc.id, ...stallDoc.data() };
      
      document.getElementById('stallName').textContent = currentStall.name || '';
      document.getElementById('stallMeta').textContent = `${currentStall.cuisine || ''} • ${currentStall.foodCentre || ''}`;
      
      // Check if returning from checkout - use flag (set by checkout when using history.back) or referrer
      const returningToStallFromCheckout = sessionStorage.getItem('returningToStallFromCheckout') === 'true';
      const isReturningFromCheckout = returningToStallFromCheckout || document.referrer.includes('checkout.html');
      
      // If returning from checkout or on refresh, ensure selectedTime is loaded
      if (!selectedTime) {
        if (isReturningFromCheckout) {
          // Clear the flag after using it
          if (returningToStallFromCheckout) {
            sessionStorage.removeItem('returningToStallFromCheckout');
          }
        }
        const savedSession = JSON.parse(sessionStorage.getItem('orderSession') || '{}');
        selectedTime = savedSession.selectedTime || localStorage.getItem('selectedTime') || '';
      }
      
      // Build time options (restore time if we have a saved time)
      const hasSavedTime = selectedTime && selectedTime !== '';
      buildTimeOptions(hasSavedTime);

      const menuRef = window.collection(window.db,'menuItems');
      const mq = window.query(menuRef, window.where('stallId','==',stallDoc.id));
      const msnap = await window.getDocs(mq);
      menuItems = msnap.docs.map(d=>({ id:d.id, ...d.data() })).sort((a,b)=> (a.category||'').localeCompare(b.category||''));
      
      if(menuItems.length===0){ 
        document.getElementById('menuContainer').innerHTML = '<div class="text-muted">No menu items</div>'; 
        return; 
      }

      renderMenuAndCategories();
    }

    function renderMenuAndCategories(){
      const categories = [...new Set(menuItems.map(m=>m.category || 'Others'))];
      const rail = document.getElementById('categoryRail');
      rail.innerHTML = categories.map((c,i)=>`<div class="category-pill ${i===0?'active':''}" data-cat="${c}" tabindex="0">${c}</div>`).join('');
      
      // Also populate horizontal category bar for mobile
      const horizontalBar = document.getElementById('categoryBarHorizontal');
      if(horizontalBar){
        horizontalBar.innerHTML = categories.map((c,i)=>`<div class="category-pill-horizontal ${i===0?'active':''}" data-cat="${c}" tabindex="0">${c}</div>`).join('');
      }
      
      const menuHtml = categories.map(cat=>{
        const items = menuItems.filter(m=> (m.category||'Others')===cat);
        return `<section class="menu-section" data-cat="${cat}">
          <h4>${cat}</h4>
          ${items.map(it=> `
            <div class="menu-item mb-3" data-id="${it.id}">
              <img src="${it.image||'/img/placeholder.svg'}" alt="${it.name}">
              <div class="menu-item-content">
                <div>
                  <div class="menu-item-header">
                    <p class="menu-item-title">${it.name}</p>
                    <div class="menu-item-price">$${(Number(it.price)||0).toFixed(2)}</div>
                    <p class="menu-item-description">${it.description||''}</p>
                  </div>
                  <div class="menu-item-status">${it.available === false ? 'Unavailable' : ''}</div>
                </div>
              </div>
              <div style="display:flex;align-items:center">
                ${ renderQtyControls(it.id) }
              </div>
            </div>
          `).join('')}
        </section>`;
      }).join('');
      document.getElementById('menuContainer').innerHTML = menuHtml;

      document.querySelectorAll('.category-pill').forEach(p=>{
        p.onclick = ()=> {
          document.querySelectorAll('.category-pill').forEach(x=>x.classList.remove('active'));
          document.querySelectorAll('.category-pill-horizontal').forEach(x=>x.classList.remove('active'));
          p.classList.add('active');
          const cat = p.dataset.cat;
          const horizontalPill = document.querySelector(`.category-pill-horizontal[data-cat="${CSS.escape(cat)}"]`);
          if(horizontalPill) horizontalPill.classList.add('active');
          const el = document.querySelector(`.menu-section[data-cat="${CSS.escape(cat)}"]`);
          if (el) el.scrollIntoView({behavior:'smooth',block:'start'});
        };
      });
      
      // Handle clicks on horizontal category pills
      document.querySelectorAll('.category-pill-horizontal').forEach(p=>{
        p.onclick = ()=> {
          document.querySelectorAll('.category-pill').forEach(x=>x.classList.remove('active'));
          document.querySelectorAll('.category-pill-horizontal').forEach(x=>x.classList.remove('active'));
          p.classList.add('active');
          const cat = p.dataset.cat;
          const railPill = document.querySelector(`.category-pill[data-cat="${CSS.escape(cat)}"]`);
          if(railPill) railPill.classList.add('active');
          const el = document.querySelector(`.menu-section[data-cat="${CSS.escape(cat)}"]`);
          if (el) el.scrollIntoView({behavior:'smooth',block:'start'});
        };
      });

      const menuCol = document.querySelector('.menu-col');
      const sections = document.querySelectorAll('.menu-section');
      
      // Function to update active category based on scroll position
      function updateActiveCategory() {
        const scrollTop = menuCol.scrollTop;
        const menuColRect = menuCol.getBoundingClientRect();
        const viewportTop = menuColRect.top;
        const scrollHeight = menuCol.scrollHeight;
        const clientHeight = menuCol.clientHeight;
        
        // Check if we're at the bottom
        const isAtBottom = scrollTop + clientHeight >= scrollHeight - 10;
        
        if (isAtBottom && sections.length > 0) {
          // At bottom, highlight last section
          const lastSection = sections[sections.length - 1];
          const cat = lastSection.dataset.cat;
          document.querySelectorAll('.category-pill').forEach(p => {
            p.classList.toggle('active', p.dataset.cat === cat);
          });
          document.querySelectorAll('.category-pill-horizontal').forEach(p => {
            p.classList.toggle('active', p.dataset.cat === cat);
          });
          return;
        }
        
        let activeSection = null;
        let bestSection = null;
        let bestDistance = Infinity;
        
        sections.forEach(section => {
          // Get section position relative to menu container
          const sectionTop = section.offsetTop;
          const sectionRect = section.getBoundingClientRect();
          
          // Calculate distance from section top to current scroll position
          const distanceFromScrollTop = scrollTop - sectionTop;
          
          // Check if section is visible in viewport
          const isVisible = sectionRect.top <= menuColRect.bottom && sectionRect.bottom >= menuColRect.top;
          
          if (isVisible) {
            // Calculate distance from section top to viewport top
            const distanceFromViewportTop = Math.abs(sectionRect.top - viewportTop);
            
            // Track the section closest to viewport top
            if (distanceFromViewportTop < bestDistance) {
              bestDistance = distanceFromViewportTop;
              bestSection = section;
            }
            
            // Prefer sections whose top is at or just above the scroll position
            if (sectionTop <= scrollTop + 50 && sectionTop >= scrollTop - 100) {
              if (!activeSection || sectionTop > activeSection.offsetTop) {
                activeSection = section;
              }
            }
          }
          
          // Also consider sections just above viewport
          if (sectionTop < scrollTop && sectionTop >= scrollTop - 200) {
            const distance = scrollTop - sectionTop;
            if (distance < bestDistance) {
              bestDistance = distance;
              bestSection = section;
            }
          }
        });
        
        // Use activeSection if found, otherwise use bestSection
        const finalSection = activeSection || bestSection;
        
        if (finalSection) {
          const cat = finalSection.dataset.cat;
          document.querySelectorAll('.category-pill').forEach(p => {
            p.classList.toggle('active', p.dataset.cat === cat);
          });
          document.querySelectorAll('.category-pill-horizontal').forEach(p => {
            p.classList.toggle('active', p.dataset.cat === cat);
          });
        }
      }
      
      // Use IntersectionObserver for better performance
      const observer = new IntersectionObserver(entries => {
        updateActiveCategory();
      }, {
        root: menuCol,
        rootMargin: '-80px 0px -60% 0px',
        threshold: [0, 0.1, 0.25, 0.5, 0.75, 1]
      });

      sections.forEach(s => observer.observe(s));
      
      // Throttled scroll handler for better performance
      let scrollTimeout;
      menuCol.addEventListener('scroll', () => {
        clearTimeout(scrollTimeout);
        scrollTimeout = setTimeout(updateActiveCategory, 50);
      });
      
      // Initial update
      updateActiveCategory();
    }

    function renderQtyControls(itemId){
      const item = menuItems.find(x=>x.id===itemId);
      const cartItem = cart.find(c=>c.id===itemId);
      const qty = cartItem ? cartItem.qty : 0;
      if (item.available === false) return `<button class="btn btn-secondary" disabled>Sold out</button>`;
      if (qty>0){
        return `
          <div class="qty-controls">
            <button class="qty-minus" onclick="changeQty('${itemId}',-1)">−</button>
            <div class="qty-display">${qty}</div>
            <button class="qty-plus" onclick="changeQty('${itemId}',1)">+</button>
          </div>
        `;
      } else {
        return `<button class="btn-add" onclick="addToCart('${itemId}')">Add to Cart</button>`;
      }
    }

    function addToCart(itemId){
      const it = menuItems.find(m=>m.id===itemId);
      if(!it) return;
      const existing = cart.find(c=>c.id===itemId);
      if(existing) existing.qty++;
      else cart.push({ id: itemId, name: it.name, price: Number(it.price)||0, qty: 1, image: it.image||'' });
      persistCartAndRerender();
    }

    function changeQty(itemId, delta){
      const ex = cart.find(c=>c.id===itemId);
      if(!ex) return;
      ex.qty += delta;
      if(ex.qty <= 0) cart = cart.filter(c=>c.id!==itemId);
      persistCartAndRerender();
    }

    function persistCartAndRerender(){
      localStorage.setItem('cart', JSON.stringify(cart));
      renderMenuAndCategories();
      updateCartUI();
    }

    function updateCartUI(){
      const total = cart.reduce((s,i)=>s+i.price*i.qty,0);
      document.querySelectorAll('#cartTotal').forEach(el=>el.textContent = '$' + total.toFixed(2));
      const btn = document.getElementById('checkoutBtn');
      if(btn) btn.disabled = cart.length === 0;
    }

    function saveSession(){
      const session = { 
        option: selectedOption, 
        selectedTime, 
        stallId: currentStall?.id || '', 
        stallSlug: currentStall?.slug || '',
        foodCentre: currentStall?.foodCentre || sessionStorage.getItem('selectedFoodCentre') || ''
      };
      sessionStorage.setItem('orderSession', JSON.stringify(session));
      localStorage.setItem('cart', JSON.stringify(cart));
      if (selectedTime) {
        localStorage.setItem('selectedTime', selectedTime);
      }
      if (currentStall) {
        localStorage.setItem('stallName', currentStall.name || '');
        localStorage.setItem('stallSlug', currentStall.slug || '');
        localStorage.setItem('stallId', currentStall.id || '');
        // Save food centre for navigation back to online-order-home
        if (currentStall.foodCentre) {
          sessionStorage.setItem('selectedFoodCentre', currentStall.foodCentre);
        }
      }
    }

    function showConfirmation(onConfirm, title = 'Leave Page?', message = 'All changes will be discarded. Your cart will be cleared. Do you want to leave?') {
      const confirmation = document.getElementById('confirmationPopup');
      const backdrop = document.getElementById('notificationBackdrop');
      
      // Update title and message
      const titleEl = confirmation.querySelector('.confirmation-title');
      const messageEl = confirmation.querySelector('.confirmation-message');
      if (titleEl) titleEl.textContent = title;
      if (messageEl) messageEl.textContent = message;
      
      backdrop.classList.add('show');
      confirmation.classList.add('show');
      
      // Store the confirm callback
      window.confirmCallback = onConfirm;
    }
    
    function hideConfirmation() {
      const confirmation = document.getElementById('confirmationPopup');
      const backdrop = document.getElementById('notificationBackdrop');
      confirmation.classList.remove('show');
      backdrop.classList.remove('show');
      window.confirmCallback = null;
    }
    
    function confirmLeave() {
      hideConfirmation();
      
      // Clear cart and time completely (both localStorage and sessionStorage)
      cart = [];
      localStorage.setItem('cart', JSON.stringify(cart));
      selectedTime = '';
      localStorage.removeItem('selectedTime');
      
      // Clear from sessionStorage as well
      const session = JSON.parse(sessionStorage.getItem('orderSession') || '{}');
      session.selectedTime = '';
      sessionStorage.setItem('orderSession', JSON.stringify(session));
      
      // Set navigation flag immediately
      isNavigating = true;
      
      // Save food centre before navigating
      if (currentStall?.foodCentre) {
        sessionStorage.setItem('selectedFoodCentre', currentStall.foodCentre);
        sessionStorage.setItem('navigatedToStall', 'true');
      }
      
      // Navigate directly based on destination
      if (navigationDestination === 'online-order-home') {
        navigationDestination = null;
        window.location.href = 'online-order-home.html';
        return;
      }
      
      // Execute callback for other cases (like popstate)
      if (window.confirmCallback) {
        const callback = window.confirmCallback;
        window.confirmCallback = null;
        callback();
      }
    }
    
    function cancelLeave() {
      hideConfirmation();
      navigationDestination = null;
    }
    
    function goBack() {
      const hasItems = cart && cart.length > 0;

      if (hasItems) {
        // Set destination so confirmLeave knows where to navigate
        navigationDestination = 'online-order-home';
        showConfirmation(() => {
          // This callback is a fallback, but confirmLeave will handle navigation directly
          if (currentStall?.foodCentre) {
            sessionStorage.setItem('selectedFoodCentre', currentStall.foodCentre);
            sessionStorage.setItem('navigatedToStall', 'true');
          }
          window.location.href = 'online-order-home.html';
        });
      } else {
        // Ensure food centre is saved before navigating
        if (currentStall?.foodCentre) {
          sessionStorage.setItem('selectedFoodCentre', currentStall.foodCentre);
          sessionStorage.setItem('navigatedToStall', 'true');
        }
        // Clear time and cart completely when going back
        selectedTime = '';
        localStorage.removeItem('selectedTime');
        cart = [];
        localStorage.setItem('cart', JSON.stringify(cart));
        
        // Clear from sessionStorage as well
        const session = JSON.parse(sessionStorage.getItem('orderSession') || '{}');
        session.selectedTime = '';
        sessionStorage.setItem('orderSession', JSON.stringify(session));
        
        isNavigating = true;
        window.location.href = 'online-order-home.html';
      }
    }

    window.addToCart = addToCart;
    window.changeQty = changeQty;
    window.setOption = setOption;
    window.goBack = goBack;
    window.confirmLeave = confirmLeave;
    window.cancelLeave = cancelLeave;

    function showNotification(message) {
      const notification = document.getElementById('notificationPopup');
      const backdrop = document.getElementById('notificationBackdrop');
      const messageEl = document.getElementById('notificationMessage');
      messageEl.textContent = message;
      backdrop.classList.add('show');
      notification.classList.add('show');
      
      // Auto-hide after 5 seconds
      setTimeout(() => {
        hideNotification();
      }, 5000);
    }
    
    function hideNotification() {
      const notification = document.getElementById('notificationPopup');
      const backdrop = document.getElementById('notificationBackdrop');
      notification.classList.remove('show');
      backdrop.classList.remove('show');
    }
    
    function goToCheckout(){
      // Set navigation flag immediately to prevent any prompts
      isNavigating = true;
      
      // Check if time has been selected
      const timeSelect = document.getElementById('timeSelect');
      const selectedTimeValue = timeSelect ? timeSelect.value : '';
      
      if (!selectedTimeValue || selectedTimeValue === '') {
        // Reset flag if validation fails
        isNavigating = false;
        showNotification('Please select a time before proceeding to checkout.');
        if (timeSelect) timeSelect.focus();
        return;
      }
      
      // Sync selectedTime with dropdown value before saving
      selectedTime = selectedTimeValue;
      saveSession();
      window.location.href = 'checkout.html';
    }
    
    window.goToCheckout = goToCheckout;
    window.hideNotification = hideNotification;

    // Removed beforeunload handler - no refresh alerts, page remains the same on refresh
    
    window.addEventListener("popstate", () => {
      const hasItems = cart && cart.length > 0;
      
      // Only intercept if we have items and not already navigating
      if (hasItems && !isNavigating) {
        // Push state back to stay on current page
        history.pushState(null, null, window.location.href);
        
        navigationDestination = null;
        
        // Show confirmation
        showConfirmation(() => {
          // Navigate back - isNavigating is already set in confirmLeave
          history.back();
        });
      }
    });

    (async ()=>{
      const savedSession = JSON.parse(sessionStorage.getItem('orderSession') || '{}');
      if (savedSession.option) {
        selectedOption = savedSession.option;
        setOption(selectedOption);
      }
      
      // Check if returning from checkout - use flag (set by checkout when using history.back) or referrer
      const returningToStallFromCheckout = sessionStorage.getItem('returningToStallFromCheckout') === 'true';
      const isReturningFromCheckout = returningToStallFromCheckout || document.referrer.includes('checkout.html');
      
      // Check if coming from online-order-home (should clear time)
      const comingFromOnlineOrder = document.referrer.includes('online-order-home.html');
      
      // Load selectedTime - restore on refresh or when returning from checkout, but not when coming from online-order-home
      if (comingFromOnlineOrder) {
        // Coming from online-order-home - clear time
        selectedTime = '';
        sessionStorage.setItem('orderSession', JSON.stringify({...savedSession, selectedTime: ''}));
        localStorage.removeItem('selectedTime');
      } else if (isReturningFromCheckout) {
        // Returning from checkout - restore time
        // Clear the flag after using it
        if (returningToStallFromCheckout) {
          sessionStorage.removeItem('returningToStallFromCheckout');
        }
        
        if (savedSession.selectedTime) {
          selectedTime = savedSession.selectedTime;
        } else {
          const savedTime = localStorage.getItem('selectedTime');
          if (savedTime) {
            selectedTime = savedTime;
          }
        }
      } else {
        // Page refresh or other navigation - restore saved time if it exists
        if (savedSession.selectedTime) {
          selectedTime = savedSession.selectedTime;
        } else {
          const savedTime = localStorage.getItem('selectedTime');
          if (savedTime) {
            selectedTime = savedTime;
          }
        }
      }
      
      // Build time options - restore time if we have a saved time (refresh or returning from checkout)
      const hasSavedTime = selectedTime && selectedTime !== '';
      buildTimeOptions(hasSavedTime);
      
      loadStallAndMenu().then(() => {
        cart = JSON.parse(localStorage.getItem('cart') || '[]');
        updateCartUI();
        // Restore time if we have a saved time (on refresh or returning from checkout)
        if (selectedTime) {
          setTimeout(() => {
            const savedSession = JSON.parse(sessionStorage.getItem('orderSession') || '{}');
            const savedTime = savedSession.selectedTime || localStorage.getItem('selectedTime');
            if (savedTime) {
              selectedTime = savedTime;
              const timeSelect = document.getElementById('timeSelect');
              if (timeSelect) {
                timeSelect.value = savedTime;
                // If value didn't match exactly, try to find a close match
                if (timeSelect.value !== savedTime && savedTime !== 'asap') {
                  try {
                    const savedDate = new Date(savedTime);
                    if (!isNaN(savedDate.getTime())) {
                      for (let option of timeSelect.options) {
                        if (option.value && option.value !== '') {
                          const optionDate = new Date(option.value);
                          if (!isNaN(optionDate.getTime())) {
                            const timeDiff = Math.abs(savedDate.getTime() - optionDate.getTime());
                            if (timeDiff < 15 * 60 * 1000) {
                              option.selected = true;
                              selectedTime = option.value;
                              timeSelect.value = option.value;
                              saveSession();
                              break;
                            }
                          }
                        }
                      }
                    }
                  } catch (e) {
                    // Ignore parse errors
                  }
                }
              }
            }
          }, 100);
        } else {
          // First visit - ensure no time is selected
          selectedTime = '';
          const timeSelect = document.getElementById('timeSelect');
          if (timeSelect) {
            timeSelect.value = '';
          }
        }
      });
    })();
  </script>

  <div class="cart-fixed">
    <div class="cart-content">
      <div class="cart-total">
        <strong>Cart Total:</strong> 
        <span id="cartTotal">$0.00</span>
      </div>
      <div class="checkout-section">
        <button id="checkoutBtn" onclick="goToCheckout()" disabled>View Cart & Checkout</button>
      </div>
    </div>
  </div>

  <!-- Notification Backdrop (shared for both notification and confirmation) -->
  <div id="notificationBackdrop" class="notification-backdrop" onclick="hideNotification(); cancelLeave();"></div>
  
  <!-- Notification Popup -->
  <div id="notificationPopup" class="notification-popup">
    <div class="notification-icon">⚠️</div>
    <div class="notification-message" id="notificationMessage">Please select a time before proceeding to checkout.</div>
    <div class="notification-button">
      <button class="notification-btn" onclick="hideNotification()">OK</button>
    </div>
  </div>

  <!-- Confirmation Popup -->
  <div id="confirmationPopup" class="confirmation-popup">
    <div class="confirmation-icon">⚠️</div>
    <div class="confirmation-title">Leave Page?</div>
    <div class="confirmation-message">All changes will be discarded. Your cart will be cleared. Do you want to leave?</div>
    <div class="confirmation-buttons">
      <button class="confirmation-btn confirmation-btn-yes" onclick="confirmLeave()">Yes</button>
      <button class="confirmation-btn confirmation-btn-no" onclick="cancelLeave()">No</button>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
