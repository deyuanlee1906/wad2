<!-- /pages/order/stall.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Stall — Menu</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet" />
  <script type="module" src="/scripts/firebaseauth.js"></script>

  <style>
    :root{--bg:#f8f9fa;--card:#fff;--accent:#d98566}
    body{background:var(--bg);margin:0;padding-top:70px;padding-bottom:140px;font-family:Inter,system-ui}
    @media (max-width:768px){ body{padding-top:0;padding-bottom:140px} }
    .container{max-width:1200px;padding:18px;margin:0 auto}
    .header{display:flex;align-items:center;gap:12px;margin-bottom:12px}
    .header h2{margin:0;font-size:1.25rem}
    .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:12px}
    .time-select{min-width:160px}
    .layout{display:grid;grid-template-columns: 220px 1fr; gap:18px}
    @media (max-width:767px){ .layout { grid-template-columns: 1fr; } .left-rail{order:2} .menu-col{order:1} }
    .left-rail{position:sticky;top:82px;height:calc(100vh - 170px);overflow:auto;padding-right:8px}
    @media (max-width:768px){ .left-rail{top:12px} }
    .category-pill{padding:8px 12px;border-radius:999px;background:#fff;margin-bottom:8px;display:block;border:1px solid rgba(0,0,0,0.06);cursor:pointer}
    .category-pill.active{background:var(--accent);color:#fff;border-color:var(--accent)}
    .menu-list{padding:10px}
    .menu-section{margin-bottom:18px}
    .menu-item{display:flex;gap:12px;background:var(--card);padding:12px;border-radius:10px;align-items:center;border:1px solid rgba(0,0,0,0.04)}
    .menu-item img{width:90px;height:70px;object-fit:cover;border-radius:8px}
    .qty-controls{display:flex;align-items:center;gap:6px}
    .qty-controls button{width:34px;height:34px;border-radius:6px;border:1px solid rgba(0,0,0,0.08);background:#fff}
    .cart-fixed{position:fixed;bottom:0;left:0;right:0;background:#fff;padding:12px;border-top:1px solid #ddd;z-index:1000}
    @media (max-width:375px){
      .layout{grid-template-columns:1fr}
      .left-rail{height:auto;position:relative;display:flex;overflow:auto;padding-bottom:8px;gap:6px}
      .category-pill{white-space:nowrap}
      .menu-item img{width:70px;height:60px}
      .qty-controls button{width:30px;height:30px}
      .time-select{min-width:120px}
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <button class="btn btn-link" onclick="history.back()"><i class="bi bi-arrow-left"></i> Back</button>
      <h2 id="stallName">Loading...</h2>
    </div>

    <div class="controls">
      <div class="btn-group" role="group">
        <button id="dineBtn" class="btn btn-outline-primary active" onclick="setOption('Dine In')">Dine In</button>
        <button id="pickupBtn" class="btn btn-outline-primary" onclick="setOption('Takeaway')">Takeaway</button>
      </div>

      <div class="time-select">
        <select id="timeSelect" class="form-select"></select>
      </div>

      <div class="flex-grow-1 text-end">
        <small id="stallMeta" class="text-muted"></small>
      </div>
    </div>

    <div class="layout">
      <aside class="left-rail" id="categoryRail" aria-label="Menu categories"></aside>

      <main class="menu-col">
        <div id="menuContainer" class="menu-list">Loading menu...</div>
      </main>
    </div>
  </div>

  <script>
    // Keep firebase logic intact
    async function waitForDb(){
      const start = Date.now();
      while(typeof window.db==='undefined'){ if(Date.now()-start>7000) break; await new Promise(r=>setTimeout(r,100)); }
    }

    // session/cart
    let selectedOption = 'Dine In';
    let selectedTime = '';
    let currentStall = null;
    let menuItems = []; // array of menu objects with category property
    let cart = JSON.parse(localStorage.getItem('cart') || '[]');

    function setOption(opt){
      selectedOption = opt;
      document.getElementById('dineBtn').classList.toggle('active', opt==='Dine In');
      document.getElementById('pickupBtn').classList.toggle('active', opt==='Takeaway');
      saveSession();
    }

    function formatTime(d){
      return d.toLocaleTimeString([], {hour:'numeric',minute:'2-digit'});
    }

    function buildTimeOptions(){
      const sel = document.getElementById('timeSelect');
      sel.innerHTML = '';
      const now = new Date();
      // round to next 15 min
      const remainder = (15 - (now.getMinutes() % 15)) % 15;
      now.setMinutes(now.getMinutes() + remainder);
      for(let i=0;i<24;i++){
        const opt = new Date(now.getTime() + i*15*60000);
        const label = formatTime(opt);
        sel.innerHTML += `<option value="${opt.toISOString()}">${label}</option>`;
      }
      sel.addEventListener('change', ()=>{ selectedTime = sel.value; saveSession(); });
      // default to first option (ASAP)
      selectedTime = sel.value || sel.options[0]?.value || '';
    }

    async function loadStallAndMenu(){
      await waitForDb();
      const slug = (new URL(location.href)).searchParams.get('slug') || sessionStorage.getItem('stallSlug') || '';
      if(!slug){ document.getElementById('menuContainer').innerHTML = '<div class="text-muted">No stall selected.</div>'; return; }

      // query stall doc by slug
      const stallsRef = window.collection(db,'stalls');
      const q = window.query(stallsRef, window.where('slug','==',slug));
      const snap = await window.getDocs(q);
      if(snap.empty){ document.getElementById('menuContainer').innerHTML = '<div class="text-muted">Stall not found.</div>'; return; }
      const stallDoc = snap.docs[0];
      currentStall = { id: stallDoc.id, ...stallDoc.data() };
      document.getElementById('stallName').textContent = currentStall.name || '';
      document.getElementById('stallMeta').textContent = `${currentStall.cuisine || ''} • ${currentStall.location || ''}`;

      // load menuItems collection filtered by stallId
      const menuRef = window.collection(db,'menuItems');
      const mq = window.query(menuRef, window.where('stallId','==',stallDoc.id));
      const msnap = await window.getDocs(mq);
      menuItems = msnap.docs.map(d=>({ id:d.id, ...d.data() })).sort((a,b)=> (a.category||'').localeCompare(b.category||''));
      if(menuItems.length===0){ document.getElementById('menuContainer').innerHTML = '<div class="text-muted">No menu items</div>'; return; }

      renderMenuAndCategories();
      buildTimeOptions();
    }

    // render categories + menu with scroll-spy behavior
    function renderMenuAndCategories(){
      // categories unique order
      const categories = [...new Set(menuItems.map(m=>m.category || 'Others'))];
      const rail = document.getElementById('categoryRail');
      rail.innerHTML = categories.map((c,i)=>`<div class="category-pill ${i===0?'active':''}" data-cat="${c}" tabindex="0">${c}</div>`).join('');
      // menu sections
      const menuHtml = categories.map(cat=>{
        const items = menuItems.filter(m=> (m.category||'Others')===cat);
        return `<section class="menu-section" data-cat="${cat}">
          <h4 style="margin-bottom:10px">${cat}</h4>
          ${items.map(it=> `
            <div class="menu-item mb-2" data-id="${it.id}">
              <img src="${it.image||'/img/placeholder.svg'}" alt="${it.name}">
              <div style="flex:1">
                <div class="d-flex justify-content-between align-items-start">
                  <div><strong>${it.name}</strong><div class="text-muted small">${it.description||''}</div></div>
                  <div class="text-primary fw-semibold">$${(Number(it.price)||0).toFixed(2)}</div>
                </div>
                <div class="text-muted small">${it.available? '': 'Unavailable'}</div>
              </div>
              <div class="qty-controls">
                ${ renderQtyControls(it.id) }
              </div>
            </div>
          `).join('')}
        </section>`;
      }).join('');
      document.getElementById('menuContainer').innerHTML = menuHtml;

      // wire category click (scroll to section)
      document.querySelectorAll('.category-pill').forEach(p=>{
        p.onclick = ()=> {
          document.querySelectorAll('.category-pill').forEach(x=>x.classList.remove('active'));
          p.classList.add('active');
          const cat = p.dataset.cat;
          const el = document.querySelector(`.menu-section[data-cat="${CSS.escape(cat)}"]`);
          if (el) el.scrollIntoView({behavior:'smooth',block:'start'});
        };
      });

      // attach quantity button handlers
      document.querySelectorAll('.menu-item').forEach(mi=>{
        const id = mi.dataset.id;
        mi.querySelectorAll('.btn-add, .btn-light, .qty-plus, .qty-minus').forEach(()=>{}); // noop just ensure elements exist
      });

      // IntersectionObserver for highlight
      const observer = new IntersectionObserver(entries=>{
        entries.forEach(en=>{
          if(en.isIntersecting){
            const cat = en.target.dataset.cat;
            document.querySelectorAll('.category-pill').forEach(p=>p.classList.toggle('active', p.dataset.cat===cat));
          }
        });
      }, {root: document.querySelector('.menu-col'), rootMargin: '0px 0px -60% 0px', threshold: 0.1});

      document.querySelectorAll('.menu-section').forEach(s=>observer.observe(s));
    }

    // returns current qty controls HTML for item
    function renderQtyControls(itemId){
      const item = menuItems.find(x=>x.id===itemId);
      const cartItem = cart.find(c=>c.id===itemId);
      const qty = cartItem ? cartItem.qty : 0;
      if (!item.available) return `<button class="btn btn-secondary" disabled>Sold out</button>`;
      if (qty>0){
        return `
          <button class="qty-minus" onclick="changeQty('${itemId}',-1)">−</button>
          <div style="min-width:26px;text-align:center">${qty}</div>
          <button class="qty-plus" onclick="changeQty('${itemId}',1)">+</button>
        `;
      } else {
        return `<button class="btn btn-primary btn-add" onclick="addToCart('${itemId}')">Add</button>`;
      }
    }

    function addToCart(itemId){
      const it = menuItems.find(m=>m.id===itemId);
      if(!it) return;
      const existing = cart.find(c=>c.id===itemId);
      if(existing) existing.qty++;
      else cart.push({ id: itemId, name: it.name, price: Number(it.price)||0, qty: 1, image: it.image||'' });
      persistCartAndRerender();
    }

    function changeQty(itemId, delta){
      const ex = cart.find(c=>c.id===itemId);
      if(!ex) return;
      ex.qty += delta;
      if(ex.qty <= 0) cart = cart.filter(c=>c.id!==itemId);
      persistCartAndRerender();
    }

    function persistCartAndRerender(){
      localStorage.setItem('cart', JSON.stringify(cart));
      // re-render only qty controls for performance — simplified: re-render whole menu for correctness
      renderMenuAndCategories();
      updateCartUI();
    }

    function updateCartUI(){
      const total = cart.reduce((s,i)=>s+i.price*i.qty,0);
      document.querySelectorAll('#cartTotal').forEach(el=>el.textContent = '$' + total.toFixed(2));
      // checkout button will be placed in fixed bar
      const btn = document.getElementById('checkoutBtn');
      if(btn) btn.disabled = cart.length === 0;
    }

    function saveSession(){
      const session = { option: selectedOption, selectedTime, stallId: currentStall?.id || '' };
      sessionStorage.setItem('orderSession', JSON.stringify(session));
      localStorage.setItem('cart', JSON.stringify(cart));
    }

    // expose functions to window so inline onclick can call them
    window.addToCart = addToCart;
    window.changeQty = changeQty;
    window.setOption = setOption;

    // checkout: save and navigate to checkout page
    function goToCheckout(){
      saveSession();
      window.location.href = '/pages/order/checkout.html';
    }
    window.goToCheckout = goToCheckout;

    // init
    (async ()=>{ buildTimeOptions(); await loadStallAndMenu(); updateCartUI(); })();
  </script>

  <!-- fixed cart area -->
  <div class="cart-fixed">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <div><strong>Cart Total:</strong> <span id="cartTotal">$0.00</span></div>
      <div style="width:240px;text-align:right">
        <button id="checkoutBtn" class="btn btn-success" onclick="goToCheckout()" disabled>View Cart & Checkout</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Bottom Nav -->
  <div class="nav-bar">
    <a href="/" class="nav-logo"><i class="bi bi-shop"></i>ChopeLah</a>
    <div class="nav-items">
      <button class="active" onclick="location.href='/pages/order/online-order-home.html'"><i class="bi bi-cart3"></i><span>Order</span></button>
      <button onclick="location.href='/pages/community/community.html'"><i class="bi bi-people"></i><span>Community</span></button>
      <button onclick="location.href='/pages/chope/chope.html'"><i class="bi bi-bookmark"></i><span>Chope</span></button>
      <button onclick="location.href='/pages/crowd/crowd-view.html'"><i class="bi bi-eye"></i><span>Crowd View</span></button>
    </div>
    <div class="nav-right">
      <button class="notification-btn" onclick="alert('No new notifications')">
        <i class="bi bi-bell"></i>
        <span class="notification-badge">3</span>
      </button>
      <button onclick="location.href='/pages/profile/profile.html'"><i class="bi bi-person"></i><span>Profile</span></button>
    </div>
  </div>
</body>
</html>
