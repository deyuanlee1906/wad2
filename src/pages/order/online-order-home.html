<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Online Order - Select Stall</title>

  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet" />

  <!-- Custom styles -->
  <link rel="stylesheet" href="/styles/main.css" />
  <link rel="stylesheet" href="/styles/components.css" />

  <!-- Firebase -->
  <script type="module" src="/scripts/firebaseauth.js"></script>

  <style>
    :root {
      --clr-cloud: #f8f9fa;
      --clr-ink: #222;
      --clr-sand: #f1f3f5;
      --clr-green: #28a745;
      --clr-red: #dc3545;
    }

    body {
      color: var(--clr-ink);
      background: var(--clr-cloud);
      margin: 0;
      padding-top: 70px;
      padding-bottom: 100px;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      overflow-x: hidden;
    }
    
    @media (max-width: 768px) {
      body {
        padding-top: 0;
        padding-bottom: 100px;
      }
    }

    .main-content {
      padding: 0 20px;
      width: 100%;
      box-sizing: border-box;
      max-width: 1400px;
      margin: 0 auto;
    }

    .location-header {
      display: flex;
      align-items: center;
      gap: 6px;
      font-weight: 700;
      margin: 16px 0 8px;
    }

    .search-wrap {
      position: relative;
      margin-bottom: 16px;
    }

    .search-bar {
      border: none;
      border-bottom: 1px solid var(--clr-ink);
      padding-right: 36px;
      background: transparent;
      color: var(--clr-ink);
    }

    .search-clear {
      position: absolute;
      right: 6px;
      top: 50%;
      transform: translateY(-50%);
      border: none;
      background: transparent;
      color: var(--clr-ink);
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }

    .stall-list-title {
      font-size: 1.3em;
      font-weight: 700;
      margin: 24px 0 16px;
    }

    /* Grid Layout */
    #availableStalls, #closedStalls {
      display: grid;
      gap: 16px;
    }

    @media (min-width: 768px) {
      #availableStalls, #closedStalls {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (min-width: 992px) {
      #availableStalls, #closedStalls {
        grid-template-columns: repeat(3, 1fr);
        gap: 24px;
      }
    }

    @media (min-width: 1200px) {
      #availableStalls, #closedStalls {
        gap: 32px;
      }
    }

    /* Stall Card */
    .stall-card {
      background: #fff;
      border: 1px solid rgba(38,38,38,0.12);
      border-radius: 12px;
      display: flex;
      gap: 12px;
      padding: 16px;
      box-shadow: 0 2px 8px rgba(38,38,38,0.08);
      transition: all 0.3s ease;
      align-items: flex-start;
      cursor: pointer;
    }

    .stall-card:hover {
      box-shadow: 0 4px 16px rgba(38,38,38,0.12);
      transform: translateY(-2px);
    }

    #closedStalls .stall-card {
      opacity: 0.7;
      background: var(--clr-cloud);
    }

    #closedStalls .stall-card:hover {
      opacity: 0.85;
      border-color: var(--clr-red);
    }

    .stall-img-wrap {
      width: 100px;
      height: 140px;
      border-radius: 10px;
      overflow: hidden;
      flex-shrink: 0;
      box-shadow: 0 2px 8px rgba(38,38,38,0.1);
    }

    .stall-img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 10px;
      border: 2px solid var(--clr-cloud);
      transition: transform 0.3s ease, border-color 0.3s ease;
    }

    .stall-card:hover .stall-img {
      transform: scale(1.02);
      border-color: var(--clr-sand);
    }

    .stall-info {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    .stall-info b {
      font-weight: 600;
      font-size: 1.1em;
    }

    .stall-info small {
      font-size: 0.9em;
      opacity: 0.9;
    }

    .stall-meta {
      margin-top: 6px;
      font-size: 0.85em;
      opacity: 0.8;
      border-top: 1px solid rgba(38,38,38,0.1);
      padding-top: 3px;
    }

    .status-dot {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 6px;
    }

    .status-open { background: var(--clr-green); }
    .status-closed { background: var(--clr-red); }

    .stars { color: #FFC107; }

    /* Mobile Adjustments */
    @media (max-width: 767px) {
      body { padding-bottom: 120px; }
      .main-content { padding: 0 16px; }
      .stall-card { height: 160px; }
      .stall-img-wrap { width: 90px; height: 130px; }
    }

  </style>
</head>

<body>
  <div class="main-content">
    <div class="location-header">
      <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="#000" class="me-1" viewBox="0 0 16 16">
        <path d="M8 16s6-5.686 6-10A6 6 0 1 0 2 6c0 4.314 6 10 6 10Zm0-8a2 2 0 1 1 0-4 2 2 0 0 1 0 4Z"/>
      </svg>
      <span id="foodCentreLocation">Maxwell Food Centre</span>
    </div>

    <div class="search-wrap">
      <input type="text" id="stallSearch" class="form-control search-bar" placeholder="Search for a stall/food">
      <button id="clearSearch" class="search-clear" type="button">&times;</button>
    </div>

    <div class="stall-list-title">Available Stalls</div>
    <div id="availableStalls" aria-live="polite"></div>

    <div class="stall-list-title mt-4">Closed Stalls</div>
    <div id="closedStalls" aria-live="polite"></div>
  </div>

  <!-- Firebase + Stall Logic -->
  <script>
    async function waitForDb(timeout = 5000) {
      const start = Date.now();
      while (typeof window.db === 'undefined') {
        if (Date.now() - start > timeout) throw new Error('Firestore not available');
        await new Promise(r => setTimeout(r, 100));
      }
    }

    const toSlug = s => String(s||'').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');

    function statusDot(open) {
      return `<span class="status-dot ${open ? 'status-open' : 'status-closed'}"></span>${open ? 'Open' : 'Closed'}`;
    }

    function stars(r) {
      const full = Math.max(0, Math.min(5, Math.round(Number(r)||0)));
      return `<span class="stars">${'â˜…'.repeat(full)}</span>`;
    }

    function showClosedStallPopup(name){ alert(name + ' is currently closed.'); }

    let stalls = [];
    let loaded = false;

    function renderStalls(filter='') {
      if (!loaded) {
        document.getElementById('availableStalls').innerHTML = '<div class="text-muted">Loading stalls...</div>';
        return;
      }
      const q = filter.trim().toLowerCase();
      const filtered = q
        ? stalls.filter(s => s.name.toLowerCase().includes(q) || s.cuisine.toLowerCase().includes(q))
        : stalls;

      const available = filtered.filter(s => s.status.toLowerCase() === 'open');
      const closed = filtered.filter(s => s.status.toLowerCase() === 'closed');

      const makeCard = s => `
        <div class="stall-card" data-slug="${s.slug}">
          <div class="stall-img-wrap">
            <img class="stall-img" src="${s.image || '/img/stall1.jpg'}" alt="${s.name}">
          </div>
          <div class="stall-info">
            <b>${s.name}</b>
            <small>${s.cuisine || ''}</small>
            <small>${statusDot(s.status.toLowerCase() === 'open')}</small>
            <small>Price: ${s.priceRange || 'N/A'}</small>
            <small>Ratings: ${stars(s.rating)}</small>
            <div class="stall-meta">ETA: ${s.status === 'open' ? s.waitTime || 'N/A' : 'N/A'}</div>
          </div>
        </div>`;

      document.getElementById('availableStalls').innerHTML = available.length
        ? available.map(makeCard).join('')
        : '<div class="text-muted">No available stalls found.</div>';

      document.getElementById('closedStalls').innerHTML = closed.length
        ? closed.map(makeCard).join('')
        : '<div class="text-muted">No closed stalls found.</div>';

      document.querySelectorAll('.stall-card').forEach(c => {
        c.onclick = () => {
          const slug = c.dataset.slug;
          const s = stalls.find(x => x.slug === slug);
          if (!s) return;
          if (s.status.toLowerCase() === 'closed') return showClosedStallPopup(s.name);
          const url = new URL('selection.html', window.location.href);
          url.searchParams.set('slug', slug);
          sessionStorage.setItem('stallSlug', slug);
          window.location.href = url;
        };
      });
    }

    async function loadStalls() {
      try {
        await waitForDb();
        const { collection, getDocs } = window;
        const stallsRef = collection(db, 'stalls');
        const snap = await getDocs(stallsRef);
        stalls = snap.docs.map(d => {
          const data = d.data();
          return {
            id: d.id,
            slug: data.slug || toSlug(data.name || d.id),
            name: data.name || '',
            cuisine: data.cuisine || '',
            status: data.status || 'closed',
            priceRange: data.priceRange || '',
            rating: data.rating || 0,
            waitTime: data.waitTime || '',
            image: data.image || ''
          };
        });
        loaded = true;
        renderStalls();
      } catch (err) {
        console.error('Error loading stalls', err);
        loaded = true;
        stalls = [];
        renderStalls();
      }
    }

    // Search handling
    (() => {
      const input = document.getElementById('stallSearch');
      const clear = document.getElementById('clearSearch');
      input.addEventListener('input', () => {
        renderStalls(input.value);
        clear.style.visibility = input.value ? 'visible' : 'hidden';
      });
      clear.addEventListener('click', () => {
        input.value = '';
        renderStalls('');
        clear.style.visibility = 'hidden';
        input.focus();
      });
      clear.style.visibility = 'hidden';
    })();

    loadStalls();
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Navigation -->
  <div class="nav-bar">
    <a href="/" class="nav-logo"><i class="bi bi-shop"></i>ChopeLah</a>
    <div class="nav-items">
      <button class="active" onclick="location.href='/pages/order/online-order-home.html'"><i class="bi bi-cart3"></i><span>Order</span></button>
      <button onclick="location.href='/pages/community/community.html'"><i class="bi bi-people"></i><span>Community</span></button>
      <button onclick="location.href='/pages/chope/chope.html'"><i class="bi bi-bookmark"></i><span>Chope</span></button>
      <button onclick="location.href='/pages/crowd/crowd-view.html'"><i class="bi bi-eye"></i><span>Crowd View</span></button>
    </div>
    <div class="nav-right">
      <button class="notification-btn" onclick="alert('No new notifications')">
        <i class="bi bi-bell"></i>
        <span class="notification-badge">3</span>
      </button>
      <button onclick="location.href='/pages/profile/profile.html'"><i class="bi bi-person"></i><span>Profile</span></button>
    </div>
  </div>
</body>
</html>
