<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Online Order - Select Stall</title>

  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet" />

  <!-- Custom styles -->
  <link rel="stylesheet" href="/styles/main.css" />
  <link rel="stylesheet" href="/styles/components.css" />

  <!-- Firebase -->
  <script type="module" src="/scripts/firebaseauth.js"></script>

  <style>
    :root {
      --clr-cloud: #f8f9fa;
      --clr-ink: #222;
      --clr-sand: #f1f3f5;
      --clr-green: #28a745;
      --clr-red: #dc3545;
    }

    body {
      color: var(--clr-ink);
      background: var(--clr-cloud);
      margin: 0;
      padding-top: 70px;
      padding-bottom: 100px;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      overflow-x: hidden;
    }
    
    @media (max-width: 768px) {
      body {
        padding-top: 0;
        padding-bottom: 100px;
      }
    }

    .main-content {
      padding: 0 20px;
      width: 100%;
      box-sizing: border-box;
      max-width: 1400px;
      margin: 0 auto;
    }

    .location-header {
      display: flex;
      align-items: center;
      gap: 12px;
      font-weight: 700;
      margin: 16px 0 8px;
      flex-wrap: wrap;
    }

    .food-centre-select {
      position: relative;
      flex: 1;
      min-width: 200px;
      max-width: 400px;
    }

    .food-centre-input-wrapper {
      position: relative;
    }

    .food-centre-input {
      width: 100%;
      padding: 10px 36px 10px 12px;
      border: 1px solid var(--clr-ink);
      border-radius: 6px;
      background: white;
      color: var(--clr-ink);
      font-size: 16px;
      font-weight: 600;
      cursor: text;
      transition: all 0.2s;
      box-sizing: border-box;
    }

    .food-centre-input::placeholder {
      color: rgba(34, 34, 34, 0.5);
      font-weight: 500;
    }

    .food-centre-input:hover {
      border-color: #4285f4;
      box-shadow: 0 0 0 2px rgba(66, 133, 244, 0.1);
    }

    .food-centre-input:focus {
      outline: none;
      border-color: #4285f4;
      box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.2);
    }

    .food-centre-dropdown-icon {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      pointer-events: none;
      width: 12px;
      height: 12px;
      transition: transform 0.2s;
    }

    .food-centre-select.open .food-centre-dropdown-icon {
      transform: translateY(-50%) rotate(180deg);
    }

    .food-centre-dropdown {
      position: absolute;
      top: calc(100% + 4px);
      left: 0;
      right: 0;
      background: white;
      border: 1px solid var(--clr-ink);
      border-radius: 6px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      max-height: 200px;
      overflow-y: auto;
      z-index: 1000;
      display: none;
      margin-top: 4px;
    }

    .food-centre-select.open .food-centre-dropdown {
      display: block;
    }

    .food-centre-option {
      padding: 12px;
      cursor: pointer;
      transition: background-color 0.15s;
      border-bottom: 1px solid rgba(38, 38, 38, 0.1);
      font-weight: 500;
    }

    .food-centre-option:last-child {
      border-bottom: none;
    }

    .food-centre-option:hover {
      background-color: rgba(66, 133, 244, 0.1);
    }

    .food-centre-option.selected {
      background-color: rgba(66, 133, 244, 0.15);
      font-weight: 600;
    }

    .food-centre-option.hidden {
      display: none;
    }

    .search-wrap {
      position: relative;
      margin-bottom: 16px;
    }

    .search-bar {
      border: none;
      border-bottom: 1px solid var(--clr-ink);
      padding-right: 36px;
      background: transparent;
      color: var(--clr-ink);
    }

    /* Add disabled state styling for search bar */
    .search-bar:disabled {
      background: #e9ecef;
      color: #6c757d;
      border-bottom-color: #d3d3d3;
      cursor: not-allowed;
    }

    .search-bar:disabled::placeholder {
      color: #999;
    }

    .search-clear {
      position: absolute;
      right: 6px;
      top: 50%;
      transform: translateY(-50%);
      border: none;
      background: transparent;
      color: var(--clr-ink);
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }

    .stall-list-title {
      font-size: 1.3em;
      font-weight: 700;
      margin: 24px 0 16px;
    }

    /* Grid Layout */
    #availableStalls, #closedStalls {
      display: grid;
      gap: 16px;
    }

    @media (min-width: 768px) {
      #availableStalls, #closedStalls {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (min-width: 992px) {
      #availableStalls, #closedStalls {
        grid-template-columns: repeat(3, 1fr);
        gap: 24px;
      }
    }

    @media (min-width: 1200px) {
      #availableStalls, #closedStalls {
        gap: 32px;
      }
    }

    /* Stall Card */
    .stall-card {
      background: #fff;
      border: 1px solid rgba(38,38,38,0.12);
      border-radius: 12px;
      display: flex;
      gap: 12px;
      padding: 16px;
      box-shadow: 0 2px 8px rgba(38,38,38,0.08);
      transition: all 0.3s ease;
      align-items: flex-start;
      cursor: pointer;
    }

    .stall-card:hover {
      box-shadow: 0 4px 16px rgba(38,38,38,0.12);
      transform: translateY(-2px);
    }

    #closedStalls .stall-card {
      opacity: 0.7;
      background: var(--clr-cloud);
    }

    #closedStalls .stall-card:hover {
      opacity: 0.85;
      border-color: var(--clr-red);
    }

    .stall-img-wrap {
      width: 100px;
      height: 140px;
      border-radius: 10px;
      overflow: hidden;
      flex-shrink: 0;
      box-shadow: 0 2px 8px rgba(38,38,38,0.1);
    }

    .stall-img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 10px;
      border: 2px solid var(--clr-cloud);
      transition: transform 0.3s ease, border-color 0.3s ease;
    }

    .stall-card:hover .stall-img {
      transform: scale(1.02);
      border-color: var(--clr-sand);
    }

    .stall-info {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    .stall-info b {
      font-weight: 600;
      font-size: 1.1em;
    }

    .stall-info small {
      font-size: 0.9em;
      opacity: 0.9;
    }

    .stall-meta {
      margin-top: 6px;
      font-size: 0.85em;
      opacity: 0.8;
      border-top: 1px solid rgba(38,38,38,0.1);
      padding-top: 3px;
    }

    .status-dot {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 6px;
    }

    .status-open { background: var(--clr-green); }
    .status-closed { background: var(--clr-red); }

    .stars { color: #FFC107; }

    /* Mobile Adjustments */
    @media (max-width: 767px) {
      body { padding-bottom: 120px; }
      .main-content { padding: 0 16px; }
      .stall-card { height: 160px; }
      .stall-img-wrap { width: 90px; height: 130px; }
    }

  </style>
</head>

<body>
  <div class="main-content">
    <div class="location-header">
      <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="#000" class="me-1" viewBox="0 0 16 16">
        <path d="M8 16s6-5.686 6-10A6 6 0 1 0 2 6c0 4.314 6 10 6 10Zm0-8a2 2 0 1 1 0-4 2 2 0 0 1 0 4Z"/>
      </svg>
      <div class="food-centre-select" id="foodCentreSelectWrapper">
        <div class="food-centre-input-wrapper">
          <input 
            type="text" 
            id="foodCentreSelect" 
            class="food-centre-input" 
            placeholder="Please select a food centre"
            autocomplete="off"
            aria-label="Select Food Centre"
          />
          <svg class="food-centre-dropdown-icon" xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 12 12">
            <path fill="#222" d="M6 9L1 4h10z"/>
          </svg>
        </div>
        <div class="food-centre-dropdown" id="foodCentreDropdown" role="listbox">
          <div class="food-centre-option" data-value="Maxwell Food Centre">Maxwell Food Centre</div>
          <div class="food-centre-option" data-value="Newton Food Centre">Newton Food Centre</div>
          <div class="food-centre-option" data-value="Changi Village Food Centre">Changi Village Food Centre</div>
        </div>
      </div>
    </div>

    <div class="search-wrap">
      <input type="text" id="stallSearch" class="form-control search-bar" placeholder="Search for a stall/food" disabled>
      <button id="clearSearch" class="search-clear" type="button">&times;</button>
    </div>

    <div class="stall-list-title" id="availableStallsTitle">Available Stalls</div>
    <div id="availableStalls" aria-live="polite"></div>

    <div class="stall-list-title mt-4" id="closedStallsTitle">Closed Stalls</div>
    <div id="closedStalls" aria-live="polite"></div>
  </div>

  <!-- Firebase + Stall Logic -->
  <script>
    async function waitForDb(timeout = 10000) {
      const start = Date.now();
      while (typeof window.db === 'undefined') {
        if (Date.now() - start > timeout) {
          console.error('Timeout waiting for window.db');
          console.error('Available window properties:', Object.keys(window).filter(k => k.includes('db') || k.includes('firebase')));
          throw new Error('Firestore not available. Please check if firebaseauth.js loaded correctly.');
        }
        await new Promise(r => setTimeout(r, 100));
      }
      console.log('window.db is available');
    }

    const toSlug = s => String(s||'').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');

    function statusDot(open) {
      return `<span class="status-dot ${open ? 'status-open' : 'status-closed'}"></span>${open ? 'Open' : 'Closed'}`;
    }

    function stars(r) {
      const full = Math.max(0, Math.min(5, Math.round(Number(r)||0)));
      return `<span class="stars">${'â˜…'.repeat(full)}</span>`;
    }

    function showClosedStallPopup(name){ alert(name + ' is currently closed.'); }

    let stalls = [];
    let loaded = false;
    let selectedFoodCentre = null; // Will be set during initialization

    function renderStalls(filter='') {
      // If no food centre selected, show nothing
      if (!selectedFoodCentre || selectedFoodCentre.trim() === '') {
        document.getElementById('availableStallsTitle').style.display = 'none';
        document.getElementById('closedStallsTitle').style.display = 'none';
        document.getElementById('availableStalls').innerHTML = '';
        document.getElementById('closedStalls').innerHTML = '';
        return;
      }

      // Show titles when food centre is selected
      document.getElementById('availableStallsTitle').style.display = 'block';
      document.getElementById('closedStallsTitle').style.display = 'block';

      if (!loaded) {
        document.getElementById('availableStalls').innerHTML = '<div class="text-muted">Loading stalls...</div>';
        document.getElementById('closedStalls').innerHTML = '';
        return;
      }
      
      // Filter by selected food centre first
      const foodCentreFiltered = stalls.filter(s => 
        (s.foodCentre || '').trim() === selectedFoodCentre
      );
      
      // Then filter by search query
      const q = filter.trim().toLowerCase();
      const filtered = q
        ? foodCentreFiltered.filter(s => 
            s.name.toLowerCase().includes(q) || 
            s.cuisine.toLowerCase().includes(q)
          )
        : foodCentreFiltered;

      const available = filtered.filter(s => s.status.toLowerCase() === 'open');
      const closed = filtered.filter(s => s.status.toLowerCase() === 'closed');

      const makeCard = s => `
        <div class="stall-card" data-slug="${s.slug}">
          <div class="stall-img-wrap">
            <img class="stall-img" src="${s.image || '/img/stall1.jpg'}" alt="${s.name}">
          </div>
          <div class="stall-info">
            <b>${s.name}</b>
            <small>${s.cuisine || ''}</small>
            <small>${statusDot(s.status.toLowerCase() === 'open')}</small>
            <small>Price: ${s.priceRange || 'N/A'}</small>
            <small>Ratings: ${stars(s.rating)}</small>
            <div class="stall-meta">ETA: ${s.status === 'open' ? s.waitTime || 'N/A' : 'N/A'}</div>
          </div>
        </div>`;

      document.getElementById('availableStalls').innerHTML = available.length
        ? available.map(makeCard).join('')
        : '<div class="text-muted">No available stalls found.</div>';

      document.getElementById('closedStalls').innerHTML = closed.length
        ? closed.map(makeCard).join('')
        : '<div class="text-muted">No closed stalls found.</div>';

      document.querySelectorAll('.stall-card').forEach(c => {
        c.onclick = () => {
          const slug = c.dataset.slug;
          const s = stalls.find(x => x.slug === slug);
          if (!s) return;
          if (s.status.toLowerCase() === 'closed') return showClosedStallPopup(s.name);
          const url = new URL('stall.html', window.location.href);
          url.searchParams.set('slug', slug);
          sessionStorage.setItem('stallSlug', slug);
          window.location.href = url;
        };
      });
    }

    async function loadStalls() {
      try {
        await waitForDb();
        
        // Verify window.db and other functions are available
        if (!window.db || !window.collection || !window.getDocs) {
          console.error('Firebase functions not available:', {
            db: typeof window.db,
            collection: typeof window.collection,
            getDocs: typeof window.getDocs
          });
          throw new Error('Firebase functions not available');
        }
        
        const stallsRef = window.collection(window.db, 'stalls');
        const snap = await window.getDocs(stallsRef);
        
        console.log(`Loaded ${snap.docs.length} stalls from Firebase`);
        
        stalls = snap.docs.map(d => {
          const data = d.data();
          return {
            id: d.id,
            slug: data.slug || toSlug(data.name || d.id),
            name: data.name || '',
            cuisine: data.cuisine || '',
            foodCentre: data.foodCentre || '',
            status: data.status || 'closed',
            priceRange: data.priceRange || '',
            rating: data.rating || 0,
            waitTime: data.waitTime || '',
            image: data.image || ''
          };
        });
        
        loaded = true;
        // Enable search bar once data is loaded
        const searchInput = document.getElementById('stallSearch');
        if (searchInput) {
          searchInput.disabled = false;
        }
        renderStalls();
      } catch (err) {
        console.error('Error loading stalls:', err);
        console.error('Error details:', err.message, err.stack);
        loaded = true;
        stalls = [];
        // Show error message to user
        document.getElementById('availableStalls').innerHTML = `<div class="text-muted">Error loading stalls: ${err.message}</div>`;
        document.getElementById('closedStalls').innerHTML = '';
        // Still enable search bar even on error
        const searchInput = document.getElementById('stallSearch');
        if (searchInput) {
          searchInput.disabled = false;
        }
      }
    }

    // Food centre selection handler (searchable dropdown)
    (() => {
      const input = document.getElementById('foodCentreSelect');
      const wrapper = document.getElementById('foodCentreSelectWrapper');
      const dropdown = document.getElementById('foodCentreDropdown');
      const options = dropdown.querySelectorAll('.food-centre-option');
      const foodCentres = ['Maxwell Food Centre', 'Newton Food Centre', 'Changi Village Food Centre'];
      
      // Define helper functions first
      function updateSelectedOption(value) {
        options.forEach(opt => {
          opt.classList.remove('selected');
          if (opt.dataset.value === value) {
            opt.classList.add('selected');
          }
        });
      }
      
      function filterOptions() {
        const searchTerm = input.value.toLowerCase().trim();
        options.forEach(option => {
          const value = option.dataset.value.toLowerCase();
          if (value.includes(searchTerm) || searchTerm === '') {
            option.classList.remove('hidden');
          } else {
            option.classList.add('hidden');
          }
        });
      }
      
      const saved = sessionStorage.getItem('selectedFoodCentre');
      if (saved && foodCentres.includes(saved)) {
        // Keep this for now if you want to restore user's previous selection
        // Otherwise, skip this block entirely
      }
      
      input.value = '';
      selectedFoodCentre = null;
      sessionStorage.removeItem('selectedFoodCentre');
      document.getElementById('availableStallsTitle').style.display = 'none';
      document.getElementById('closedStallsTitle').style.display = 'none';
      document.getElementById('availableStalls').innerHTML = '';
      document.getElementById('closedStalls').innerHTML = '';
      
      // Toggle dropdown on input click/focus
      input.addEventListener('focus', () => {
        wrapper.classList.add('open');
        filterOptions();
      });
      
      input.addEventListener('click', () => {
        wrapper.classList.add('open');
        filterOptions();
      });
      
      // Filter options as user types
      input.addEventListener('input', (e) => {
        filterOptions();
      });
      
      // Handle option selection
      options.forEach(option => {
        option.addEventListener('click', () => {
          const value = option.dataset.value;
          input.value = value;
          selectedFoodCentre = value;
          sessionStorage.setItem('selectedFoodCentre', selectedFoodCentre);
          wrapper.classList.remove('open');
          updateSelectedOption(value);
          document.getElementById('stallSearch').disabled = false;
          // Load stalls if not already loaded, then render
          if (!loaded) {
            loadStalls();
          } else {
            renderStalls(document.getElementById('stallSearch').value);
          }
        });
      });
      
      // Close dropdown when clicking outside
      document.addEventListener('click', (e) => {
        if (!wrapper.contains(e.target)) {
          wrapper.classList.remove('open');
          // If input was cleared and there was a selection, restore it
          if (!input.value.trim() && selectedFoodCentre) {
            input.value = selectedFoodCentre;
          }
          // If input was cleared and no selection, keep it empty
          else if (!input.value.trim() && !selectedFoodCentre) {
            selectedFoodCentre = '';
            sessionStorage.removeItem('selectedFoodCentre');
            document.getElementById('stallSearch').disabled = true;
            renderStalls('');
          }
        }
      });
      
      // Handle keyboard navigation
      input.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowDown') {
          e.preventDefault();
          wrapper.classList.add('open');
          const visibleOptions = Array.from(options).filter(opt => !opt.classList.contains('hidden'));
          if (visibleOptions.length > 0) {
            visibleOptions[0].focus();
          }
        } else if (e.key === 'Enter') {
          e.preventDefault();
          const visibleOptions = Array.from(options).filter(opt => !opt.classList.contains('hidden'));
          if (visibleOptions.length === 1) {
            visibleOptions[0].click();
          } else if (visibleOptions.length > 0 && document.activeElement.classList.contains('food-centre-option')) {
            document.activeElement.click();
          }
        } else if (e.key === 'Escape') {
          wrapper.classList.remove('open');
          input.blur();
        }
      });
      
      // Make options focusable for keyboard navigation
      options.forEach(option => {
        option.setAttribute('tabindex', '0');
        option.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            option.click();
          }
        });
      });
    })();

    // Search handling
    (() => {
      const input = document.getElementById('stallSearch');
      const clear = document.getElementById('clearSearch');
      
      input.disabled = true;
      
      input.addEventListener('input', () => {
        renderStalls(input.value);
        clear.style.visibility = input.value ? 'visible' : 'hidden';
      });
      
      clear.addEventListener('click', () => {
        input.value = '';
        renderStalls('');
        clear.style.visibility = 'hidden';
        input.focus();
      });
      clear.style.visibility = 'hidden';
    })();
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Navigation -->
  <div class="nav-bar">
    <a href="/" class="nav-logo"><i class="bi bi-shop"></i>ChopeLah</a>
    <div class="nav-items">
      <button class="active" onclick="location.href='/pages/order/online-order-home.html'"><i class="bi bi-cart3"></i><span>Order</span></button>
      <button onclick="location.href='/pages/community/community.html'"><i class="bi bi-people"></i><span>Community</span></button>
      <button onclick="location.href='/pages/chope/chope.html'"><i class="bi bi-bookmark"></i><span>Chope</span></button>
      <button onclick="location.href='/pages/crowd/crowd-view.html'"><i class="bi bi-eye"></i><span>Crowd View</span></button>
    </div>
    <div class="nav-right">
      <button class="notification-btn" onclick="alert('No new notifications')">
        <i class="bi bi-bell"></i>
        <span class="notification-badge">3</span>
      </button>
      <button onclick="location.href='/pages/profile/profile.html'"><i class="bi bi-person"></i><span>Profile</span></button>
    </div>
  </div>
</body>
</html>
