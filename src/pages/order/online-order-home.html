<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Online Order - Select Stall</title>

  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet" />

  <!-- Custom styles -->
  <link rel="stylesheet" href="/styles/main.css" />
  <link rel="stylesheet" href="/styles/components.css" />

  <!-- Firebase -->
  <script type="module" src="/scripts/firebaseauth.js"></script>

  <style>
    /* CRITICAL: Fallback CSS to ensure mobile view is visible before JS runs */
    /* This prevents FOUC (Flash of Unstyled Content) and ensures mobile view appears immediately */
    /* MUST come before other styles to ensure proper cascade */
    
    /* Default: Show mobile view on small screens, hide desktop */
    @media screen and (max-width: 767px) {
      .desktop-view {
        display: none !important;
        visibility: hidden !important;
        opacity: 0 !important;
      }
      .mobile-view {
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
        background: #f8f9fa !important;
        color: #222 !important;
        position: relative !important;
        z-index: 1 !important;
        width: 100% !important;
        min-height: calc(100vh - 100px) !important;
        height: auto !important;
        overflow-y: auto !important;
        overflow-x: hidden !important;
      }
      .mobile-view * {
        visibility: visible !important;
        opacity: 1 !important;
      }
    }
    
    /* Desktop: Show desktop view, hide mobile */
    @media screen and (min-width: 768px) {
      .desktop-view {
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
      }
      .mobile-view {
        display: none !important;
        visibility: hidden !important;
        opacity: 0 !important;
      }
    }
  </style>

  <style>
    :root {
      --clr-cloud: #f8f9fa;
      --clr-ink: #222;
      --clr-sand: #f1f3f5;
      --clr-green: #28a745;
      --clr-red: #dc3545;
      
      /* Header variables matching crowd-view */
      --font-size-3xl: 24px;
      --font-size-base: 14px;
      --font-weight-bold: 600;
      --space-32: 32px;
      --space-16: 16px;
      --space-8: 8px;
      --color-text-secondary: #666;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      color: var(--clr-ink);
      background: var(--clr-cloud);
      margin: 0;
      padding-top: 70px;
      padding-bottom: 100px;
      overflow-x: hidden;
      width: 100%;
      max-width: 100vw;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    
    @media (max-width: 768px) {
      body {
        padding-top: env(safe-area-inset-top);
        padding-bottom: calc(100px + env(safe-area-inset-bottom));
      }
    }

    /* Desktop View - Default: visible on desktop (overridden by media query on mobile) */
    .desktop-view {
      display: block;
      padding: var(--space-32);
      max-width: 1400px;
      margin: 0 auto;
      width: 100%;
      box-sizing: border-box;
      flex: 1;
      min-height: 0;
    }

    /* Mobile View - Visibility controlled by media queries above */
    /* DO NOT set display: none here - let media queries handle it */
    .mobile-view {
      padding: var(--space-16);
      padding-top: var(--space-8);
      width: 100%;
      max-width: 100vw;
      box-sizing: border-box;
      overflow-x: hidden;
      overflow-y: auto;
      background: var(--clr-cloud);
      position: relative;
      z-index: 1;
      color: var(--clr-ink);
      visibility: visible;
      opacity: 1;
      flex: 1 1 auto;
      min-height: calc(100vh - 100px);
      /* Display is controlled by media queries in the first style block */
    }

    /* Header styling matching crowd-view */
    .header {
      margin-bottom: var(--space-32);
    }

    .header h1 {
      font-size: var(--font-size-3xl);
      font-weight: var(--font-weight-bold);
      color: #1a1a1a;
      margin-bottom: var(--space-8);
    }

    .header-subtitle {
      font-size: var(--font-size-base);
      color: var(--color-text-secondary);
    }

    .location-header {
      display: flex;
      align-items: center;
      gap: 12px;
      font-weight: 700;
      margin: 20px 0 8px;
      flex-wrap: wrap;
    }
    
    .header-controls {
      display: flex;
      flex-direction: column;
      align-items: stretch;
      gap: 16px;
      width: 100%;
      margin-top: 20px;
    }

    .food-centre-select {
      position: relative;
      width: 100%;
      display: flex;
      align-items: center;
    }

    .food-centre-input-wrapper {
      position: relative;
      width: 100%;
      display: flex;
      align-items: center;
    }

    .food-centre-input {
      width: 100%;
      padding: 10px 36px 10px 12px;
      border: 1px solid #1a1a1a;
      border-radius: 6px;
      background: white;
      color: #1a1a1a;
      font-size: 16px;
      font-weight: 600;
      cursor: text;
      transition: all 0.2s;
      box-sizing: border-box;
      height: 44px;
      line-height: 24px;
    }

    .food-centre-input::placeholder {
      color: rgba(34, 34, 34, 0.5);
      font-weight: 500;
    }

    .food-centre-input:hover {
      border-color: #4285f4;
      box-shadow: 0 0 0 2px rgba(66, 133, 244, 0.1);
    }

    .food-centre-input:focus {
      outline: none;
      border-color: #4285f4;
      box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.2);
    }

    .food-centre-dropdown-icon {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      pointer-events: none;
      width: 12px;
      height: 12px;
      transition: transform 0.2s;
    }

    .food-centre-select.open .food-centre-dropdown-icon {
      transform: translateY(-50%) rotate(180deg);
    }

    .food-centre-dropdown {
      position: absolute;
      top: calc(100% + 4px);
      left: 0;
      right: 0;
      background: white;
      border: 1px solid #1a1a1a;
      border-radius: 6px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      max-height: 300px;
      overflow-y: auto;
      z-index: 1000;
      display: none;
      margin-top: 4px;
    }

    .food-centre-select.open .food-centre-dropdown {
      display: block;
    }

    .dropdown-search-bar {
      padding: 12px;
      border-bottom: 1px solid rgba(38, 38, 38, 0.1);
      position: sticky;
      top: 0;
      background: white;
      border-radius: 6px 6px 0 0;
      z-index: 10;
    }

    .dropdown-search-bar input {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid rgba(38, 38, 38, 0.2);
      border-radius: 4px;
      font-size: 14px;
      transition: border-color 0.2s;
    }

    .dropdown-search-bar input:focus {
      outline: none;
      border-color: #4285f4;
      box-shadow: 0 0 0 2px rgba(66, 133, 244, 0.1);
    }

    .food-centre-option {
      padding: 12px;
      cursor: pointer;
      transition: background-color 0.15s;
      border-bottom: 1px solid rgba(38, 38, 38, 0.1);
      font-weight: 500;
    }

    .food-centre-option:last-child {
      border-bottom: none;
    }

    .food-centre-option:hover {
      background-color: rgba(66, 133, 244, 0.1);
    }

    .food-centre-option.selected {
      background-color: rgba(66, 133, 244, 0.15);
      font-weight: 600;
    }

    .food-centre-option.hidden {
      display: none;
    }

    .search-wrap {
      position: relative;
      width: 100%;
      display: flex;
      align-items: center;
    }

    .search-container {
      position: relative;
      width: 100%;
      max-width: 100%;
      display: flex;
      align-items: center;
      background: white;
      border: 1px solid #1a1a1a;
      border-radius: 6px;
      overflow: hidden;
      box-sizing: border-box;
      height: 44px;
    }

    .search-container i {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: rgba(26, 26, 26, 0.5);
      pointer-events: none;
      z-index: 1;
      font-size: 16px;
    }

    .search-container input {
      width: 100%;
      padding: 10px 12px 10px 40px;
      border: none;
      border-radius: 6px;
      background: transparent;
      color: #1a1a1a;
      font-size: 16px;
      font-weight: 600;
      transition: all 0.2s;
      box-sizing: border-box;
      outline: none;
      height: 100%;
      line-height: 24px;
    }

    .search-container input::placeholder {
      color: rgba(26, 26, 26, 0.5);
      font-weight: 500;
    }

    .search-container:hover {
      border-color: #4285f4;
      box-shadow: 0 0 0 2px rgba(66, 133, 244, 0.1);
    }

    .search-container:focus-within {
      border-color: #4285f4;
      box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.2);
    }

    .search-container input:focus {
      outline: none;
    }

    .search-bar {
      display: none;
    }
    
    .search-clear {
      display: none;
    }

    .stall-list-title {
      font-size: 1.3em;
      font-weight: 700;
      margin: 24px 0 16px;
    }

    #availableStalls, #closedStalls {
      display: grid;
      gap: 16px;
    }
    
    @media (min-width: 768px) {
      #availableStalls, #closedStalls {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    
    @media (min-width: 992px) {
      #availableStalls, #closedStalls {
        grid-template-columns: repeat(3, 1fr);
        gap: 24px;
      }
    }
    
    @media (min-width: 1200px) {
      #availableStalls, #closedStalls {
        gap: 32px;
      }
    }

    .stall-card {
      background: #fff;
      border: 1px solid rgba(38,38,38,0.12);
      border-radius: 12px;
      display: flex;
      gap: 12px;
      padding: 16px;
      box-shadow: 0 2px 8px rgba(38,38,38,0.08);
      transition: all 0.3s ease;
      align-items: flex-start;
      cursor: pointer;
    }

    .stall-card:hover {
      box-shadow: 0 4px 16px rgba(38,38,38,0.12);
      transform: translateY(-2px);
    }

    #closedStalls .stall-card {
      opacity: 0.7;
      background: var(--clr-cloud);
      cursor: not-allowed;
      pointer-events: none;
      position: relative;
    }

    .stall-img-wrap {
      width: 100px;
      height: 140px;
      border-radius: 10px;
      overflow: hidden;
      flex-shrink: 0;
      box-shadow: 0 2px 8px rgba(38,38,38,0.1);
    }

    .stall-img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 10px;
      border: 2px solid var(--clr-cloud);
      transition: transform 0.3s ease, border-color 0.3s ease;
    }

    .stall-card:hover .stall-img {
      transform: scale(1.02);
      border-color: var(--clr-sand);
    }

    .stall-info {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    .stall-info b {
      font-weight: 600;
      font-size: 1.1em;
    }

    .stall-info small {
      font-size: 0.9em;
      opacity: 0.9;
    }

    .stall-meta {
      margin-top: 6px;
      font-size: 0.85em;
      opacity: 0.8;
      border-top: 1px solid rgba(38,38,38,0.1);
      padding-top: 3px;
    }

    .status-dot {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 6px;
    }

    .status-open { background: var(--clr-green); }
    .status-closed { background: var(--clr-red); }

    .stars { color: #FFC107; }

    /* Responsive - Mobile (max-width: 767px) */
    /* CRITICAL: This ensures mobile view is ALWAYS visible on mobile devices */
    @media (max-width: 767px) {
      body { 
        padding-bottom: 120px; 
      }
      
      /* Hide desktop view on mobile */
      .desktop-view {
        display: none !important;
        visibility: hidden !important;
        opacity: 0 !important;
      }

      /* Show mobile view on mobile - MUST be visible */
      .mobile-view {
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
        padding: var(--space-16) !important;
        padding-top: var(--space-8) !important;
        position: relative !important;
        z-index: 1 !important;
        background: var(--clr-cloud) !important;
        width: 100% !important;
        max-width: 100vw !important;
        color: var(--clr-ink) !important;
        height: auto !important;
        min-height: calc(100vh - 100px) !important;
        overflow-y: auto !important;
        overflow-x: hidden !important;
        flex: 1 1 auto !important;
        margin: 0 !important;
        top: 0 !important;
        left: 0 !important;
        right: 0 !important;
      }
      
      /* Ensure all child elements are visible */
      .mobile-view * {
        visibility: visible !important;
        opacity: 1 !important;
      }

      .mobile-view .header {
        margin-bottom: var(--space-24);
        padding: 0;
      }

      .mobile-view .header h1 {
        font-size: 20px;
        margin-bottom: var(--space-8);
      }

      .header-controls {
        flex-direction: column;
        align-items: stretch;
        gap: var(--space-8);
        padding: 0;
        margin-top: var(--space-16);
      }

      .food-centre-select {
        min-width: 100%;
        max-width: 100%;
      }
      
      .search-wrap {
        min-width: 100%;
      }

      .stall-card {
        padding: var(--space-12);
        height: 200px; 
        align-items: center;
      }
      
      .stall-img-wrap { 
        width: 100px; 
        height: 170px; 
      }
      
      .stall-info {
        justify-content: center;
      }
      
      #availableStallsMobile, #closedStallsMobile {
        display: grid;
        gap: 16px;
      }
    }

    /* iPhone 14 Pro Max specific optimizations (430x932) */
    @media (max-width: 430px) {
      .desktop-view {
        display: none !important;
        visibility: hidden !important;
      }

      .mobile-view {
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
        padding: var(--space-16) !important;
        padding-top: var(--space-8) !important;
        padding-bottom: max(var(--space-16), env(safe-area-inset-bottom)) !important;
        position: relative !important;
        z-index: 1 !important;
        background: var(--clr-cloud) !important;
        width: 100% !important;
        max-width: 100vw !important;
        color: var(--clr-ink) !important;
        height: auto !important;
        min-height: calc(100vh - 100px) !important;
        overflow-y: auto !important;
        overflow-x: hidden !important;
        flex: 1 1 auto !important;
        margin: 0 !important;
        top: 0 !important;
        left: 0 !important;
        right: 0 !important;
      }
      
      .mobile-view * {
        visibility: visible !important;
        opacity: 1 !important;
      }

      .mobile-view .header {
        padding-top: 0;
        margin-bottom: var(--space-20);
      }

      .header-controls {
        margin-top: var(--space-16);
        gap: var(--space-12);
      }

      .stall-card {
        padding: var(--space-16);
      }

      .stall-img-wrap {
        width: 100px;
        height: 140px;
      }

      #availableStallsMobile, #closedStallsMobile {
        gap: var(--space-16);
      }

      .stall-list-title {
        font-size: 1.2rem;
        margin: var(--space-20) 0 var(--space-12);
      }
    }

    /* iPhone SE and small devices */
    @media (max-width: 390px) {
      body {
        padding-bottom: 100px; 
      }
      
      .main-content {
        padding: 0 12px; 
      }
      
      .header-controls {
        margin: 12px 0 8px;
        gap: 8px;
      }
      
      .food-centre-select {
        min-width: 180px;
      }
      
      .food-centre-input {
        font-size: 14px;
        padding: 8px 32px 8px 10px;
      }
      
      .stall-card {
        height: 180px;
        padding: 12px;
        align-items: center;
      }
      
      .stall-img-wrap {
        width: 90px;
        height: 155px;
      }
      
      .stall-info {
        min-width: 0;
        overflow: hidden;
        justify-content: center;
        display: flex;
        flex-direction: column;
      }
      
      .stall-info h5 {
        font-size: 1rem;
      }
      
      .stall-info .text-muted {
        font-size: 0.8rem;
      }
      
      .search-wrap {
        margin: 12px 0;
      }
      
      .search-bar {
        font-size: 14px;
        padding: 10px 36px 10px 12px;
      }
      
      .stall-info h5 {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      
      .stall-info .text-muted {
        overflow: hidden;
        text-overflow: ellipsis;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        white-space: normal;
      }
      
      .food-centre-input {
        min-height: 44px;
      }
      
      .search-bar {
        min-height: 44px;
      }
      
      .search-clear {
        width: 44px;
        height: 44px;
      }
    }

  </style>
</head>

<body>
  <!-- DESKTOP VIEW -->
  <div class="desktop-view">
    <div class="header">
      <div style="display: flex; justify-content: space-between; align-items: start;">
        <div>
          <h1>Online Order</h1>
          <p class="header-subtitle">Order delicious food from food centres across Singapore</p>
        </div>
      </div>
      
      <div class="header-controls">
        <div class="food-centre-select" id="foodCentreSelectWrapper">
          <div class="food-centre-input-wrapper">
            <input 
              type="text" 
              id="foodCentreSelect" 
              class="food-centre-input" 
              placeholder="Please select a food centre"
              autocomplete="off"
              aria-label="Select Food Centre"
            />
            <svg class="food-centre-dropdown-icon" xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 12 12">
              <path fill="#222" d="M6 9L1 4h10z"/>
            </svg>
          </div>
          <div class="food-centre-dropdown" id="foodCentreDropdown" role="listbox">
            <div class="dropdown-search-bar">
              <input 
                type="text" 
                id="dropdownSearchInput" 
                placeholder="Search food centre..."
                autocomplete="off"
              />
            </div>
            <div class="food-centre-option" data-value="Maxwell Food Centre">Maxwell Food Centre</div>
            <div class="food-centre-option" data-value="Newton Food Centre">Newton Food Centre</div>
            <div class="food-centre-option" data-value="Changi Village Food Centre">Changi Village Food Centre</div>
          </div>
        </div>
        
        <div class="search-wrap">
          <div class="search-container">
            <i class="bi bi-search"></i>
            <input type="text" id="stallSearch" placeholder="Search for a stall/food" disabled>
          </div>
        </div>
      </div>

    <div id="emptyState" style="display: none;">
      <div style="text-align: center; padding: 60px 20px; color: #666;">
        <svg xmlns="http://www.w3.org/2000/svg" width="80" height="80" fill="currentColor" style="opacity: 0.3; margin-bottom: 20px;" viewBox="0 0 16 16">
          <path d="M8 16s6-5.686 6-10A6 6 0 1 0 2 6c0 4.314 6 10 6 10Zm0-8a2 2 0 1 1 0-4 2 2 0 0 1 0 4Z"/>
        </svg>
        <h3 style="font-size: 24px; font-weight: 600; margin-bottom: 12px; color: #333;">Select a Food Centre</h3>
        <p style="font-size: 16px; margin-bottom: 8px; color: #666;">To view available stalls and start ordering, please select a food centre from the dropdown above.</p>
      </div>
    </div>

    <div class="stall-list-title" id="availableStallsTitle">Available Stalls</div>
    <div id="availableStalls" aria-live="polite"></div>

    <div class="stall-list-title mt-4" id="closedStallsTitle">Closed Stalls</div>
    <div id="closedStalls" aria-live="polite"></div>
  </div>

  <!-- MOBILE VIEW -->
  <div class="mobile-view" id="mobileViewContainer">
    <div class="header">
      <div style="display: flex; justify-content: space-between; align-items: start;">
        <div>
          <h1>ðŸ›’ Online Order</h1>
          <p class="header-subtitle">Order delicious food from hawker centres across Singapore</p>
        </div>
      </div>
      
      <div class="header-controls">
        <div class="food-centre-select" id="foodCentreSelectWrapperMobile">
          <div class="food-centre-input-wrapper">
            <input 
              type="text" 
              id="foodCentreSelectMobile" 
              class="food-centre-input" 
              placeholder="Please select a food centre"
              autocomplete="off"
              aria-label="Select Food Centre"
            />
            <svg class="food-centre-dropdown-icon" xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 12 12">
              <path fill="#222" d="M6 9L1 4h10z"/>
            </svg>
          </div>
          <div class="food-centre-dropdown" id="foodCentreDropdownMobile" role="listbox">
            <div class="dropdown-search-bar">
              <input 
                type="text" 
                id="dropdownSearchInputMobile" 
                placeholder="Search food centre..."
                autocomplete="off"
              />
            </div>
            <div class="food-centre-option" data-value="Maxwell Food Centre">Maxwell Food Centre</div>
            <div class="food-centre-option" data-value="Newton Food Centre">Newton Food Centre</div>
            <div class="food-centre-option" data-value="Changi Village Food Centre">Changi Village Food Centre</div>
          </div>
        </div>
        
        <div class="search-wrap">
          <div class="search-container">
            <i class="bi bi-search"></i>
            <input type="text" id="stallSearchMobile" placeholder="Search for a stall/food" disabled>
          </div>
        </div>
      </div>
    </div>

    <div id="emptyStateMobile" style="display: block;">
      <div style="text-align: center; padding: 60px 20px; color: #666;">
        <svg xmlns="http://www.w3.org/2000/svg" width="80" height="80" fill="currentColor" style="opacity: 0.3; margin-bottom: 20px;" viewBox="0 0 16 16">
          <path d="M8 16s6-5.686 6-10A6 6 0 1 0 2 6c0 4.314 6 10 6 10Zm0-8a2 2 0 1 1 0-4 2 2 0 0 1 0 4Z"/>
        </svg>
        <h3 style="font-size: 24px; font-weight: 600; margin-bottom: 12px; color: #333;">Select a Food Centre</h3>
        <p style="font-size: 16px; margin-bottom: 8px; color: #666;">To view available stalls and start ordering, please select a food centre from the dropdown above.</p>
      </div>
    </div>

    <div class="stall-list-title" id="availableStallsTitleMobile" style="display: none;">Available Stalls</div>
    <div id="availableStallsMobile" aria-live="polite"></div>

    <div class="stall-list-title mt-4" id="closedStallsTitleMobile" style="display: none;">Closed Stalls</div>
    <div id="closedStallsMobile" aria-live="polite"></div>
  </div>

  <script>
    async function waitForDb(timeout = 10000) {
      const start = Date.now();
      while (typeof window.db === 'undefined') {
        if (Date.now() - start > timeout) {
          console.error('Timeout waiting for window.db');
          console.error('Available window properties:', Object.keys(window).filter(k => k.includes('db') || k.includes('firebase')));
          throw new Error('Firestore not available. Please check if firebaseauth.js loaded correctly.');
        }
        await new Promise(r => setTimeout(r, 100));
      }
      console.log('window.db is available');
    }

    const toSlug = s => String(s||'').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');

    function statusDot(open) {
      return `<span class="status-dot ${open ? 'status-open' : 'status-closed'}"></span>${open ? 'Open' : 'Closed'}`;
    }

    function stars(r) {
      const full = Math.max(0, Math.min(5, Math.round(Number(r)||0)));
      return `<span class="stars">${'â˜…'.repeat(full)}</span>`;
    }

    function showClosedStallPopup(name){ 
      alert(`${name} is currently closed. Please try again later or select another stall.`); 
    }

    let stalls = [];
    let loaded = false;
    let selectedFoodCentre = null;

    function renderStalls(filter='') {
      if (!selectedFoodCentre || selectedFoodCentre.trim() === '') {
        // Desktop
        document.getElementById('availableStallsTitle').style.display = 'none';
        document.getElementById('closedStallsTitle').style.display = 'none';
        document.getElementById('availableStalls').innerHTML = '';
        document.getElementById('closedStalls').innerHTML = '';
        document.getElementById('emptyState').style.display = 'block';
        // Mobile
        const availableStallsTitleMobile = document.getElementById('availableStallsTitleMobile');
        const closedStallsTitleMobile = document.getElementById('closedStallsTitleMobile');
        const emptyStateMobile = document.getElementById('emptyStateMobile');
        if (availableStallsTitleMobile) availableStallsTitleMobile.style.display = 'none';
        if (closedStallsTitleMobile) closedStallsTitleMobile.style.display = 'none';
        if (document.getElementById('availableStallsMobile')) document.getElementById('availableStallsMobile').innerHTML = '';
        if (document.getElementById('closedStallsMobile')) document.getElementById('closedStallsMobile').innerHTML = '';
        if (emptyStateMobile) emptyStateMobile.style.display = 'block';
        return;
      }

      // Desktop
      document.getElementById('emptyState').style.display = 'none';
      document.getElementById('availableStallsTitle').style.display = 'block';
      document.getElementById('closedStallsTitle').style.display = 'block';
      // Mobile
      const emptyStateMobile = document.getElementById('emptyStateMobile');
      const availableStallsTitleMobile = document.getElementById('availableStallsTitleMobile');
      const closedStallsTitleMobile = document.getElementById('closedStallsTitleMobile');
      if (emptyStateMobile) emptyStateMobile.style.display = 'none';
      if (availableStallsTitleMobile) availableStallsTitleMobile.style.display = 'block';
      if (closedStallsTitleMobile) closedStallsTitleMobile.style.display = 'block';

      if (!loaded) {
        document.getElementById('availableStalls').innerHTML = '<div class="text-muted">Loading stalls...</div>';
        document.getElementById('closedStalls').innerHTML = '';
        if (document.getElementById('availableStallsMobile')) {
          document.getElementById('availableStallsMobile').innerHTML = '<div class="text-muted">Loading stalls...</div>';
        }
        if (document.getElementById('closedStallsMobile')) {
          document.getElementById('closedStallsMobile').innerHTML = '';
        }
        return;
      }
      
      const foodCentreFiltered = stalls.filter(s => 
        (s.foodCentre || '').trim() === selectedFoodCentre
      );
      
      const q = filter.trim().toLowerCase();
      const filtered = q
        ? foodCentreFiltered.filter(s => 
            s.name.toLowerCase().includes(q) || 
            s.cuisine.toLowerCase().includes(q)
          )
        : foodCentreFiltered;

      const available = filtered.filter(s => s.status.toLowerCase() === 'open');
      const closed = filtered.filter(s => s.status.toLowerCase() === 'closed');

      const makeCard = s => `
        <div class="stall-card" data-slug="${s.slug}">
          <div class="stall-img-wrap">
            <img class="stall-img" src="${s.image || '/img/stall1.jpg'}" alt="${s.name}">
  </div>
          <div class="stall-info">
            <b>${s.name}</b>
            <small>${s.cuisine || ''}</small>
            <small>${statusDot(s.status.toLowerCase() === 'open')}</small>
            <small>Price: ${s.priceRange || 'N/A'}</small>
            <small>Ratings: ${stars(s.rating)}</small>
            <div class="stall-meta">Estimated Wait Time: ${s.status === 'open' ? s.waitTime || 'N/A' : 'N/A'}</div>
          </div>
        </div>`;

      const availableHTML = available.length
        ? available.map(makeCard).join('')
        : '<div class="text-muted">No available stalls found.</div>';
      
      const closedHTML = closed.length
        ? closed.map(makeCard).join('')
        : '<div class="text-muted">No closed stalls found.</div>';

      // Desktop
      document.getElementById('availableStalls').innerHTML = availableHTML;
      document.getElementById('closedStalls').innerHTML = closedHTML;
      
      // Mobile
      if (document.getElementById('availableStallsMobile')) {
        document.getElementById('availableStallsMobile').innerHTML = availableHTML;
      }
      if (document.getElementById('closedStallsMobile')) {
        document.getElementById('closedStallsMobile').innerHTML = closedHTML;
      }

      // Attach click handlers to all stall cards (both desktop and mobile)
      document.querySelectorAll('.stall-card').forEach(c => {
        c.onclick = (e) => {
          e.preventDefault();
          e.stopPropagation();
          const slug = c.dataset.slug;
          const s = stalls.find(x => x.slug === slug);
          if (!s) {
            console.error('Stall not found:', slug);
            return;
          }
          
          if (s.status.toLowerCase() === 'closed') {
            showClosedStallPopup(s.name);
            return;
          }
          
          // Save food centre selection before navigating to stall
          if (selectedFoodCentre) {
            sessionStorage.setItem('selectedFoodCentre', selectedFoodCentre);
            // Set a flag to indicate we're navigating to stall
            sessionStorage.setItem('navigatedToStall', 'true');
          }
          
          const url = new URL('stall.html', window.location.href);
          url.searchParams.set('slug', slug);
          sessionStorage.setItem('stallSlug', slug);
          window.location.href = url;
        };
      });
    }

    async function loadStalls() {
      try {
        await waitForDb();
        
        if (!window.db || !window.collection || !window.getDocs) {
          console.error('Firebase functions not available:', {
            db: typeof window.db,
            collection: typeof window.collection,
            getDocs: typeof window.getDocs
          });
          throw new Error('Firebase functions not available');
        }
        
        const stallsRef = window.collection(window.db, 'stalls');
        const snap = await window.getDocs(stallsRef);
        
        console.log(`Loaded ${snap.docs.length} stalls from Firebase`);
        
        stalls = snap.docs.map(d => {
          const data = d.data();
          return {
            id: d.id,
            slug: data.slug || toSlug(data.name || d.id),
            name: data.name || '',
            cuisine: data.cuisine || '',
            foodCentre: data.foodCentre || '',
            status: data.status || 'closed',
            priceRange: data.priceRange || '',
            rating: data.rating || 0,
            waitTime: data.waitTime || '',
            image: data.image || ''
          };
        });
        
        loaded = true;
        const searchInput = document.getElementById('stallSearch');
        if (searchInput) {
          searchInput.disabled = false;
        }
        const searchInputMobile = document.getElementById('stallSearchMobile');
        if (searchInputMobile) {
          searchInputMobile.disabled = false;
        }
        renderStalls();
      } catch (err) {
        console.error('Error loading stalls:', err);
        console.error('Error details:', err.message, err.stack);
        loaded = true;
        stalls = [];
        document.getElementById('availableStalls').innerHTML = `<div class="text-muted">Error loading stalls: ${err.message}</div>`;
        document.getElementById('closedStalls').innerHTML = '';
        if (document.getElementById('availableStallsMobile')) {
          document.getElementById('availableStallsMobile').innerHTML = `<div class="text-muted">Error loading stalls: ${err.message}</div>`;
        }
        if (document.getElementById('closedStallsMobile')) {
          document.getElementById('closedStallsMobile').innerHTML = '';
        }
        const searchInput = document.getElementById('stallSearch');
        if (searchInput) {
          searchInput.disabled = false;
        }
        const searchInputMobile = document.getElementById('stallSearchMobile');
        if (searchInputMobile) {
          searchInputMobile.disabled = false;
        }
      }
    }

    // Food centre selection handler
    (() => {
      const input = document.getElementById('foodCentreSelect');
      const wrapper = document.getElementById('foodCentreSelectWrapper');
      const dropdown = document.getElementById('foodCentreDropdown');
      const dropdownSearch = document.getElementById('dropdownSearchInput');
      const options = dropdown.querySelectorAll('.food-centre-option');
      const foodCentres = ['Maxwell Food Centre', 'Newton Food Centre', 'Changi Village Food Centre'];
      
      function updateSelectedOption(value) {
        options.forEach(opt => {
          opt.classList.remove('selected');
          if (opt.dataset.value === value) {
            opt.classList.add('selected');
          }
        });
      }
      
      function filterOptions() {
        const searchTerm = dropdownSearch.value.toLowerCase().trim();
        options.forEach(option => {
          const value = option.dataset.value.toLowerCase();
          if (value.includes(searchTerm) || searchTerm === '') {
            option.classList.remove('hidden');
          } else {
            option.classList.add('hidden');
          }
        });
      }
      
      // Check if returning from stall page
      const navigatedToStall = sessionStorage.getItem('navigatedToStall') === 'true';
      const previouslySelected = sessionStorage.getItem('selectedFoodCentre');
      
      // Always clear cart and selected time when coming to online-order-home (refresh everything)
      localStorage.setItem('cart', JSON.stringify([]));
      localStorage.removeItem('selectedTime');
      const session = JSON.parse(sessionStorage.getItem('orderSession') || '{}');
      session.selectedTime = '';
      sessionStorage.setItem('orderSession', JSON.stringify(session));
      
      if (navigatedToStall && previouslySelected && foodCentres.includes(previouslySelected)) {
        // Clear the flag
        sessionStorage.removeItem('navigatedToStall');
        
        // Restore selection when coming back from stall page (but cart and time are cleared)
        input.value = previouslySelected;
        selectedFoodCentre = previouslySelected;
        updateSelectedOption(previouslySelected);
        // Also update mobile input
        const inputMobile = document.getElementById('foodCentreSelectMobile');
        if (inputMobile) {
          inputMobile.value = previouslySelected;
        }
        const wrapperMobile = document.getElementById('foodCentreSelectWrapperMobile');
        if (wrapperMobile) {
          const optionsMobile = wrapperMobile.querySelectorAll('.food-centre-option');
          optionsMobile.forEach(opt => {
            opt.classList.remove('selected');
            if (opt.dataset.value === previouslySelected) {
              opt.classList.add('selected');
            }
          });
        }
        document.getElementById('stallSearch').disabled = false;
        const searchInputMobile = document.getElementById('stallSearchMobile');
        if (searchInputMobile) {
          searchInputMobile.disabled = false;
        }
        // Hide empty state and show stalls
        document.getElementById('emptyState').style.display = 'none';
        document.getElementById('availableStallsTitle').style.display = 'block';
        document.getElementById('closedStallsTitle').style.display = 'block';
        const emptyStateMobile = document.getElementById('emptyStateMobile');
        const availableStallsTitleMobile = document.getElementById('availableStallsTitleMobile');
        const closedStallsTitleMobile = document.getElementById('closedStallsTitleMobile');
        if (emptyStateMobile) emptyStateMobile.style.display = 'none';
        if (availableStallsTitleMobile) availableStallsTitleMobile.style.display = 'block';
        if (closedStallsTitleMobile) closedStallsTitleMobile.style.display = 'block';
        // Trigger stall loading immediately
        loadStalls();
      } else {
        // Fresh page load - clear everything
        input.value = '';
        input.placeholder = 'Please select a food centre';
        selectedFoodCentre = null;
        sessionStorage.removeItem('selectedFoodCentre');
        sessionStorage.removeItem('navigatedToStall');
        document.getElementById('stallSearch').disabled = true;
        const searchInputMobile = document.getElementById('stallSearchMobile');
        if (searchInputMobile) {
          searchInputMobile.disabled = true;
        }
        const inputMobile = document.getElementById('foodCentreSelectMobile');
        if (inputMobile) {
          inputMobile.value = '';
          inputMobile.placeholder = 'Please select a food centre';
        }
        document.getElementById('availableStallsTitle').style.display = 'none';
        document.getElementById('closedStallsTitle').style.display = 'none';
        document.getElementById('availableStalls').innerHTML = '';
        document.getElementById('closedStalls').innerHTML = '';
        document.getElementById('emptyState').style.display = 'block';
        const availableStallsTitleMobile = document.getElementById('availableStallsTitleMobile');
        const closedStallsTitleMobile = document.getElementById('closedStallsTitleMobile');
        if (availableStallsTitleMobile) availableStallsTitleMobile.style.display = 'none';
        if (closedStallsTitleMobile) closedStallsTitleMobile.style.display = 'none';
        if (document.getElementById('availableStallsMobile')) document.getElementById('availableStallsMobile').innerHTML = '';
        if (document.getElementById('closedStallsMobile')) document.getElementById('closedStallsMobile').innerHTML = '';
        const emptyStateMobile = document.getElementById('emptyStateMobile');
        if (emptyStateMobile) emptyStateMobile.style.display = 'block';
      }
      
      input.addEventListener('focus', () => {
        wrapper.classList.add('open');
        dropdownSearch.focus();
        filterOptions();
      });
      
      input.addEventListener('click', () => {
        wrapper.classList.add('open');
        dropdownSearch.focus();
        filterOptions();
      });
      
      dropdownSearch.addEventListener('input', (e) => {
        filterOptions();
      });
      
      options.forEach(option => {
        option.addEventListener('click', () => {
          const value = option.dataset.value;
          input.value = value;
          selectedFoodCentre = value;
          sessionStorage.setItem('selectedFoodCentre', selectedFoodCentre);
          wrapper.classList.remove('open');
          dropdownSearch.value = '';
          updateSelectedOption(value);
          // Also update mobile dropdown
          const wrapperMobile = document.getElementById('foodCentreSelectWrapperMobile');
          const dropdownMobile = document.getElementById('foodCentreDropdownMobile');
          const dropdownSearchMobile = document.getElementById('dropdownSearchInputMobile');
          const inputMobile = document.getElementById('foodCentreSelectMobile');
          if (wrapperMobile && inputMobile) {
            inputMobile.value = value;
            wrapperMobile.classList.remove('open');
            if (dropdownSearchMobile) dropdownSearchMobile.value = '';
            const optionsMobile = dropdownMobile ? dropdownMobile.querySelectorAll('.food-centre-option') : [];
            optionsMobile.forEach(opt => {
              opt.classList.remove('selected');
              if (opt.dataset.value === value) {
                opt.classList.add('selected');
              }
            });
          }
          document.getElementById('stallSearch').disabled = false;
          const searchInputMobile = document.getElementById('stallSearchMobile');
          if (searchInputMobile) {
            searchInputMobile.disabled = false;
          }
          if (!loaded) {
            loadStalls();
          } else {
            const searchValue = document.getElementById('stallSearch').value;
            renderStalls(searchValue);
          }
        });
      });
      
      document.addEventListener('click', (e) => {
        if (!wrapper.contains(e.target)) {
          wrapper.classList.remove('open');
          dropdownSearch.value = '';
          if (!input.value.trim() && selectedFoodCentre) {
            input.value = selectedFoodCentre;
          }
          else if (!input.value.trim() && !selectedFoodCentre) {
            selectedFoodCentre = '';
            sessionStorage.removeItem('selectedFoodCentre');
            document.getElementById('stallSearch').disabled = true;
            const searchInputMobile = document.getElementById('stallSearchMobile');
            if (searchInputMobile) {
              searchInputMobile.disabled = true;
            }
            document.getElementById('emptyState').style.display = 'block';
            const emptyStateMobile = document.getElementById('emptyStateMobile');
            if (emptyStateMobile) emptyStateMobile.style.display = 'block';
            renderStalls('');
          }
        }
      });
      
      input.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowDown') {
          e.preventDefault();
          wrapper.classList.add('open');
          const visibleOptions = Array.from(options).filter(opt => !opt.classList.contains('hidden'));
          if (visibleOptions.length > 0) {
            visibleOptions[0].focus();
          }
        } else if (e.key === 'Escape') {
          wrapper.classList.remove('open');
          input.blur();
        }
      });
      
      dropdownSearch.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowDown') {
          e.preventDefault();
          const visibleOptions = Array.from(options).filter(opt => !opt.classList.contains('hidden'));
          if (visibleOptions.length > 0) {
            visibleOptions[0].focus();
          }
        } else if (e.key === 'Escape') {
          wrapper.classList.remove('open');
          input.blur();
        }
      });
      
      options.forEach(option => {
        option.setAttribute('tabindex', '0');
        option.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            option.click();
          } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            dropdownSearch.focus();
          }
        });
      });
    })();

    // Search handling
    (() => {
      const input = document.getElementById('stallSearch');
      
      input.disabled = true;
      
      input.addEventListener('input', () => {
        renderStalls(input.value);
      });
    })();
    
    // Mobile search handling
    (() => {
      const inputMobile = document.getElementById('stallSearchMobile');
      
      if (inputMobile) {
        inputMobile.disabled = true;
        
        inputMobile.addEventListener('input', () => {
          renderStalls(inputMobile.value);
        });
      }
    })();

    // Mobile food centre selection handler
    (() => {
      const inputMobile = document.getElementById('foodCentreSelectMobile');
      const wrapperMobile = document.getElementById('foodCentreSelectWrapperMobile');
      const dropdownMobile = document.getElementById('foodCentreDropdownMobile');
      const dropdownSearchMobile = document.getElementById('dropdownSearchInputMobile');
      
      if (!inputMobile || !wrapperMobile || !dropdownMobile || !dropdownSearchMobile) {
        return;
      }
      
      const optionsMobile = dropdownMobile.querySelectorAll('.food-centre-option');
      const foodCentres = ['Maxwell Food Centre', 'Newton Food Centre', 'Changi Village Food Centre'];
      
      function updateSelectedOptionMobile(value) {
        optionsMobile.forEach(opt => {
          opt.classList.remove('selected');
          if (opt.dataset.value === value) {
            opt.classList.add('selected');
          }
        });
      }
      
      function filterOptionsMobile() {
        const searchTerm = dropdownSearchMobile.value.toLowerCase().trim();
        optionsMobile.forEach(option => {
          const value = option.dataset.value.toLowerCase();
          if (value.includes(searchTerm) || searchTerm === '') {
            option.classList.remove('hidden');
          } else {
            option.classList.add('hidden');
          }
        });
      }
      
      inputMobile.addEventListener('focus', () => {
        wrapperMobile.classList.add('open');
        dropdownSearchMobile.focus();
        filterOptionsMobile();
      });
      
      inputMobile.addEventListener('click', () => {
        wrapperMobile.classList.add('open');
        dropdownSearchMobile.focus();
        filterOptionsMobile();
      });
      
      dropdownSearchMobile.addEventListener('input', (e) => {
        filterOptionsMobile();
      });
      
      optionsMobile.forEach(option => {
        option.addEventListener('click', () => {
          const value = option.dataset.value;
          inputMobile.value = value;
          selectedFoodCentre = value;
          sessionStorage.setItem('selectedFoodCentre', selectedFoodCentre);
          wrapperMobile.classList.remove('open');
          dropdownSearchMobile.value = '';
          updateSelectedOptionMobile(value);
          // Also update desktop dropdown
          const input = document.getElementById('foodCentreSelect');
          const wrapper = document.getElementById('foodCentreSelectWrapper');
          const dropdown = document.getElementById('foodCentreDropdown');
          if (input && wrapper) {
            input.value = value;
            wrapper.classList.remove('open');
            const dropdownSearch = document.getElementById('dropdownSearchInput');
            if (dropdownSearch) dropdownSearch.value = '';
            const options = dropdown ? dropdown.querySelectorAll('.food-centre-option') : [];
            options.forEach(opt => {
              opt.classList.remove('selected');
              if (opt.dataset.value === value) {
                opt.classList.add('selected');
              }
            });
          }
          document.getElementById('stallSearchMobile').disabled = false;
          const searchInput = document.getElementById('stallSearch');
          if (searchInput) {
            searchInput.disabled = false;
          }
          if (!loaded) {
            loadStalls();
          } else {
            const searchValue = document.getElementById('stallSearchMobile').value;
            renderStalls(searchValue);
          }
        });
      });
      
      document.addEventListener('click', (e) => {
        if (!wrapperMobile.contains(e.target)) {
          wrapperMobile.classList.remove('open');
          dropdownSearchMobile.value = '';
          if (!inputMobile.value.trim() && selectedFoodCentre) {
            inputMobile.value = selectedFoodCentre;
          }
          else if (!inputMobile.value.trim() && !selectedFoodCentre) {
            selectedFoodCentre = '';
            sessionStorage.removeItem('selectedFoodCentre');
            document.getElementById('stallSearchMobile').disabled = true;
            const searchInput = document.getElementById('stallSearch');
            if (searchInput) {
              searchInput.disabled = true;
            }
            const emptyStateMobile = document.getElementById('emptyStateMobile');
            if (emptyStateMobile) emptyStateMobile.style.display = 'block';
            document.getElementById('emptyState').style.display = 'block';
            renderStalls('');
          }
        }
      });
      
      inputMobile.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowDown') {
          e.preventDefault();
          wrapperMobile.classList.add('open');
          const visibleOptions = Array.from(optionsMobile).filter(opt => !opt.classList.contains('hidden'));
          if (visibleOptions.length > 0) {
            visibleOptions[0].focus();
          }
        } else if (e.key === 'Escape') {
          wrapperMobile.classList.remove('open');
          inputMobile.blur();
        }
      });
      
      dropdownSearchMobile.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowDown') {
          e.preventDefault();
          const visibleOptions = Array.from(optionsMobile).filter(opt => !opt.classList.contains('hidden'));
          if (visibleOptions.length > 0) {
            visibleOptions[0].focus();
          }
        } else if (e.key === 'Escape') {
          wrapperMobile.classList.remove('open');
          inputMobile.blur();
        }
      });
      
      optionsMobile.forEach(option => {
        option.setAttribute('tabindex', '0');
        option.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            option.click();
          } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            dropdownSearchMobile.focus();
          }
        });
      });
    })();

    // View mode functions will be moved to end of body
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Navigation -->
  <div class="nav-bar">
    <a href="/" class="nav-logo"><img src="/img/logo.jpg" alt="ChopeLah" /></a>
    <div class="nav-items">
      <button class="active" onclick="location.href='/pages/order/online-order-home.html'"><i class="bi bi-cart3"></i><span>Order</span></button>
      <button onclick="location.href='/pages/community/community.html'"><i class="bi bi-people"></i><span>Community</span></button>
      <button onclick="location.href='/pages/chope/chope.html'"><i class="bi bi-bookmark"></i><span>Chope</span></button>
      <button onclick="location.href='/pages/crowd/crowd-view.html'"><i class="bi bi-eye"></i><span>Crowd View</span></button>
    </div>
    <div class="nav-right">
      <button class="notification-btn" onclick="toggleOrderNotification()">
        <i class="bi bi-bell"></i>
        <span class="notification-badge" style="display: none;">1</span>
    </button>
      <button onclick="location.href='/pages/profile/profile.html'"><i class="bi bi-person"></i><span>Profile</span></button>
</div>
  </div>
  <script src="/scripts/notification.js"></script>
  
  <!-- Initialize page after all content is loaded -->
  <!-- CRITICAL: These functions ensure view mode is correct after page loads -->
  <script>
    // View mode check function - ensures correct view is displayed
    // CSS handles initial display, but JS ensures it stays correct
    function checkViewMode() {
      const isMobile = window.innerWidth <= 767;
      const mobileView = document.querySelector('.mobile-view');
      const desktopView = document.querySelector('.desktop-view');
      
      // Safety check: ensure elements exist
      if (!mobileView || !desktopView) {
        return;
      }
      
      if (isMobile) {
        // Mobile: ensure mobile view is visible, desktop is hidden
        mobileView.style.display = 'block';
        mobileView.style.visibility = 'visible';
        mobileView.style.opacity = '1';
        desktopView.style.display = 'none';
        desktopView.style.visibility = 'hidden';
      } else {
        // Desktop: ensure desktop view is visible, mobile is hidden
        desktopView.style.display = 'block';
        desktopView.style.visibility = 'visible';
        mobileView.style.display = 'none';
        mobileView.style.visibility = 'hidden';
      }
    }
    
    // Initialize page function - called after DOM is ready
    function initializePage() {
      // Ensure correct view is shown (CSS handles initial display, JS ensures it stays correct)
      checkViewMode();
      // Render stalls
      if (typeof renderStalls === 'function') {
        renderStalls();
      }
    }
    
    // Wait for window load to ensure all resources are ready
    window.addEventListener('load', function() {
      initializePage();
    });
    
    // Also run on DOMContentLoaded as fallback for faster initial render
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', function() {
        checkViewMode();
      });
    } else {
      // DOM already loaded, run immediately
      checkViewMode();
    }
    
    // Handle resize events to update view mode
    window.addEventListener('resize', checkViewMode);
  </script>
</body>
</html>