<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Menu Selection</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet" />
  <link rel="stylesheet" href="/styles/main.css">
  <link rel="stylesheet" href="/styles/components.css" />
  <script type="module" src="/scripts/firebaseauth.js"></script>
  <style>
    body { background: var(--clr-cloud); }
    .order-header-bar {
      display: flex;
      gap: 8px;
      justify-content: space-between;
      margin-bottom: 0.75rem;
      flex-wrap: wrap;
      position: sticky;
      top: 0;
      background: var(--clr-cloud);
      padding: 8px 0;
      border-bottom: 1px solid rgba(38,38,38,0.08);
      box-shadow: 0 2px 8px rgba(38,38,38,0.04);
      z-index: 10;
    }
    .order-header-box {
      background: #fff;
      border: 1px solid rgba(38,38,38,0.12);
      border-radius: 10px;
      padding: 8px 12px;
      min-height: 44px;
      font-size: 11px;
      display: flex;
      align-items: center;
      margin-bottom: 0;
      flex: 1;
      box-shadow: 0 1px 4px rgba(38,38,38,0.06);
    }
    .order-header-box b {
      font-size: 12px;
    }
    .cat-side-nav {
      background: #fff;
      border-right: 1px solid rgba(38,38,38,0.1);
      min-width: 90px;
      max-width: 120px;
      padding: 0;
      height: calc(100vh - 200px);
      position: sticky;
      top: 0;
      overflow-y: auto;
    }
    .food-panel {
      height: calc(100vh - 200px);
      overflow-y: auto;
      padding-right: 8px;
    }
    .cat-btn {
      width: 100%;
      padding: 16px 18px;
      border: none;
      border-bottom: 1px solid #e5e5e5;
      background: none;
      text-align: left;
      font-weight: 700;
      font-size: 11px;
      color: #333;
      outline: none;
      transition: background 0.15s;
    }
    .cat-btn.selected, .cat-btn:active {
      background: var(--clr-sand);
    }
    .food-card {
      background: #fff;
      border: 1px solid rgba(38,38,38,0.12);
      border-radius: 12px;
      display: flex;
      align-items: center;
      padding: 12px;
      margin-bottom: 12px;
      gap: 12px;
      min-height: 80px;
      width: 100%;
      box-sizing: border-box;
    }
    .food-img-wrapper {
      width: 80px; 
      height: 80px; 
      border-radius: 10px; 
      border: 1.5px solid var(--clr-cloud);
      background: var(--clr-cloud);
      flex-shrink: 0;
      overflow: hidden;
      position: relative;
    }
    .food-img {
      width: 100%; 
      height: 100%; 
      object-fit: cover; 
      display: block;
    }
    .food-info { flex-grow: 1; }
    .food-title { font-weight: bold; font-size: 0.9em; }
    .food-price { color: #5c5c5c; font-size: 0.85em; }
    .food-controls {
      display: flex; align-items: center; gap: 2px;
      width: 80px;
      height: 32px;
      background: var(--clr-cloud);
      border-radius: 20px;
      padding: 4px;
      border: 1px solid rgba(38,38,38,0.1);
      flex-shrink: 0;
      justify-content: flex-end;
      position: relative;
      margin-left: auto;
    }
    .food-controls .btn { 
      padding: 2px 6px; font-size: 0.75em; border-radius: 12px;
      min-width: 20px; height: 20px; display: flex; align-items: center; justify-content: center;
      flex-shrink: 0;
    }
    .food-controls .btn-outline-primary { border: none; background: #fff; color: var(--clr-clay); }
    .food-controls .btn-outline-primary:hover { background: var(--clr-sand); }
    .food-controls .btn-outline-danger { border: none; background: #fff; color: #dc3545; }
    .food-controls .btn-outline-danger:hover { background: #f8d7da; }
    .food-controls .btn-outline-secondary { border: none; background: #fff; color: #6c757d; }
    .food-controls .btn-outline-secondary:hover { background: #e9ecef; }
    .food-controls .qty-display { 
      width: 16px; text-align: center; font-weight: 600; color: var(--clr-ink);
      padding: 0 1px; font-size: 0.75em; flex-shrink: 0;
      display: flex; align-items: center; justify-content: center;
      height: 20px;
      order: -1;
    }
    .food-controls .btn-add-only {
      margin-left: auto;
    }
    .cart-bar {
      position: fixed;
      bottom: 0; left: 0; right: 0;
      max-width: 500px;
      margin: 0 auto;
      background: #fff !important;
      border-top: 2px solid #f1f1f1;
      box-shadow: 0 -2px 14px rgba(0,0,0,0.04);
      z-index: 31;
    }
    .cart-bar-btn {
      font-weight: 600; font-size: 0.95em;
      border-radius: 18px;
      padding: 8px 16px;
      height: 36px;
    }
    @media (max-width: 767px) {
      .cat-side-nav {
        min-width: 80px !important; max-width: 30vw !important;
        border-right: 1px solid #efefef;
        height: calc(100vh - 180px);
      }
      .cat-btn, .cat-btn.selected { font-size: 0.9em; padding: 8px 6px;}
      .cart-bar {
        left:0; right:0;
        border-radius:0 !important;
        bottom: 0;
        max-width: 100vw;
      }
      .container { padding-left: 5px; padding-right: 5px;}
      .food-controls { width: 65px; height: 28px; }
      .food-controls .btn { min-width: 16px; height: 16px; padding: 1px 3px; font-size: 0.65em; }
      .food-img-wrapper { width: 70px; height: 70px; flex-shrink: 0; }
      .food-card { min-height: 70px; }
      .food-title { font-size: 0.85em; }
      .food-price { font-size: 0.8em; }
      .cart-bar-btn { font-size: 0.9em; height: 32px; padding: 6px 12px; }
    }
    @media (max-width:400px){
      .order-header-bar { gap: 2vw;}
      .order-header-box { min-width: 120px; padding: 6px 0.6em;}
      .cart-bar { max-width:100vw;}
      .cat-side-nav { min-width:60px !important;}
    }
    /* Override for buttons on this page */
    button:not(.nav-bar button) {
      width: auto !important;
      margin: 0 !important;
      box-shadow: none !important;
      font-weight: inherit !important;
    }
  </style>
</head>
<body>
  <div class="container pb-5 tight" style="max-width: 500px;">
    <!-- Order summary bar -->
    <div class="order-header-bar mt-2 mb-0">
      <div class="order-header-box d-flex align-items-center flex-grow-1 gap-2">
        <span><svg width="18" height="18" fill="gray" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M8 16s6-5.686 6-10A6 6 0 1 0 2 6c0 4.314 6 10 6 10Zm0-8a2 2 0 1 1 0-4 2 2 0 0 1 0 4Z"/></svg></span>
        <span>
          <div style="font-size:12px;"><span id="orderOption"></span></div>
          <b id="orderStall">Stall A</b>
        </span>
      </div>
      <div class="order-header-box d-flex align-items-center gap-2 flex-grow-1">
        <span id="timeIcon"><svg width="16" height="16" fill="var(--clr-clay)" viewBox="0 0 16 16"><path d="M8 3.5a.5.5 0 0 1 .5.5v4h3a.5.5 0 0 1 0 1H8a.5.5 0 0 1-.5-.5V4a.5.5 0 0 1 .5-.5z"/><path d="M8 16A8 8 0 1 1 8 0a8 8 0 0 1 0 16zM8 1a7 7 0 1 0 0 14A7 7 0 0 0 8 1z"/></svg></span>
        <span id="orderTime">22 Sep 12:00</span>
      </div>
    </div>
    <div class="row gx-0">
      <!-- Categories navigation -->
      <div class="col-md-3 col-4 cat-side-nav d-flex flex-column p-0 mb-1">
        <div id="categoryList"></div>
      </div>
      <!-- Food list -->
      <div class="col-md-9 col-8 px-md-4 px-1 food-panel">
        <div id="foodSections" class="pt-2"></div>
      </div>
    </div>
  </div>
  <!-- Cart bar -->
  <div class="cart-bar shadow-sm py-2 px-3 d-flex justify-content-between align-items-center gap-2">
    <button id="viewCartBtn" class="btn btn-outline-primary cart-bar-btn flex-grow-1">View my cart</button>
    <span class="fw-bold fs-5" id="cartTotal">$0.00</span>
  </div>

  <script>
    // URL params and state
    const urlParams = new URLSearchParams(window.location.search);
    const orderOptionParam = urlParams.get('option') || '';
    const orderStall = urlParams.get('stall') || localStorage.getItem('selectedStall') || 'Stall A';
    const orderTimeParam = urlParams.get('time') || localStorage.getItem('selectedTime') || '22 Sep 12:00';

    // Determine selected option: prefer a value set from stall.html via localStorage, then URL param, then default
    const storedOption = localStorage.getItem('selectedOption'); // stall.html can set this key
    const orderOption = storedOption || orderOptionParam || 'Dine In';
    document.getElementById('orderStall').textContent = orderStall;
    document.getElementById('orderOption').textContent = orderOption;

    // Handle time display: show ASAP or time with clock icon
    const timeEl = document.getElementById('orderTime');
    const timeIcon = document.getElementById('timeIcon');
    
    console.log('orderTimeParam:', orderTimeParam); // Debug log
    
    if (orderTimeParam && orderTimeParam.toLowerCase() === 'asap') {
      // Show ASAP with clock icon
      timeEl.innerHTML = '<svg width="16" height="16" fill="var(--clr-clay)" viewBox="0 0 16 16" style="margin-right: 6px;"><path d="M8 3.5a.5.5 0 0 1 .5.5v4h3a.5.5 0 0 1 0 1H8a.5.5 0 0 1-.5-.5V4a.5.5 0 0 1 .5-.5z"/><path d="M8 16A8 8 0 1 1 8 0a8 8 0 0 1 0 16zM8 1a7 7 0 1 0 0 14A7 7 0 0 0 8 1z"/></svg>ASAP';
      if (timeIcon) timeIcon.style.display = 'none';
    } else {
      // Show time with clock icon
      timeEl.textContent = orderTimeParam;
      if (timeIcon) timeIcon.style.display = 'inline';
    }
  </script>
  <script>
    // Data setup
    let categories = [ { name: "Soup" }, { name: "Noodles" }, { name: "Rice" }, { name: "Sides" } ];
    let foodsPerCategory = [
      [ { name: "ABC Soup", price: 4, img: "/img/food1.jpg", id: "cr", category: "Soup" },
        { name: "Carrot Soup", price: 5, img: "/img/food2.jpg", id: "rd", category: "Soup" },
        { name: "Peanut Soup", price: 7, img: "/img/food3.jpg", id: "sf", category: "Soup" } ],
      [ { name: "Laksa", price: 4.5, img: "/img/food4.jpg", id: "lk", category: "Noodles" },
        { name: "Char Kway Teow", price: 5.5, img: "/img/food5.jpg", id: "ckt", category: "Noodles" },
        { name: "Hokkien Mee", price: 6, img: "/img/food6.jpg", id: "hm", category: "Noodles" } ],
      [ { name: "Egg Fried Rice", price: 4, img: "/img/food7.jpg", id: "nl", category: "Rice" },
        { name: "Bacon Fried Rice", price: 6.5, img: "/img/food8.jpg", id: "ren", category: "Rice" } ],
      [ { name: "Nuggets", price: 3.5, img: "/img/food9.jpg", id: "rp", category: "Sides" },
        { name: "Fried Spring Rolls", price: 7, img: "/img/food10.jpg", id: "bir", category: "Sides" } ]
    ];
    let selectedCatIdx = 0;
    let cart = [];
    
    // Load cart from localStorage on page load
    function loadCart() {
      try {
        const savedCart = localStorage.getItem('cart');
        if (savedCart) {
          cart = JSON.parse(savedCart);
          if (!Array.isArray(cart)) {
            cart = [];
          }
          console.log('Loaded cart from localStorage:', cart);
        } else {
          cart = [];
        }
      } catch (e) {
        console.warn('Error loading cart from localStorage:', e);
        cart = [];
      }
    }
    
    // Save cart to localStorage
    function saveCart() {
      try {
        localStorage.setItem('cart', JSON.stringify(cart));
        console.log('Saved cart to localStorage:', cart);
      } catch (e) {
        console.warn('Error saving cart to localStorage:', e);
      }
    }
    
    // Get quantity for a specific food item
    function getCartQuantity(foodId) {
      const item = cart.find(item => item.id === foodId);
      return item ? item.qty : 0;
    }
    
    // Update cart quantity for a specific food item
    function updateCartQuantity(foodId, quantity) {
      const existingIndex = cart.findIndex(item => item.id === foodId);
      
      if (quantity <= 0) {
        // Remove item from cart
        if (existingIndex !== -1) {
          cart.splice(existingIndex, 1);
        }
      } else {
        // Add or update item in cart
        const foodItem = foodsPerCategory.flat().find(f => f.id === foodId);
        if (foodItem) {
          if (existingIndex !== -1) {
            // Update existing item
            cart[existingIndex].qty = quantity;
          } else {
            // Add new item
            cart.push({
              id: foodId,
              name: foodItem.name,
              price: foodItem.price,
              qty: quantity
            });
          }
        }
      }
      
      saveCart();
    }
    
    // Initialize cart
    loadCart();

    // Removed API; using local categories

    // Side nav/category
    function renderCategoryBar() {
      let html = "";
      categories.forEach((cat, idx) => {
        html += `<button class="cat-btn${idx===selectedCatIdx ? ' selected':''}" onclick="scrollToCategory(${idx})">${cat.name}</button>`;
      });
      document.getElementById('categoryList').innerHTML = html;
    }

    // Food item sections/cards
    function renderFoodSections() {
      let html = "";
      categories.forEach((cat, idx) => {
        html += `<div class="section" id="catSection${idx}">
          <div class="category-header mb-2">${cat.name}</div>
          ${
            foodsPerCategory[idx].length === 0
            ? '<div class="text-muted mb-3">No food in this category.</div>'
            : foodsPerCategory[idx].map(food => {
                const qty = getCartQuantity(food.id);
                return `
                  <div class="food-card" data-food-id="${food.id}">
                    <div class="food-img-wrapper">
                      <img src="${food.img || ''}" alt="${food.name}" class="food-img"/>
                    </div>
                    <div class="food-info">
                      <div class="food-title">${food.name}</div>
                      <div class="food-price">$${food.price.toFixed(2)}</div>
                    </div>
                    <div class="food-controls">
                      ${qty === 0
                        ? `<button type="button" class="btn btn-outline-primary btn-add-only" onclick="addToCart('${food.id}')" aria-label="Add to cart">+</button>`
                        : `<span class="qty-display">${qty}</span>
                           <button type="button" class="btn btn-outline-secondary" onclick="removeFromCart('${food.id}')" aria-label="Remove one">-</button>
                           <button type="button" class="btn btn-outline-primary" onclick="addToCart('${food.id}')" aria-label="Add one more">+</button>`
                      }
                    </div>
                  </div>
                `;
              }).join('')
          }
        </div>`;
      });
      document.getElementById('foodSections').innerHTML = html;
    }

    // Scroll and sync
    function scrollToCategory(idx) {
      const section = document.getElementById('catSection' + idx);
      if (section) section.scrollIntoView({ behavior: 'smooth' });
    }
    window.scrollToCategory = scrollToCategory;

    function updateCategoryOnScroll() {
      let sections = categories.map((_, idx) => document.getElementById('catSection' + idx));
      let scrollPos = window.pageYOffset || document.documentElement.scrollTop;
      let activeIdx = 0;
      
      // Find the section that's most visible in the viewport
      for (let i = 0; i < sections.length; i++) {
        if (sections[i]) {
          let rect = sections[i].getBoundingClientRect();
          let sectionTop = rect.top + window.pageYOffset - 100; // offset for header
          let sectionBottom = sectionTop + rect.height;
          
          // If section is in viewport, make it active
          if (scrollPos >= sectionTop && scrollPos < sectionBottom) {
            activeIdx = i;
            break;
          }
          // If we've scrolled past this section, it's the active one
          if (scrollPos >= sectionTop) {
            activeIdx = i;
          }
        }
      }
      
      if (activeIdx !== selectedCatIdx) {
        selectedCatIdx = activeIdx;
        renderCategoryBar();
      }
    }
    window.addEventListener('scroll', updateCategoryOnScroll);
    
    // Also listen for scroll on the food panel specifically
    document.addEventListener('DOMContentLoaded', function() {
      const foodPanel = document.querySelector('.food-panel');
      if (foodPanel) {
        foodPanel.addEventListener('scroll', updateCategoryOnScroll);
      }
    });

    window.addToCart = function(fid) {
      const currentQty = getCartQuantity(fid);
      updateCartQuantity(fid, currentQty + 1);
      updateFoodItemControls(fid);
      updateCartBar();
    };
    window.removeFromCart = function(fid) {
      const currentQty = getCartQuantity(fid);
      updateCartQuantity(fid, currentQty - 1);
      updateFoodItemControls(fid);
      updateCartBar();
    };

    function updateFoodItemControls(fid) {
      // Find and update only the specific food item controls without re-rendering images
      const qty = getCartQuantity(fid);
      const controlsElement = document.querySelector(`[data-food-id="${fid}"] .food-controls`);
      if (controlsElement) {
        if (qty === 0) {
          controlsElement.innerHTML = `<button type="button" class="btn btn-outline-primary btn-add-only" onclick="addToCart('${fid}')" aria-label="Add to cart">+</button>`;
        } else {
          controlsElement.innerHTML = `<span class="qty-display">${qty}</span>
                                     <button type="button" class="btn btn-outline-secondary" onclick="removeFromCart('${fid}')" aria-label="Remove one">-</button>
                                     <button type="button" class="btn btn-outline-primary" onclick="addToCart('${fid}')" aria-label="Add one more">+</button>`;
        }
      }
    }

    function updateCartBar() {
      let total = 0;
      cart.forEach(item => {
        total += item.price * item.qty;
      });
      document.getElementById('cartTotal').textContent = '$' + total.toFixed(2);
    }

    // View cart button => go to checkout
    document.getElementById('viewCartBtn').onclick = function() {
      // Ensure cart is saved before navigating
      saveCart();
      console.log('Saving cart before checkout:', cart);
      window.location.href = "checkout.html";
    };

    (function init() {
      renderFoodSections();
      renderCategoryBar();
      updateCartBar();
    })();
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
