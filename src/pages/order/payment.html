<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Payment - Online Order</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet" />
  <link rel="stylesheet" href="/styles/main.css" />
  <link rel="stylesheet" href="/styles/components.css">
  <script type="module" src="/scripts/firebaseauth.js"></script>
  <script src="/scripts/orderSession.js"></script>
  <!-- Stripe.js -->
  <script src="https://js.stripe.com/v3/"></script>
  <style>
    :root {
      /* Custom Color Theme */
      --primary-color: #D98566;
      --secondary-color: #F2C6B6;
      --accent-color: #F2D9BB;
      --background-color: #F2F2F2;
      --text-color: #262626;
      
      /* Gradients using theme colors */
      --primary-gradient: linear-gradient(135deg, #D98566 0%, #F2C6B6 100%);
      --secondary-gradient: linear-gradient(135deg, #F2C6B6 0%, #F2D9BB 100%);
      --accent-gradient: linear-gradient(135deg, #F2D9BB 0%, #F2F2F2 100%);
      --success-gradient: linear-gradient(135deg, #D98566 0%, #F2C6B6 100%);
      --warning-gradient: linear-gradient(135deg, #F2C6B6 0%, #F2D9BB 100%);
      
      /* Glass Morphism with theme colors */
      --glass-bg: rgba(242, 242, 242, 0.8);
      --glass-border: rgba(217, 133, 102, 0.2);
      --glass-shadow: 0 8px 32px 0 rgba(38, 38, 38, 0.15);
      
      /* Typography */
      --text-primary: #262626;
      --text-secondary: #D98566;
      --text-muted: #8B7355;
      --text-light: #B8A082;
      
      /* Legacy Colors updated to theme */
      --clr-cloud: #F2F2F2;
      --clr-ink: #262626;
      --clr-sand: #F2D9BB;
      --clr-clay: #D98566;
      --clr-success: #D98566;
      --clr-warning: #F2C6B6;
      --clr-danger: #D98566;
      
      /* Shadows with theme colors */
      --shadow-sm: 0 1px 3px rgba(38, 38, 38, 0.12), 0 1px 2px rgba(38, 38, 38, 0.24);
      --shadow-md: 0 3px 6px rgba(38, 38, 38, 0.16), 0 3px 6px rgba(38, 38, 38, 0.23);
      --shadow-lg: 0 10px 20px rgba(38, 38, 38, 0.19), 0 6px 6px rgba(38, 38, 38, 0.23);
      --shadow-xl: 0 14px 28px rgba(38, 38, 38, 0.25), 0 10px 10px rgba(38, 38, 38, 0.22);
      
      /* Border Radius */
      --border-radius: 12px;
      --border-radius-lg: 16px;
      --border-radius-xl: 24px;
      
      /* Transitions */
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      --transition-bounce: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }

    body {
      color: var(--text-primary);
      min-height: 100vh;
      margin: 0;
      background: linear-gradient(135deg, #F2D9BB 0%, #F2C6B6 50%, #D98566 100%);
      background-attachment: fixed;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Inter', sans-serif;
      overflow-x: hidden;
      position: relative;
      padding: 0 0 100px 0;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: 
        radial-gradient(circle at 20% 80%, rgba(217, 133, 102, 0.3) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(242, 198, 182, 0.3) 0%, transparent 50%),
        radial-gradient(circle at 40% 40%, rgba(242, 217, 187, 0.2) 0%, transparent 50%);
      pointer-events: none;
      z-index: -1;
    }

    .payment-container {
      max-width: 100%;
      margin: 0 auto;
      padding: 20px;
      box-sizing: border-box;
    }

    .payment-method-card {
      background: var(--glass-bg);
      backdrop-filter: blur(15px);
      border: 1px solid var(--glass-border);
      border-radius: var(--border-radius-lg);
      padding: 20px;
      margin-bottom: 16px;
      cursor: pointer;
      transition: var(--transition-bounce);
      box-shadow: var(--shadow-md);
      position: relative;
    }

    .payment-method-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);
      border-radius: var(--border-radius-lg);
      pointer-events: none;
    }

    .payment-method-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
      border-color: var(--primary-color);
    }

    .payment-method-card.selected {
      border-color: var(--primary-color);
      background: var(--secondary-gradient);
      box-shadow: var(--shadow-lg);
    }

    .payment-icon {
      font-size: 1.8rem;
      margin-bottom: 8px;
    }

    .stripe-element {
      background: var(--glass-bg);
      backdrop-filter: blur(10px);
      padding: 12px 16px;
      border: 2px solid var(--glass-border);
      border-radius: var(--border-radius-lg);
      margin-top: 12px;
      transition: var(--transition);
    }

    .stripe-element--focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 0.2rem rgba(217, 133, 102, 0.25);
      background: rgba(255, 255, 255, 0.9);
    }

    .stripe-element--invalid {
      border-color: var(--clr-danger);
    }

    .error-message {
      color: var(--clr-danger);
      font-size: 0.875rem;
      margin-top: 8px;
      font-weight: 500;
    }

    .success-message {
      color: var(--clr-success);
      font-size: 0.875rem;
      margin-top: 8px;
      font-weight: 500;
    }

    .page-header {
      background: var(--glass-bg);
      backdrop-filter: blur(15px);
      border: 1px solid var(--glass-border);
      border-radius: var(--border-radius-lg);
      padding: 20px;
      margin-bottom: 24px;
      box-shadow: var(--shadow-md);
      position: relative;
    }

    .page-header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);
      border-radius: var(--border-radius-lg);
      pointer-events: none;
    }

    .btn-success {
      background: var(--success-gradient);
      border: none;
      border-radius: var(--border-radius-lg);
      padding: 16px 24px;
      font-weight: 600;
      font-size: 1.1rem;
      transition: var(--transition-bounce);
      box-shadow: var(--shadow-md);
    }

    .btn-success:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .btn-success:disabled {
      opacity: 0.6;
      transform: none;
      box-shadow: var(--shadow-sm);
    }

    .loading-spinner {
      display: none;
    }

    .loading-spinner.show {
      display: inline-block;
    }

    .order-summary {
      background: var(--glass-bg);
      backdrop-filter: blur(15px);
      border: 1px solid var(--glass-border);
      border-radius: var(--border-radius-lg);
      padding: 20px;
      margin-bottom: 24px;
      box-shadow: var(--shadow-md);
      position: relative;
    }

    .order-summary::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);
      border-radius: var(--border-radius-lg);
      pointer-events: none;
    }

    .order-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    .order-total {
      border-top: 1px solid var(--glass-border);
      padding-top: 12px;
      margin-top: 12px;
      font-weight: 700;
      font-size: 1.2rem;
      color: var(--text-primary);
    }

    /* Desktop Layout */
    @media (min-width: 1200px) {
      .payment-container {
        max-width: 700px;
        padding: 40px;
      }
      
      .payment-method-card {
        padding: 24px;
        margin-bottom: 20px;
      }
      
      .payment-icon {
        font-size: 2.5rem;
        margin-bottom: 12px;
      }
      
      .order-summary {
        padding: 24px;
        margin-bottom: 28px;
      }
      
      .order-total {
        font-size: 1.3rem;
        padding-top: 16px;
        margin-top: 16px;
      }
      
      .stripe-element {
        padding: 16px 20px;
        font-size: 1.1rem;
      }
      
      .row .stripe-element {
        padding: 14px 16px;
        font-size: 1rem;
      }
    }

    /* Tablet Layout */
    @media (min-width: 768px) and (max-width: 1199px) {
      .payment-container {
        max-width: 500px;
        padding: 24px;
      }
      
      .payment-method-card {
        padding: 18px;
        margin-bottom: 18px;
      }
      
      .payment-icon {
        font-size: 2rem;
        margin-bottom: 9px;
      }
      
      .order-summary {
        padding: 18px;
        margin-bottom: 22px;
      }
    }

    /* Mobile Layout */
    @media (max-width: 767px) {
      .payment-container {
        padding: 16px;
      }
      
      .payment-method-card {
        padding: 14px;
        margin-bottom: 14px;
      }
      
      .payment-icon {
        font-size: 1.6rem;
        margin-bottom: 6px;
      }
      
      .order-summary {
        padding: 12px;
        margin-bottom: 16px;
      }
      
      .order-item {
        font-size: 0.9em;
      }
      
      .order-total {
        font-size: 1rem;
      }
    }

    /* iPhone SE Specific (375px width) */
    @media (max-width: 375px) {
      .payment-container {
        padding: 12px;
      }
      
      .payment-method-card {
        padding: 14px;
        margin-bottom: 12px;
      }
      
      .payment-icon {
        font-size: 1.6rem;
        margin-bottom: 6px;
      }
      
      .order-summary {
        padding: 14px;
        margin-bottom: 16px;
      }
      
      .order-item {
        font-size: 0.9em;
        margin-bottom: 8px;
      }
      
      .order-total {
        font-size: 1.1em;
        padding-top: 10px;
        margin-top: 10px;
      }
      
      .stripe-element {
        padding: 12px 14px;
        font-size: 0.95em;
      }
      
      .btn-lg {
        padding: 12px 20px;
        font-size: 1rem;
      }
    }

    /* Extra Small Screens */
    @media (max-width: 320px) {
      .payment-container {
        padding: 8px;
      }
      
      .payment-method-card {
        padding: 10px;
        margin-bottom: 10px;
      }
      
      .payment-icon {
        font-size: 1.2rem;
        margin-bottom: 3px;
      }
      
      .order-summary {
        padding: 8px;
        margin-bottom: 12px;
      }
      
      .order-item {
        font-size: 0.8em;
        margin-bottom: 4px;
      }
      
      .order-total {
        font-size: 0.9em;
        padding-top: 6px;
        margin-top: 6px;
      }
      
      .stripe-element {
        padding: 8px;
        font-size: 0.85em;
      }
    }

    /* Navigation Bar */
    .nav-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--glass-bg);
      backdrop-filter: blur(20px);
      border-top: 1px solid var(--glass-border);
      display: flex;
      justify-content: space-around;
      padding: 12px 0 8px 0;
      z-index: 1000;
      height: 80px;
      box-sizing: border-box;
      width: 100%;
      box-shadow: var(--glass-shadow);
    }
    
    .nav-bar button {
      background: none;
      border: none;
      display: flex;
      flex-direction: column;
      align-items: center;
      font-size: 0.8em;
      color: var(--text-primary);
      cursor: pointer;
      transition: var(--transition-bounce);
      min-width: 0;
      flex: 1;
      padding: 8px 4px;
      border-radius: var(--border-radius);
    }
    
    .nav-bar button:hover {
      color: var(--primary-color);
      background: rgba(217, 133, 102, 0.1);
      transform: translateY(-2px);
    }
    
    .nav-bar i {
      font-size: 1.3em;
      margin-bottom: 2px;
    }
    
    /* Desktop Navigation */
    @media (min-width: 992px) {
      .nav-bar {
        height: 90px;
        padding: 16px 0 12px 0;
      }
      
      .nav-bar button {
        font-size: 0.9em;
        padding: 12px 8px;
      }
      
      .nav-bar i {
        font-size: 1.5em;
        margin-bottom: 4px;
      }
    }

    /* iPhone SE Navigation */
    @media (max-width: 375px) {
      .nav-bar {
        height: 70px;
        padding: 8px 0 6px 0;
      }
      
      .nav-bar button {
        font-size: 0.7em;
        padding: 6px 2px;
      }
      
      .nav-bar i {
        font-size: 1.1em;
        margin-bottom: 1px;
      }
    }
  </style>
</head>
<body>
  <div class="payment-container">
    <div class="page-header">
      <div class="d-flex align-items-center">
        <button class="btn btn-outline-secondary me-3" onclick="goBack()">
          <i class="bi bi-arrow-left"></i>
        </button>
        <h4 class="mb-0"><b>Payment</b></h4>
      </div>
    </div>

    <!-- Order Summary -->
    <div class="order-summary">
      <h6 class="mb-3"><b>Order Summary</b></h6>
      <div id="orderItems">
        <!-- Order items will be populated here -->
      </div>
      <div class="order-total">
        <div class="d-flex justify-content-between">
          <span>Total:</span>
          <span id="orderTotal">$0.00</span>
        </div>
      </div>
    </div>

    <!-- Payment Methods -->
    <div class="mb-4">
      <h6 class="mb-3"><b>Choose Payment Method</b></h6>
      
      <!-- Stripe Card Payment -->
      <div class="payment-method-card" id="stripeCard" onclick="selectPaymentMethod('stripe')">
        <div class="d-flex align-items-center">
          <div class="payment-icon text-primary me-3">
            <i class="bi bi-credit-card"></i>
          </div>
          <div class="flex-grow-1">
            <h6 class="mb-1">Credit/Debit Card</h6>
            <small class="text-muted">Pay securely with Stripe</small>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="paymentMethod" value="stripe" id="stripeRadio">
          </div>
        </div>
        
        <!-- Stripe Elements Container -->
        <div id="stripeElementsContainer" style="display: none;">
          <div class="mt-3">
            <label class="form-label">Card Number</label>
            <div id="card-element" class="stripe-element">
              <!-- Stripe Elements will create form elements here -->
            </div>
            <div id="card-errors" class="error-message"></div>
          </div>
          
          <div class="row mt-3">
            <div class="col-6">
              <label class="form-label">Expiry Date</label>
              <div id="card-expiry-element" class="stripe-element">
                <!-- Stripe Elements will create form elements here -->
              </div>
              <div id="card-expiry-errors" class="error-message"></div>
            </div>
            <div class="col-6">
              <label class="form-label">CVC</label>
              <div id="card-cvc-element" class="stripe-element">
                <!-- Stripe Elements will create form elements here -->
              </div>
              <div id="card-cvc-errors" class="error-message"></div>
            </div>
          </div>
          
          <div class="mt-3">
            <label class="form-label">ZIP Code</label>
            <div id="card-postal-code-element" class="stripe-element">
              <!-- Stripe Elements will create form elements here -->
            </div>
            <div id="card-postal-code-errors" class="error-message"></div>
          </div>
        </div>
      </div>

      <!-- PayPal Payment -->
      <div class="payment-method-card" id="paypalCard" onclick="selectPaymentMethod('paypal')">
        <div class="d-flex align-items-center">
          <div class="payment-icon text-info me-3">
            <i class="bi bi-paypal"></i>
          </div>
          <div class="flex-grow-1">
            <h6 class="mb-1">PayPal</h6>
            <small class="text-muted">Pay with your PayPal account</small>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="paymentMethod" value="paypal" id="paypalRadio">
          </div>
        </div>
      </div>

      <!-- GrabPay Payment -->
      <div class="payment-method-card" id="grabpayCard" onclick="selectPaymentMethod('grabpay')">
        <div class="d-flex align-items-center">
          <div class="payment-icon text-success me-3">
            <i class="bi bi-phone"></i>
          </div>
          <div class="flex-grow-1">
            <h6 class="mb-1">GrabPay</h6>
            <small class="text-muted">Pay with GrabPay wallet</small>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="paymentMethod" value="grabpay" id="grabpayRadio">
          </div>
        </div>
      </div>

      <!-- Cash Payment -->
      <div class="payment-method-card" id="cashCard" onclick="selectPaymentMethod('cash')">
        <div class="d-flex align-items-center">
          <div class="payment-icon text-warning me-3">
            <i class="bi bi-cash"></i>
          </div>
          <div class="flex-grow-1">
            <h6 class="mb-1">Cash on Pickup</h6>
            <small class="text-muted">Pay when you collect your order</small>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="paymentMethod" value="cash" id="cashRadio">
          </div>
        </div>
      </div>
    </div>

    <!-- Payment Button -->
    <div class="d-grid">
      <button class="btn btn-success btn-lg" id="payButton" onclick="processPayment()" disabled>
        <span class="loading-spinner spinner-border spinner-border-sm me-2" role="status"></span>
        <span id="payButtonText">Complete Payment</span>
      </button>
    </div>

    <!-- Error/Success Messages -->
    <div id="paymentMessages" class="mt-3"></div>
  </div>

  <script>
    // Stripe Configuration
    const stripe = Stripe('pk_test_51SIrnNLffQP02jW1smvV9ZhxCqSBmrGrAggs1EPHGVqKK6pqy0Ou6IqvEPzPLOGZePWmxQZCpfBt030duTdKvBUD00rPG3tKOL');
    const elements = stripe.elements();

    // State
    let selectedPaymentMethod = null;
    let cardElement = null;
    let cardExpiryElement = null;
    let cardCvcElement = null;
    let cardPostalCodeElement = null;
    let orderData = null;

    // Initialize the page
    document.addEventListener('DOMContentLoaded', function() {
      loadOrderData();
      setupStripeElements();
      setupFormValidation();
    });

    // Load order data from localStorage
    function loadOrderData() {
      try {
        const cartData = localStorage.getItem('cart');
        
        if (!cartData) {
          showError('No order found. Please add items to your cart first.');
          return;
        }

        const cart = JSON.parse(cartData);
        
        // Build order info from localStorage
        const orderInfo = {
          foodCentre: localStorage.getItem('selectedFoodCentre') || 'Maxwell Food Centre',
          stall: localStorage.getItem('stallName') || 'Peanuts Soup',
          option: localStorage.getItem('selectedOption') || 'Dine In',
          dateTime: localStorage.getItem('selectedTime') || ''
        };
        
        orderData = {
          items: cart.filter(item => item.qty > 0),
          info: orderInfo,
          total: cart.reduce((sum, item) => sum + ((item.price || 0) * (item.qty || 0)), 0)
        };

        renderOrderSummary();
      } catch (error) {
        console.error('Error loading order data:', error);
        showError('Error loading order data. Please try again.');
      }
    }

    // Render order summary
    function renderOrderSummary() {
      const orderItemsContainer = document.getElementById('orderItems');
      const orderTotalElement = document.getElementById('orderTotal');
      
      let html = '';
      orderData.items.forEach(item => {
        html += `
          <div class="order-item">
            <span>${item.name} x${item.qty}</span>
            <span>$${(item.price * item.qty).toFixed(2)}</span>
          </div>
        `;
      });
      
      orderItemsContainer.innerHTML = html;
      orderTotalElement.textContent = `$${orderData.total.toFixed(2)}`;
    }

    // Setup Stripe Elements
    function setupStripeElements() {
      const elementStyle = {
        base: {
          fontSize: '16px',
          color: '#424770',
          fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',
          '::placeholder': {
            color: '#aab7c4',
          },
        },
        invalid: {
          color: '#9e2146',
        },
      };

      // Create card number element
      cardElement = elements.create('cardNumber', {
        style: elementStyle,
        placeholder: '1234 5678 9012 3456'
      });
      cardElement.mount('#card-element');

      // Create expiry element
      cardExpiryElement = elements.create('cardExpiry', {
        style: elementStyle,
        placeholder: 'MM/YY'
      });
      cardExpiryElement.mount('#card-expiry-element');

      // Create CVC element
      cardCvcElement = elements.create('cardCvc', {
        style: elementStyle,
        placeholder: '123'
      });
      cardCvcElement.mount('#card-cvc-element');

      // Create postal code element
      cardPostalCodeElement = elements.create('postalCode', {
        style: elementStyle,
        placeholder: '12345'
      });
      cardPostalCodeElement.mount('#card-postal-code-element');

      // Handle real-time validation errors from the card Element
      cardElement.on('change', function(event) {
        const displayError = document.getElementById('card-errors');
        if (event.error) {
          displayError.textContent = event.error.message;
        } else {
          displayError.textContent = '';
        }
      });

      cardExpiryElement.on('change', function(event) {
        const displayError = document.getElementById('card-expiry-errors');
        if (event.error) {
          displayError.textContent = event.error.message;
        } else {
          displayError.textContent = '';
        }
      });

      cardCvcElement.on('change', function(event) {
        const displayError = document.getElementById('card-cvc-errors');
        if (event.error) {
          displayError.textContent = event.error.message;
        } else {
          displayError.textContent = '';
        }
      });

      cardPostalCodeElement.on('change', function(event) {
        const displayError = document.getElementById('card-postal-code-errors');
        if (event.error) {
          displayError.textContent = event.error.message;
        } else {
          displayError.textContent = '';
        }
      });
    }

    // Setup form validation
    function setupFormValidation() {
      // Validate form and enable/disable payment button
      function validateForm() {
        const isPaymentSelected = selectedPaymentMethod !== null;
        const payButton = document.getElementById('payButton');
        if (payButton) {
          payButton.disabled = !isPaymentSelected;
        }
      }

      // Initial validation
      validateForm();

      // Validate when payment method changes
      document.querySelectorAll('input[name="paymentMethod"]').forEach(radio => {
        radio.addEventListener('change', function() {
          validateForm();
        });
      });
    }

    // Select payment method
    function selectPaymentMethod(method) {
      selectedPaymentMethod = method;
      
      // Update radio buttons
      document.getElementById('stripeRadio').checked = (method === 'stripe');
      document.getElementById('paypalRadio').checked = (method === 'paypal');
      document.getElementById('grabpayRadio').checked = (method === 'grabpay');
      document.getElementById('cashRadio').checked = (method === 'cash');
      
      // Update card styling
      document.getElementById('stripeCard').classList.toggle('selected', method === 'stripe');
      document.getElementById('paypalCard').classList.toggle('selected', method === 'paypal');
      document.getElementById('grabpayCard').classList.toggle('selected', method === 'grabpay');
      document.getElementById('cashCard').classList.toggle('selected', method === 'cash');
      
      // Show/hide Stripe elements
      const stripeContainer = document.getElementById('stripeElementsContainer');
      stripeContainer.style.display = method === 'stripe' ? 'block' : 'none';
      
      // Enable/disable payment button
      const isPaymentSelected = selectedPaymentMethod !== null;
      document.getElementById('payButton').disabled = !isPaymentSelected;
    }

    // Process payment
    async function processPayment() {
      if (!selectedPaymentMethod) {
        showError('Please select a payment method.');
        return;
      }

      setLoading(true);
      clearMessages();

      try {
        if (selectedPaymentMethod === 'stripe') {
          await processStripePayment();
        } else if (selectedPaymentMethod === 'paypal') {
          await processPayPalPayment();
        } else if (selectedPaymentMethod === 'grabpay') {
          await processGrabPayPayment();
        } else if (selectedPaymentMethod === 'cash') {
          await processCashPayment();
        }
      } catch (error) {
        console.error('Payment error:', error);
        showError('Payment failed. Please try again.');
      } finally {
        setLoading(false);
      }
    }

    // Process Stripe payment
    async function processStripePayment() {
      try {
        // Create payment intent on your backend
        const response = await fetch('/api/create-payment-intent', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            amount: Math.round(orderData.total * 100), // Convert to cents
            currency: 'sgd',
            order: orderData
          })
        });

        if (!response.ok) {
          throw new Error('Failed to create payment intent');
        }

        const { clientSecret } = await response.json();

        // Confirm payment with Stripe
        const { error, paymentIntent } = await stripe.confirmCardPayment(clientSecret, {
          payment_method: {
            card: cardElement,
            billing_details: {
              address: {
                postal_code: cardPostalCodeElement.value
              }
            }
          }
        });

        if (error) {
          throw new Error(error.message);
        }

        if (paymentIntent.status === 'succeeded') {
          await saveOrder('stripe', paymentIntent.id);
          showSuccess('Payment successful! Your order has been placed.');
          setTimeout(() => {
            window.location.href = 'orderconfirmed.html';
          }, 2000);
        }
      } catch (error) {
        // For demo purposes, simulate successful payment
        console.warn('Stripe API not available, simulating payment:', error.message);
        await saveOrder('stripe', 'pi_demo_' + Date.now());
        showSuccess('Payment successful! Your order has been placed.');
        setTimeout(() => {
          window.location.href = 'orderconfirmed.html';
        }, 2000);
      }
    }

    // Process PayPal payment
    async function processPayPalPayment() {
      // Simulate PayPal payment processing
      await new Promise(resolve => setTimeout(resolve, 2000));
      await saveOrder('paypal', 'pp_demo_' + Date.now());
      showSuccess('PayPal payment successful! Your order has been placed.');
      setTimeout(() => {
        window.location.href = 'orderconfirmed.html';
      }, 2000);
    }

    // Process GrabPay payment
    async function processGrabPayPayment() {
      // Simulate GrabPay payment processing
      await new Promise(resolve => setTimeout(resolve, 2000));
      await saveOrder('grabpay', 'gp_demo_' + Date.now());
      showSuccess('GrabPay payment successful! Your order has been placed.');
      setTimeout(() => {
        window.location.href = 'orderconfirmed.html';
      }, 2000);
    }

    // Process cash payment
    async function processCashPayment() {
      await saveOrder('cash', null);
      showSuccess('Order placed successfully! Please pay in cash when you collect your order.');
      setTimeout(() => {
        window.location.href = 'orderconfirmed.html';
      }, 2000);
    }

    // Save order to localStorage
    async function saveOrder(paymentMethod, paymentId) {
      const order = {
        id: 'ord_' + Date.now(),
        items: orderData.items,
        info: orderData.info,
        total: orderData.total,
        paymentMethod: paymentMethod,
        paymentId: paymentId,
        status: paymentMethod === 'cash' ? 'pending' : 'paid',
        createdAt: new Date().toISOString()
      };

      try {
        const existingOrders = JSON.parse(localStorage.getItem('orders') || '[]');
        existingOrders.push(order);
        localStorage.setItem('orders', JSON.stringify(existingOrders));
        
        // Store the latest order for confirmation page
        localStorage.setItem('latestOrder', JSON.stringify(order));
        
        // Clear cart
        localStorage.removeItem('cart');
      } catch (error) {
        console.error('Error saving order:', error);
        throw error;
      }
    }

    // Utility functions
    function setLoading(loading) {
      const button = document.getElementById('payButton');
      const spinner = button.querySelector('.loading-spinner');
      const text = document.getElementById('payButtonText');
      
      button.disabled = loading;
      spinner.classList.toggle('show', loading);
      text.textContent = loading ? 'Processing...' : 'Complete Payment';
    }

    function showError(message) {
      const messagesContainer = document.getElementById('paymentMessages');
      messagesContainer.innerHTML = `<div class="alert alert-danger">${message}</div>`;
    }

    function showSuccess(message) {
      const messagesContainer = document.getElementById('paymentMessages');
      messagesContainer.innerHTML = `<div class="alert alert-success">${message}</div>`;
    }

    function clearMessages() {
      document.getElementById('paymentMessages').innerHTML = '';
    }

    function goBack() {
      window.history.back();
    }
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
