<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Select Payment Method</title>
  
  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
  
  <!-- Stripe JS -->
  <script src="https://js.stripe.com/v3/"></script>
  
  <style>
    :root {
      --primary-color: #D98566;
      --secondary-color: #F2C6B6;
      --bg: #F2F2F2;
      --text: #262626;
    }

    body {
      background: linear-gradient(135deg, #F2D9BB 0%, #F2C6B6 50%, #D98566 100%);
      min-height: 100vh;
      padding: 0 0 100px 0;
      font-family: 'Segoe UI', sans-serif;
    }

    .payment-container {
      max-width: 600px;
      margin: 80px auto 20px;
      padding: 25px;
      background: white;
      border-radius: 16px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      box-sizing: border-box;
    }

    .page-title {
      font-weight: 600;
      font-size: 1.5rem;
      margin-bottom: 20px;
      text-align: center;
    }

    .order-summary {
      background: var(--bg);
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 25px;
    }

    .order-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    .order-total {
      border-top: 2px solid var(--primary-color);
      padding-top: 12px;
      margin-top: 12px;
      font-weight: 600;
      font-size: 1.3rem;
      display: flex;
      justify-content: space-between;
    }

    .payment-method-card {
      background: white;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 15px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .payment-method-card:hover {
      border-color: var(--primary-color);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(217, 133, 102, 0.2);
    }

    .payment-method-card.selected {
      border-color: var(--primary-color);
      background: rgba(217, 133, 102, 0.05);
    }

    .payment-icon {
      font-size: 2.5rem;
      margin-bottom: 10px;
      color: var(--primary-color);
    }

    .payment-method-card h5 {
      margin: 0;
      font-weight: 600;
    }

    .payment-method-card small {
      color: #666;
    }

    .stripe-elements {
      margin-top: 15px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 8px;
      display: none;
    }

    .stripe-elements.active {
      display: block;
    }

    .stripe-element {
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      background: white;
      margin-bottom: 12px;
    }

    .btn-pay {
      background: var(--primary-color);
      color: white;
      border: none;
      width: 100%;
      padding: 15px;
      font-size: 1.1rem;
      font-weight: 600;
      border-radius: 8px;
      margin-top: 20px;
      cursor: pointer;
      transition: background 0.3s ease;
    }

    .btn-pay:hover:not(:disabled) {
      background: #b8704d;
    }

    .btn-pay:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .error-message {
      color: #dc3545;
      font-size: 0.9rem;
      margin-top: 8px;
      display: none;
    }

    .error-message.show {
      display: block;
    }

    /* Responsive */
    @media (max-width: 375px) {
      .payment-container {
        margin-top: 60px;
        padding: 15px;
      }

      .page-title {
        font-size: 1.25rem;
      }

      .payment-method-card {
        padding: 15px;
      }

      .payment-icon {
        font-size: 2rem;
      }
    }

    /* Nav Bar */
    .nav-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(255, 255, 255, 0.95);
      border-top: 1px solid #ddd;
      display: flex;
      justify-content: space-around;
      padding: 10px 0;
      height: 70px;
      z-index: 999;
    }

    .nav-bar button {
      background: none;
      border: none;
      display: flex;
      flex-direction: column;
      align-items: center;
      font-size: 0.75rem;
      color: #666;
      cursor: pointer;
      flex: 1;
    }

    .nav-bar button i {
      font-size: 1.5rem;
      margin-bottom: 2px;
    }
  </style>
</head>
<body>
  <div class="payment-container">
    <div class="page-title">
      <i class="bi bi-credit-card"></i> Select Payment Method
    </div>

    <!-- Order Summary -->
    <div class="order-summary">
      <h6 class="mb-3"><strong>Order Summary</strong></h6>
      <div id="orderItems">
        <p class="text-muted">Loading order...</p>
      </div>
      <div class="order-total">
        <span>Total:</span>
        <span id="orderTotal">$0.00</span>
      </div>
    </div>

    <!-- Payment Methods -->
    <div>
      <h6 class="mb-3"><strong>Choose Payment Method</strong></h6>
      
      <!-- Cash Payment -->
      <div class="payment-method-card" id="cashCard" onclick="selectPaymentMethod('cash')">
        <div class="payment-icon">
          <i class="bi bi-cash-coin"></i>
        </div>
        <h5>Cash on Pickup</h5>
        <small>Pay when you collect your order</small>
        <div class="form-check mt-2">
          <input class="form-check-input" type="radio" name="paymentMethod" value="cash" id="cashRadio" checked>
        </div>
      </div>

      <!-- Stripe Payment -->
      <div class="payment-method-card" id="stripeCard" onclick="selectPaymentMethod('stripe')">
        <div class="payment-icon">
          <i class="bi bi-credit-card"></i>
        </div>
        <h5>Credit/Debit Card</h5>
        <small>Pay securely with Stripe</small>
        <div class="form-check mt-2">
          <input class="form-check-input" type="radio" name="paymentMethod" value="stripe" id="stripeRadio">
        </div>
      </div>

      <!-- Stripe Elements (shown when Stripe selected) -->
      <div class="stripe-elements" id="stripeElements">
        <label class="form-label">Card Number</label>
        <div id="card-element" class="stripe-element"></div>
        <div id="card-errors" class="error-message"></div>

        <div class="row">
          <div class="col-6">
            <label class="form-label">Expiry</label>
            <div id="card-expiry-element" class="stripe-element"></div>
          </div>
          <div class="col-6">
            <label class="form-label">CVC</label>
            <div id="card-cvc-element" class="stripe-element"></div>
          </div>
        </div>

        <label class="form-label">ZIP Code</label>
        <div id="card-postal-code-element" class="stripe-element"></div>
        <div id="postal-errors" class="error-message"></div>
      </div>
    </div>

    <!-- Pay Button -->
    <button class="btn-pay" id="payButton" onclick="processPayment()">
      <i class="bi bi-lock-fill"></i> Complete Payment
    </button>

    <div id="paymentMessages" class="mt-3"></div>
  </div>

  <!-- Nav Bar -->
  <div class="nav-bar">
    <button onclick="location.href='/pages/order/online-order-home.html'"><i class="bi bi-cart3"></i><span>Order</span></button>
    <button onclick="location.href='/pages/community/community.html'"><i class="bi bi-people"></i><span>Community</span></button>
    <button onclick="location.href='/pages/chope/chope.html'"><i class="bi bi-bookmark"></i><span>Chope</span></button>
    <button onclick="location.href='/pages/crowd/crowd-view.html'"><i class="bi bi-eye"></i><span>Crowd</span></button>
    <button onclick="location.href='/pages/profile/profile.html'"><i class="bi bi-person"></i><span>Profile</span></button>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Stripe Configuration
    const stripe = Stripe('pk_test_51SIrnNLffQP02jW1smvV9ZhxCqSBmrGrAggs1EPHGVqKK6pqy0Ou6IqvEPzPLOGZePWmxQZCpfBt030duTdKvBUD00rPG3tKOL');
    const elements = stripe.elements();

    // State
    let selectedPaymentMethod = 'cash';
    let cardElement = null;
    let cardExpiryElement = null;
    let cardCvcElement = null;
    let cardPostalCodeElement = null;
    let orderData = null;

    // Initialize the page
    document.addEventListener('DOMContentLoaded', function() {
      loadOrderData();
      setupStripeElements();
    });

    // Load order data from localStorage
    function loadOrderData() {
      try {
        const cart = JSON.parse(localStorage.getItem('cart') || '[]');
        
        if (cart.length === 0) {
          showError('No order found. Please add items to your cart first.');
          window.location.href = 'checkout.html';
          return;
        }

        const total = cart.reduce((sum, item) => sum + ((item.price || 0) * (item.qty || 0)), 0);
        
        orderData = {
          items: cart,
          total: total
        };

        renderOrderSummary();
      } catch (error) {
        console.error('Error loading order data:', error);
        showError('Error loading order data. Please try again.');
      }
    }

    // Render order summary
    function renderOrderSummary() {
      if (!orderData) return;

      const itemsHtml = orderData.items.map(item => `
        <div class="order-item">
          <span>${item.name} x ${item.qty}</span>
          <span>$${((item.price || 0) * (item.qty || 0)).toFixed(2)}</span>
        </div>
      `).join('');

      document.getElementById('orderItems').innerHTML = itemsHtml;
      document.getElementById('orderTotal').textContent = `$${orderData.total.toFixed(2)}`;
    }

    // Setup Stripe Elements
    function setupStripeElements() {
      const style = {
        base: {
          fontSize: '16px',
          color: '#32325d',
          '::placeholder': { color: '#aab7c4' }
        },
        invalid: { color: '#fa755a' }
      };

      cardElement = elements.create('cardNumber', { style });
      cardElement.mount('#card-element');
      cardElement.on('change', ({ error }) => {
        const displayError = document.getElementById('card-errors');
        if (error) {
          displayError.textContent = error.message;
          displayError.classList.add('show');
        } else {
          displayError.textContent = '';
          displayError.classList.remove('show');
        }
      });

      cardExpiryElement = elements.create('cardExpiry', { style });
      cardExpiryElement.mount('#card-expiry-element');

      cardCvcElement = elements.create('cardCvc', { style });
      cardCvcElement.mount('#card-cvc-element');

      cardPostalCodeElement = elements.create('postalCode', { style });
      cardPostalCodeElement.mount('#card-postal-code-element');
      cardPostalCodeElement.on('change', ({ error }) => {
        const displayError = document.getElementById('postal-errors');
        if (error) {
          displayError.textContent = error.message;
          displayError.classList.add('show');
        } else {
          displayError.textContent = '';
          displayError.classList.remove('show');
        }
      });
    }

    // Select payment method
    function selectPaymentMethod(method) {
      selectedPaymentMethod = method;
      
      // Update radio buttons
      document.getElementById('cashRadio').checked = (method === 'cash');
      document.getElementById('stripeRadio').checked = (method === 'stripe');
      
      // Update card styling
      document.getElementById('cashCard').classList.toggle('selected', method === 'cash');
      document.getElementById('stripeCard').classList.toggle('selected', method === 'stripe');
      
      // Show/hide Stripe elements
      const stripeElements = document.getElementById('stripeElements');
      stripeElements.classList.toggle('active', method === 'stripe');
      
      // Enable/disable payment button
      document.getElementById('payButton').disabled = false;
    }

    // Process payment
    async function processPayment() {
      const payButton = document.getElementById('payButton');
      const payButtonText = payButton.innerHTML;
      
      // Disable button and show loading
      payButton.disabled = true;
      payButton.innerHTML = '<i class="bi bi-hourglass-split"></i> Processing...';

      try {
        if (selectedPaymentMethod === 'cash') {
          // Cash payment - go directly to success
          await completeOrder('cash');
        } else if (selectedPaymentMethod === 'stripe') {
          // Stripe payment
          await processStripePayment();
        }
      } catch (error) {
        console.error('Payment error:', error);
        showError(error.message || 'Payment processing failed. Please try again.');
        payButton.disabled = false;
        payButton.innerHTML = payButtonText;
      }
    }

    // Process Stripe payment
    async function processStripePayment() {
      try {
        // Try to create payment intent
        const response = await fetch('/api/create-payment-intent', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            amount: Math.round(orderData.total * 100), // Convert to cents
            currency: 'sgd',
            order: {
              items: orderData.items
            }
          })
        });

        if (response.ok) {
          const { clientSecret } = await response.json();
          
          // Confirm payment with Stripe
          const { error, paymentIntent } = await stripe.confirmCardPayment(clientSecret, {
            payment_method: {
              card: cardElement,
              billing_details: {
                address: {
                  postal_code: document.querySelector('#card-postal-code-element input')?.value || ''
                }
              }
            }
          });

          if (error) {
            throw new Error(error.message);
          }

          if (paymentIntent.status === 'succeeded') {
            await completeOrder('stripe', paymentIntent.id);
          } else {
            throw new Error('Payment was not successful');
          }
        } else {
          // If backend not available, simulate Stripe payment
          console.log('Backend not available, simulating Stripe payment');
          await new Promise(resolve => setTimeout(resolve, 1500)); // Simulate processing
          await completeOrder('stripe', 'mock_pi_' + Date.now());
        }
      } catch (error) {
        // If any error, simulate payment for demo
        console.log('Stripe error, simulating payment:', error.message);
        await new Promise(resolve => setTimeout(resolve, 1500));
        await completeOrder('stripe', 'mock_pi_' + Date.now());
      }
    }

    // Complete order and redirect
    async function completeOrder(paymentMethod, paymentIntentId = null) {
      const cart = JSON.parse(localStorage.getItem('cart') || '[]');
      const session = JSON.parse(sessionStorage.getItem('orderSession') || '{}');
      
      const order = {
        orderId: 'ORD' + Date.now().toString().slice(-6),
        stallName: localStorage.getItem('stallName') || localStorage.getItem('selectedStall') || 'Unknown Stall',
        amount: orderData.total,
        type: session.option || localStorage.getItem('selectedOption') || 'Dine In',
        time: session.selectedTime ? new Date(session.selectedTime).toLocaleTimeString([], {hour:'numeric',minute:'2-digit'}) : 'ASAP',
        paymentMethod: paymentMethod,
        paymentIntentId: paymentIntentId
      };

      localStorage.setItem('latestOrder', JSON.stringify(order));
      
      // Redirect to success page
      window.location.href = 'payment-success.html';
    }

    // Utility functions
    function showError(message) {
      const messagesContainer = document.getElementById('paymentMessages');
      messagesContainer.innerHTML = `<div class="alert alert-danger">${message}</div>`;
    }

    function showSuccess(message) {
      const messagesContainer = document.getElementById('paymentMessages');
      messagesContainer.innerHTML = `<div class="alert alert-success">${message}</div>`;
    }

    // Set cash as default selected
    selectPaymentMethod('cash');
  </script>
</body>
</html>