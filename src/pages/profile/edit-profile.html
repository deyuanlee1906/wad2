<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Edit Profile</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="/styles/main.css">
  <link rel="stylesheet" href="/styles/components.css">
  <style>
    /* Edit Profile Container */
    .edit-profile-container {
      max-width: 640px;
      margin: 0 auto;
      padding: 20px 16px 80px 16px;
      background-color: #fafafa;
      min-height: 100vh;
    }

    .edit-profile-header {
      background-color: #ffffff;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 24px;
      margin-bottom: 16px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    .edit-profile-header h3 {
      font-size: 20px;
      font-weight: 600;
      color: #1a1a1a;
      margin-bottom: 20px;
    }

    .profile-preview {
      display: flex;
      align-items: center;
      gap: 20px;
      padding-bottom: 20px;
      border-bottom: 1px solid #e0e0e0;
      margin-bottom: 24px;
    }

    .avatar-lg {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: linear-gradient(135deg, #6c757d, #adb5bd);
      color: #ffffff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 32px;
      flex-shrink: 0;
    }

    .profile-info-preview {
      flex: 1;
      min-width: 0;
    }

    .profile-info-preview .username {
      font-size: 16px;
      font-weight: 600;
      color: #1a1a1a;
      margin-bottom: 4px;
    }

    .profile-info-preview .email {
      font-size: 14px;
      color: #666;
    }

    .form-section {
      background-color: #ffffff;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 16px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    .form-section-title {
      font-size: 16px;
      font-weight: 600;
      color: #1a1a1a;
      margin-bottom: 16px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group:last-child {
      margin-bottom: 0;
    }

    .form-label {
      font-size: 14px;
      font-weight: 500;
      color: #1a1a1a;
      margin-bottom: 8px;
      display: block;
    }

    .form-control {
      width: 100%;
      padding: 10px 14px;
      border: 1px solid #d0d0d0;
      border-radius: 6px;
      font-size: 14px;
      background-color: #ffffff;
      color: #1a1a1a;
      transition: all 0.2s ease;
    }

    .form-control:focus {
      outline: none;
      border-color: #C9784F;
      box-shadow: 0 0 0 3px rgba(201, 120, 79, 0.1);
    }

    .form-text {
      font-size: 13px;
      color: #666;
      margin-top: 6px;
      display: block;
    }

    .text-danger {
      color: #dc3545;
      font-size: 13px;
      margin-top: 6px;
    }

    .hidden {
      display: none;
    }

    .btn {
      padding: 10px 20px;
      font-size: 14px;
      font-weight: 500;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .btn-primary {
      background-color: #C9784F;
      color: #ffffff;
    }

    .btn-primary:hover {
      background-color: #b36a43;
    }

    .btn-outline-secondary {
      background-color: transparent;
      border: 1px solid #d0d0d0;
      color: #666;
    }

    .btn-outline-secondary:hover {
      background-color: #f5f5f5;
      color: #1a1a1a;
    }

    .btn-outline-danger {
      background-color: transparent;
      border: 1px solid #dc3545;
      color: #dc3545;
    }

    .btn-outline-danger:hover {
      background-color: #dc3545;
      color: #ffffff;
    }

    .alert {
      padding: 12px 16px;
      border-radius: 6px;
      font-size: 14px;
      background-color: #e7f3ff;
      border: 1px solid #b3d9ff;
      color: #004085;
    }

    /* Mobile Responsive */
    @media (max-width: 768px) {
      .edit-profile-container {
        padding: 12px 12px 80px 12px;
      }

      .edit-profile-header,
      .form-section {
        padding: 16px;
      }

      .profile-preview {
        flex-direction: column;
        align-items: center;
        text-align: center;
      }

      .avatar-lg {
        width: 72px;
        height: 72px;
        font-size: 28px;
      }
    }
  </style>
  <script type="module" src="/scripts/firebaseauth.js"></script>
</head>
<body>
  <div class="edit-profile-container">
    <!-- Header with Profile Preview -->
    <div class="edit-profile-header">
      <h3>Edit Profile</h3>
      
      <div class="profile-preview">
        <div id="avatarPreview" class="avatar-lg">U</div>
        <div class="profile-info-preview">
          <div id="currentUsername" class="username">@username</div>
          <div id="currentEmail" class="email">Loading...</div>
        </div>
        <button id="logoutBtn" class="btn btn-outline-danger">
          <i class="bi bi-box-arrow-right"></i> Logout
        </button>
      </div>

      <!-- Photo Upload -->
      <div class="form-group">
        <input id="photoInput" type="file" accept="image/*" class="form-control">
        <span class="form-text">Upload a new profile photo (JPEG/PNG recommended)</span>
        <div id="photoError" class="text-danger hidden"></div>
      </div>
    </div>

    <!-- Username Section -->
    <div class="form-section">
      <div class="form-section-title">
        <i class="bi bi-at"></i> Username
      </div>
      <div class="form-group">
        <input id="usernameInput" type="text" class="form-control" placeholder="Enter new username">
        <span class="form-text">Must be unique. Use lowercase letters, numbers, and underscores (3-20 characters)</span>
        <div id="usernameError" class="text-danger hidden"></div>
      </div>
      <button id="saveUsernameBtn" class="btn btn-primary">
        <i class="bi bi-check-lg"></i> Save Username
      </button>
    </div>

    <!-- Email Section -->
    <div class="form-section">
      <div class="form-section-title">
        <i class="bi bi-envelope"></i> Email Address
      </div>
      <div class="form-group">
        <input id="emailInput" type="email" class="form-control" placeholder="Enter new email">
        <div id="emailError" class="text-danger hidden"></div>
      </div>
      <button id="saveEmailBtn" class="btn btn-primary">
        <i class="bi bi-check-lg"></i> Save Email
      </button>
    </div>

    <!-- Password Section -->
    <div class="form-section">
      <div class="form-section-title">
        <i class="bi bi-lock"></i> Password
      </div>
      <div class="form-group">
        <input id="passwordInput" type="password" class="form-control" placeholder="Enter new password">
        <span class="form-text">Minimum 8 characters with uppercase, lowercase, number, and special character</span>
        <div id="passwordError" class="text-danger hidden"></div>
      </div>
      <button id="savePasswordBtn" class="btn btn-primary">
        <i class="bi bi-check-lg"></i> Save Password
      </button>
    </div>

    <!-- Info Alert -->
    <div class="alert">
      <i class="bi bi-info-circle"></i> 
      For security, you may need to re-enter your password when changing email or password.
    </div>
  </div>

    <div class="nav-bar">
        <a href="/" class="nav-logo"><i class="bi bi-shop"></i>ChopeLah</a>
        <div class="nav-items">
            <button onclick="location.href='/pages/order/online-order-home.html'">
                <i class="bi bi-cart3"></i>
                <span>Order</span>
            </button>
            <button onclick="location.href='/pages/community/community.html'">
                <i class="bi bi-people"></i>
                <span>Community</span>
            </button>
            <button onclick="location.href='/pages/chope/chope.html'">
                <i class="bi bi-bookmark"></i>
                <span>Chope</span>
            </button>
            <button onclick="location.href='/pages/crowd/crowd-view.html'">
                <i class="bi bi-eye"></i>
                <span>Crowd View</span>
            </button>
        </div>
        <div class="nav-right">
            <button class="notification-btn" onclick="alert('No new notifications')">
                <i class="bi bi-bell"></i>
                <span class="notification-badge">3</span>
            </button>
            <button class="active" onclick="location.href='/pages/profile/profile.html'">
                <i class="bi bi-person"></i>
                <span>Profile</span>
            </button>
        </div>
    </div>

  <script type="module">
    import { getAuth, onAuthStateChanged, updateEmail, updatePassword, signOut, reauthenticateWithCredential, EmailAuthProvider } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-storage.js";

    const auth = getAuth();
    const db = getFirestore();
    const storage = getStorage();

    const avatarPreview = document.getElementById('avatarPreview');
    const currentUsernameEl = document.getElementById('currentUsername');
    const currentEmailEl = document.getElementById('currentEmail');
    const photoInput = document.getElementById('photoInput');
    const photoError = document.getElementById('photoError');

    const usernameInput = document.getElementById('usernameInput');
    const usernameError = document.getElementById('usernameError');
    const saveUsernameBtn = document.getElementById('saveUsernameBtn');

    const emailInput = document.getElementById('emailInput');
    const emailError = document.getElementById('emailError');
    const saveEmailBtn = document.getElementById('saveEmailBtn');

    const passwordInput = document.getElementById('passwordInput');
    const passwordError = document.getElementById('passwordError');
    const savePasswordBtn = document.getElementById('savePasswordBtn');

    const logoutBtn = document.getElementById('logoutBtn');

    function showError(el, message) {
      el.textContent = message || '';
      el.classList.toggle('hidden', !message);
    }

    function setAvatar(name, photoURL) {
      // Always show default grey avatar with initial (no external photos)
      const initial = (name || 'U').trim().charAt(0).toUpperCase() || 'U';
      avatarPreview.textContent = initial;
      avatarPreview.style.background = 'linear-gradient(135deg, #6c757d, #adb5bd)';
      avatarPreview.style.color = '#ffffff';
    }

    async function loadCurrentUser(uid) {
      const snap = await getDoc(doc(db, 'users', uid));
      const data = snap.exists() ? snap.data() : {};
      const username = data.username || (data.email ? data.email.split('@')[0] : 'user');
      currentUsernameEl.textContent = `@${username}`;
      currentEmailEl.textContent = data.email || '';
      // Always use default grey avatar (no external photos)
      setAvatar(username, '');
    }

    onAuthStateChanged(auth, async (user) => {
      const uid = user?.uid || localStorage.getItem('loggedInUserId');
      if (!uid) return;
      await loadCurrentUser(uid);
    });

    // Username change with uniqueness via usernames collection
    saveUsernameBtn.addEventListener('click', async () => {
      showError(usernameError, '');
      const user = auth.currentUser;
      if (!user) return;
      const desired = (usernameInput.value || '').trim().toLowerCase();
      if (!desired) { showError(usernameError, 'Please enter a username.'); return; }
      if (!/^[a-z0-9_]{3,20}$/.test(desired)) { showError(usernameError, '3-20 chars: a-z, 0-9, underscore.'); return; }

      try {
        const currentUserDoc = await getDoc(doc(db, 'users', user.uid));
        const currentUsername = currentUserDoc.exists() ? (currentUserDoc.data().username || '').toLowerCase() : '';
        if (currentUsername === desired) { showError(usernameError, 'This is already your username.'); return; }

        const mappingDoc = await getDoc(doc(db, 'usernames', desired));
        if (mappingDoc.exists()) { showError(usernameError, 'Username is taken.'); return; }

        // Reserve new username
        await setDoc(doc(db, 'usernames', desired), { uid: user.uid, email: user.email });
        // Remove old mapping if exists and belongs to user
        if (currentUsername) {
          const oldRef = doc(db, 'usernames', currentUsername);
          const oldSnap = await getDoc(oldRef);
          if (oldSnap.exists() && oldSnap.data().uid === user.uid) {
            // Soft-delete by overwriting with a placeholder UID could be an option, but we'll skip delete here for safety
          }
        }
        await setDoc(doc(db, 'users', user.uid), { username: desired }, { merge: true });
        await loadCurrentUser(user.uid);
        usernameInput.value = '';
      } catch (e) {
        console.error(e);
        showError(usernameError, 'Could not change username. Try again.');
      }
    });

    // Email change requires reauth when needed
    saveEmailBtn.addEventListener('click', async () => {
      showError(emailError, '');
      const user = auth.currentUser;
      if (!user) return;
      const newEmail = (emailInput.value || '').trim().toLowerCase();
      if (!newEmail) { showError(emailError, 'Please enter an email.'); return; }

      async function doUpdate() {
        await updateEmail(user, newEmail);
        await setDoc(doc(db, 'users', user.uid), { email: newEmail }, { merge: true });
        // Update username mapping email if one exists for user's current username
        const userDoc = await getDoc(doc(db, 'users', user.uid));
        const uname = userDoc.exists() ? (userDoc.data().username || '').toLowerCase() : '';
        if (uname) { await setDoc(doc(db, 'usernames', uname), { uid: user.uid, email: newEmail }, { merge: true }); }
        await loadCurrentUser(user.uid);
        emailInput.value = '';
      }

      try {
        await doUpdate();
      } catch (e) {
        if (e.code === 'auth/requires-recent-login') {
          const currentEmail = auth.currentUser?.email || '';
          const pw = window.prompt('For security, please re-enter your password:');
          if (!pw) { showError(emailError, 'Reauthentication cancelled.'); return; }
          try {
            const cred = EmailAuthProvider.credential(currentEmail, pw);
            await reauthenticateWithCredential(auth.currentUser, cred);
            await doUpdate();
          } catch (err) {
            showError(emailError, 'Reauthentication failed.');
          }
        } else if (e.code === 'auth/email-already-in-use') {
          showError(emailError, 'Email is already in use.');
        } else if (e.code === 'auth/invalid-email') {
          showError(emailError, 'Invalid email format.');
        } else {
          showError(emailError, 'Could not change email. Try again.');
        }
      }
    });

    // Password change with validation
    function validatePassword(pw) {
      const issues = [];
      if (pw.length < 8) issues.push('8+ characters');
      if (!/[A-Z]/.test(pw)) issues.push('1 uppercase');
      if (!/[a-z]/.test(pw)) issues.push('1 lowercase');
      if (!/[0-9]/.test(pw)) issues.push('1 number');
      if (!/[!@#$%^&*()_+\-=[\]{};':"\\|,.<>\/?`~]/.test(pw)) issues.push('1 special');
      return issues;
    }

    savePasswordBtn.addEventListener('click', async () => {
      showError(passwordError, '');
      const user = auth.currentUser;
      if (!user) return;
      const newPw = passwordInput.value || '';
      const issues = validatePassword(newPw);
      if (issues.length) { showError(passwordError, 'Password must include: ' + issues.join(', ')); return; }

      async function doUpdatePw() { await updatePassword(user, newPw); passwordInput.value=''; }

      try {
        await doUpdatePw();
      } catch (e) {
        if (e.code === 'auth/requires-recent-login') {
          const currentEmail = auth.currentUser?.email || '';
          const pw = window.prompt('For security, please re-enter your current password:');
          if (!pw) { showError(passwordError, 'Reauthentication cancelled.'); return; }
          try {
            const cred = EmailAuthProvider.credential(currentEmail, pw);
            await reauthenticateWithCredential(auth.currentUser, cred);
            await doUpdatePw();
          } catch (err) {
            showError(passwordError, 'Reauthentication failed.');
          }
        } else if (e.code === 'auth/weak-password') {
          showError(passwordError, 'Password is too weak.');
        } else {
          showError(passwordError, 'Could not change password.');
        }
      }
    });

    // Photo upload -> Storage -> update users.photoURL
    photoInput.addEventListener('change', async (e) => {
      showError(photoError, '');
      const file = e.target.files?.[0];
      const user = auth.currentUser;
      if (!file || !user) return;
      try {
        const path = `user_uploads/${user.uid}/profile_${Date.now()}`;
        const r = ref(storage, path);
        await uploadBytes(r, file);
        const url = await getDownloadURL(r);
        await setDoc(doc(db, 'users', user.uid), { photoURL: url }, { merge: true });
        await loadCurrentUser(user.uid);
      } catch (e) {
        console.error(e);
        showError(photoError, 'Could not upload photo.');
      }
    });

    // Logout
    logoutBtn.addEventListener('click', async () => {
      try {
        await signOut(auth);
      } catch (_) {}
      localStorage.removeItem('loggedInUserId');
      window.location.href = '/index.html';
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>

