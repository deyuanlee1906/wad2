<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Edit Profile - ChopeLah</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="/styles/main.css">
  <link rel="stylesheet" href="/styles/components.css">
  <style>
    /* Edit Profile Container */
    .edit-profile-container {
      max-width: 640px;
      margin: 0 auto;
      padding: 20px 16px 80px 16px;
      background-color: #fafafa;
      min-height: 100vh;
    }

    .edit-profile-header {
      background-color: #ffffff;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 24px;
      margin-bottom: 16px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    .edit-profile-header h3 {
      font-size: 20px;
      font-weight: 600;
      color: #1a1a1a;
      margin-bottom: 20px;
    }

    .profile-preview {
      display: flex;
      align-items: center;
      gap: 20px;
      padding-bottom: 20px;
      border-bottom: 1px solid #e0e0e0;
      margin-bottom: 24px;
    }

    .avatar-lg {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: linear-gradient(135deg, #6c757d, #adb5bd);
      color: #ffffff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 32px;
      flex-shrink: 0;
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      border: 3px solid #ffffff;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      position: relative;
    }

    .avatar-upload-wrapper {
      position: relative;
      display: inline-block;
    }

    .avatar-upload-btn {
      position: absolute;
      bottom: 0;
      right: 0;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background-color: #C9784F;
      color: #ffffff;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      border: 2px solid #ffffff;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      transition: all 0.2s ease;
      z-index: 10;
    }

    .avatar-upload-btn:hover {
      background-color: #b36a43;
      transform: scale(1.1);
    }

    .avatar-upload-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .avatar-upload-btn i {
      font-size: 14px;
    }

    #profileImageInput {
      display: none;
    }

    .upload-status {
      font-size: 13px;
      margin-top: 8px;
      padding: 8px;
      border-radius: 4px;
    }

    .upload-status.loading {
      background-color: #e7f3ff;
      color: #004085;
    }

    .upload-status.success {
      background-color: #d4edda;
      color: #155724;
    }

    .upload-status.error {
      background-color: #f8d7da;
      color: #721c24;
    }

    .profile-info-preview {
      flex: 1;
      min-width: 0;
    }

    .profile-info-preview .username {
      font-size: 16px;
      font-weight: 600;
      color: #1a1a1a;
      margin-bottom: 4px;
    }

    .profile-info-preview .email {
      font-size: 14px;
      color: #666;
    }

    .form-section {
      background-color: #ffffff;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 16px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    .form-section-title {
      font-size: 16px;
      font-weight: 600;
      color: #1a1a1a;
      margin-bottom: 16px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group:last-child {
      margin-bottom: 0;
    }

    .form-label {
      font-size: 14px;
      font-weight: 500;
      color: #1a1a1a;
      margin-bottom: 8px;
      display: block;
    }

    .form-control {
      width: 100%;
      padding: 10px 14px;
      border: 1px solid #d0d0d0;
      border-radius: 6px;
      font-size: 14px;
      background-color: #ffffff;
      color: #1a1a1a;
      transition: all 0.2s ease;
    }

    .form-control:focus {
      outline: none;
      border-color: #C9784F;
      box-shadow: 0 0 0 3px rgba(201, 120, 79, 0.1);
    }

    .form-control:disabled {
      background-color: #f5f5f5;
      cursor: not-allowed;
    }

    .form-text {
      font-size: 13px;
      color: #666;
      margin-top: 6px;
      display: block;
    }

    .text-danger {
      color: #dc3545;
      font-size: 13px;
      margin-top: 6px;
    }

    .text-success {
      color: #28a745;
      font-size: 13px;
      margin-top: 6px;
    }

    .hidden {
      display: none;
    }

    .btn {
      padding: 10px 20px;
      font-size: 14px;
      font-weight: 500;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .btn-primary {
      background-color: #C9784F;
      color: #ffffff;
    }

    .btn-primary:hover:not(:disabled) {
      background-color: #b36a43;
    }

    .btn-outline-secondary {
      background-color: transparent;
      border: 1px solid #d0d0d0;
      color: #666;
    }

    .btn-outline-secondary:hover:not(:disabled) {
      background-color: #f5f5f5;
      color: #1a1a1a;
    }

    .btn-outline-danger {
      background-color: transparent;
      border: 1px solid #dc3545;
      color: #dc3545;
    }

    .btn-outline-danger:hover:not(:disabled) {
      background-color: #dc3545;
      color: #ffffff;
    }

    .alert {
      padding: 12px 16px;
      border-radius: 6px;
      font-size: 14px;
      margin-bottom: 16px;
    }

    .alert-info {
      background-color: #e7f3ff;
      border: 1px solid #b3d9ff;
      color: #004085;
    }

    .alert-warning {
      background-color: #fff3cd;
      border: 1px solid #ffc107;
      color: #856404;
    }

    .spinner-border-sm {
      width: 1rem;
      height: 1rem;
      border-width: 0.2em;
    }

    /* Mobile Responsive */
    @media (max-width: 768px) {
      .edit-profile-container {
        padding: 12px 12px 80px 12px;
      }

      .edit-profile-header,
      .form-section {
        padding: 16px;
      }

      .profile-preview {
        flex-direction: column;
        align-items: center;
        text-align: center;
      }

      .avatar-lg {
        width: 72px;
        height: 72px;
        font-size: 28px;
      }
    }
  </style>
</head>
<body>
  <div class="edit-profile-container">
    <!-- Header with Profile Preview -->
    <div class="edit-profile-header">
      <h3>Edit Profile</h3>
      
      <div class="profile-preview">
        <div class="avatar-upload-wrapper">
          <div id="avatarPreview" class="avatar-lg">U</div>
          <button type="button" id="avatarUploadBtn" class="avatar-upload-btn" title="Change profile picture">
            <i class="bi bi-camera-fill"></i>
          </button>
          <input type="file" id="profileImageInput" accept="image/jpeg,image/jpg,image/png,image/gif">
        </div>
        <div class="profile-info-preview">
          <div id="currentUsername" class="username">@username</div>
          <div id="currentEmail" class="email">Loading...</div>
        </div>
        <button id="logoutBtn" class="btn btn-outline-danger">
          <i class="bi bi-box-arrow-right"></i> Logout
        </button>
      </div>
      <div id="profileImageStatus" class="upload-status hidden"></div>
    </div>

    <!-- Profile Picture Section -->
    <div class="form-section">
      <div class="form-section-title">
        <i class="bi bi-image"></i> Profile Picture
      </div>
      <div class="form-group">
        <p class="form-text">Upload a profile picture. Supported formats: JPG, PNG, GIF (max 5MB)</p>
        <div id="profileImageError" class="text-danger hidden"></div>
        <div id="profileImageSuccess" class="text-success hidden"></div>
      </div>
    </div>

    <!-- Username Section -->
    <div class="form-section">
      <div class="form-section-title">
        <i class="bi bi-at"></i> Username
      </div>
      <div class="form-group">
        <label for="usernameInput" class="form-label">New Username</label>
        <input id="usernameInput" type="text" class="form-control" placeholder="Enter new username">
        <span class="form-text">Must be unique. Use lowercase letters, numbers, and underscores (3-20 characters)</span>
        <div id="usernameError" class="text-danger hidden"></div>
        <div id="usernameSuccess" class="text-success hidden"></div>
      </div>
      <button id="saveUsernameBtn" class="btn btn-primary">
        <i class="bi bi-check-lg"></i> Save Username
      </button>
    </div>

    <!-- Bio Section -->
    <div class="form-section">
      <div class="form-section-title">
        <i class="bi bi-chat-left-text"></i> Bio
      </div>
      <div class="form-group">
        <label for="bioInput" class="form-label">Bio</label>
        <textarea id="bioInput" class="form-control" placeholder="Tell us about yourself..." rows="4"></textarea>
        <span class="form-text">Share your food interests or favorite hawker centers!</span>
        <div id="bioError" class="text-danger hidden"></div>
        <div id="bioSuccess" class="text-success hidden"></div>
      </div>
      <button id="saveBioBtn" class="btn btn-primary">
        <i class="bi bi-check-lg"></i> Save Bio
      </button>
    </div>

    <!-- Email Section -->
    <div class="form-section">
      <div class="form-section-title">
        <i class="bi bi-envelope"></i> Email Address
      </div>
      <div class="form-group">
        <label for="emailInput" class="form-label">New Email</label>
        <input id="emailInput" type="email" class="form-control" placeholder="Enter new email">
        <span class="form-text">You may need to re-enter your password for security</span>
        <div id="emailError" class="text-danger hidden"></div>
        <div id="emailSuccess" class="text-success hidden"></div>
      </div>
      <button id="saveEmailBtn" class="btn btn-primary">
        <i class="bi bi-check-lg"></i> Save Email
      </button>
    </div>

    <!-- Password Section -->
    <div class="form-section">
      <div class="form-section-title">
        <i class="bi bi-lock"></i> Password
      </div>
      <div class="form-group">
        <label for="passwordInput" class="form-label">New Password</label>
        <input id="passwordInput" type="password" class="form-control" placeholder="Enter new password">
        <span class="form-text">Minimum 8 characters with uppercase, lowercase, number, and special character</span>
        <div id="passwordError" class="text-danger hidden"></div>
        <div id="passwordSuccess" class="text-success hidden"></div>
      </div>
      <button id="savePasswordBtn" class="btn btn-primary">
        <i class="bi bi-check-lg"></i> Save Password
      </button>
    </div>

    <!-- Info Alert -->
    <div class="alert alert-info">
      <i class="bi bi-info-circle"></i> 
      <strong>Note:</strong> For security, you may need to re-enter your password when changing email or password. 
      If you encounter CORS errors, clear your browser cache or use incognito mode.
    </div>
  </div>

  <!-- Navigation Bar -->
    <div class="nav-bar">
        <a href="/" class="nav-logo"><img src="/img/logo.jpg" alt="ChopeLah" /></a>
        <div class="nav-items">
            <button onclick="location.href='/pages/order/online-order-home.html'">
                <i class="bi bi-cart3"></i>
                <span>Order</span>
            </button>
            <button onclick="location.href='/pages/community/community.html'">
                <i class="bi bi-people"></i>
                <span>Community</span>
            </button>
            <button onclick="location.href='/pages/chope/chope.html'">
                <i class="bi bi-bookmark"></i>
                <span>Chope</span>
            </button>
            <button onclick="location.href='/pages/crowd/crowd-view.html'">
                <i class="bi bi-eye"></i>
                <span>Crowd View</span>
            </button>
        </div>
        <div class="nav-right">
            <button class="notification-btn" onclick="alert('No new notifications')">
                <i class="bi bi-bell"></i>
                <span class="notification-badge">3</span>
            </button>
            <button class="active" onclick="location.href='/pages/profile/profile.html'">
                <i class="bi bi-person"></i>
                <span>Profile</span>
            </button>
        </div>
    </div>

  <script type="module">
    /**
     * PROFILE EDITING PAGE - Firebase v9 Modular SDK
     * 
     * This page allows users to:
     * 1. Upload and update profile picture (Firebase Storage)
     * 2. Change username (Firestore)
     * 3. Change bio (Firestore)
     * 4. Change email address (Firebase Auth + Firestore)
     * 5. Change password (Firebase Auth)
     * 
     * Storage: wad2-login-5799b.firebasestorage.app
     * Profile picture path: profilePictures/{user.uid}/profile.jpg
     */

    // ============================================
    // STEP 1: FIREBASE SDK IMPORTS (v9 Modular)
    // ============================================
    // Import Firebase App initialization
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    
    // Import Firebase Auth functions
    import { 
      getAuth, 
      onAuthStateChanged, 
      updateEmail, 
      updatePassword, 
      signOut, 
      reauthenticateWithCredential, 
      EmailAuthProvider 
    } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
    
    // Import Firestore functions
    import { 
      getFirestore, 
      doc, 
      getDoc, 
      setDoc 
    } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";
    
    // Import Firebase Storage functions
    import { 
      getStorage, 
      ref, 
      uploadBytes, 
      getDownloadURL, 
      deleteObject 
    } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-storage.js";

    // ============================================
    // STEP 2: FIREBASE CONFIGURATION
    // ============================================
    // Replace the API key with your actual Firebase API key
    const firebaseConfig = {
      apiKey: "AIzaSyApmvl3E-sbQMZfadYGfa4P0EJ6N7IEZmo", // Replace with your API key
      authDomain: "wad2-login-5799b.firebaseapp.com",
      projectId: "wad2-login-5799b",
      storageBucket: "wad2-login-5799b.firebasestorage.app", // New default bucket
      messagingSenderId: "148986270821",
      appId: "1:148986270821:web:fc17df5adf49b464a1628c"
    };

    // ============================================
    // STEP 3: INITIALIZE FIREBASE SERVICES
    // ============================================
    // Initialize Firebase App
    const app = initializeApp(firebaseConfig);
    
    // Initialize Firebase Auth
    const auth = getAuth(app);
    
    // Initialize Firestore
    const db = getFirestore(app);
    
    // Initialize Firebase Storage with the new bucket
    // The bucket is specified in firebaseConfig.storageBucket
    // If you need to use a different bucket, use: getStorage(app, "gs://bucket-name")
    const storage = getStorage(app);

    // ============================================
    // STEP 4: DOM ELEMENT REFERENCES
    // ============================================
    const avatarPreview = document.getElementById('avatarPreview');
    const currentUsernameEl = document.getElementById('currentUsername');
    const currentEmailEl = document.getElementById('currentEmail');
    const logoutBtn = document.getElementById('logoutBtn');

    // Profile picture elements
    const profileImageInput = document.getElementById('profileImageInput');
    const profileImageError = document.getElementById('profileImageError');
    const profileImageSuccess = document.getElementById('profileImageSuccess');
    const profileImageStatus = document.getElementById('profileImageStatus');
    const avatarUploadBtn = document.getElementById('avatarUploadBtn');

    // Username elements
    const usernameInput = document.getElementById('usernameInput');
    const usernameError = document.getElementById('usernameError');
    const usernameSuccess = document.getElementById('usernameSuccess');
    const saveUsernameBtn = document.getElementById('saveUsernameBtn');

    // Bio elements
    const bioInput = document.getElementById('bioInput');
    const bioError = document.getElementById('bioError');
    const bioSuccess = document.getElementById('bioSuccess');
    const saveBioBtn = document.getElementById('saveBioBtn');

    // Email elements
    const emailInput = document.getElementById('emailInput');
    const emailError = document.getElementById('emailError');
    const emailSuccess = document.getElementById('emailSuccess');
    const saveEmailBtn = document.getElementById('saveEmailBtn');

    // Password elements
    const passwordInput = document.getElementById('passwordInput');
    const passwordError = document.getElementById('passwordError');
    const passwordSuccess = document.getElementById('passwordSuccess');
    const savePasswordBtn = document.getElementById('savePasswordBtn');

    // ============================================
    // STEP 5: UTILITY FUNCTIONS
    // ============================================
    /**
     * Show error message in an element
     * @param {HTMLElement} el - Error element
     * @param {string} message - Error message
     */
    function showError(el, message) {
      if (el) {
        el.textContent = message || '';
        el.classList.toggle('hidden', !message);
      }
    }

    /**
     * Show success message in an element
     * @param {HTMLElement} el - Success element
     * @param {string} message - Success message
     */
    function showSuccess(el, message) {
      if (el) {
      el.textContent = message || '';
      el.classList.toggle('hidden', !message);
        // Auto-hide success message after 3 seconds
        if (message) {
          setTimeout(() => {
            el.classList.add('hidden');
            el.textContent = '';
          }, 3000);
        }
      }
    }

    /**
     * Clear all error and success messages
     */
    function clearMessages() {
      [usernameError, usernameSuccess, bioError, bioSuccess, emailError, 
       emailSuccess, passwordError, passwordSuccess, profileImageError, 
       profileImageSuccess].forEach(el => {
        if (el) {
          el.classList.add('hidden');
          el.textContent = '';
        }
      });
    }

    /**
     * Update avatar display with user's name and optional profile picture
     * @param {string} name - User's display name or username
     * @param {string|null} photoURL - URL of profile picture from Firebase Storage
     */
    function setAvatar(name, photoURL) {
      if (!avatarPreview) return;
      
      if (photoURL && photoURL.trim() !== '') {
        // Show uploaded profile picture from Firebase Storage
        avatarPreview.style.backgroundImage = `url(${photoURL})`;
        avatarPreview.style.backgroundSize = 'cover';
        avatarPreview.style.backgroundPosition = 'center';
        avatarPreview.style.backgroundRepeat = 'no-repeat';
        avatarPreview.textContent = '';
      } else {
        // Show default grey avatar with initial
        const initial = (name || 'U').trim().charAt(0).toUpperCase() || 'U';
        avatarPreview.textContent = initial;
        avatarPreview.style.backgroundImage = 'none';
        avatarPreview.style.background = 'linear-gradient(135deg, #6c757d, #adb5bd)';
        avatarPreview.style.color = '#ffffff';
      }
    }

    // ============================================
    // STEP 6: LOAD CURRENT USER DATA
    // ============================================
    /**
     * Load current user's profile data from Firestore and prefill the form
     * @param {string} uid - User's Firebase Auth UID
     */
    async function loadCurrentUser(uid) {
      try {
        // Get user document from Firestore
        const userDocRef = doc(db, 'users', uid);
        const userDocSnap = await getDoc(userDocRef);
        
        if (!userDocSnap.exists()) {
          console.warn('User document does not exist in Firestore');
          return;
        }

        const userData = userDocSnap.data();
        const username = userData.username || (userData.email ? userData.email.split('@')[0] : 'user');
        const photoURL = userData.photoURL || null;
        const bio = userData.bio || '';
        const email = userData.email || auth.currentUser?.email || '';

        // Update UI elements
        if (currentUsernameEl) {
          currentUsernameEl.textContent = `@${username}`;
        }
        if (currentEmailEl) {
          currentEmailEl.textContent = email;
        }
        if (bioInput) {
          bioInput.value = bio;
        }
        if (usernameInput) {
        usernameInput.value = '';
        }
        if (emailInput) {
          emailInput.placeholder = email || 'Enter new email';
        emailInput.value = '';
      }

        // Update avatar with profile picture if available
        setAvatar(username, photoURL);
        
        console.log('‚úÖ User profile loaded successfully');
      } catch (error) {
        console.error('‚ùå Error loading user data:', error);
        showError(profileImageError, 'Failed to load user profile. Please refresh the page.');
      }
    }

    // ============================================
    // STEP 7: AUTH STATE LISTENER
    // ============================================
    // Listen for authentication state changes
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        // User is signed in, load their profile
        console.log('‚úÖ User authenticated:', user.uid);
        await loadCurrentUser(user.uid);
        } else {
        // User is not signed in, redirect to login
        console.log('‚ùå User not authenticated, redirecting to login...');
        window.location.href = '/index.html';
      }
    });

    // ============================================
    // STEP 8: PROFILE PICTURE UPLOAD
    // ============================================
    /**
     * Handle profile picture upload to Firebase Storage
     * Uploads image to profilePictures/{userId}/profile.jpg
     * Saves download URL to Firestore users/{userId}/photoURL
     */
    
    // Trigger file input when camera button is clicked
    if (avatarUploadBtn && profileImageInput) {
      avatarUploadBtn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        profileImageInput.click();
      });
    }

    // Handle file selection and upload
    if (profileImageInput) {
      profileImageInput.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        // Clear previous messages
        showError(profileImageError, '');
        showSuccess(profileImageSuccess, '');
        profileImageStatus.classList.add('hidden');

        // Validate file type
        const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif'];
        if (!allowedTypes.includes(file.type)) {
          showError(profileImageError, 'Invalid file type. Please upload JPG, PNG, or GIF.');
          profileImageInput.value = '';
          return;
        }

        // Validate file size (max 5MB)
        const maxSize = 5 * 1024 * 1024; // 5MB in bytes
        if (file.size > maxSize) {
          showError(profileImageError, 'File too large. Maximum size is 5MB.');
          profileImageInput.value = '';
          return;
        }

        const user = auth.currentUser;
        if (!user || !user.uid) {
          showError(profileImageError, 'Please sign in to upload a profile picture.');
          profileImageInput.value = '';
          return;
        }

        // Show loading state
        profileImageStatus.classList.remove('hidden');
        profileImageStatus.classList.remove('success', 'error');
        profileImageStatus.classList.add('loading');
        profileImageStatus.innerHTML = '<i class="bi bi-hourglass-split"></i> Uploading profile picture...';
        
        if (avatarUploadBtn) avatarUploadBtn.disabled = true;
        if (profileImageInput) profileImageInput.disabled = true;

        try {
          console.log('üì§ Starting profile picture upload...');
          console.log('User UID:', user.uid);
          console.log('File:', file.name, file.type, file.size);

          // Step 1: Delete old profile picture if it exists in Firebase Storage
          const userDocRef = doc(db, 'users', user.uid);
          const userDocSnap = await getDoc(userDocRef);
          const oldPhotoURL = userDocSnap.exists() ? userDocSnap.data().photoURL : null;
          
          // Only delete if old photo is from Firebase Storage (not Google OAuth photo)
          if (oldPhotoURL && oldPhotoURL.includes('firebasestorage.googleapis.com')) {
            try {
              const oldStorageRef = ref(storage, `profilePictures/${user.uid}/profile.jpg`);
              await deleteObject(oldStorageRef);
              console.log('‚úÖ Deleted old profile picture from Storage');
            } catch (deleteError) {
              // If deletion fails, continue anyway (file might not exist)
              console.warn('‚ö†Ô∏è Could not delete old profile picture:', deleteError.message);
            }
          }

          // Step 2: Upload new profile picture to Firebase Storage
          // Path: profilePictures/{userId}/profile.jpg
          const storagePath = `profilePictures/${user.uid}/profile.jpg`;
          const storageRef = ref(storage, storagePath);
          console.log('üìÅ Storage path:', storagePath);

          // Upload file with metadata
          const uploadResult = await uploadBytes(storageRef, file, {
            contentType: file.type || 'image/jpeg'
          });
          console.log('‚úÖ Upload successful:', uploadResult);

          // Step 3: Get download URL from Firebase Storage
          const downloadURL = await getDownloadURL(uploadResult.ref);
          console.log('üîó Download URL:', downloadURL);

          // Step 4: Save download URL to Firestore
          await setDoc(userDocRef, { 
            photoURL: downloadURL 
          }, { merge: true });
          console.log('üíæ Saved photoURL to Firestore');

          // Step 5: Update avatar preview immediately
          const username = userDocSnap.exists() ? (userDocSnap.data().username || user.displayName || user.email?.split('@')[0] || 'User') : 'User';
          setAvatar(username, downloadURL);

          // Show success message
          profileImageStatus.classList.remove('loading');
          profileImageStatus.classList.add('success');
          profileImageStatus.innerHTML = '<i class="bi bi-check-circle"></i> Profile picture updated successfully!';
          showSuccess(profileImageSuccess, 'Profile picture uploaded successfully!');
          
          // Hide success message after 3 seconds
          setTimeout(() => {
            profileImageStatus.classList.add('hidden');
          }, 3000);

          // Reload user data to ensure consistency
          await loadCurrentUser(user.uid);

        } catch (error) {
          console.error('‚ùå Profile picture upload error:', error);
          console.error('Error code:', error.code);
          console.error('Error message:', error.message);

          // Show detailed error message
          let errorMessage = 'Failed to upload profile picture. ';
          
          if (error.code === 'storage/unauthorized') {
            errorMessage += 'You do not have permission to upload. Please check Firebase Storage rules.';
          } else if (error.code === 'storage/quota-exceeded') {
            errorMessage += 'Storage quota exceeded. Please contact support.';
          } else if (error.code === 'storage/unauthenticated') {
            errorMessage += 'Please sign in to upload a profile picture.';
          } else if (error.code === 'storage/canceled') {
            errorMessage += 'Upload was canceled.';
          } else if (error.message && error.message.includes('CORS')) {
            errorMessage += 'CORS error detected. Please clear your browser cache or use incognito mode.';
          } else if (error.message) {
            errorMessage += error.message;
          } else {
            errorMessage += 'Please try again.';
          }

          showError(profileImageError, errorMessage);
          profileImageStatus.classList.remove('loading');
          profileImageStatus.classList.add('error');
          profileImageStatus.innerHTML = '<i class="bi bi-x-circle"></i> Upload failed. Check error message below.';
        } finally {
          // Reset file input and enable buttons
          if (profileImageInput) {
          profileImageInput.disabled = false;
          profileImageInput.value = '';
          }
          if (avatarUploadBtn) avatarUploadBtn.disabled = false;
        }
      });
    }

    // ============================================
    // STEP 9: USERNAME CHANGE
    // ============================================
    /**
     * Handle username change with uniqueness check via usernames collection
     */
    if (saveUsernameBtn) {
      saveUsernameBtn.addEventListener('click', async () => {
        showError(usernameError, '');
        showSuccess(usernameSuccess, '');
        
      const user = auth.currentUser;
        if (!user) {
          showError(usernameError, 'Please sign in to change your username.');
          return;
        }

        const desired = (usernameInput?.value || '').trim().toLowerCase();
        
        // Validation
        if (!desired) {
          showError(usernameError, 'Please enter a username.');
          return;
        }
        
        if (!/^[a-z0-9_]{3,20}$/.test(desired)) {
          showError(usernameError, 'Username must be 3-20 characters: a-z, 0-9, underscore only.');
          return;
        }

        if (saveUsernameBtn) saveUsernameBtn.disabled = true;

        try {
          // Check current username
          const userDocRef = doc(db, 'users', user.uid);
          const userDocSnap = await getDoc(userDocRef);
          const currentUsername = userDocSnap.exists() ? (userDocSnap.data().username || '').toLowerCase() : '';
          
          if (currentUsername === desired) {
            showError(usernameError, 'This is already your username.');
            if (saveUsernameBtn) saveUsernameBtn.disabled = false;
            return;
          }

          // Check if username is already taken
          const usernameMappingRef = doc(db, 'usernames', desired);
          const usernameMappingSnap = await getDoc(usernameMappingRef);
          
          if (usernameMappingSnap.exists()) {
            showError(usernameError, 'Username is already taken. Please choose another.');
            if (saveUsernameBtn) saveUsernameBtn.disabled = false;
            return;
          }

          // Reserve new username
          await setDoc(usernameMappingRef, { 
            uid: user.uid, 
            email: user.email 
          });

          // Remove old mapping if exists and belongs to user
          if (currentUsername) {
            const oldMappingRef = doc(db, 'usernames', currentUsername);
            const oldMappingSnap = await getDoc(oldMappingRef);
            if (oldMappingSnap.exists() && oldMappingSnap.data().uid === user.uid) {
              // Note: We could delete the old mapping, but keeping it for safety
              // You can uncomment this if you want to delete old mappings:
              // await deleteDoc(oldMappingRef);
            }
          }

          // Update user document
          await setDoc(userDocRef, { 
            username: desired 
          }, { merge: true });

          // Reload user data
          await loadCurrentUser(user.uid);
          
          if (usernameInput) usernameInput.value = '';
          showSuccess(usernameSuccess, 'Username updated successfully!');
          console.log('‚úÖ Username updated:', desired);

        } catch (error) {
          console.error('‚ùå Error changing username:', error);
          showError(usernameError, 'Could not change username. Please try again.');
        } finally {
          if (saveUsernameBtn) saveUsernameBtn.disabled = false;
        }
      });
    }

    // ============================================
    // STEP 10: BIO CHANGE
    // ============================================
    /**
     * Handle bio change (no auth required, just update Firestore)
     */
    if (saveBioBtn) {
      saveBioBtn.addEventListener('click', async () => {
        showError(bioError, '');
        showSuccess(bioSuccess, '');

      const user = auth.currentUser;
      if (!user) {
          showError(bioError, 'Please sign in to update your bio.');
        return;
      }

        const newBio = (bioInput?.value || '').trim();
        
        if (saveBioBtn) saveBioBtn.disabled = true;

        try {
          // Bio can be empty - allow clearing it
          const userDocRef = doc(db, 'users', user.uid);
          await setDoc(userDocRef, { 
            bio: newBio || null 
          }, { merge: true });
          
          // Reload user data
          await loadCurrentUser(user.uid);
          
          showSuccess(bioSuccess, 'Bio updated successfully!');
          console.log('‚úÖ Bio updated');

        } catch (error) {
          console.error('‚ùå Error updating bio:', error);
          showError(bioError, 'Could not update bio. Please try again.');
        } finally {
          if (saveBioBtn) saveBioBtn.disabled = false;
        }
      });
    }

    // ============================================
    // STEP 11: EMAIL CHANGE
    // ============================================
    /**
     * Handle email change (requires reauthentication if needed)
     */
    if (saveEmailBtn) {
      saveEmailBtn.addEventListener('click', async () => {
        showError(emailError, '');
        showSuccess(emailSuccess, '');
        
        const user = auth.currentUser;
        if (!user) {
          showError(emailError, 'Please sign in to change your email.');
          return;
        }

        const newEmail = (emailInput?.value || '').trim().toLowerCase();
        
        // Validation
        if (!newEmail) {
          showError(emailError, 'Please enter an email address.');
          return;
        }

        if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(newEmail)) {
          showError(emailError, 'Please enter a valid email address.');
          return;
        }

        if (saveEmailBtn) saveEmailBtn.disabled = true;

        // Function to perform email update
        async function doUpdateEmail() {
          // Update email in Firebase Auth
          await updateEmail(user, newEmail);
          
          // Update email in Firestore
          const userDocRef = doc(db, 'users', user.uid);
          await setDoc(userDocRef, { 
            email: newEmail 
          }, { merge: true });

          // Update username mapping email if one exists for user's current username
          const userDocSnap = await getDoc(userDocRef);
          const username = userDocSnap.exists() ? (userDocSnap.data().username || '').toLowerCase() : '';
          if (username) {
            const usernameMappingRef = doc(db, 'usernames', username);
            await setDoc(usernameMappingRef, { 
              uid: user.uid, 
              email: newEmail 
            }, { merge: true });
          }

          // Reload user data
          await loadCurrentUser(user.uid);
          
          if (emailInput) emailInput.value = '';
          showSuccess(emailSuccess, 'Email updated successfully!');
          console.log('‚úÖ Email updated:', newEmail);
        }

        try {
          // Try to update email directly
          await doUpdateEmail();
        } catch (error) {
          // If reauthentication is required
          if (error.code === 'auth/requires-recent-login') {
            const currentEmail = auth.currentUser?.email || '';
            const password = window.prompt('For security, please re-enter your password:');
            
            if (!password) {
              showError(emailError, 'Reauthentication cancelled.');
              if (saveEmailBtn) saveEmailBtn.disabled = false;
              return;
            }

            try {
              // Reauthenticate user
              const credential = EmailAuthProvider.credential(currentEmail, password);
              await reauthenticateWithCredential(auth.currentUser, credential);
              
              // Try update again after reauthentication
              await doUpdateEmail();
            } catch (reauthError) {
              console.error('‚ùå Reauthentication error:', reauthError);
              if (reauthError.code === 'auth/wrong-password') {
                showError(emailError, 'Incorrect password. Please try again.');
              } else if (reauthError.code === 'auth/invalid-credential') {
                showError(emailError, 'Invalid credentials. Please try again.');
              } else {
                showError(emailError, 'Reauthentication failed. Please try again.');
              }
            }
          } else if (error.code === 'auth/email-already-in-use') {
            showError(emailError, 'Email is already in use by another account.');
          } else if (error.code === 'auth/invalid-email') {
            showError(emailError, 'Invalid email format.');
          } else {
            console.error('‚ùå Error changing email:', error);
            showError(emailError, 'Could not change email. Please try again.');
          }
        } finally {
          if (saveEmailBtn) saveEmailBtn.disabled = false;
        }
      });
    }

    // ============================================
    // STEP 12: PASSWORD CHANGE
    // ============================================
    /**
     * Validate password strength
     * @param {string} pw - Password to validate
     * @returns {string[]} Array of validation issues
     */
    function validatePassword(pw) {
      const issues = [];
      if (pw.length < 8) issues.push('8+ characters');
      if (!/[A-Z]/.test(pw)) issues.push('1 uppercase letter');
      if (!/[a-z]/.test(pw)) issues.push('1 lowercase letter');
      if (!/[0-9]/.test(pw)) issues.push('1 number');
      if (!/[!@#$%^&*()_+\-=[\]{};':"\\|,.<>\/?`~]/.test(pw)) issues.push('1 special character');
      return issues;
    }

    /**
     * Handle password change (requires reauthentication)
     */
    if (savePasswordBtn) {
      savePasswordBtn.addEventListener('click', async () => {
        showError(passwordError, '');
        showSuccess(passwordSuccess, '');
        
        const user = auth.currentUser;
        if (!user) {
          showError(passwordError, 'Please sign in to change your password.');
          return;
        }

        const newPassword = passwordInput?.value || '';
        
        // Validate password strength
        const issues = validatePassword(newPassword);
        if (issues.length > 0) {
          showError(passwordError, 'Password must include: ' + issues.join(', ') + '.');
          return;
        }

        if (savePasswordBtn) savePasswordBtn.disabled = true;

        // Function to perform password update
        async function doUpdatePassword() {
          await updatePassword(user, newPassword);
          if (passwordInput) passwordInput.value = '';
          showSuccess(passwordSuccess, 'Password updated successfully!');
          console.log('‚úÖ Password updated');
        }

        try {
          // Try to update password directly
          await doUpdatePassword();
      } catch (error) {
          // If reauthentication is required
        if (error.code === 'auth/requires-recent-login') {
            const currentEmail = auth.currentUser?.email || '';
            const password = window.prompt('For security, please re-enter your current password:');
            
            if (!password) {
              showError(passwordError, 'Reauthentication cancelled.');
              if (savePasswordBtn) savePasswordBtn.disabled = false;
              return;
            }

            try {
              // Reauthenticate user
              const credential = EmailAuthProvider.credential(currentEmail, password);
              await reauthenticateWithCredential(auth.currentUser, credential);
              
              // Try update again after reauthentication
              await doUpdatePassword();
            } catch (reauthError) {
              console.error('‚ùå Reauthentication error:', reauthError);
              if (reauthError.code === 'auth/wrong-password') {
                showError(passwordError, 'Incorrect password. Please try again.');
              } else if (reauthError.code === 'auth/invalid-credential') {
                showError(passwordError, 'Invalid credentials. Please try again.');
        } else {
                showError(passwordError, 'Reauthentication failed. Please try again.');
              }
            }
          } else if (error.code === 'auth/weak-password') {
            showError(passwordError, 'Password is too weak. Please choose a stronger password.');
          } else {
            console.error('‚ùå Error changing password:', error);
            showError(passwordError, 'Could not change password. Please try again.');
          }
        } finally {
          if (savePasswordBtn) savePasswordBtn.disabled = false;
        }
      });
    }

    // ============================================
    // STEP 13: LOGOUT
    // ============================================
    if (logoutBtn) {
    logoutBtn.addEventListener('click', async () => {
      try {
        await signOut(auth);
      localStorage.removeItem('loggedInUserId');
      window.location.href = '/index.html';
        } catch (error) {
          console.error('‚ùå Logout error:', error);
          // Still redirect even if logout fails
          localStorage.removeItem('loggedInUserId');
          window.location.href = '/index.html';
        }
      });
    }

    // ============================================
    // INITIALIZATION COMPLETE
    // ============================================
    console.log('‚úÖ Profile editing page initialized successfully');
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
