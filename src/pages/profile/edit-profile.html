<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Edit Profile</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="/styles/main.css">
  <link rel="stylesheet" href="/styles/components.css">
  <style>
    /* Edit Profile Container */
    .edit-profile-container {
      max-width: 640px;
      margin: 0 auto;
      padding: 20px 16px 80px 16px;
      background-color: #fafafa;
      min-height: 100vh;
    }

    .edit-profile-header {
      background-color: #ffffff;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 24px;
      margin-bottom: 16px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    .edit-profile-header h3 {
      font-size: 20px;
      font-weight: 600;
      color: #1a1a1a;
      margin-bottom: 20px;
    }

    .profile-preview {
      display: flex;
      align-items: center;
      gap: 20px;
      padding-bottom: 20px;
      border-bottom: 1px solid #e0e0e0;
      margin-bottom: 24px;
    }

    .avatar-lg {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: linear-gradient(135deg, #6c757d, #adb5bd);
      color: #ffffff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 32px;
      flex-shrink: 0;
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      border: 3px solid #ffffff;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      position: relative;
    }

    .avatar-upload-wrapper {
      position: relative;
      display: inline-block;
    }

    .avatar-upload-btn {
      position: absolute;
      bottom: 0;
      right: 0;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background-color: #C9784F;
      color: #ffffff;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      border: 2px solid #ffffff;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      transition: all 0.2s ease;
      z-index: 10;
    }

    .avatar-upload-btn:hover {
      background-color: #b36a43;
      transform: scale(1.1);
    }

    .avatar-upload-btn i {
      font-size: 14px;
    }

    #profileImageInput {
      display: none;
    }

    .upload-status {
      font-size: 13px;
      margin-top: 8px;
      padding: 8px;
      border-radius: 4px;
    }

    .upload-status.loading {
      background-color: #e7f3ff;
      color: #004085;
    }

    .upload-status.success {
      background-color: #d4edda;
      color: #155724;
    }

    .upload-status.error {
      background-color: #f8d7da;
      color: #721c24;
    }

    .profile-info-preview {
      flex: 1;
      min-width: 0;
    }

    .profile-info-preview .username {
      font-size: 16px;
      font-weight: 600;
      color: #1a1a1a;
      margin-bottom: 4px;
    }

    .profile-info-preview .email {
      font-size: 14px;
      color: #666;
    }

    .form-section {
      background-color: #ffffff;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 16px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    .form-section-title {
      font-size: 16px;
      font-weight: 600;
      color: #1a1a1a;
      margin-bottom: 16px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group:last-child {
      margin-bottom: 0;
    }

    .form-label {
      font-size: 14px;
      font-weight: 500;
      color: #1a1a1a;
      margin-bottom: 8px;
      display: block;
    }

    .form-control {
      width: 100%;
      padding: 10px 14px;
      border: 1px solid #d0d0d0;
      border-radius: 6px;
      font-size: 14px;
      background-color: #ffffff;
      color: #1a1a1a;
      transition: all 0.2s ease;
    }

    .form-control:focus {
      outline: none;
      border-color: #C9784F;
      box-shadow: 0 0 0 3px rgba(201, 120, 79, 0.1);
    }

    .form-text {
      font-size: 13px;
      color: #666;
      margin-top: 6px;
      display: block;
    }

    .text-danger {
      color: #dc3545;
      font-size: 13px;
      margin-top: 6px;
    }

    .hidden {
      display: none;
    }

    .btn {
      padding: 10px 20px;
      font-size: 14px;
      font-weight: 500;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .btn-primary {
      background-color: #C9784F;
      color: #ffffff;
    }

    .btn-primary:hover {
      background-color: #b36a43;
    }

    .btn-outline-secondary {
      background-color: transparent;
      border: 1px solid #d0d0d0;
      color: #666;
    }

    .btn-outline-secondary:hover {
      background-color: #f5f5f5;
      color: #1a1a1a;
    }

    .btn-outline-danger {
      background-color: transparent;
      border: 1px solid #dc3545;
      color: #dc3545;
    }

    .btn-outline-danger:hover {
      background-color: #dc3545;
      color: #ffffff;
    }

    .alert {
      padding: 12px 16px;
      border-radius: 6px;
      font-size: 14px;
      background-color: #e7f3ff;
      border: 1px solid #b3d9ff;
      color: #004085;
    }

    /* Mobile Responsive */
    @media (max-width: 768px) {
      .edit-profile-container {
        padding: 12px 12px 80px 12px;
      }

      .edit-profile-header,
      .form-section {
        padding: 16px;
      }

      .profile-preview {
        flex-direction: column;
        align-items: center;
        text-align: center;
      }

      .avatar-lg {
        width: 72px;
        height: 72px;
        font-size: 28px;
      }
    }
  </style>
  <script type="module" src="/scripts/firebaseauth.js"></script>
</head>
<body>
  <div class="edit-profile-container">
    <!-- Welcome Banner for New Users -->
    <div id="welcomeBanner" class="alert alert-success" style="display: none; background-color: #d4edda; border-color: #c3e6cb; color: #155724;">
      <i class="bi bi-check-circle-fill"></i> 
      <strong>Welcome to ChopeLah!</strong> Your account has been created. Take a moment to customize your profile below, then click "Continue to App" when you're ready.
      <button id="continueToAppBtn" class="btn btn-primary" style="margin-top: 8px;">
        <i class="bi bi-arrow-right-circle"></i> Continue to App
      </button>
    </div>

    <!-- Header with Profile Preview -->
    <div class="edit-profile-header">
      <h3>Edit Profile</h3>
      
      <div class="profile-preview">
        <div class="avatar-upload-wrapper">
          <div id="avatarPreview" class="avatar-lg">U</div>
          <button type="button" id="avatarUploadBtn" class="avatar-upload-btn" title="Change profile picture">
            <i class="bi bi-camera-fill"></i>
          </button>
          <input type="file" id="profileImageInput" accept="image/jpeg,image/jpg,image/png,image/gif">
        </div>
        <div class="profile-info-preview">
          <div id="currentUsername" class="username">@username</div>
          <div id="currentEmail" class="email">Loading...</div>
        </div>
        <button id="logoutBtn" class="btn btn-outline-danger">
          <i class="bi bi-box-arrow-right"></i> Logout
        </button>
      </div>
      <div id="profileImageStatus" class="upload-status hidden"></div>
    </div>

    <!-- Profile Picture Section -->
    <div class="form-section">
      <div class="form-section-title">
        <i class="bi bi-image"></i> Profile Picture
      </div>
      <div class="form-group">
        <p class="form-text">Upload a profile picture. Supported formats: JPG, PNG, GIF (max 5MB)</p>
        <div id="profileImageError" class="text-danger hidden"></div>
      </div>
    </div>

    <!-- Username Section -->
    <div class="form-section">
      <div class="form-section-title">
        <i class="bi bi-at"></i> Username
      </div>
      <div class="form-group">
        <input id="usernameInput" type="text" class="form-control" placeholder="Enter new username">
        <span class="form-text">Must be unique. Use lowercase letters, numbers, and underscores (3-20 characters)</span>
        <div id="usernameError" class="text-danger hidden"></div>
      </div>
      <button id="saveUsernameBtn" class="btn btn-primary">
        <i class="bi bi-check-lg"></i> Save Username
      </button>
    </div>

    <!-- Bio Section -->
    <div class="form-section">
      <div class="form-section-title">
        <i class="bi bi-chat-left-text"></i> Bio
      </div>
      <div class="form-group">
        <textarea id="bioInput" class="form-control" placeholder="Tell us about yourself..." rows="4"></textarea>
        <span class="form-text">Share your food interests or favorite hawker centers!</span>
        <div id="bioError" class="text-danger hidden"></div>
      </div>
      <button id="saveBioBtn" class="btn btn-primary">
        <i class="bi bi-check-lg"></i> Save Bio
      </button>
    </div>

    <!-- Email Section -->
    <div class="form-section">
      <div class="form-section-title">
        <i class="bi bi-envelope"></i> Email Address
      </div>
      <div class="form-group">
        <input id="emailInput" type="email" class="form-control" placeholder="Enter new email">
        <div id="emailError" class="text-danger hidden"></div>
      </div>
      <button id="saveEmailBtn" class="btn btn-primary">
        <i class="bi bi-check-lg"></i> Save Email
      </button>
    </div>

    <!-- Password Section -->
    <div class="form-section">
      <div class="form-section-title">
        <i class="bi bi-lock"></i> Password
      </div>
      <div class="form-group">
        <input id="passwordInput" type="password" class="form-control" placeholder="Enter new password">
        <span class="form-text">Minimum 8 characters with uppercase, lowercase, number, and special character</span>
        <div id="passwordError" class="text-danger hidden"></div>
      </div>
      <button id="savePasswordBtn" class="btn btn-primary">
        <i class="bi bi-check-lg"></i> Save Password
      </button>
    </div>

    <!-- Info Alert -->
    <div class="alert">
      <i class="bi bi-info-circle"></i> 
      For security, you may need to re-enter your password when changing email or password.
    </div>

    <!-- Danger Zone -->
    <div class="form-section" style="border: 2px solid #dc3545;">
      <div class="form-section-title" style="color: #dc3545;">
        <i class="bi bi-exclamation-triangle-fill"></i> Danger Zone
      </div>
      <div class="form-group">
        <p class="text-muted" style="font-size: 14px; margin-bottom: 16px;">
          <strong>Permanently delete your account and all associated data.</strong>
        </p>
        <p class="text-muted" style="font-size: 13px;">
          This action cannot be undone. All your data will be removed:
        </p>
        <ul class="text-muted" style="font-size: 13px; margin-left: 20px;">
          <li>All your posts</li>
          <li>All your likes on posts (hearts will be removed from posts)</li>
          <li>All your follows</li>
          <li>All your saved/bookmarked posts</li>
          <li>Your profile information</li>
          <li>Your authentication account</li>
        </ul>
        <div id="deleteError" class="text-danger hidden" style="margin-top: 12px;"></div>
      </div>
      <button id="deleteAccountBtn" class="btn btn-danger">
        <i class="bi bi-trash3"></i> Delete My Account
      </button>
    </div>
  </div>

    <div class="nav-bar">
        <a href="/" class="nav-logo"><i class="bi bi-shop"></i>ChopeLah</a>
        <div class="nav-items">
            <button onclick="location.href='/pages/order/online-order-home.html'">
                <i class="bi bi-cart3"></i>
                <span>Order</span>
            </button>
            <button onclick="location.href='/pages/community/community.html'">
                <i class="bi bi-people"></i>
                <span>Community</span>
            </button>
            <button onclick="location.href='/pages/chope/chope.html'">
                <i class="bi bi-bookmark"></i>
                <span>Chope</span>
            </button>
            <button onclick="location.href='/pages/crowd/crowd-view.html'">
                <i class="bi bi-eye"></i>
                <span>Crowd View</span>
            </button>
        </div>
        <div class="nav-right">
            <button class="notification-btn" onclick="alert('No new notifications')">
                <i class="bi bi-bell"></i>
                <span class="notification-badge">3</span>
            </button>
            <button class="active" onclick="location.href='/pages/profile/profile.html'">
                <i class="bi bi-person"></i>
                <span>Profile</span>
            </button>
        </div>
    </div>

  <script type="module">
    // Import Firebase Auth functions
    import { getAuth, onAuthStateChanged, updateEmail, updatePassword, signOut, reauthenticateWithCredential, EmailAuthProvider, deleteUser } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
    // Import Firestore functions
    import { getFirestore, doc, getDoc, setDoc, collection, getDocs, deleteDoc, query, where } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";
    // Import Firebase Storage functions
    import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-storage.js";

    // Wait for Firebase to initialize before using it
    let auth, db, storage;

    // Initialize Firebase instances - wait for firebaseauth.js to finish
    async function initFirebase() {
      try {
        // Wait for Firebase to be initialized by firebaseauth.js
        if (window.firebaseInitPromise) {
          await window.firebaseInitPromise;
          console.log('Firebase initialization promise resolved');
        } else {
          // If promise doesn't exist, wait a bit for firebaseauth.js to load
          console.log('Waiting for firebaseauth.js to initialize...');
          let attempts = 0;
          while (!window.firebaseInitPromise && attempts < 20) {
            await new Promise(resolve => setTimeout(resolve, 100));
            attempts++;
          }
          if (window.firebaseInitPromise) {
            await window.firebaseInitPromise;
          }
        }
        
        // Use window.auth and window.db if available (set by firebaseauth.js)
        if (window.auth && window.db) {
          auth = window.auth;
          db = window.db;
          // Initialize Storage using the same app instance
          const { getApp } = await import("https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js");
          const app = window.app || getApp();
          storage = getStorage(app);
          console.log('‚úÖ Using Firebase instances from firebaseauth.js (Auth, Firestore, Storage)');
        } else {
          // Fallback: try to get from default app
          const { getApp } = await import("https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js");
          const app = getApp();
          auth = getAuth(app);
          db = getFirestore(app);
          storage = getStorage(app);
          console.log('Created Firebase instances from default app');
        }
      } catch (error) {
        console.error('Error initializing Firebase:', error);
        // Try to continue with default app anyway
        try {
          const { getApp } = await import("https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js");
          const app = getApp();
          auth = getAuth(app);
          db = getFirestore(app);
        } catch (e) {
          console.error('Failed to initialize Firebase:', e);
          throw e;
        }
      }
    }

    const avatarPreview = document.getElementById('avatarPreview');
    const currentUsernameEl = document.getElementById('currentUsername');
    const currentEmailEl = document.getElementById('currentEmail');

    const usernameInput = document.getElementById('usernameInput');
    const usernameError = document.getElementById('usernameError');
    const saveUsernameBtn = document.getElementById('saveUsernameBtn');

    const bioInput = document.getElementById('bioInput');
    const bioError = document.getElementById('bioError');
    const saveBioBtn = document.getElementById('saveBioBtn');

    const emailInput = document.getElementById('emailInput');
    const emailError = document.getElementById('emailError');
    const saveEmailBtn = document.getElementById('saveEmailBtn');

    const passwordInput = document.getElementById('passwordInput');
    const passwordError = document.getElementById('passwordError');
    const savePasswordBtn = document.getElementById('savePasswordBtn');

    const deleteError = document.getElementById('deleteError');
    const deleteAccountBtn = document.getElementById('deleteAccountBtn');

    const logoutBtn = document.getElementById('logoutBtn');
    const welcomeBanner = document.getElementById('welcomeBanner');
    const continueToAppBtn = document.getElementById('continueToAppBtn');
    
    // Profile picture upload elements
    const profileImageInput = document.getElementById('profileImageInput');
    const profileImageError = document.getElementById('profileImageError');
    const profileImageStatus = document.getElementById('profileImageStatus');
    const avatarUploadBtn = document.getElementById('avatarUploadBtn');

    // Check if this is a new user (from URL parameter)
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('welcome') === 'true') {
      welcomeBanner.style.display = 'block';
    }

    // Handle "Continue to App" button
    if (continueToAppBtn) {
      continueToAppBtn.addEventListener('click', () => {
        window.location.href = '/pages/chope/chope.html';
      });
    }

    function showError(el, message) {
      el.textContent = message || '';
      el.classList.toggle('hidden', !message);
    }

    /**
     * Update avatar display with user's name and optional profile picture
     * @param {string} name - User's display name or username
     * @param {string|null} photoURL - URL of profile picture from Firebase Storage
     */
    function setAvatar(name, photoURL) {
      if (photoURL && photoURL.trim() !== '') {
        // Show uploaded profile picture from Firebase Storage
        avatarPreview.style.backgroundImage = `url(${photoURL})`;
        avatarPreview.style.backgroundSize = 'cover';
        avatarPreview.style.backgroundPosition = 'center';
        avatarPreview.style.backgroundRepeat = 'no-repeat';
        avatarPreview.textContent = '';
      } else {
        // Show default grey avatar with initial
        const initial = (name || 'U').trim().charAt(0).toUpperCase() || 'U';
        avatarPreview.textContent = initial;
        avatarPreview.style.backgroundImage = 'none';
        avatarPreview.style.background = 'linear-gradient(135deg, #6c757d, #adb5bd)';
        avatarPreview.style.color = '#ffffff';
      }
    }

    /**
     * Load current user's profile data from Firestore and prefill the form
     * @param {string} uid - User's Firebase Auth UID
     */
    async function loadCurrentUser(uid) {
      try {
        const snap = await getDoc(doc(db, 'users', uid));
        const data = snap.exists() ? snap.data() : {};
        const username = data.username || (data.email ? data.email.split('@')[0] : 'user');
        const photoURL = data.photoURL || null; // Get photoURL from Firestore
        
        // Update UI elements
        currentUsernameEl.textContent = `@${username}`;
        const currentEmail = data.email || auth.currentUser?.email || '';
        currentEmailEl.textContent = currentEmail;
        bioInput.value = data.bio || '';
        usernameInput.value = ''; // Clear input field
        emailInput.placeholder = currentEmail || 'Enter new email'; // Show current email as placeholder
        
        // Update avatar with profile picture if available
        setAvatar(username, photoURL);
      } catch (error) {
        console.error('Error loading user data:', error);
      }
    }

    // Initialize Firebase and then set up auth state listener
    initFirebase().then(() => {
      if (auth) {
        onAuthStateChanged(auth, async (user) => {
          const uid = user?.uid || localStorage.getItem('loggedInUserId');
          if (!uid) return;
          await loadCurrentUser(uid);
        });
      } else {
        console.error('Auth not available');
        // Try to load with localStorage fallback
        const uid = localStorage.getItem('loggedInUserId');
        if (uid) loadCurrentUser(uid);
      }
    }).catch(error => {
      console.error('Failed to initialize Firebase:', error);
      // Try to load with localStorage fallback
      const uid = localStorage.getItem('loggedInUserId');
      if (uid) loadCurrentUser(uid);
    });

    // Username change with uniqueness via usernames collection
    saveUsernameBtn.addEventListener('click', async () => {
      showError(usernameError, '');
      const user = auth.currentUser;
      if (!user) return;
      const desired = (usernameInput.value || '').trim().toLowerCase();
      if (!desired) { showError(usernameError, 'Please enter a username.'); return; }
      if (!/^[a-z0-9_]{3,20}$/.test(desired)) { showError(usernameError, '3-20 chars: a-z, 0-9, underscore.'); return; }

      try {
        const currentUserDoc = await getDoc(doc(db, 'users', user.uid));
        const currentUsername = currentUserDoc.exists() ? (currentUserDoc.data().username || '').toLowerCase() : '';
        if (currentUsername === desired) { showError(usernameError, 'This is already your username.'); return; }

        const mappingDoc = await getDoc(doc(db, 'usernames', desired));
        if (mappingDoc.exists()) { showError(usernameError, 'Username is taken.'); return; }

        // Reserve new username
        await setDoc(doc(db, 'usernames', desired), { uid: user.uid, email: user.email });
        // Remove old mapping if exists and belongs to user
        if (currentUsername) {
          const oldRef = doc(db, 'usernames', currentUsername);
          const oldSnap = await getDoc(oldRef);
          if (oldSnap.exists() && oldSnap.data().uid === user.uid) {
            // Soft-delete by overwriting with a placeholder UID could be an option, but we'll skip delete here for safety
          }
        }
        await setDoc(doc(db, 'users', user.uid), { username: desired }, { merge: true });
        await loadCurrentUser(user.uid);
        usernameInput.value = '';
      } catch (e) {
        console.error(e);
        showError(usernameError, 'Could not change username. Try again.');
      }
    });

    // Email change requires reauth when needed
    saveEmailBtn.addEventListener('click', async () => {
      showError(emailError, '');
      const user = auth.currentUser;
      if (!user) return;
      const newEmail = (emailInput.value || '').trim().toLowerCase();
      if (!newEmail) { showError(emailError, 'Please enter an email.'); return; }

      async function doUpdate() {
        await updateEmail(user, newEmail);
        await setDoc(doc(db, 'users', user.uid), { email: newEmail }, { merge: true });
        // Update username mapping email if one exists for user's current username
        const userDoc = await getDoc(doc(db, 'users', user.uid));
        const uname = userDoc.exists() ? (userDoc.data().username || '').toLowerCase() : '';
        if (uname) { await setDoc(doc(db, 'usernames', uname), { uid: user.uid, email: newEmail }, { merge: true }); }
        await loadCurrentUser(user.uid);
        emailInput.value = '';
      }

      try {
        await doUpdate();
      } catch (e) {
        if (e.code === 'auth/requires-recent-login') {
          const currentEmail = auth.currentUser?.email || '';
          const pw = window.prompt('For security, please re-enter your password:');
          if (!pw) { showError(emailError, 'Reauthentication cancelled.'); return; }
          try {
            const cred = EmailAuthProvider.credential(currentEmail, pw);
            await reauthenticateWithCredential(auth.currentUser, cred);
            await doUpdate();
          } catch (err) {
            showError(emailError, 'Reauthentication failed.');
          }
        } else if (e.code === 'auth/email-already-in-use') {
          showError(emailError, 'Email is already in use.');
        } else if (e.code === 'auth/invalid-email') {
          showError(emailError, 'Invalid email format.');
        } else {
          showError(emailError, 'Could not change email. Try again.');
        }
      }
    });

    // Password change with validation
    function validatePassword(pw) {
      const issues = [];
      if (pw.length < 8) issues.push('8+ characters');
      if (!/[A-Z]/.test(pw)) issues.push('1 uppercase');
      if (!/[a-z]/.test(pw)) issues.push('1 lowercase');
      if (!/[0-9]/.test(pw)) issues.push('1 number');
      if (!/[!@#$%^&*()_+\-=[\]{};':"\\|,.<>\/?`~]/.test(pw)) issues.push('1 special');
      return issues;
    }

    savePasswordBtn.addEventListener('click', async () => {
      showError(passwordError, '');
      const user = auth.currentUser;
      if (!user) return;
      const newPw = passwordInput.value || '';
      const issues = validatePassword(newPw);
      if (issues.length) { showError(passwordError, 'Password must include: ' + issues.join(', ')); return; }

      async function doUpdatePw() { await updatePassword(user, newPw); passwordInput.value=''; }

      try {
        await doUpdatePw();
      } catch (e) {
        if (e.code === 'auth/requires-recent-login') {
          const currentEmail = auth.currentUser?.email || '';
          const pw = window.prompt('For security, please re-enter your current password:');
          if (!pw) { showError(passwordError, 'Reauthentication cancelled.'); return; }
          try {
            const cred = EmailAuthProvider.credential(currentEmail, pw);
            await reauthenticateWithCredential(auth.currentUser, cred);
            await doUpdatePw();
          } catch (err) {
            showError(passwordError, 'Reauthentication failed.');
          }
        } else if (e.code === 'auth/weak-password') {
          showError(passwordError, 'Password is too weak.');
        } else {
          showError(passwordError, 'Could not change password.');
        }
      }
    });

    /**
     * Handle profile picture upload to Firebase Storage
     * Uploads image to profilePictures/{userId}/profile.jpg
     * Saves download URL to Firestore users/{userId}/photoURL
     */
    // Trigger file input when camera button is clicked
    if (avatarUploadBtn && profileImageInput) {
      avatarUploadBtn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        profileImageInput.click();
      });
    }

    // Handle file selection and upload
    if (profileImageInput) {
      profileImageInput.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        // Clear previous errors
        showError(profileImageError, '');
        profileImageStatus.classList.add('hidden');

        // Validate file type
        const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif'];
        if (!allowedTypes.includes(file.type)) {
          showError(profileImageError, 'Invalid file type. Please upload JPG, PNG, or GIF.');
          profileImageInput.value = '';
          return;
        }

        // Validate file size (max 5MB)
        const maxSize = 5 * 1024 * 1024; // 5MB in bytes
        if (file.size > maxSize) {
          showError(profileImageError, 'File too large. Maximum size is 5MB.');
          profileImageInput.value = '';
          return;
        }

        const user = auth.currentUser;
        if (!user || !user.uid) {
          showError(profileImageError, 'Please sign in to upload a profile picture.');
          profileImageInput.value = '';
          return;
        }

        if (!storage) {
          showError(profileImageError, 'Storage not initialized. Please refresh the page.');
          profileImageInput.value = '';
          return;
        }

        // Show loading state
        profileImageStatus.classList.remove('hidden');
        profileImageStatus.classList.remove('success', 'error');
        profileImageStatus.classList.add('loading');
        profileImageStatus.innerHTML = '<i class="bi bi-hourglass-split"></i> Uploading profile picture...';
        profileImageInput.disabled = true;
        avatarUploadBtn.disabled = true;

        try {
          console.log('üì§ Starting profile picture upload...');
          console.log('User UID:', user.uid);
          console.log('File:', file.name, file.type, file.size);

          // Step 1: Delete old profile picture if it exists in Firebase Storage
          const userDoc = await getDoc(doc(db, 'users', user.uid));
          const oldPhotoURL = userDoc.exists() ? userDoc.data().photoURL : null;
          
          // Only delete if old photo is from Firebase Storage (not Google OAuth photo)
          if (oldPhotoURL && oldPhotoURL.includes('firebasestorage.googleapis.com')) {
            try {
              const oldStorageRef = ref(storage, `profilePictures/${user.uid}/profile.jpg`);
              await deleteObject(oldStorageRef);
              console.log('‚úÖ Deleted old profile picture from Storage');
            } catch (deleteError) {
              // If deletion fails, continue anyway (file might not exist)
              console.warn('‚ö†Ô∏è Could not delete old profile picture:', deleteError.message);
            }
          }

          // Step 2: Upload new profile picture to Firebase Storage
          // Path: profilePictures/{userId}/profile.jpg
          const storagePath = `profilePictures/${user.uid}/profile.jpg`;
          const storageRef = ref(storage, storagePath);
          console.log('üìÅ Storage path:', storagePath);

          // Upload file with metadata
          const uploadResult = await uploadBytes(storageRef, file, {
            contentType: file.type || 'image/jpeg'
          });
          console.log('‚úÖ Upload successful:', uploadResult);

          // Step 3: Get download URL from Firebase Storage
          const downloadURL = await getDownloadURL(uploadResult.ref);
          console.log('üîó Download URL:', downloadURL);

          // Step 4: Save download URL to Firestore
          await setDoc(doc(db, 'users', user.uid), { 
            photoURL: downloadURL 
          }, { merge: true });
          console.log('üíæ Saved photoURL to Firestore');

          // Step 5: Update avatar preview immediately
          setAvatar(user.displayName || user.email?.split('@')[0] || 'User', downloadURL);

          // Show success message
          profileImageStatus.classList.remove('loading');
          profileImageStatus.classList.add('success');
          profileImageStatus.innerHTML = '<i class="bi bi-check-circle"></i> Profile picture updated successfully!';
          
          // Hide success message after 3 seconds
          setTimeout(() => {
            profileImageStatus.classList.add('hidden');
          }, 3000);

          // Reload user data to ensure consistency
          await loadCurrentUser(user.uid);

        } catch (error) {
          console.error('‚ùå Profile picture upload error:', error);
          console.error('Error code:', error.code);
          console.error('Error message:', error.message);

          // Show detailed error message
          let errorMessage = 'Failed to upload profile picture. ';
          
          if (error.code === 'storage/unauthorized') {
            errorMessage += 'You do not have permission to upload. Please check Firebase Storage rules.';
          } else if (error.code === 'storage/quota-exceeded') {
            errorMessage += 'Storage quota exceeded. Please contact support.';
          } else if (error.code === 'storage/unauthenticated') {
            errorMessage += 'Please sign in to upload a profile picture.';
          } else if (error.message) {
            errorMessage += error.message;
          } else {
            errorMessage += 'Please try again.';
          }

          showError(profileImageError, errorMessage);
          profileImageStatus.classList.remove('loading');
          profileImageStatus.classList.add('error');
          profileImageStatus.innerHTML = '<i class="bi bi-x-circle"></i> Upload failed. Check error message below.';
        } finally {
          // Reset file input and enable buttons
          profileImageInput.disabled = false;
          avatarUploadBtn.disabled = false;
          profileImageInput.value = '';
        }
      });
    }

    // Bio change (no auth required, just update Firestore)
    saveBioBtn.addEventListener('click', async () => {
      showError(bioError, '');
      const user = auth.currentUser;
      if (!user) return;
      const newBio = (bioInput.value || '').trim();
      
      // Bio can be empty - allow clearing it
      try {
        await setDoc(doc(db, 'users', user.uid), { bio: newBio || null }, { merge: true });
        await loadCurrentUser(user.uid);
        alert('Bio updated successfully!');
      } catch (e) {
        console.error(e);
        showError(bioError, 'Could not update bio. Try again.');
      }
    });

    // Delete Account with comprehensive cleanup
    deleteAccountBtn.addEventListener('click', async () => {
      const confirmation = window.prompt(
        '‚ö†Ô∏è WARNING: This will permanently delete your account and ALL data.\n\n' +
        'Type "DELETE" (in capitals) to confirm deletion:'
      );
      
      if (confirmation !== 'DELETE') {
        if (confirmation) {
          showError(deleteError, 'Deletion cancelled. You must type "DELETE" exactly (in capitals).');
        }
        return;
      }

      const user = auth.currentUser;
      if (!user) {
        showError(deleteError, 'Not authenticated.');
        return;
      }

      const uid = user.uid;
      deleteAccountBtn.disabled = true;
      deleteAccountBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Deleting...';
      showError(deleteError, '');

      try {
        console.log('Starting account deletion for user:', uid);

        // Step 1: Get user's username for cleanup
        const userDoc = await getDoc(doc(db, 'users', uid));
        const username = userDoc.exists() ? userDoc.data().username : null;
        console.log('Username:', username);

        // Step 2: Delete all user's posts and their likes
        const postsQuery = query(collection(db, 'posts'), where('authorId', '==', uid));
        const postsSnapshot = await getDocs(postsQuery);
        console.log(`Deleting ${postsSnapshot.size} user posts...`);
        
        for (const postDoc of postsSnapshot.docs) {
          const postId = postDoc.id;
          
          // Delete all likes on this post
          const postLikesSnapshot = await getDocs(collection(db, 'posts', postId, 'likes'));
          for (const likeDoc of postLikesSnapshot.docs) {
            await deleteDoc(likeDoc.ref);
          }
          
          // Delete the post itself
          await deleteDoc(doc(db, 'posts', postId));
        }

        // Step 3: Remove user's likes from ALL posts (this resets hearts on other posts)
        const userLikesSnapshot = await getDocs(collection(db, 'users', uid, 'likes'));
        console.log(`Cleaning up ${userLikesSnapshot.size} likes from posts...`);
        
        for (const likeDoc of userLikesSnapshot.docs) {
          const postId = likeDoc.id;
          // Remove from post's likes subcollection (this decrements like count)
          try {
            await deleteDoc(doc(db, 'posts', postId, 'likes', uid));
          } catch (e) {
            console.warn(`Could not delete like from post ${postId}:`, e);
          }
          // Remove from user's likes subcollection
          await deleteDoc(likeDoc.ref);
        }

        // Step 4: Delete user's bookmarks
        const userBookmarksSnapshot = await getDocs(collection(db, 'users', uid, 'bookmarks'));
        console.log(`Cleaning up ${userBookmarksSnapshot.size} bookmarks...`);
        
        for (const bookmarkDoc of userBookmarksSnapshot.docs) {
          await deleteDoc(bookmarkDoc.ref);
        }

        // Step 5: Delete user's follows
        const userFollowsSnapshot = await getDocs(collection(db, 'users', uid, 'follows'));
        console.log(`Cleaning up ${userFollowsSnapshot.size} follows...`);
        
        for (const followDoc of userFollowsSnapshot.docs) {
          await deleteDoc(followDoc.ref);
        }

        // Step 6: Delete profile picture from Storage (if exists)
        try {
          const userDocSnapshot = await getDoc(doc(db, 'users', uid));
          const photoURL = userDocSnapshot.exists() ? userDocSnapshot.data().photoURL : null;
          
          // Only delete if photo is from Firebase Storage (not Google OAuth)
          if (photoURL && photoURL.includes('firebasestorage.googleapis.com') && storage) {
            try {
              const storageRef = ref(storage, `profilePictures/${uid}/profile.jpg`);
              await deleteObject(storageRef);
              console.log('‚úÖ Deleted profile picture from Storage');
            } catch (storageError) {
              console.warn('‚ö†Ô∏è Could not delete profile picture from Storage:', storageError);
            }
          }
        } catch (storageError) {
          console.warn('‚ö†Ô∏è Error checking for profile picture:', storageError);
        }

        // Step 7: Delete username reservation
        if (username) {
          try {
            await deleteDoc(doc(db, 'usernames', username));
            console.log(`Deleted username reservation: ${username}`);
          } catch (e) {
            console.warn('Could not delete username reservation:', e);
          }
        }

        // Step 8: Delete user document
        await deleteDoc(doc(db, 'users', uid));
        console.log('Deleted user document');

        // Step 9: Delete Firebase Auth account
        await deleteUser(user);
        console.log('Deleted Firebase Auth user');

        // Step 10: Clear local storage
        localStorage.removeItem('loggedInUserId');

        // Success - redirect to home
        alert('‚úÖ Your account has been permanently deleted.\n\nAll your likes, follows, and bookmarks have been removed from all posts.');
        window.location.href = '/index.html';

      } catch (error) {
        console.error('Account deletion error:', error);
        deleteAccountBtn.disabled = false;
        deleteAccountBtn.innerHTML = '<i class="bi bi-trash3"></i> Delete My Account';
        
        if (error.code === 'auth/requires-recent-login') {
          showError(deleteError, 
            'üîí For security, please log out and log back in, then try deleting your account again.');
        } else {
          showError(deleteError, 
            '‚ùå Could not delete account: ' + (error.message || 'Unknown error. Please try again.'));
        }
      }
    });

    // Logout
    logoutBtn.addEventListener('click', async () => {
      try {
        await signOut(auth);
      } catch (_) {}
      localStorage.removeItem('loggedInUserId');
      window.location.href = '/index.html';
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>

