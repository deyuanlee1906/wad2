<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Profile</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="/styles/main.css">
  <link rel="stylesheet" href="/styles/components.css">
  <style>
    /* Profile Container */
    .profile-container {
      max-width: 935px;
      margin: 0 auto;
      padding: 20px 16px 80px 16px;
      background-color: #fafafa;
      min-height: 100vh;
    }

    /* Profile Header */
    .profile-header {
      background-color: #ffffff;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 24px;
      margin-bottom: 16px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    .profile-info {
      display: flex;
      align-items: center;
      gap: 24px;
    }

    .profile-avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: linear-gradient(135deg, #6c757d, #adb5bd);
      color: #ffffff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 32px;
      flex-shrink: 0;
    }

    .profile-details {
      flex: 1;
      min-width: 0;
    }

    .profile-username {
      font-size: 20px;
      font-weight: 600;
      color: #1a1a1a;
      margin-bottom: 4px;
    }

    .profile-name {
      font-size: 14px;
      color: #666;
      margin-bottom: 8px;
    }

    .profile-bio {
      font-size: 14px;
      color: #1a1a1a;
      line-height: 1.5;
      margin-bottom: 12px;
      max-width: 500px;
      word-wrap: break-word;
    }

    .profile-bio:empty {
      display: none;
    }

    .profile-actions button {
      padding: 8px 24px;
      font-size: 14px;
      font-weight: 500;
      border-radius: 6px;
    }

    /* Tabs */
    .profile-tabs {
      background-color: #ffffff;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      display: flex;
      justify-content: center;
      margin-bottom: 16px;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    .tab-btn {
      flex: 1;
      background: none !important;
      border: none !important;
      padding: 16px 12px !important;
      font-weight: 500 !important;
      font-size: 14px !important;
      color: #666 !important;
      border-bottom: 3px solid transparent !important;
      cursor: pointer;
      transition: all 0.2s ease;
      margin: 0 !important;
      box-shadow: none !important;
      border-radius: 0 !important;
      width: auto !important;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .tab-btn:hover {
      background-color: #f5f5f5 !important;
      color: #1a1a1a !important;
    }

    .tab-btn.active {
      color: #C9784F !important;
      border-bottom-color: #C9784F !important;
      background-color: transparent !important;
    }

    .tab-btn i {
      font-size: 18px;
    }

    /* Grid */
    .profile-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 4px;
      background-color: #ffffff;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 4px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    .grid-item {
      width: 100%;
      aspect-ratio: 1 / 1;
      background: linear-gradient(135deg, #F2C6B6, #F2D9BB);
      border-radius: 4px;
      overflow: hidden;
      cursor: pointer;
      transition: transform 0.2s ease;
      position: relative;
    }

    .grid-item:hover {
      transform: scale(0.98);
    }

    .grid-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .grid-item.add-tile {
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f5f5f5;
      border: 2px dashed #d0d0d0;
      color: #999;
      font-size: 48px;
      font-weight: 300;
      transition: all 0.2s ease;
    }

    .grid-item.add-tile:hover {
      background: #e9ecef;
      border-color: #C9784F;
      color: #C9784F;
      transform: scale(1);
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #999;
      background-color: #ffffff;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    .empty-state i {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    /* Following List Styles */
    .following-list {
      background-color: #ffffff;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    .following-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px;
      border-bottom: 1px solid #e0e0e0;
      transition: background-color 0.2s ease;
    }

    .following-item:last-child {
      border-bottom: none;
    }

    .following-item:hover {
      background-color: #f8f9fa;
    }

    .following-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .following-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: linear-gradient(135deg, #C9784F, #F2C6B6);
      color: #ffffff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 18px;
    }

    .following-details {
      flex: 1;
      min-width: 0;
    }

    .following-name {
      font-weight: 600;
      color: #1a1a1a;
      margin-bottom: 2px;
    }

    .following-username {
      font-size: 14px;
      color: #666;
    }

    .following-actions button {
      padding: 6px 16px;
      font-size: 13px;
      font-weight: 500;
      border-radius: 6px;
    }

    /* Mobile Responsive */
    @media (max-width: 768px) {
      .profile-container {
        padding: 12px 12px 80px 12px;
      }

      .profile-header {
        padding: 16px;
      }

      .profile-info {
        gap: 16px;
      }

      .profile-avatar {
        width: 64px;
        height: 64px;
        font-size: 24px;
      }

      .profile-username {
        font-size: 18px;
      }

      .profile-name {
        font-size: 13px;
      }

      .profile-actions button {
        padding: 6px 16px;
        font-size: 13px;
      }

      .tab-btn {
        padding: 12px 8px !important;
        font-size: 13px !important;
      }

      .tab-btn i {
        font-size: 16px;
      }

      .profile-grid {
        gap: 2px;
        padding: 2px;
      }

      .grid-item.add-tile {
        font-size: 36px;
      }
    }

    /* Small Mobile */
    @media (max-width: 480px) {
      .profile-info {
        flex-direction: column;
        align-items: flex-start;
        text-align: center;
      }

      .profile-avatar {
        align-self: center;
      }

      .profile-details {
        width: 100%;
        text-align: center;
      }

      .profile-actions {
        width: 100%;
      }

      .profile-actions button {
        width: 100%;
      }

      .tab-btn span {
        display: none;
      }

      .tab-btn {
        flex-direction: column;
        gap: 4px;
      }
    }
  </style>
  <script type="module" src="/scripts/firebaseauth.js"></script>
</head>
<body>
  <div class="profile-container">
    <!-- Profile Header -->
    <div class="profile-header">
      <div class="profile-info">
        <div id="profileAvatar" class="profile-avatar">U</div>
        <div class="profile-details">
          <div id="profileUsername" class="profile-username">@username</div>
          <div id="profileName" class="profile-name">Loading...</div>
          <div id="profileBio" class="profile-bio"></div>
          <div class="profile-actions">
            <button id="editProfileBtn" class="btn btn-outline-secondary">
              <i class="bi bi-pencil"></i> Edit Profile
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Tabs -->
    <div class="profile-tabs">
      <button class="tab-btn active" data-tab="posts">
        <i class="bi bi-grid-3x3-gap"></i>
        <span>Posts</span>
      </button>
      <button class="tab-btn" data-tab="liked">
        <i class="bi bi-heart"></i>
        <span>Liked</span>
      </button>
      <button class="tab-btn" data-tab="saved">
        <i class="bi bi-bookmark"></i>
        <span>Saved</span>
      </button>
      <button class="tab-btn" data-tab="following">
        <i class="bi bi-people"></i>
        <span>Following</span>
      </button>
    </div>

    <!-- Tab Content -->
    <div id="tabContent">
      <div class="tab-panel" data-tab="posts">
        <div class="profile-grid" id="postsGrid"></div>
      </div>
      <div class="tab-panel d-none" data-tab="liked">
        <div class="profile-grid" id="likedGrid"></div>
      </div>
      <div class="tab-panel d-none" data-tab="saved">
        <div class="profile-grid" id="savedGrid"></div>
      </div>
      <div class="tab-panel d-none" data-tab="following">
        <div class="following-list" id="followingList"></div>
      </div>
    </div>
  </div>

    <div class="nav-bar">
        <a href="/" class="nav-logo"><i class="bi bi-shop"></i>ChopeLah</a>
        <div class="nav-items">
            <button onclick="location.href='/pages/order/online-order-home.html'">
                <i class="bi bi-cart3"></i>
                <span>Order</span>
            </button>
            <button onclick="location.href='/pages/community/community.html'">
                <i class="bi bi-people"></i>
                <span>Community</span>
            </button>
            <button onclick="location.href='/pages/chope/chope.html'">
                <i class="bi bi-bookmark"></i>
                <span>Chope</span>
            </button>
            <button onclick="location.href='/pages/crowd/crowd-view.html'">
                <i class="bi bi-eye"></i>
                <span>Crowd View</span>
            </button>
        </div>
        <div class="nav-right">
            <button class="notification-btn" onclick="alert('No new notifications')">
                <i class="bi bi-bell"></i>
                <span class="notification-badge">3</span>
            </button>
            <button class="active" onclick="location.href='/pages/profile/profile.html'">
                <i class="bi bi-person"></i>
                <span>Profile</span>
            </button>
        </div>
    </div>

  <script type="module">
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, collection, query, where, orderBy, limit, getDocs, documentId, addDoc, serverTimestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

    const auth = getAuth();
    const db = getFirestore();

    const profileUsernameEl = document.getElementById('profileUsername');
    const profileNameEl = document.getElementById('profileName');
    const profileBioEl = document.getElementById('profileBio');
    const profileAvatarEl = document.getElementById('profileAvatar');
    const editBtn = document.getElementById('editProfileBtn');
    let currentUserProfile = { username: '', displayName: '', photoURL: '', bio: '' };
    if (editBtn) {
      editBtn.addEventListener('click', () => { window.location.href = 'edit-profile.html'; });
    }

    function setAvatarFromNameOrPhoto(name, photoURL) {
      // Always show default grey avatar with initial (no external photos)
      const initial = (name || 'U').trim().charAt(0).toUpperCase() || 'U';
      profileAvatarEl.textContent = initial;
      profileAvatarEl.style.background = 'linear-gradient(135deg, #6c757d, #adb5bd)';
      profileAvatarEl.style.color = '#ffffff';
    }

    async function loadUserProfile(uid) {
      try {
        const snap = await getDoc(doc(db, 'users', uid));
        const data = snap.exists() ? snap.data() : {};
        const username = data.username || (data.email ? data.email.split('@')[0] : 'user');
        const displayName = data.name || [data.firstName, data.lastName].filter(Boolean).join(' ') || '';
        const bio = data.bio || '';
        
        profileUsernameEl.textContent = `@${username}`;
        profileNameEl.textContent = displayName;
        
        // Display bio if it exists
        if (bio && bio.trim()) {
          profileBioEl.textContent = bio;
          profileBioEl.style.display = 'block';
        } else {
          profileBioEl.textContent = '';
          profileBioEl.style.display = 'none';
        }
        
        // Always use default grey avatar (no external photos)
        setAvatarFromNameOrPhoto(displayName || username, '');
        currentUserProfile = { username, displayName, photoURL: '', bio };
      } catch (e) {
        console.error('Failed to load user profile', e);
      }
    }

    onAuthStateChanged(auth, (user) => {
      if (user && user.uid) {
        loadUserProfile(user.uid);
        loadAllGrids(user.uid);
      } else {
        const uid = localStorage.getItem('loggedInUserId');
        if (uid) { loadUserProfile(uid); loadAllGrids(uid); }
      }
    });

    const tabs = document.querySelectorAll('.tab-btn');
    const panels = document.querySelectorAll('.tab-panel');
    tabs.forEach(btn => btn.addEventListener('click', () => {
      tabs.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      const tab = btn.getAttribute('data-tab');
      panels.forEach(p => p.classList.toggle('d-none', p.getAttribute('data-tab') !== tab));
    }));

    function addPlaceholders(targetId, count = 9) {
      const grid = document.getElementById(targetId);
      if (!grid) return;
      grid.innerHTML = '';
      for (let i = 0; i < count; i++) {
        const item = document.createElement('div');
        item.className = 'grid-item';
        grid.appendChild(item);
      }
    }

    addPlaceholders('postsGrid');
    addPlaceholders('likedGrid');
    addPlaceholders('savedGrid');

    async function loadAllGrids(uid) {
      await Promise.all([
        loadUserPosts(uid),
        loadUserLiked(uid),
        loadUserSaved(uid),
        loadUserFollowing(uid)
      ]);
    }

    function renderGridItems(targetId, items) {
      const grid = document.getElementById(targetId);
      if (!grid) return;
      const panel = grid.parentElement;
      
      // Remove any existing empty state
      const existingEmpty = panel.querySelector('.empty-state');
      if (existingEmpty) existingEmpty.remove();
      
      grid.innerHTML = '';
      
      if (!items || items.length === 0) {
        const empty = document.createElement('div');
        empty.className = 'empty-state';
        empty.innerHTML = '<i class="bi bi-grid-3x3-gap"></i><div>No items yet</div>';
        panel.appendChild(empty);
        grid.style.display = 'none';
        return;
      }
      
      grid.style.display = 'grid';
      items.forEach(item => {
        const cell = document.createElement('div');
        cell.className = 'grid-item';
        if (item.id) { cell.dataset.postId = item.id; }
        if (item.mediaUrl) {
          const img = document.createElement('img');
          img.src = item.mediaUrl;
          img.alt = 'post';
          cell.appendChild(img);
        }
        // Deep-link to community post view and open comments
        cell.addEventListener('click', () => {
          const pid = item.id || '';
          if (!pid) return;
          window.location.href = '/pages/community/community.html?postId=${encodeURIComponent(pid)}&open=comments';
        });
        grid.appendChild(cell);
      });
    }

    async function loadUserPosts(uid) {
      try {
        const postsRef = collection(db, 'posts');
        const qy = query(postsRef, where('authorId', '==', uid), orderBy('createdAt', 'desc'), limit(21));
        const snap = await getDocs(qy);
        const items = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        renderPostsWithAddTile(items);
      } catch (e) {
        console.error('loadUserPosts error', e);
      }
    }

    // Plus-tile uploader for Posts grid
    function renderPostsWithAddTile(items) {
      const grid = document.getElementById('postsGrid');
      if (!grid) return;
      const panel = grid.parentElement;
      
      // Remove any existing empty state
      const existingEmpty = panel.querySelector('.empty-state');
      if (existingEmpty) existingEmpty.remove();
      
      grid.innerHTML = '';
      grid.style.display = 'grid';
      
      const addTile = document.createElement('div');
      addTile.className = 'grid-item add-tile';
      addTile.innerHTML = '+';
      addTile.title = 'Create new post';
      addTile.addEventListener('click', async () => {
        try {
          const caption = window.prompt('Write a caption for your post (text-only, no image):') || '';
          if (!caption.trim()) {
            alert('Please enter some text for your post.');
            return;
          }
          const user = getAuth().currentUser;
          if (!user) { alert('Please sign in to post.'); return; }
          const authorName = currentUserProfile.displayName || currentUserProfile.username || 'User';
          await addDoc(collection(db, 'posts'), {
            authorId: user.uid,
            authorName,
            caption,
            mediaUrl: null, // No image upload - text-only posts
            createdAt: serverTimestamp()
          });
          await loadUserPosts(user.uid);
          alert('Post published!');
        } catch (err) {
          console.error('Create post failed', err);
          alert('Could not create post. Try again.');
        }
      });
      grid.appendChild(addTile);
      
      if (items && items.length) {
        items.forEach(item => {
          const cell = document.createElement('div');
          cell.className = 'grid-item';
          if (item.mediaUrl) {
            const img = document.createElement('img');
            img.src = item.mediaUrl;
            img.alt = 'post';
            cell.appendChild(img);
          }
          cell.addEventListener('click', () => {
            const pid = item.id || '';
            if (!pid) return;
            window.location.href = `/pages/community/community.html?postId=${encodeURIComponent(pid)}&open=comments`;
          });
          grid.appendChild(cell);
        });
      }
    }

    async function batchGetPostsByIds(ids) {
      const chunks = [];
      for (let i = 0; i < ids.length; i += 10) chunks.push(ids.slice(i, i + 10));
      const results = [];
      for (const ch of chunks) {
        const postsRef = collection(db, 'posts');
        const qy = query(postsRef, where(documentId(), 'in', ch));
        const snap = await getDocs(qy);
        results.push(...snap.docs.map(d => ({ id: d.id, ...d.data() })));
      }
      return results;
    }

    async function loadUserLiked(uid) {
      try {
        const likesRef = collection(db, 'users', uid, 'likes');
        const snap = await getDocs(likesRef);
        const postIds = snap.docs.map(d => d.id);
        if (postIds.length === 0) { renderGridItems('likedGrid', []); return; }
        const posts = await batchGetPostsByIds(postIds);
        if (posts.length === 0) {
          // Fallback: show placeholders for the number of likes if posts not yet available
          const grid = document.getElementById('likedGrid');
          if (grid) { 
            grid.innerHTML=''; 
            grid.style.display = 'grid';
            postIds.forEach(()=>{ 
              const d=document.createElement('div'); 
              d.className='grid-item'; 
              grid.appendChild(d); 
            }); 
          }
        } else {
          renderGridItems('likedGrid', posts);
        }
      } catch (e) {
        console.error('loadUserLiked error', e);
      }
    }

    async function loadUserSaved(uid) {
      try {
        const bookmarksRef = collection(db, 'users', uid, 'bookmarks');
        const snap = await getDocs(bookmarksRef);
        const postIds = snap.docs.map(d => d.id);
        if (postIds.length === 0) { renderGridItems('savedGrid', []); return; }
        const posts = await batchGetPostsByIds(postIds);
        if (posts.length === 0) {
          // Fallback: show placeholders if posts not yet available
          const grid = document.getElementById('savedGrid');
          if (grid) { 
            grid.innerHTML=''; 
            grid.style.display = 'grid';
            postIds.forEach(()=>{ 
              const d=document.createElement('div'); 
              d.className='grid-item'; 
              grid.appendChild(d); 
            }); 
          }
        } else {
          renderGridItems('savedGrid', posts);
        }
      } catch (e) {
        console.error('loadUserSaved error', e);
      }
    }

    async function loadUserFollowing(uid) {
      try {
        const followsRef = collection(db, 'users', uid, 'follows');
        const snap = await getDocs(followsRef);
        
        const followingList = document.getElementById('followingList');
        const panel = followingList.parentElement;
        
        // Remove any existing empty state
        const existingEmpty = panel.querySelector('.empty-state');
        if (existingEmpty) existingEmpty.remove();
        
        followingList.innerHTML = '';
        
        if (snap.empty) {
          const empty = document.createElement('div');
          empty.className = 'empty-state';
          empty.innerHTML = '<i class="bi bi-people"></i><div>Not following anyone yet</div>';
          panel.appendChild(empty);
          followingList.style.display = 'none';
          return;
        }
        
        followingList.style.display = 'block';
        
        // Render each followed user
        snap.docs.forEach(docSnap => {
          const data = docSnap.data();
          const authorName = data.authorName || docSnap.id;
          
          const item = document.createElement('div');
          item.className = 'following-item';
          
          const initial = authorName.charAt(0).toUpperCase();
          
          item.innerHTML = `
            <div class="following-info">
              <div class="following-avatar">${initial}</div>
              <div class="following-details">
                <div class="following-name">${authorName}</div>
                <div class="following-username">Community Member</div>
              </div>
            </div>
            <div class="following-actions">
              <button class="btn btn-outline-secondary btn-sm unfollow-btn" data-author="${authorName}">
                <i class="bi bi-person-dash"></i> Unfollow
              </button>
            </div>
          `;
          
          // Add unfollow functionality
          const unfollowBtn = item.querySelector('.unfollow-btn');
          unfollowBtn.addEventListener('click', async () => {
            try {
              const currentUser = getAuth().currentUser;
              if (!currentUser) return;
              
              await deleteDoc(doc(db, 'users', currentUser.uid, 'follows', authorName));
              item.remove();
              
              // Check if list is now empty
              if (followingList.children.length === 0) {
                const empty = document.createElement('div');
                empty.className = 'empty-state';
                empty.innerHTML = '<i class="bi bi-people"></i><div>Not following anyone yet</div>';
                panel.appendChild(empty);
                followingList.style.display = 'none';
              }
            } catch (e) {
              console.error('Unfollow failed', e);
              alert('Could not unfollow user. Please try again.');
            }
          });
          
          followingList.appendChild(item);
        });
      } catch (e) {
        console.error('loadUserFollowing error', e);
      }
    }
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>

