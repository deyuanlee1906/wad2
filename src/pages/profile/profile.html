<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Profile</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="/styles/main.css">
  <link rel="stylesheet" href="/styles/components.css">
  <style>
    /* Profile Container */
    .profile-container {
      max-width: 935px;
      margin: 0 auto;
      padding: 20px 16px 80px 16px;
      background-color: #fafafa;
      min-height: 100vh;
    }

    /* Profile Header */
    .profile-header {
      background-color: #ffffff;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 24px;
      margin-bottom: 16px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    .profile-info {
      display: flex;
      align-items: center;
      gap: 24px;
    }

    .profile-avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: linear-gradient(135deg, #6c757d, #adb5bd);
      color: #ffffff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 32px;
      flex-shrink: 0;
    }

    .profile-details {
      flex: 1;
      min-width: 0;
    }

    .profile-username {
      font-size: 20px;
      font-weight: 600;
      color: #1a1a1a;
      margin-bottom: 4px;
    }

    .profile-name {
      font-size: 14px;
      color: #666;
      margin-bottom: 8px;
    }

    .profile-bio {
      font-size: 14px;
      color: #1a1a1a;
      line-height: 1.5;
      margin-bottom: 12px;
      max-width: 500px;
      word-wrap: break-word;
    }

    .profile-bio:empty {
      display: none;
    }

    .profile-actions button {
      padding: 8px 24px;
      font-size: 14px;
      font-weight: 500;
      border-radius: 6px;
    }

    /* Tabs */
    .profile-tabs {
      background-color: #ffffff;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      display: flex;
      justify-content: center;
      margin-bottom: 16px;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    .tab-btn {
      flex: 1;
      background: none !important;
      border: none !important;
      padding: 16px 12px !important;
      font-weight: 500 !important;
      font-size: 14px !important;
      color: #666 !important;
      border-bottom: 3px solid transparent !important;
      cursor: pointer;
      transition: all 0.2s ease;
      margin: 0 !important;
      box-shadow: none !important;
      border-radius: 0 !important;
      width: auto !important;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .tab-btn:hover {
      background-color: #f5f5f5 !important;
      color: #1a1a1a !important;
    }

    .tab-btn.active {
      color: #C9784F !important;
      border-bottom-color: #C9784F !important;
      background-color: transparent !important;
    }

    .tab-btn i {
      font-size: 18px;
    }

    /* Grid */
    .profile-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 4px;
      background-color: #ffffff;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 4px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    .grid-item {
      width: 100%;
      aspect-ratio: 1 / 1;
      background: linear-gradient(135deg, #F2C6B6, #F2D9BB);
      border-radius: 4px;
      overflow: hidden;
      cursor: pointer;
      transition: transform 0.2s ease;
      position: relative;
    }

    .grid-item:hover {
      transform: scale(0.98);
    }

    .grid-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .grid-item.add-tile {
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f5f5f5;
      border: 2px dashed #d0d0d0;
      color: #999;
      font-size: 48px;
      font-weight: 300;
      transition: all 0.2s ease;
    }

    .grid-item.add-tile:hover {
      background: #e9ecef;
      border-color: #C9784F;
      color: #C9784F;
      transform: scale(1);
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #999;
      background-color: #ffffff;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    .empty-state i {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    /* Following List Styles */
    .following-list {
      background-color: #ffffff;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    .following-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px;
      border-bottom: 1px solid #e0e0e0;
      transition: background-color 0.2s ease;
    }

    .following-item:last-child {
      border-bottom: none;
    }

    .following-item:hover {
      background-color: #f8f9fa;
    }

    .following-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .following-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: linear-gradient(135deg, #C9784F, #F2C6B6);
      color: #ffffff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 18px;
    }

    .following-details {
      flex: 1;
      min-width: 0;
    }

    .following-name {
      font-weight: 600;
      color: #1a1a1a;
      margin-bottom: 2px;
    }

    .following-username {
      font-size: 14px;
      color: #666;
    }

    .following-actions button {
      padding: 6px 16px;
      font-size: 13px;
      font-weight: 500;
      border-radius: 6px;
    }

    /* Order History Styles */
    .order-history-container {
      background-color: #ffffff;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      overflow: hidden;
    }

    .order-history-item {
      padding: 20px;
      border-bottom: 1px solid #e0e0e0;
      transition: background-color 0.2s ease;
    }

    .order-history-item:last-child {
      border-bottom: none;
    }

    .order-history-item:hover {
      background-color: #f8f9fa;
    }

    .order-history-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 12px;
    }

    .order-history-id {
      font-weight: 600;
      color: #1a1a1a;
      font-size: 1rem;
      margin-bottom: 4px;
    }

    .order-history-date {
      font-size: 0.85rem;
      color: #666;
    }

    .order-history-total {
      font-weight: 700;
      color: #D98566;
      font-size: 1.1rem;
      text-align: right;
    }

    .order-history-details {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid #f0f0f0;
      font-size: 0.9rem;
    }

    .order-history-detail-item {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .order-history-detail-label {
      color: #666;
      font-size: 0.85rem;
    }

    .order-history-detail-value {
      color: #1a1a1a;
      font-weight: 500;
    }

    .order-history-items {
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid #f0f0f0;
    }

    .order-history-item-list {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 0.85rem;
      color: #666;
    }

      .order-history-item-entry {
        display: flex;
        justify-content: space-between;
      }

      /* Post Creation Modal Styles */
      .post-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 2000;
        display: none;
        align-items: center;
        justify-content: center;
        animation: fadeIn 0.2s ease-out;
      }

      .post-modal-overlay.show {
        display: flex;
      }

      .post-modal {
        background: white;
        border-radius: 12px;
        width: 90%;
        max-width: 600px;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        animation: slideUp 0.3s ease-out;
      }

      @keyframes slideUp {
        from {
          transform: translateY(20px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      .post-modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px;
        border-bottom: 1px solid #e0e0e0;
      }

      .post-modal-header h3 {
        margin: 0;
        font-size: 1.25rem;
        font-weight: 600;
        color: #1a1a1a;
      }

      .post-modal-close {
        background: none;
        border: none;
        font-size: 1.5rem;
        color: #666;
        cursor: pointer;
        padding: 0;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: all 0.2s;
      }

      .post-modal-close:hover {
        background: #f0f0f0;
        color: #1a1a1a;
      }

      .post-modal-body {
        padding: 20px;
      }

      .post-image-upload {
        margin-bottom: 20px;
      }

      .post-image-preview-container {
        position: relative;
        width: 100%;
        margin-bottom: 12px;
        border-radius: 8px;
        overflow: hidden;
        border: 2px dashed #d0d0d0;
        background: #f8f9fa;
        min-height: 200px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .post-image-preview-container.has-image {
        border: 2px solid #e0e0e0;
        background: #000;
      }

      .post-image-preview {
        max-width: 100%;
        max-height: 400px;
        object-fit: contain;
        display: none;
      }

      .post-image-preview.show {
        display: block;
      }

      .post-image-upload-placeholder {
        text-align: center;
        padding: 40px 20px;
        color: #999;
      }

      .post-image-upload-placeholder i {
        font-size: 48px;
        margin-bottom: 12px;
        display: block;
      }

      .post-image-remove-btn {
        position: absolute;
        top: 10px;
        right: 10px;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        border: none;
        border-radius: 50%;
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 1.2rem;
        transition: all 0.2s;
      }

      .post-image-remove-btn:hover {
        background: rgba(0, 0, 0, 0.9);
        transform: scale(1.1);
      }

      .post-image-upload-btn {
        width: 100%;
        padding: 12px;
        background: #f8f9fa;
        border: 2px dashed #d0d0d0;
        border-radius: 8px;
        color: #666;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 0.95rem;
        font-weight: 500;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }

      .post-image-upload-btn:hover {
        background: #e9ecef;
        border-color: #C9784F;
        color: #C9784F;
      }

      .post-caption-input {
        width: 100%;
        min-height: 120px;
        padding: 12px;
        border: 1px solid #d0d0d0;
        border-radius: 8px;
        font-size: 0.95rem;
        font-family: inherit;
        resize: vertical;
        transition: all 0.2s;
      }

      .post-caption-input:focus {
        outline: none;
        border-color: #C9784F;
        box-shadow: 0 0 0 3px rgba(201, 120, 79, 0.1);
      }

      .post-modal-footer {
        padding: 20px;
        border-top: 1px solid #e0e0e0;
        display: flex;
        justify-content: flex-end;
        gap: 12px;
      }

      .post-submit-btn {
        padding: 10px 24px;
        background: #C9784F;
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .post-submit-btn:hover:not(:disabled) {
        background: #b8653f;
        transform: translateY(-1px);
      }

      .post-submit-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .post-cancel-btn {
        padding: 10px 24px;
        background: #f8f9fa;
        color: #666;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
      }

      .post-cancel-btn:hover {
        background: #e9ecef;
      }

      .post-upload-progress {
        margin-top: 12px;
        padding: 12px;
        background: #f0f7ff;
        border-radius: 8px;
        display: none;
      }

      .post-upload-progress.show {
        display: block;
      }

      .post-upload-progress-text {
        font-size: 0.9rem;
        color: #1976d2;
        margin-bottom: 8px;
      }

      .post-upload-progress-bar {
        width: 100%;
        height: 8px;
        background: #e0e0e0;
        border-radius: 4px;
        overflow: hidden;
      }

      .post-upload-progress-fill {
        height: 100%;
        background: #1976d2;
        transition: width 0.3s ease;
        width: 0%;
      }

      @media (max-width: 768px) {
      .order-history-header {
        flex-direction: column;
        gap: 8px;
      }

      .order-history-total {
        text-align: left;
      }

      .order-history-details {
        grid-template-columns: 1fr;
      }
    }

    /* Mobile Responsive */
    @media (max-width: 768px) {
      .profile-container {
        padding: 12px 12px 80px 12px;
      }

      .profile-header {
        padding: 16px;
      }

      .profile-info {
        gap: 16px;
      }

      .profile-avatar {
        width: 64px;
        height: 64px;
        font-size: 24px;
      }

      .profile-username {
        font-size: 18px;
      }

      .profile-name {
        font-size: 13px;
      }

      .profile-actions button {
        padding: 6px 16px;
        font-size: 13px;
      }

      .tab-btn {
        padding: 12px 8px !important;
        font-size: 13px !important;
      }

      .tab-btn i {
        font-size: 16px;
      }

      .profile-grid {
        gap: 2px;
        padding: 2px;
      }

      .grid-item.add-tile {
        font-size: 36px;
      }
    }

    /* Small Mobile */
    @media (max-width: 480px) {
      .profile-info {
        flex-direction: column;
        align-items: flex-start;
        text-align: center;
      }

      .profile-avatar {
        align-self: center;
      }

      .profile-details {
        width: 100%;
        text-align: center;
      }

      .profile-actions {
        width: 100%;
      }

      .profile-actions button {
        width: 100%;
      }

      .tab-btn span {
        display: none;
      }

      .tab-btn {
        flex-direction: column;
        gap: 4px;
      }
    }
  </style>
  <script type="module" src="/scripts/firebaseauth.js"></script>
</head>
<body>
  <div class="profile-container">
    <!-- Profile Header -->
    <div class="profile-header">
      <div class="profile-info">
        <div id="profileAvatar" class="profile-avatar">U</div>
        <div class="profile-details">
          <div id="profileUsername" class="profile-username">@username</div>
          <div id="profileName" class="profile-name">Loading...</div>
          <div id="profileBio" class="profile-bio"></div>
          <div class="profile-actions">
            <button id="editProfileBtn" class="btn btn-outline-secondary">
              <i class="bi bi-pencil"></i> Edit Profile
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Tabs -->
    <div class="profile-tabs">
      <button class="tab-btn active" data-tab="posts">
        <i class="bi bi-grid-3x3-gap"></i>
        <span>Posts</span>
      </button>
      <button class="tab-btn" data-tab="liked">
        <i class="bi bi-heart"></i>
        <span>Liked</span>
      </button>
      <button class="tab-btn" data-tab="saved">
        <i class="bi bi-bookmark"></i>
        <span>Saved</span>
      </button>
      <button class="tab-btn" data-tab="following">
        <i class="bi bi-people"></i>
        <span>Following</span>
      </button>
      <button class="tab-btn" data-tab="orders">
        <i class="bi bi-bag-check"></i>
        <span>Order History</span>
      </button>
    </div>

    <!-- Tab Content -->
    <div id="tabContent">
      <div class="tab-panel" data-tab="posts">
        <div class="profile-grid" id="postsGrid"></div>
      </div>
      <div class="tab-panel d-none" data-tab="liked">
        <div class="profile-grid" id="likedGrid"></div>
      </div>
      <div class="tab-panel d-none" data-tab="saved">
        <div class="profile-grid" id="savedGrid"></div>
      </div>
      <div class="tab-panel d-none" data-tab="following">
        <div class="following-list" id="followingList"></div>
      </div>
      <div class="tab-panel d-none" data-tab="orders">
        <div class="order-history-container" id="orderHistoryContainer"></div>
      </div>
    </div>
  </div>

  <!-- Post Creation Modal -->
  <div class="post-modal-overlay" id="postModalOverlay">
    <div class="post-modal" onclick="event.stopPropagation()">
      <div class="post-modal-header">
        <h3>Create New Post</h3>
        <button class="post-modal-close" onclick="closePostModal()">
          <i class="bi bi-x"></i>
        </button>
      </div>
      <div class="post-modal-body">
        <div class="post-image-upload">
          <div class="post-image-preview-container" id="postImagePreviewContainer">
            <img class="post-image-preview" id="postImagePreview" alt="Preview">
            <div class="post-image-upload-placeholder" id="postImagePlaceholder">
              <i class="bi bi-image"></i>
              <div>No image selected</div>
            </div>
            <button class="post-image-remove-btn" id="postImageRemoveBtn" onclick="removePostImage()" style="display: none;">
              <i class="bi bi-x"></i>
            </button>
          </div>
          <input type="file" id="postImageInput" accept="image/*" style="display: none;" onchange="handlePostImageSelect(event)">
          <button class="post-image-upload-btn" onclick="document.getElementById('postImageInput').click()">
            <i class="bi bi-camera"></i>
            Choose Image
          </button>
          <div class="post-upload-progress" id="postUploadProgress">
            <div class="post-upload-progress-text" id="postUploadProgressText">Uploading image...</div>
            <div class="post-upload-progress-bar">
              <div class="post-upload-progress-fill" id="postUploadProgressFill"></div>
            </div>
          </div>
        </div>
        <div class="form-group">
          <label for="postCaptionInput" style="display: block; margin-bottom: 8px; font-weight: 500; color: #1a1a1a;">Caption</label>
          <textarea 
            id="postCaptionInput" 
            class="post-caption-input" 
            placeholder="Write a caption for your post..."
          ></textarea>
        </div>
      </div>
      <div class="post-modal-footer">
        <button class="post-cancel-btn" onclick="closePostModal()">Cancel</button>
        <button class="post-submit-btn" id="postSubmitBtn" onclick="submitPost()">
          <i class="bi bi-check-lg"></i>
          <span>Publish</span>
        </button>
      </div>
    </div>
  </div>

    <div class="nav-bar">
        <a href="/" class="nav-logo"><i class="bi bi-shop"></i>ChopeLah</a>
        <div class="nav-items">
            <button onclick="location.href='/pages/order/online-order-home.html'">
                <i class="bi bi-cart3"></i>
                <span>Order</span>
            </button>
            <button onclick="location.href='/pages/community/community.html'">
                <i class="bi bi-people"></i>
                <span>Community</span>
            </button>
            <button onclick="location.href='/pages/chope/chope.html'">
                <i class="bi bi-bookmark"></i>
                <span>Chope</span>
            </button>
            <button onclick="location.href='/pages/crowd/crowd-view.html'">
                <i class="bi bi-eye"></i>
                <span>Crowd View</span>
            </button>
        </div>
        <div class="nav-right">
            <button class="notification-btn" onclick="toggleOrderNotification()">
                <i class="bi bi-bell"></i>
                <span class="notification-badge" style="display: none;">1</span>
            </button>
            <button class="active" onclick="location.href='/pages/profile/profile.html'">
                <i class="bi bi-person"></i>
                <span>Profile</span>
            </button>
        </div>
    </div>

  <script type="module">
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, collection, query, where, orderBy, limit, getDocs, documentId, addDoc, serverTimestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-storage.js";

    // Wait for Firebase to initialize before using it
    let auth, db, storage;

    // Initialize Firebase instances - wait for firebaseauth.js to finish
    async function initFirebase() {
      try {
        // Wait for Firebase to be initialized by firebaseauth.js
        if (window.firebaseInitPromise) {
          await window.firebaseInitPromise;
          console.log('‚úÖ Firebase initialization promise resolved');
        } else {
          // If promise doesn't exist, wait a bit for firebaseauth.js to load
          console.log('‚è≥ Waiting for firebaseauth.js to initialize...');
          let attempts = 0;
          while (!window.firebaseInitPromise && attempts < 20) {
            await new Promise(resolve => setTimeout(resolve, 100));
            attempts++;
          }
          if (window.firebaseInitPromise) {
            await window.firebaseInitPromise;
          }
        }
        
        // Use window.auth, window.db, and window.app if available (set by firebaseauth.js)
        if (window.auth && window.db && window.app) {
          auth = window.auth;
          db = window.db;
          // Explicitly use the new storage bucket
          storage = getStorage(window.app, "gs://wad2-login-5799b.firebasestorage.app");
          console.log('‚úÖ Using Firebase instances from firebaseauth.js');
          console.log('‚úÖ Auth initialized:', !!auth);
          console.log('‚úÖ Firestore initialized:', !!db);
          console.log('‚úÖ Storage initialized:', !!storage);
          return;
        }
        
        // Fallback: get app from firebaseInitPromise result
        if (window.firebaseInitPromise) {
          const initResult = await window.firebaseInitPromise;
          if (initResult && initResult.app) {
            auth = initResult.auth || getAuth(initResult.app);
            db = initResult.db || getFirestore(initResult.app);
            // Explicitly use the new storage bucket
            storage = getStorage(initResult.app, "gs://wad2-login-5799b.firebasestorage.app");
            console.log('‚úÖ Using Firebase instances from firebaseInitPromise');
            console.log('‚úÖ Auth initialized:', !!auth);
            console.log('‚úÖ Firestore initialized:', !!db);
            console.log('‚úÖ Storage initialized:', !!storage);
            return;
          }
        }
        
        // Last resort: get default app
        const { getApp } = await import("https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js");
        const app = getApp();
        auth = getAuth(app);
        db = getFirestore(app);
        // Explicitly use the new storage bucket
        storage = getStorage(app, "gs://wad2-login-5799b.firebasestorage.app");
        console.log('‚úÖ Created Firebase instances from default app');
        console.log('‚úÖ Auth initialized:', !!auth);
        console.log('‚úÖ Firestore initialized:', !!db);
        console.log('‚úÖ Storage initialized:', !!storage);
      } catch (error) {
        console.error('‚ùå Error initializing Firebase:', error);
        // Try to continue with window.app if available
        if (window.app) {
          try {
            auth = window.auth || getAuth(window.app);
            db = window.db || getFirestore(window.app);
            // Explicitly use the new storage bucket
            storage = getStorage(window.app, "gs://wad2-login-5799b.firebasestorage.app");
            console.log('‚úÖ Created Firebase instances from window.app (fallback)');
            console.log('‚úÖ Auth initialized:', !!auth);
            console.log('‚úÖ Firestore initialized:', !!db);
            console.log('‚úÖ Storage initialized:', !!storage);
          } catch (e) {
            console.error('‚ùå Failed to initialize from window.app:', e);
            alert('Failed to initialize Firebase. Please refresh the page.');
            throw e;
          }
        } else {
          throw new Error('Firebase app not available');
        }
      }
    }

    const profileUsernameEl = document.getElementById('profileUsername');
    const profileNameEl = document.getElementById('profileName');
    const profileBioEl = document.getElementById('profileBio');
    const profileAvatarEl = document.getElementById('profileAvatar');
    const editBtn = document.getElementById('editProfileBtn');
    let currentUserProfile = { username: '', displayName: '', photoURL: '', bio: '' };
    if (editBtn) {
      editBtn.addEventListener('click', () => { window.location.href = 'edit-profile.html'; });
    }

    function setAvatarFromNameOrPhoto(name, photoURL) {
      // Show profile picture if available, otherwise show default grey avatar with initial
      if (photoURL && photoURL.trim() !== '') {
        // Show uploaded profile picture from Firebase Storage
        profileAvatarEl.style.backgroundImage = `url(${photoURL})`;
        profileAvatarEl.style.backgroundSize = 'cover';
        profileAvatarEl.style.backgroundPosition = 'center';
        profileAvatarEl.style.backgroundRepeat = 'no-repeat';
        profileAvatarEl.textContent = '';
      } else {
        // Show default grey avatar with initial
        const initial = (name || 'U').trim().charAt(0).toUpperCase() || 'U';
        profileAvatarEl.textContent = initial;
        profileAvatarEl.style.backgroundImage = 'none';
        profileAvatarEl.style.background = 'linear-gradient(135deg, #6c757d, #adb5bd)';
        profileAvatarEl.style.color = '#ffffff';
      }
    }

    async function loadUserProfile(uid) {
      try {
        const snap = await getDoc(doc(db, 'users', uid));
        const data = snap.exists() ? snap.data() : {};
        const username = data.username || (data.email ? data.email.split('@')[0] : 'user');
        const displayName = data.name || [data.firstName, data.lastName].filter(Boolean).join(' ') || '';
        const bio = data.bio || '';
        const photoURL = data.photoURL || null; // Load photoURL from Firestore
        
        profileUsernameEl.textContent = `@${username}`;
        profileNameEl.textContent = displayName;
        
        // Display bio if it exists
        if (bio && bio.trim()) {
          profileBioEl.textContent = bio;
          profileBioEl.style.display = 'block';
        } else {
          profileBioEl.textContent = '';
          profileBioEl.style.display = 'none';
        }
        
        // Show profile picture if available, otherwise show default avatar
        setAvatarFromNameOrPhoto(displayName || username, photoURL);
        currentUserProfile = { username, displayName, photoURL: photoURL || '', bio };
      } catch (e) {
        console.error('Failed to load user profile', e);
      }
    }

    // Initialize Firebase and then set up auth state listener
    initFirebase().then(() => {
      if (auth) {
        onAuthStateChanged(auth, (user) => {
          if (user && user.uid) {
            loadUserProfile(user.uid);
            loadAllGrids(user.uid);
          } else {
            const uid = localStorage.getItem('loggedInUserId');
            if (uid) { loadUserProfile(uid); loadAllGrids(uid); }
          }
        });
      } else {
        console.error('Auth not available');
        // Try to load with localStorage fallback
        const uid = localStorage.getItem('loggedInUserId');
        if (uid) { loadUserProfile(uid); loadAllGrids(uid); }
      }
    }).catch(error => {
      console.error('Failed to initialize Firebase:', error);
      // Try to load with localStorage fallback
      const uid = localStorage.getItem('loggedInUserId');
      if (uid) { loadUserProfile(uid); loadAllGrids(uid); }
    });

    const tabs = document.querySelectorAll('.tab-btn');
    const panels = document.querySelectorAll('.tab-panel');
    tabs.forEach(btn => btn.addEventListener('click', () => {
      tabs.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      const tab = btn.getAttribute('data-tab');
      panels.forEach(p => p.classList.toggle('d-none', p.getAttribute('data-tab') !== tab));
      
      // Load order history when orders tab is clicked
      if (tab === 'orders') {
        loadOrderHistory();
      }
    }));

    function addPlaceholders(targetId, count = 9) {
      const grid = document.getElementById(targetId);
      if (!grid) return;
      grid.innerHTML = '';
      for (let i = 0; i < count; i++) {
        const item = document.createElement('div');
        item.className = 'grid-item';
        grid.appendChild(item);
      }
    }

    addPlaceholders('postsGrid');
    addPlaceholders('likedGrid');
    addPlaceholders('savedGrid');

    async function loadAllGrids(uid) {
      await Promise.all([
        loadUserPosts(uid),
        loadUserLiked(uid),
        loadUserSaved(uid),
        loadUserFollowing(uid)
      ]);
    }

    function renderGridItems(targetId, items) {
      const grid = document.getElementById(targetId);
      if (!grid) return;
      const panel = grid.parentElement;
      
      // Remove any existing empty state
      const existingEmpty = panel.querySelector('.empty-state');
      if (existingEmpty) existingEmpty.remove();
      
      grid.innerHTML = '';
      
      if (!items || items.length === 0) {
        const empty = document.createElement('div');
        empty.className = 'empty-state';
        empty.innerHTML = '<i class="bi bi-grid-3x3-gap"></i><div>No items yet</div>';
        panel.appendChild(empty);
        grid.style.display = 'none';
        return;
      }
      
      grid.style.display = 'grid';
      items.forEach(item => {
        const cell = document.createElement('div');
        cell.className = 'grid-item';
        if (item.id) { cell.dataset.postId = item.id; }
        if (item.mediaUrl) {
          const img = document.createElement('img');
          img.src = item.mediaUrl;
          img.alt = 'post';
          cell.appendChild(img);
        }
        // Deep-link to community post view and open comments
        cell.addEventListener('click', () => {
          const pid = item.id || '';
          if (!pid) return;
          window.location.href = '/pages/community/community.html?postId=${encodeURIComponent(pid)}&open=comments';
        });
        grid.appendChild(cell);
      });
    }

    async function loadUserPosts(uid) {
      try {
        const postsRef = collection(db, 'posts');
        const qy = query(postsRef, where('authorId', '==', uid), orderBy('createdAt', 'desc'), limit(21));
        const snap = await getDocs(qy);
        const items = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        renderPostsWithAddTile(items);
      } catch (e) {
        console.error('loadUserPosts error', e);
      }
    }

    // Post creation modal functions
    let selectedPostImage = null;

    window.openPostModal = function() {
      const modal = document.getElementById('postModalOverlay');
      if (modal) {
        modal.classList.add('show');
        // Reset form
        document.getElementById('postCaptionInput').value = '';
        removePostImage();
        document.getElementById('postUploadProgress').classList.remove('show');
      }
    };

    window.closePostModal = function() {
      const modal = document.getElementById('postModalOverlay');
      if (modal) {
        modal.classList.remove('show');
      }
    };

    window.handlePostImageSelect = function(event) {
      const file = event.target.files[0];
      if (!file) return;

      // Validate file type
      if (!file.type.startsWith('image/')) {
        alert('Please select an image file.');
        return;
      }

      // Validate file size (max 5MB)
      if (file.size > 5 * 1024 * 1024) {
        alert('Image size must be less than 5MB.');
        return;
      }

      selectedPostImage = file;

      // Show preview
      const reader = new FileReader();
      reader.onload = function(e) {
        const preview = document.getElementById('postImagePreview');
        const container = document.getElementById('postImagePreviewContainer');
        const placeholder = document.getElementById('postImagePlaceholder');
        const removeBtn = document.getElementById('postImageRemoveBtn');

        preview.src = e.target.result;
        preview.classList.add('show');
        container.classList.add('has-image');
        placeholder.style.display = 'none';
        removeBtn.style.display = 'flex';
      };
      reader.readAsDataURL(file);
    };

    window.removePostImage = function() {
      selectedPostImage = null;
      const preview = document.getElementById('postImagePreview');
      const container = document.getElementById('postImagePreviewContainer');
      const placeholder = document.getElementById('postImagePlaceholder');
      const removeBtn = document.getElementById('postImageRemoveBtn');
      const input = document.getElementById('postImageInput');

      preview.src = '';
      preview.classList.remove('show');
      container.classList.remove('has-image');
      placeholder.style.display = 'block';
      removeBtn.style.display = 'none';
      input.value = '';
    };

    window.submitPost = async function() {
      const captionInput = document.getElementById('postCaptionInput');
      const caption = captionInput.value.trim();
      
      if (!selectedPostImage && !caption) {
        alert('Please add an image or write a caption.');
        return;
      }

      // Ensure Firebase is initialized
      if (!auth || !db) {
        console.log('‚ö†Ô∏è Firebase not initialized, initializing now...');
        try {
          await initFirebase();
        } catch (error) {
          console.error('‚ùå Failed to initialize Firebase:', error);
          alert('Failed to initialize Firebase. Please refresh the page and try again.');
          return;
        }
      }

      const user = auth ? auth.currentUser : null;
      if (!user) {
        alert('Please sign in to post.');
        return;
      }

        // Check if storage is initialized
        if (!storage) {
          console.error('‚ùå Firebase Storage is not initialized');
          // Try to initialize storage with explicit bucket
          try {
            if (window.app) {
              storage = getStorage(window.app, "gs://wad2-login-5799b.firebasestorage.app");
              console.log('‚úÖ Storage initialized from window.app with new bucket');
            } else {
              const { getApp } = await import("https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js");
              const app = getApp();
              storage = getStorage(app, "gs://wad2-login-5799b.firebasestorage.app");
              console.log('‚úÖ Storage initialized from default app with new bucket');
            }
          } catch (error) {
            console.error('‚ùå Failed to initialize storage:', error);
            alert('Storage service is not available. Please refresh the page and try again.');
            return;
          }
        }

      const submitBtn = document.getElementById('postSubmitBtn');
      const progressDiv = document.getElementById('postUploadProgress');
      const progressText = document.getElementById('postUploadProgressText');
      const progressFill = document.getElementById('postUploadProgressFill');

      submitBtn.disabled = true;
      let mediaUrl = null;

      try {
        // Upload image if selected
        if (selectedPostImage) {
          if (!storage) {
            throw new Error('Firebase Storage is not initialized. Please refresh the page.');
          }

          progressDiv.classList.add('show');
          progressText.textContent = 'Preparing upload...';
          progressFill.style.width = '10%';

          // Create unique filename - sanitize filename to remove special characters
          const timestamp = Date.now();
          const sanitizedName = selectedPostImage.name.replace(/[^a-zA-Z0-9.-]/g, '_');
          const filename = `posts/${user.uid}/${timestamp}_${sanitizedName}`;
          
          console.log('üì§ Uploading to:', filename);
          console.log('üì¶ File size:', (selectedPostImage.size / 1024 / 1024).toFixed(2), 'MB');
          console.log('üìã File type:', selectedPostImage.type);
          
          const storageRef = ref(storage, filename);

          // Upload to Firebase Storage
          progressFill.style.width = '30%';
          progressText.textContent = 'Uploading image...';
          
          console.log('üîÑ Starting upload...');
          const uploadResult = await uploadBytes(storageRef, selectedPostImage);
          console.log('‚úÖ Upload successful:', uploadResult);
          
          progressFill.style.width = '80%';
          progressText.textContent = 'Getting download URL...';
          
          // Get download URL
          mediaUrl = await getDownloadURL(uploadResult.ref);
          console.log('üîó Download URL:', mediaUrl);
          
          progressFill.style.width = '100%';
          progressText.textContent = 'Upload complete!';
        }

        // Create post in Firestore
        progressText.textContent = 'Publishing post...';
        
        // Load current user profile data to get the latest username and photoURL
        const userDocRef = doc(db, 'users', user.uid);
        const userDocSnap = await getDoc(userDocRef);
        const userData = userDocSnap.exists() ? userDocSnap.data() : {};
        const currentUsername = userData.username || currentUserProfile.username || 'User';
        const currentPhotoURL = userData.photoURL || null;
        
        // Use username with @ prefix for display, or fallback to displayName
        const authorName = currentUsername || currentUserProfile.displayName || 'User';
        
        // Ensure db is initialized
        if (!db) {
          console.error('‚ùå Firestore is not initialized');
          throw new Error('Database is not available. Please refresh the page and try again.');
        }
        
        console.log('üìù Creating post in Firestore...', {
          authorId: user.uid,
          authorName,
          hasCaption: !!caption,
          hasImage: !!mediaUrl,
          dbInitialized: !!db
        });
        
        const postData = {
          authorId: user.uid,
          authorName: authorName, // Username from Firestore
          authorPhotoURL: currentPhotoURL || null, // Profile picture URL from Firestore
          caption: caption || '',
          mediaUrl: mediaUrl || null,
          createdAt: serverTimestamp()
        };
        
        console.log('üì¶ Post data:', postData);
        const postRef = await addDoc(collection(db, 'posts'), postData);
        console.log('‚úÖ Post created with ID:', postRef.id);

        // Close modal and reload posts
        closePostModal();
        
        // Reset form
        selectedPostImage = null;
        if (captionInput) captionInput.value = '';
        const previewContainer = document.getElementById('postImagePreviewContainer');
        const placeholder = document.getElementById('postImagePlaceholder');
        const preview = document.getElementById('postImagePreview');
        const removeBtn = document.getElementById('postImageRemoveBtn');
        if (previewContainer && placeholder && preview && removeBtn) {
          preview.style.display = 'none';
          placeholder.style.display = 'block';
          removeBtn.style.display = 'none';
        }
        
        // Reload posts
        try {
          await loadUserPosts(user.uid);
          console.log('üéâ Post published successfully!');
        } catch (reloadError) {
          console.error('‚ö†Ô∏è Post created but failed to reload:', reloadError);
          // Post was created successfully, just reload failed
          alert('Post published successfully! Please refresh the page to see it.');
        }
        
      } catch (err) {
        console.error('‚ùå Create post failed:', err);
        console.error('Error details:', {
          code: err.code,
          message: err.message,
          stack: err.stack,
          name: err.name
        });
        
        let errorMessage = 'Could not create post. ';
        
        if (err.code === 'storage/unauthorized') {
          errorMessage += 'You do not have permission to upload files. Please check Firebase Storage rules.';
        } else if (err.code === 'storage/quota-exceeded') {
          errorMessage += 'Storage quota exceeded. Please contact support.';
        } else if (err.code === 'storage/canceled') {
          errorMessage += 'Upload was canceled.';
        } else if (err.code === 'storage/unknown') {
          errorMessage += 'An unknown storage error occurred. Please try again.';
        } else if (err.code === 'permission-denied') {
          errorMessage += 'Permission denied. Please check Firebase Firestore rules.';
        } else if (err.message) {
          errorMessage += err.message;
        } else {
          errorMessage += 'Please try again.';
        }
        
        alert(errorMessage);
      } finally {
        submitBtn.disabled = false;
        progressDiv.classList.remove('show');
        progressFill.style.width = '0%';
      }
    };

    // Close modal when clicking outside
    document.getElementById('postModalOverlay')?.addEventListener('click', function(e) {
      if (e.target === this) {
        closePostModal();
      }
    });

    // Plus-tile uploader for Posts grid
    function renderPostsWithAddTile(items) {
      const grid = document.getElementById('postsGrid');
      if (!grid) return;
      const panel = grid.parentElement;
      
      // Remove any existing empty state
      const existingEmpty = panel.querySelector('.empty-state');
      if (existingEmpty) existingEmpty.remove();
      
      grid.innerHTML = '';
      grid.style.display = 'grid';
      
      const addTile = document.createElement('div');
      addTile.className = 'grid-item add-tile';
      addTile.innerHTML = '+';
      addTile.title = 'Create new post';
      addTile.addEventListener('click', openPostModal);
      grid.appendChild(addTile);
      
      if (items && items.length) {
        const currentUser = auth ? auth.currentUser : null;
        items.forEach(item => {
          const cell = document.createElement('div');
          cell.className = 'grid-item';
          cell.style.position = 'relative';
          
          // Check if current user owns this post
          const isOwnPost = currentUser && item.authorId === currentUser.uid;
          
          if (item.mediaUrl) {
            const img = document.createElement('img');
            img.src = item.mediaUrl;
            img.alt = 'post';
            cell.appendChild(img);
          }
          
          // Add delete button for own posts
          if (isOwnPost) {
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'post-delete-btn';
            deleteBtn.innerHTML = '<i class="bi bi-trash"></i>';
            deleteBtn.style.cssText = 'position: absolute; top: 8px; right: 8px; background: rgba(0,0,0,0.7); color: white; border: none; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; cursor: pointer; opacity: 0; transition: opacity 0.2s; z-index: 10;';
            deleteBtn.title = 'Delete post';
            
            cell.addEventListener('mouseenter', () => {
              deleteBtn.style.opacity = '1';
            });
            cell.addEventListener('mouseleave', () => {
              deleteBtn.style.opacity = '0';
            });
            
            deleteBtn.addEventListener('click', async (e) => {
              e.stopPropagation();
              const postId = item.id;
              
              if (!confirm('Are you sure you want to delete this post? This action cannot be undone.')) {
                return;
              }
              
              try {
                deleteBtn.disabled = true;
                deleteBtn.innerHTML = '<i class="bi bi-hourglass-split"></i>';
                
                // Delete image from Firebase Storage if it exists
                if (item.mediaUrl && item.mediaUrl.includes('firebasestorage.googleapis.com')) {
                  try {
                    const urlParts = item.mediaUrl.split('/o/');
                    if (urlParts.length > 1) {
                      const pathPart = urlParts[1].split('?')[0];
                      const decodedPath = decodeURIComponent(pathPart);
                      const storageRef = ref(storage, decodedPath);
                      await deleteObject(storageRef);
                      console.log('‚úÖ Deleted image from Storage');
                    }
                  } catch (storageError) {
                    console.warn('‚ö†Ô∏è Could not delete image from Storage:', storageError);
                  }
                }
                
                // Delete all likes on this post
                const likesRef = collection(db, 'posts', postId, 'likes');
                const likesSnap = await getDocs(likesRef);
                const deleteLikesPromises = likesSnap.docs.map(likeDoc => deleteDoc(likeDoc.ref));
                await Promise.all(deleteLikesPromises);
                
                // Delete the post document
                await deleteDoc(doc(db, 'posts', postId));
                
                // Remove from UI
                cell.style.opacity = '0';
                cell.style.transition = 'opacity 0.3s ease';
                setTimeout(() => {
                  cell.remove();
                  // Reload posts grid
                  loadUserPosts(currentUser.uid);
                }, 300);
                
                console.log('‚úÖ Post deleted successfully');
              } catch (error) {
                console.error('‚ùå Error deleting post:', error);
                alert('Failed to delete post. Please try again.');
                deleteBtn.disabled = false;
                deleteBtn.innerHTML = '<i class="bi bi-trash"></i>';
              }
            });
            
            cell.appendChild(deleteBtn);
          }
          
          cell.addEventListener('click', () => {
            const pid = item.id || '';
            if (!pid) return;
            window.location.href = `/pages/community/community.html?postId=${encodeURIComponent(pid)}&open=comments`;
          });
          grid.appendChild(cell);
        });
      }
    }

    async function batchGetPostsByIds(ids) {
      const chunks = [];
      for (let i = 0; i < ids.length; i += 10) chunks.push(ids.slice(i, i + 10));
      const results = [];
      for (const ch of chunks) {
        const postsRef = collection(db, 'posts');
        const qy = query(postsRef, where(documentId(), 'in', ch));
        const snap = await getDocs(qy);
        results.push(...snap.docs.map(d => ({ id: d.id, ...d.data() })));
      }
      return results;
    }

    async function loadUserLiked(uid) {
      try {
        const likesRef = collection(db, 'users', uid, 'likes');
        const snap = await getDocs(likesRef);
        const postIds = snap.docs.map(d => d.id);
        if (postIds.length === 0) { renderGridItems('likedGrid', []); return; }
        const posts = await batchGetPostsByIds(postIds);
        if (posts.length === 0) {
          // Fallback: show placeholders for the number of likes if posts not yet available
          const grid = document.getElementById('likedGrid');
          if (grid) { 
            grid.innerHTML=''; 
            grid.style.display = 'grid';
            postIds.forEach(()=>{ 
              const d=document.createElement('div'); 
              d.className='grid-item'; 
              grid.appendChild(d); 
            }); 
          }
        } else {
          renderGridItems('likedGrid', posts);
        }
      } catch (e) {
        console.error('loadUserLiked error', e);
      }
    }

    async function loadUserSaved(uid) {
      try {
        const bookmarksRef = collection(db, 'users', uid, 'bookmarks');
        const snap = await getDocs(bookmarksRef);
        const postIds = snap.docs.map(d => d.id);
        if (postIds.length === 0) { renderGridItems('savedGrid', []); return; }
        const posts = await batchGetPostsByIds(postIds);
        if (posts.length === 0) {
          // Fallback: show placeholders if posts not yet available
          const grid = document.getElementById('savedGrid');
          if (grid) { 
            grid.innerHTML=''; 
            grid.style.display = 'grid';
            postIds.forEach(()=>{ 
              const d=document.createElement('div'); 
              d.className='grid-item'; 
              grid.appendChild(d); 
            }); 
          }
        } else {
          renderGridItems('savedGrid', posts);
        }
      } catch (e) {
        console.error('loadUserSaved error', e);
      }
    }

    async function loadUserFollowing(uid) {
      try {
        const followsRef = collection(db, 'users', uid, 'follows');
        const snap = await getDocs(followsRef);
        
        const followingList = document.getElementById('followingList');
        const panel = followingList.parentElement;
        
        // Remove any existing empty state
        const existingEmpty = panel.querySelector('.empty-state');
        if (existingEmpty) existingEmpty.remove();
        
        followingList.innerHTML = '';
        
        if (snap.empty) {
          const empty = document.createElement('div');
          empty.className = 'empty-state';
          empty.innerHTML = '<i class="bi bi-people"></i><div>Not following anyone yet</div>';
          panel.appendChild(empty);
          followingList.style.display = 'none';
          return;
        }
        
        followingList.style.display = 'block';
        
        // Render each followed user
        snap.docs.forEach(docSnap => {
          const data = docSnap.data();
          const authorName = data.authorName || docSnap.id;
          
          const item = document.createElement('div');
          item.className = 'following-item';
          
          const initial = authorName.charAt(0).toUpperCase();
          
          item.innerHTML = `
            <div class="following-info">
              <div class="following-avatar">${initial}</div>
              <div class="following-details">
                <div class="following-name">${authorName}</div>
                <div class="following-username">Community Member</div>
              </div>
            </div>
            <div class="following-actions">
              <button class="btn btn-outline-secondary btn-sm unfollow-btn" data-author="${authorName}">
                <i class="bi bi-person-dash"></i> Unfollow
              </button>
            </div>
          `;
          
          // Add unfollow functionality
          const unfollowBtn = item.querySelector('.unfollow-btn');
          unfollowBtn.addEventListener('click', async () => {
            try {
              const currentUser = getAuth().currentUser;
              if (!currentUser) return;
              
              await deleteDoc(doc(db, 'users', currentUser.uid, 'follows', authorName));
              item.remove();
              
              // Check if list is now empty
              if (followingList.children.length === 0) {
                const empty = document.createElement('div');
                empty.className = 'empty-state';
                empty.innerHTML = '<i class="bi bi-people"></i><div>Not following anyone yet</div>';
                panel.appendChild(empty);
                followingList.style.display = 'none';
              }
            } catch (e) {
              console.error('Unfollow failed', e);
              alert('Could not unfollow user. Please try again.');
            }
          });
          
          followingList.appendChild(item);
        });
      } catch (e) {
        console.error('loadUserFollowing error', e);
      }
    }

    // Load order history from Firebase
    async function loadOrderHistoryFromFirebase(uid) {
      try {
        if (!db || !collection || !getDocs || !query || !orderBy) {
          console.warn('Firebase functions not available');
          return [];
        }
        
        const orderHistoryRef = collection(db, 'users', uid, 'orderHistory');
        const q = query(orderHistoryRef, orderBy('confirmedAt', 'desc'));
        const snapshot = await getDocs(q);
        
        const orders = [];
        snapshot.forEach(doc => {
          orders.push({ ...doc.data(), orderId: doc.id });
        });
        
        console.log('‚úÖ Loaded', orders.length, 'orders from Firebase');
        return orders;
      } catch (error) {
        console.warn('‚ö†Ô∏è Failed to load from Firebase:', error);
        return [];
      }
    }

    // Load order history from localStorage
    function loadOrderHistoryFromLocalStorage() {
      try {
        const historyStr = localStorage.getItem('orderHistory');
        const orders = historyStr ? JSON.parse(historyStr) : [];
        console.log('‚úÖ Loaded', orders.length, 'orders from localStorage');
        return orders;
      } catch (error) {
        console.error('‚ùå Error loading from localStorage:', error);
        return [];
      }
    }

    // Merge and deduplicate orders from multiple sources
    function mergeOrders(...orderArrays) {
      const orderMap = new Map();
      
      // Add all orders to map (later orders overwrite earlier ones with same orderId)
      orderArrays.forEach(orders => {
        orders.forEach(order => {
          if (order && order.orderId) {
            orderMap.set(order.orderId, order);
          }
        });
      });
      
      // Convert map back to array and sort by confirmedAt (newest first)
      const merged = Array.from(orderMap.values());
      merged.sort((a, b) => {
        const dateA = new Date(a.confirmedAt || a.timestamp || 0);
        const dateB = new Date(b.confirmedAt || b.timestamp || 0);
        return dateB - dateA;
      });
      
      return merged;
    }

    // Load and display order history
    async function loadOrderHistory() {
      const container = document.getElementById('orderHistoryContainer');
      if (!container) return;

      container.innerHTML = '<div style="text-align: center; padding: 20px; color: #6c757d;">Loading order history...</div>';

      try {
        let orders = [];
        
        // Try to load from Firebase first if user is authenticated
        if (auth && db) {
          const user = auth.currentUser;
          if (user && user.uid) {
            const firebaseOrders = await loadOrderHistoryFromFirebase(user.uid);
            orders = firebaseOrders;
          }
        }
        
        // Also load from localStorage as backup
        const localOrders = loadOrderHistoryFromLocalStorage();
        
        // Merge and deduplicate orders
        orders = mergeOrders(orders, localOrders);
        
        // Update localStorage with merged data (for offline access)
        if (orders.length > 0) {
          try {
            localStorage.setItem('orderHistory', JSON.stringify(orders));
          } catch (e) {
            console.warn('Could not update localStorage:', e);
          }
        }

        container.innerHTML = '';

        if (orders.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <i class="bi bi-bag-check"></i>
              <div>No confirmed orders yet</div>
              <div style="font-size: 0.85rem; color: #999; margin-top: 8px;">
                Confirm orders from notifications to see them here
              </div>
            </div>
          `;
          return;
        }

        // Render each order
        orders.forEach(order => {
          const orderItem = document.createElement('div');
          orderItem.className = 'order-history-item';

          const total = typeof order.total === 'number' 
            ? order.total 
            : parseFloat(order.total) || 0;

          // Format confirmed date
          let confirmedDateStr = 'Date not available';
          if (order.confirmedAt) {
            try {
              const confirmedDate = new Date(order.confirmedAt);
              confirmedDateStr = confirmedDate.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
              });
            } catch (e) {
              console.error('Error formatting date:', e);
            }
          }

          // Format order items list
          let itemsHtml = '';
          if (order.items && order.items.length > 0) {
            itemsHtml = '<div class="order-history-items"><div class="order-history-item-list">';
            order.items.forEach(item => {
              const qty = item.qty || item.quantity || 1;
              const name = item.name || item.item_name || 'Food Item';
              itemsHtml += `
                <div class="order-history-item-entry">
                  <span>${name} x${qty}</span>
                </div>
              `;
            });
            itemsHtml += '</div></div>';
          }

          orderItem.innerHTML = `
            <div class="order-history-header">
              <div>
                <div class="order-history-id">${order.orderId || 'Order'}</div>
                <div class="order-history-date">Confirmed: ${confirmedDateStr}</div>
              </div>
              <div class="order-history-total">$${total.toFixed(2)}</div>
            </div>
            <div class="order-history-details">
              <div class="order-history-detail-item">
                <span class="order-history-detail-label">Stall</span>
                <span class="order-history-detail-value">${order.stall || '-'}</span>
              </div>
              <div class="order-history-detail-item">
                <span class="order-history-detail-label">Food Centre</span>
                <span class="order-history-detail-value">${order.foodCentre || '-'}</span>
              </div>
            </div>
            ${itemsHtml}
          `;

          container.appendChild(orderItem);
        });
      } catch (e) {
        console.error('Error loading order history:', e);
        container.innerHTML = `
          <div class="empty-state">
            <i class="bi bi-exclamation-triangle"></i>
            <div>Error loading order history</div>
          </div>
        `;
      }
    }

    // Listen for order history updates
    window.addEventListener('orderHistoryUpdated', function() {
      // Reload order history if orders tab is active
      const ordersTab = document.querySelector('.tab-btn[data-tab="orders"]');
      if (ordersTab && ordersTab.classList.contains('active')) {
        loadOrderHistory();
      }
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/scripts/notification.js"></script>
</body>
</html>

