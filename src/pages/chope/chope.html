<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seat Choping</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="/styles/main.css">
    <link rel="stylesheet" href="/styles/components.css">
    <script type="module" src="/scripts/firebaseauth.js"></script>
    <script src="/pages/chope/seatDatabase.js"></script>
    <script src="/pages/chope/bookingHistory.js"></script>
    <style>
        :root {
          /* Header variables matching crowd-view */
          --font-size-3xl: 24px;
          --font-size-base: 14px;
          --font-size-sm: 12px;
          --font-weight-bold: 600;
          --font-weight-medium: 500;
          --space-32: 32px;
          --space-24: 24px;
          --space-20: 20px;
          --space-16: 16px;
          --space-12: 12px;
          --space-8: 8px;
          --color-text-secondary: #666;
          --color-primary: #C9784F;
          --color-primary-hover: #b36a43;
        }

        body {
          font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
          background-color: transparent;
          color: #1a1a1a;
          line-height: 1.5;
          -webkit-font-smoothing: antialiased;
          padding-top: 70px;
          padding-bottom: 80px;
          overflow-x: hidden;
          width: 100%;
          max-width: 100vw;
        }

        @media (max-width: 768px) {
          body {
            padding-top: env(safe-area-inset-top);
            padding-bottom: calc(80px + env(safe-area-inset-bottom));
          }
        }

        /* Desktop View */
        .desktop-view {
          display: block;
          padding: var(--space-32);
          max-width: 1400px;
          margin: 0 auto;
          width: 100%;
          box-sizing: border-box;
        }

        /* Mobile View */
        .mobile-view {
          display: none;
          padding: var(--space-16);
          padding-top: max(var(--space-16), env(safe-area-inset-top));
          width: 100%;
          max-width: 100vw;
          box-sizing: border-box;
          overflow-x: hidden;
        }

        /* Header styling matching crowd-view */
        .header {
          margin-bottom: var(--space-32);
        }

        .header h1 {
          font-size: var(--font-size-3xl);
          font-weight: var(--font-weight-bold);
          color: #1a1a1a;
          margin-bottom: var(--space-8);
        }

        .header-subtitle {
          font-size: var(--font-size-base);
          color: var(--color-text-secondary);
        }

        /* Card styling matching crowd-view */
        .content-card {
          background: #ffffff;
          border: 1px solid #e0e0e0;
          border-radius: 12px;
          padding: var(--space-24);
          box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
          margin-bottom: var(--space-24);
        }

        .form-group {
          margin-bottom: var(--space-16);
        }

        .form-group label {
          display: block;
          font-size: var(--font-size-sm);
          font-weight: var(--font-weight-medium);
          color: #1a1a1a;
          margin-bottom: var(--space-8);
        }

        .timeslot-group {
          display: flex;
          flex-direction: row;
          gap: var(--space-16);
          margin-bottom: var(--space-16);
          align-items: flex-start;
        }

        .timeslot-group .form-group {
          flex: 1;
          margin-bottom: 0;
          display: flex;
          flex-direction: column;
        }

        .timeslot-group .form-group label {
          margin-bottom: var(--space-8);
        }

        .form-select {
          width: 100%;
          padding: 10px 12px;
          border: 1px solid #1a1a1a;
          border-radius: 6px;
          background: white;
          color: #1a1a1a;
          font-size: 16px;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.2s;
          box-sizing: border-box;
        }

        .form-select:hover {
          border-color: #4285f4;
          box-shadow: 0 0 0 2px rgba(66, 133, 244, 0.1);
        }

        .form-select:focus {
          outline: none;
          border-color: #4285f4;
          box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.2);
        }

        .button-group {
          display: flex;
          gap: var(--space-12);
          margin-top: var(--space-20);
        }

        .btn-primary {
          background-color: var(--color-primary);
          border: none;
          color: white;
          padding: 10px 24px;
          border-radius: 6px;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.2s;
        }

        .btn-primary:hover {
          background-color: var(--color-primary-hover);
        }

        .btn-outline-secondary {
          background-color: transparent;
          border: 1px solid #e0e0e0;
          color: #1a1a1a;
          padding: 10px 24px;
          border-radius: 6px;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.2s;
        }

        .btn-outline-secondary:hover {
          background-color: #f5f5f5;
        }

        #map{
            height: 300px;
            width: 100%;
            border-radius: 12px;
            border: 1px solid #e0e0e0;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            margin-bottom: var(--space-24);
        }

        .booking-card {
            background: white;
            border-radius: 12px;
            border: 2px solid var(--secondary-color);
            padding: 1rem;
        }

        .booking-card .detail-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid rgba(217, 133, 102, 0.2);
        }

        .booking-card .detail-item:last-child {
            border-bottom: none;
        }

        .booking-card .detail-label {
            font-weight: 600;
            color: var(--text-color);
            font-size: 0.9rem;
        }

        .booking-card .detail-value {
            color: var(--primary-color);
            font-weight: bold;
            font-size: 0.9rem;
        }

        .booking-card .time-remaining {
            font-size: 0.8rem;
            color: #6c757d;
            text-align: center;
            margin-top: 0.5rem;
        }

        #historyBtn:hover {
            color: var(--text-color) !important;
        }

        /* Responsive - Mobile */
        @media (max-width: 430px) {
          .desktop-view {
            display: none;
          }

          .mobile-view {
            display: block;
          }

          .mobile-view .header {
            margin-bottom: var(--space-24);
            padding: 0 var(--space-16);
            padding-top: var(--space-8);
          }

          .mobile-view .header h1 {
            font-size: 20px;
            margin-bottom: var(--space-8);
          }

          .content-card {
            padding: var(--space-16);
          }

          .timeslot-group {
            flex-direction: column;
          }

          .button-group {
            flex-direction: column;
          }

          .btn-primary,
          .btn-outline-secondary {
            width: 100%;
          }
        }
    </style>

</head>
<body>
    <!-- DESKTOP VIEW -->
    <div class="desktop-view">
      <div class="header">
        <div style="display: flex; justify-content: space-between; align-items: start;">
          <div>
            <h1>Seat Choping</h1>
            <p class="header-subtitle">Reserve your seat at hawker centres across Singapore</p>
          </div>
          <button id="historyBtn" class="btn" style="color: var(--primary-color);">
              <i class="bi bi-clock-history fs-4"></i>
          </button>
        </div>
      </div>

      <!-- Booking History Modal which shows the active booking -->
      <div class="modal fade" id="historyModal" tabindex="-1" aria-labelledby="historyModalLabel" aria-hidden="true">
          <div class="modal-dialog modal-dialog-scrollable">
              <div class="modal-content">
                  <div class="modal-header" style="background-color: var(--secondary-color);">
                      <h5 class="modal-title" id="historyModalLabel">Active Bookings</h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                  </div>
                  <!-- active booking -->
                  <div class="modal-body">
                      <div id="activeBookings" class="d-flex flex-column gap-3">
                          <!-- Active bookings will be inserted here -->
                      </div>
                  </div>
              </div>
          </div>
      </div>

      <div class="content-card">
        <div id="map" class="mb-4"></div>

        <div class="timeslot-group">
          <div class="form-group">
            <label for="timeslot">Select Timeslot</label>
            <select id="timeslot" class="form-select" required>
              <option value="8:00 AM" selected>8:00 AM</option>
              <option value="8:30 AM">8:30 AM</option>
              <option value="9:00 AM">9:00 AM</option>
              <option value="9:30 AM">9:30 AM</option>
              <option value="10:00 AM">10:00 AM</option>
              <option value="10:30 AM">10:30 AM</option>
              <option value="11:00 AM">11:00 AM</option>
              <option value="11:30 AM">11:30 AM</option>
              <option value="12:00 PM">12:00 PM</option>
              <option value="12:30 PM">12:30 PM</option>
              <option value="1:00 PM">1:00 PM</option>
              <option value="1:30 PM">1:30 PM</option>
              <option value="2:00 PM">2:00 PM</option>
              <option value="2:30 PM">2:30 PM</option>
              <option value="3:00 PM">3:00 PM</option>
              <option value="3:30 PM">3:30 PM</option>
              <option value="4:00 PM">4:00 PM</option>
              <option value="4:30 PM">4:30 PM</option>
              <option value="5:00 PM">5:00 PM</option>
              <option value="5:30 PM">5:30 PM</option>
              <option value="6:00 PM">6:00 PM</option>
              <option value="6:30 PM">6:30 PM</option>
              <option value="7:00 PM">7:00 PM</option>
              <option value="7:30 PM">7:30 PM</option>
              <option value="8:00 PM">8:00 PM</option>
            </select>
          </div>

          <div class="form-group">
            <label for="duration">Duration</label>
            <select id="duration" class="form-select" required>
              <option value="30 mins" selected>30 mins</option>
              <option value="1 hour">1 hr</option>
            </select>
          </div>
        </div>

        <div class="button-group">
          <button id="checkBtn" class="btn-primary">Check Availability</button>
          <button id="resetBtn" class="btn-outline-secondary">Reset</button>
        </div>
      </div>
    </div>

    <!-- MOBILE VIEW -->
    <div class="mobile-view">
      <div class="header">
        <div style="display: flex; justify-content: space-between; align-items: start;">
          <div>
            <h1>üìç Seat Choping</h1>
            <p class="header-subtitle">Reserve your seat at hawker centres across Singapore</p>
          </div>
          <button id="historyBtnMobile" class="btn" style="color: var(--primary-color);">
              <i class="bi bi-clock-history fs-4"></i>
          </button>
        </div>
      </div>

      <!-- Booking History Modal which shows the active booking -->
      <div class="modal fade" id="historyModalMobile" tabindex="-1" aria-labelledby="historyModalLabelMobile" aria-hidden="true">
          <div class="modal-dialog modal-dialog-scrollable">
              <div class="modal-content">
                  <div class="modal-header" style="background-color: var(--secondary-color);">
                      <h5 class="modal-title" id="historyModalLabelMobile">Active Bookings</h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                  </div>
                  <!-- active booking -->
                  <div class="modal-body">
                      <div id="activeBookingsMobile" class="d-flex flex-column gap-3">
                          <!-- Active bookings will be inserted here -->
                      </div>
                  </div>
              </div>
          </div>
      </div>

      <div class="content-card">
        <div id="mapMobile" class="mb-4"></div>

        <div class="timeslot-group">
          <div class="form-group">
            <label for="timeslotMobile">Select Timeslot</label>
            <select id="timeslotMobile" class="form-select" required>
              <option value="8:00 AM" selected>8:00 AM</option>
              <option value="8:30 AM">8:30 AM</option>
              <option value="9:00 AM">9:00 AM</option>
              <option value="9:30 AM">9:30 AM</option>
              <option value="10:00 AM">10:00 AM</option>
              <option value="10:30 AM">10:30 AM</option>
              <option value="11:00 AM">11:00 AM</option>
              <option value="11:30 AM">11:30 AM</option>
              <option value="12:00 PM">12:00 PM</option>
              <option value="12:30 PM">12:30 PM</option>
              <option value="1:00 PM">1:00 PM</option>
              <option value="1:30 PM">1:30 PM</option>
              <option value="2:00 PM">2:00 PM</option>
              <option value="2:30 PM">2:30 PM</option>
              <option value="3:00 PM">3:00 PM</option>
              <option value="3:30 PM">3:30 PM</option>
              <option value="4:00 PM">4:00 PM</option>
              <option value="4:30 PM">4:30 PM</option>
              <option value="5:00 PM">5:00 PM</option>
              <option value="5:30 PM">5:30 PM</option>
              <option value="6:00 PM">6:00 PM</option>
              <option value="6:30 PM">6:30 PM</option>
              <option value="7:00 PM">7:00 PM</option>
              <option value="7:30 PM">7:30 PM</option>
              <option value="8:00 PM">8:00 PM</option>
            </select>
          </div>

          <div class="form-group">
            <label for="durationMobile">Duration</label>
            <select id="durationMobile" class="form-select" required>
              <option value="30 mins" selected>30 mins</option>
              <option value="1 hour">1 hr</option>
            </select>
          </div>
        </div>

        <div class="button-group">
          <button id="checkBtnMobile" class="btn-primary">Check Availability</button>
          <button id="resetBtnMobile" class="btn-outline-secondary">Reset</button>
        </div>
      </div>
    </div>

    <!--  -->

    <script>
        var map;
        var userMark; // a mark for user's location
        // function for the maps
        function initMap(){
            map = new google.maps.Map(document.getElementById('map'),{
                center: {lat: 1.352, lng: 103.819},
                zoom: 15
            });

            // Food centres data
            const centres = [
                {
                    name: "Maxwell Food Centre",
                    position: { lat: 1.2804, lng: 103.8446 },
                    link: "maxwell.html"
                },
                {
                    name: "Newton Food Centre",
                    position: { lat: 1.3113, lng: 103.8383 },
                    link: "newton.html"
                },
                {
                    name: "Changi Village Food Centre",
                    position: { lat: 1.3891, lng: 103.9871 },
                    link: "changiVillage.html"
                }
            ];
            
            // Food centres icons and info window
            const bounds = new google.maps.LatLngBounds();
            const infoWindow = new google.maps.InfoWindow();
            const foodIcon = {
                url: "https://maps.google.com/mapfiles/kml/shapes/dining.png",
                scaledSize: new google.maps.Size(32, 32)
            };

            // Add markers for centres
            centres.forEach((c) => {
                const marker = new google.maps.Marker({
                    position: c.position,
                    map,
                    title: c.name,
                    icon: foodIcon
                });
                bounds.extend(c.position);

                marker.addListener('click', () => {
                    infoWindow.setContent(
                        `<div style="min-width:180px"><strong>${c.name}</strong><br><a href="${c.link}">View details</a></div>`
                    );
                    infoWindow.open({ anchor: marker, map });
                });
            });
            
            //get the user's location
            if(navigator.geolocation){
                navigator.geolocation.getCurrentPosition(
                    (pos) => {
                        const userLoc = {
                            lat: pos.coords.latitude,
                            lng: pos.coords.longitude
                        };
                        // marks the user's current location
                        userMark = new google.maps.Marker({
                            position: userLoc,
                            map,
                            title: "You are here",
                            icon: {
                                url: "https://maps.google.com/mapfiles/ms/icons/blue-dot.png" // the google map's blue dot like on mobile app
                            }
                        });
                        bounds.extend(userLoc);
                        map.fitBounds(bounds);
                    }, // when cannot locate the user's location
                    () => alert("Could not access location.")
                );
            } else {
                alert("Geolocation not supported.");
            }
            // If geolocation is pending/blocked, still show centres
            setTimeout(() => {
                if (!bounds.isEmpty()) {
                    map.fitBounds(bounds);
                }
            }, 800);
        }

        // Function to hide past timeslots based on current time
        function updateTimeSlots() {
            const now = new Date();
            const currentMinutes = now.getHours() * 60 + now.getMinutes(); // convert to total minutes of the day

            const select = document.getElementById("timeslot");
            const checkBtn = document.getElementById("checkBtn");
            
            const options = Array.from(select.options);

            // Loop through all options in the dropdown
            options.forEach(option => {
                // Convert option time (e.g. "10:30 AM") to minutes
                const timeStr = option.value;
                const [time, period] = timeStr.split(" ");
                let [hours, minutes] = time.split(":").map(Number);

                // Convert 12-hour format to 24-hour
                if (period === "PM" && hours !== 12) hours += 12;
                if (period === "AM" && hours === 12) hours = 0;

                const optionMinutes = hours * 60 + minutes;

                // Hide past times
                if (optionMinutes < currentMinutes) {
                    option.style.display = "none";
                } else {
                    option.style.display = "block";
                }
            });

            // Automatically select the first available future slot
            const visibleOptions = options.filter(opt => opt.style.display !== "none");
            if (visibleOptions.length > 0) {
                visibleOptions[0].selected = true;
                select.disabled = false;
                checkBtn.disabled = false; // enable button
                checkBtn.style.opacity = "1"; // restore normal appearance
                checkBtn.style.cursor = "pointer";
            } else {
                // no available slots left today
                const placeholder = document.createElement("option");
                placeholder.textContent = "No more slots available today";
                placeholder.disabled = true;
                placeholder.selected = true;
                select.innerHTML = "";
                select.appendChild(placeholder);

                // disable the button
                checkBtn.disabled = true;
                checkBtn.style.opacity = "0.6";
            }
        }

        // add event listener to the reset button
        document.getElementById("resetBtn").addEventListener("click", () =>{
            document.getElementById("timeslot").selectedIndex = 0;
            document.getElementById("duration").selectedIndex = 0;
        });

        // add event listener to the check button
        document.getElementById("checkBtn").addEventListener("click", () => {
            const time = document.getElementById("timeslot").value;
            const duration = document.getElementById("duration").value;

            // Save selection to sessionStorage so don't depend on query string behavior
            try {
                sessionStorage.setItem('chope_time', time);
                sessionStorage.setItem('chope_duration', duration);
            } catch (e) {
                console.warn('Could not write to sessionStorage', e);
            }

            

            // Build the URL and redirect (keep params as fallback) instead to set it directly
            const url = 'availableFoodCenter.html?time=' + encodeURIComponent(time) + '&duration=' + encodeURIComponent(duration);
            window.location.href = url;
        });

        // load the map and initialize booking history
        window.onload = function() {
            loadGoogleMaps();
            window.bookingHistory.initialize();
            updateTimeSlots();
        };

        // Load Google Maps API dynamically with API key from environment
        async function loadGoogleMaps() {
            try {
                const response = await fetch('/api/google-maps-config');
                if (response.ok) {
                    const config = await response.json();
                    if (config.apiKey && config.apiKey.trim() !== '') {
                        // Load Google Maps script with API key
                        const script = document.createElement('script');
                        script.src = `https://maps.googleapis.com/maps/api/js?key=${config.apiKey}&callback=initMap`;
                        script.async = true;
                        script.defer = true;
                        document.head.appendChild(script);
                        console.log('‚úÖ Loaded Google Maps API with key from environment');
                    } else {
                        console.error('‚ùå Google Maps API key is empty');
                        alert('Google Maps API key not configured. Please set GOOGLE_MAPS_API_KEY in your .env file');
                    }
                } else {
                    throw new Error('Failed to fetch Google Maps config');
                }
            } catch (error) {
                console.error('‚ùå Error loading Google Maps API:', error);
                alert('Failed to load Google Maps. Please check your API key configuration.');
            }
        }
    </script>

    <!-- AIzaSyAZYjV0jElEp2DoLwlC5gE941lkf3Ymt14 -->
    <!-------------------------Bootstrap------------------------- -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>
    <script src="/scripts/notification.js"></script>

<div class="nav-bar">
  <a href="/" class="nav-logo"><img src="/img/logo.jpg" alt="ChopeLah" /></a>
  <div class="nav-items">
    <button onclick="location.href='../order/online-order-home.html'">
      <i class="bi bi-cart3"></i>
      <span>Order</span>
    </button>
    <button onclick="location.href='../community/community.html'">
      <i class="bi bi-people"></i>
      <span>Community</span>
    </button>
    <button class="active">
      <i class="bi bi-bookmark"></i>
      <span>Chope</span>
    </button>
    <button onclick="location.href='../crowd/crowd-view.html'">
      <i class="bi bi-eye"></i>
      <span>Crowd View</span>
    </button>
  </div>
  <div class="nav-right">
                <button class="notification-btn" onclick="toggleOrderNotification()">
                <i class="bi bi-bell"></i>
                <span class="notification-badge" style="display: none;">1</span>
            </button>
    <button onclick="location.href='../profile/profile.html'">
      <i class="bi bi-person"></i>
      <span>Profile</span>
    </button>
  </div>
</div>
</body>
</html>