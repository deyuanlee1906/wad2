<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Booking Confirmation</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="/styles/main.css">
    <link rel="stylesheet" href="/styles/components.css">
    <script src="seatDatabase.js"></script>
    <style>
        /* Custom Color Theme */
        :root {
            --primary-color: #D98566;
            --secondary-color: #F2D9BB;
            --background-color: #F2F2F2;
            --text-color: #262626;
            --danger-color: #dc3545;
        }

        body {
            background-color: var(--background-color);
            min-height: 100vh;
        }

        .confirmation-container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin: 20px auto;
            max-width: 500px;
            text-align: center;
        }

        .success-icon {
            width: 80px;
            height: 80px;
            background-color: var(--primary-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 30px;
            color: white;
            font-size: 40px;
        }

        .confirmation-title {
            color: var(--text-color);
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 20px;
        }

        .booking-details {
            background-color: var(--secondary-color);
            border-radius: 15px;
            padding: 25px;
            margin: 30px 0;
        }

        .detail-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 15px 0;
            padding: 10px 0;
            border-bottom: 1px solid rgba(217, 133, 102, 0.2);
        }

        .detail-item:last-child {
            border-bottom: none;
        }

        .detail-label {
            font-weight: 600;
            color: var(--text-color);
        }

        .detail-value {
            color: var(--primary-color);
            font-weight: bold;
        }

        .custom-btn {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            border-radius: 10px;
            padding: 12px 30px;
            font-weight: 600;
            font-size: 16px;
            margin: 10px;
        }

        .custom-btn:hover {
            background-color: var(--text-color);
            border-color: var(--text-color);
        }

        .custom-btn-secondary {
            background-color: transparent;
            border: 2px solid var(--primary-color);
            color: var(--primary-color);
            border-radius: 10px;
            padding: 10px 30px;
            font-weight: 600;
            font-size: 16px;
            margin: 10px;
        }

        .custom-btn-secondary:hover {
            background-color: var(--primary-color);
            color: white;
        }

        .custom-btn-danger {
            background-color: transparent;
            border: 2px solid var(--danger-color);
            color: var(--danger-color);
            border-radius: 10px;
            padding: 10px 30px;
            font-weight: 600;
            font-size: 16px;
            margin: 10px;
            transition: all 0.3s ease;
        }

        .custom-btn-danger:hover {
            background-color: var(--danger-color);
            color: white;
        }

        .back-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            background-color: var(--secondary-color);
            border: 2px solid var(--primary-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-color);
            text-decoration: none;
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            background-color: var(--primary-color);
            color: white;
        }

        @media (max-width: 767px) {
            .confirmation-container {
                margin: 10px;
                padding: 30px 20px;
            }
            
            .back-btn {
                top: 15px;
                left: 15px;
                width: 45px;
                height: 45px;
            }
        }
    </style>
</head>
<body class="theme-gradient">
    <a href="availableFoodCenter.html" class="back-btn">
        <i class="bi bi-arrow-left"></i>
    </a>

    <div class="container-fluid d-flex align-items-center justify-content-center min-vh-100">
        <div class="confirmation-container">
            <div class="success-icon">
                <i class="bi bi-check-lg"></i>
            </div>
            
            <h1 class="confirmation-title">Booking Confirmed!</h1>
            
            <!-- show the details of the booking (center, table, seats, time, duration, booking date) -->
            <div class="booking-details">
                <div class="detail-item">
                    <span class="detail-label">Food Center:</span>
                    <span class="detail-value" id="foodCenter">-</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Table:</span>
                    <span class="detail-value" id="table">-</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Seat:</span>
                    <span class="detail-value" id="seat">-</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Time:</span>
                    <span class="detail-value" id="time">-</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Duration:</span>
                    <span class="detail-value" id="duration">-</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Booking Date:</span>
                    <span class="detail-value" id="bookingDate">-</span>
                </div>
            </div>
            
            <!-- add cancel, continue booking, and back to home button -->
            <div class="mt-4">
                <button class="btn custom-btn-danger mb-3" id="cancelBooking">
                    <i class="bi bi-x-circle me-2"></i>Cancel Booking
                </button>
                <div>
                    <a href="availableFoodCenter.html" class="btn custom-btn">
                        <i class="bi bi-plus-circle me-2"></i>Continue Booking
                    </a>
                    <a href="chope.html" class="btn custom-btn-secondary">
                        <i class="bi bi-house me-2"></i>Back to Home
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Cancel Booking Modal -->
    <div class="modal fade" id="cancelModal" tabindex="-1" aria-labelledby="cancelModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header" style="background-color: var(--secondary-color); border-bottom: 2px solid var(--danger-color);">
                    <h5 class="modal-title" id="cancelModalLabel">Cancel Booking</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center py-4">
                    <p class="mb-0" style="font-size: 1.1rem;">Are you sure you want to cancel this booking?</p>
                </div>
                <div class="modal-footer justify-content-center border-0 pt-0">
                    <button type="button" class="btn btn-secondary px-4" style="min-width: 120px;" data-bs-dismiss="modal">No</button>
                    <button type="button" class="btn custom-btn-danger px-4" style="min-width: 120px;" id="confirmCancel">Yes</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Get URL parameters and sessionStorage fallback
            const params = new URLSearchParams(window.location.search);

            // Prefer booking_* snapshot first (authoritative), then URL params, then chope_* fallback, then defaults
            const getSS = (k) => { try { return sessionStorage.getItem(k); } catch(e) { console.warn('sessionStorage.getItem failed', e); return null; } };

            const booking = {
                foodCenter: getSS('booking_foodCenter'),
                table: getSS('booking_table'),
                seat: getSS('booking_seat'),
                time: getSS('booking_time'),
                duration: getSS('booking_duration')
            };

            const chope = {
                foodCenter: getSS('chope_foodCenter'),
                table: getSS('chope_table'),
                seat: getSS('chope_seat'),
                time: getSS('chope_time'),
                duration: getSS('chope_duration')
            };

            // Helper to pick field value and record source
            const pick = (field, defaultVal) => {
                if (booking[field]) return { value: booking[field], src: 'booking_*' };
                if (params.get(field)) return { value: params.get(field), src: 'url' };
                if (chope[field]) return { value: chope[field], src: 'chope_*' };
                return { value: defaultVal, src: 'default' };
            };

            // will take the value or it no value, it will be "-"
            const pickedFoodCenter = pick('foodCenter', '-');
            const pickedTable = pick('table', '-');
            const pickedSeat = pick('seat', '-');
            const pickedTime = pick('time', '-');
            const pickedDuration = pick('duration', '-');

            console.log('[booking-confirmation] picked sources:', {
                foodCenter: pickedFoodCenter.src,
                table: pickedTable.src,
                seat: pickedSeat.src,
                time: pickedTime.src,
                duration: pickedDuration.src
            });

            const foodCenter = pickedFoodCenter.value;
            const table = pickedTable.value;
            const seat = pickedSeat.value;
            const time = pickedTime.value;
            const duration = pickedDuration.value;

            // Populate the booking details
            document.getElementById('foodCenter').textContent = foodCenter;
            document.getElementById('table').textContent = table;
            document.getElementById('seat').textContent = seat;
            document.getElementById('time').textContent = time;
            document.getElementById('duration').textContent = duration;
            
            // Set current date
            const now = new Date();
            const options = { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            };
            document.getElementById('bookingDate').textContent = now.toLocaleDateString('en-US', options);
            // Clear booking snapshot keys so later bookings don't pick stale data
            try {
                sessionStorage.removeItem('booking_foodCenter');
                sessionStorage.removeItem('booking_table');
                sessionStorage.removeItem('booking_seat');
                sessionStorage.removeItem('booking_time');
                sessionStorage.removeItem('booking_duration');
            } catch (e) {
                // ignore
            }

            // Initialize cancellation modal
            const cancelModal = new bootstrap.Modal(document.getElementById('cancelModal'));

            // Handle cancel booking button click
            document.getElementById('cancelBooking').addEventListener('click', function() {
                cancelModal.show();
            });

            // Handle confirm cancellation
            document.getElementById('confirmCancel').addEventListener('click', function() {
                // Get the food center code from the name
                let foodCenterCode = '';
                if (foodCenter.toLowerCase().includes('maxwell')) {
                    foodCenterCode = 'maxwell';
                } else if (foodCenter.toLowerCase().includes('newton')) {
                    foodCenterCode = 'newton';
                } else if (foodCenter.toLowerCase().includes('changi')) {
                    foodCenterCode = 'changiVillage';
                }
                
                if (foodCenterCode && table && seat) {
                    // First hide the modal
                    cancelModal.hide();
                    // Remove the seat booking from the database
                    try {
                        // The table and seat are strings, need to convert them to numbers for the database
                        const tableNum = parseInt(table);
                        const seatNum = parseInt(seat);
                        const success = window.seatDatabase.releaseSeat(foodCenterCode, tableNum, seatNum);
                        if (!success) {
                            throw new Error('Failed to release seat');
                        }
                        alert('Booking cancelled successfully!');
                        // Redirect back to available food centers
                        window.location.href = 'availableFoodCenter.html';
                    } catch (e) {
                        console.error('Error cancelling booking:', e);
                        alert('Failed to cancel booking. Please try again.');
                    }
                } else {
                    cancelModal.hide();
                    alert('Cannot cancel booking: missing booking details');
                }
            });
        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI"
        crossorigin="anonymous"></script>
</body>
</html>
