<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Edit Profile</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="theme.css">
  <style>
    .card { max-width: 640px; margin: 0 auto; }
    .avatar-lg { width: 112px; height: 112px; border-radius: 50%; border: 3px solid var(--color-coral); background: linear-gradient(135deg, var(--color-coral), var(--color-blush)); color: var(--color-ivory); display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 42px; }
    .hidden { display: none; }
  </style>
  <script type="module" src="firebaseauth.js"></script>
</head>
<body>
  <div class="container py-4">
    <h3 class="mb-3">Edit Profile</h3>
    <div class="card p-3">
      <div class="d-flex align-items-center gap-3 mb-3">
        <div id="avatarPreview" class="avatar-lg">U</div>
        <div class="flex-grow-1">
          <div id="currentUsername" class="fw-bold">@username</div>
          <div id="currentEmail" class="text-secondary">email</div>
        </div>
        <div>
          <button id="logoutBtn" class="btn btn-outline-secondary">Logout</button>
        </div>
      </div>

      <div class="mb-3">
        <label class="form-label">Profile Photo</label>
        <input id="photoInput" type="file" accept="image/*" class="form-control">
        <div class="form-text">JPEG/PNG recommended. Upload replaces your current photo.</div>
        <div id="photoError" class="text-danger mt-1 hidden"></div>
      </div>

      <hr>

      <div class="mb-3">
        <label for="usernameInput" class="form-label">Username</label>
        <input id="usernameInput" type="text" class="form-control" placeholder="new username">
        <div id="usernameHelp" class="form-text">Must be unique. a–z, 0–9, underscores recommended.</div>
        <div id="usernameError" class="text-danger mt-1 hidden"></div>
        <button id="saveUsernameBtn" class="btn btn-primary mt-2">Save Username</button>
      </div>

      <div class="mb-3">
        <label for="emailInput" class="form-label">Email</label>
        <input id="emailInput" type="email" class="form-control" placeholder="new email">
        <div id="emailError" class="text-danger mt-1 hidden"></div>
        <button id="saveEmailBtn" class="btn btn-primary mt-2">Save Email</button>
      </div>

      <div class="mb-3">
        <label for="passwordInput" class="form-label">New Password</label>
        <input id="passwordInput" type="password" class="form-control" placeholder="new password">
        <div class="form-text">Min 8 chars, upper, lower, number, special.</div>
        <div id="passwordError" class="text-danger mt-1 hidden"></div>
        <button id="savePasswordBtn" class="btn btn-primary mt-2">Save Password</button>
      </div>

      <div class="alert alert-info mb-0">
        For email/password changes, you may be asked to reauthenticate if your session is old.
      </div>
    </div>
  </div>

  <div class="nav-bar">
    <button onclick="location.href='online-order-home.html'">
      <i class="bi bi-cart3"></i>
      <span>Order</span>
    </button>
    <button onclick="location.href='community.html'">
      <i class="bi bi-people"></i>
      <span>Community</span>
    </button>
    <button onclick="location.href='chope-home.html'">
      <i class="bi bi-bookmark"></i>
      <span>Chope</span>
    </button>
    <button onclick="location.href='crowd-view.html'">
      <i class="bi bi-eye"></i>
      <span>Crowd View</span>
    </button>
    <button class="active" onclick="location.href='profile.html'">
      <i class="bi bi-person"></i>
      <span>Profile</span>
    </button>
  </div>

  <script type="module">
    import { getAuth, onAuthStateChanged, updateEmail, updatePassword, signOut, reauthenticateWithCredential, EmailAuthProvider } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-storage.js";

    const auth = getAuth();
    const db = getFirestore();
    const storage = getStorage();

    const avatarPreview = document.getElementById('avatarPreview');
    const currentUsernameEl = document.getElementById('currentUsername');
    const currentEmailEl = document.getElementById('currentEmail');
    const photoInput = document.getElementById('photoInput');
    const photoError = document.getElementById('photoError');

    const usernameInput = document.getElementById('usernameInput');
    const usernameError = document.getElementById('usernameError');
    const saveUsernameBtn = document.getElementById('saveUsernameBtn');

    const emailInput = document.getElementById('emailInput');
    const emailError = document.getElementById('emailError');
    const saveEmailBtn = document.getElementById('saveEmailBtn');

    const passwordInput = document.getElementById('passwordInput');
    const passwordError = document.getElementById('passwordError');
    const savePasswordBtn = document.getElementById('savePasswordBtn');

    const logoutBtn = document.getElementById('logoutBtn');

    function showError(el, message) {
      el.textContent = message || '';
      el.classList.toggle('hidden', !message);
    }

    function setAvatar(name, photoURL) {
      // Always show default grey avatar with initial (no external photos)
      const initial = (name || 'U').trim().charAt(0).toUpperCase() || 'U';
      avatarPreview.textContent = initial;
      avatarPreview.style.background = 'linear-gradient(135deg, #6c757d, #adb5bd)';
      avatarPreview.style.color = '#ffffff';
    }

    async function loadCurrentUser(uid) {
      const snap = await getDoc(doc(db, 'users', uid));
      const data = snap.exists() ? snap.data() : {};
      const username = data.username || (data.email ? data.email.split('@')[0] : 'user');
      currentUsernameEl.textContent = `@${username}`;
      currentEmailEl.textContent = data.email || '';
      // Always use default grey avatar (no external photos)
      setAvatar(username, '');
    }

    onAuthStateChanged(auth, async (user) => {
      const uid = user?.uid || localStorage.getItem('loggedInUserId');
      if (!uid) return;
      await loadCurrentUser(uid);
    });

    // Username change with uniqueness via usernames collection
    saveUsernameBtn.addEventListener('click', async () => {
      showError(usernameError, '');
      const user = auth.currentUser;
      if (!user) return;
      const desired = (usernameInput.value || '').trim().toLowerCase();
      if (!desired) { showError(usernameError, 'Please enter a username.'); return; }
      if (!/^[a-z0-9_]{3,20}$/.test(desired)) { showError(usernameError, '3-20 chars: a-z, 0-9, underscore.'); return; }

      try {
        const currentUserDoc = await getDoc(doc(db, 'users', user.uid));
        const currentUsername = currentUserDoc.exists() ? (currentUserDoc.data().username || '').toLowerCase() : '';
        if (currentUsername === desired) { showError(usernameError, 'This is already your username.'); return; }

        const mappingDoc = await getDoc(doc(db, 'usernames', desired));
        if (mappingDoc.exists()) { showError(usernameError, 'Username is taken.'); return; }

        // Reserve new username
        await setDoc(doc(db, 'usernames', desired), { uid: user.uid, email: user.email });
        // Remove old mapping if exists and belongs to user
        if (currentUsername) {
          const oldRef = doc(db, 'usernames', currentUsername);
          const oldSnap = await getDoc(oldRef);
          if (oldSnap.exists() && oldSnap.data().uid === user.uid) {
            // Soft-delete by overwriting with a placeholder UID could be an option, but we'll skip delete here for safety
          }
        }
        await setDoc(doc(db, 'users', user.uid), { username: desired }, { merge: true });
        await loadCurrentUser(user.uid);
        usernameInput.value = '';
      } catch (e) {
        console.error(e);
        showError(usernameError, 'Could not change username. Try again.');
      }
    });

    // Email change requires reauth when needed
    saveEmailBtn.addEventListener('click', async () => {
      showError(emailError, '');
      const user = auth.currentUser;
      if (!user) return;
      const newEmail = (emailInput.value || '').trim().toLowerCase();
      if (!newEmail) { showError(emailError, 'Please enter an email.'); return; }

      async function doUpdate() {
        await updateEmail(user, newEmail);
        await setDoc(doc(db, 'users', user.uid), { email: newEmail }, { merge: true });
        // Update username mapping email if one exists for user's current username
        const userDoc = await getDoc(doc(db, 'users', user.uid));
        const uname = userDoc.exists() ? (userDoc.data().username || '').toLowerCase() : '';
        if (uname) { await setDoc(doc(db, 'usernames', uname), { uid: user.uid, email: newEmail }, { merge: true }); }
        await loadCurrentUser(user.uid);
        emailInput.value = '';
      }

      try {
        await doUpdate();
      } catch (e) {
        if (e.code === 'auth/requires-recent-login') {
          const currentEmail = auth.currentUser?.email || '';
          const pw = window.prompt('For security, please re-enter your password:');
          if (!pw) { showError(emailError, 'Reauthentication cancelled.'); return; }
          try {
            const cred = EmailAuthProvider.credential(currentEmail, pw);
            await reauthenticateWithCredential(auth.currentUser, cred);
            await doUpdate();
          } catch (err) {
            showError(emailError, 'Reauthentication failed.');
          }
        } else if (e.code === 'auth/email-already-in-use') {
          showError(emailError, 'Email is already in use.');
        } else if (e.code === 'auth/invalid-email') {
          showError(emailError, 'Invalid email format.');
        } else {
          showError(emailError, 'Could not change email. Try again.');
        }
      }
    });

    // Password change with validation
    function validatePassword(pw) {
      const issues = [];
      if (pw.length < 8) issues.push('8+ characters');
      if (!/[A-Z]/.test(pw)) issues.push('1 uppercase');
      if (!/[a-z]/.test(pw)) issues.push('1 lowercase');
      if (!/[0-9]/.test(pw)) issues.push('1 number');
      if (!/[!@#$%^&*()_+\-=[\]{};':"\\|,.<>\/?`~]/.test(pw)) issues.push('1 special');
      return issues;
    }

    savePasswordBtn.addEventListener('click', async () => {
      showError(passwordError, '');
      const user = auth.currentUser;
      if (!user) return;
      const newPw = passwordInput.value || '';
      const issues = validatePassword(newPw);
      if (issues.length) { showError(passwordError, 'Password must include: ' + issues.join(', ')); return; }

      async function doUpdatePw() { await updatePassword(user, newPw); passwordInput.value=''; }

      try {
        await doUpdatePw();
      } catch (e) {
        if (e.code === 'auth/requires-recent-login') {
          const currentEmail = auth.currentUser?.email || '';
          const pw = window.prompt('For security, please re-enter your current password:');
          if (!pw) { showError(passwordError, 'Reauthentication cancelled.'); return; }
          try {
            const cred = EmailAuthProvider.credential(currentEmail, pw);
            await reauthenticateWithCredential(auth.currentUser, cred);
            await doUpdatePw();
          } catch (err) {
            showError(passwordError, 'Reauthentication failed.');
          }
        } else if (e.code === 'auth/weak-password') {
          showError(passwordError, 'Password is too weak.');
        } else {
          showError(passwordError, 'Could not change password.');
        }
      }
    });

    // Photo upload -> Storage -> update users.photoURL
    photoInput.addEventListener('change', async (e) => {
      showError(photoError, '');
      const file = e.target.files?.[0];
      const user = auth.currentUser;
      if (!file || !user) return;
      try {
        const path = `user_uploads/${user.uid}/profile_${Date.now()}`;
        const r = ref(storage, path);
        await uploadBytes(r, file);
        const url = await getDownloadURL(r);
        await setDoc(doc(db, 'users', user.uid), { photoURL: url }, { merge: true });
        await loadCurrentUser(user.uid);
      } catch (e) {
        console.error(e);
        showError(photoError, 'Could not upload photo.');
      }
    });

    // Logout
    logoutBtn.addEventListener('click', async () => {
      try {
        await signOut(auth);
      } catch (_) {}
      localStorage.removeItem('loggedInUserId');
      window.location.href = 'index.html';
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>

